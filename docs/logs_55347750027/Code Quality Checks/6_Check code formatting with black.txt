2026-01-25T08:57:20.9737067Z ##[group]Run black --check --diff app/ tests/
2026-01-25T08:57:20.9737450Z [36;1mblack --check --diff app/ tests/[0m
2026-01-25T08:57:20.9770515Z shell: /usr/bin/bash -e {0}
2026-01-25T08:57:20.9770763Z env:
2026-01-25T08:57:20.9770941Z   PYTHON_VERSION: 3.13
2026-01-25T08:57:20.9771248Z   pythonLocation: /opt/hostedtoolcache/Python/3.13.11/x64
2026-01-25T08:57:20.9771686Z   PKG_CONFIG_PATH: /opt/hostedtoolcache/Python/3.13.11/x64/lib/pkgconfig
2026-01-25T08:57:20.9772097Z   Python_ROOT_DIR: /opt/hostedtoolcache/Python/3.13.11/x64
2026-01-25T08:57:20.9772477Z   Python2_ROOT_DIR: /opt/hostedtoolcache/Python/3.13.11/x64
2026-01-25T08:57:20.9772854Z   Python3_ROOT_DIR: /opt/hostedtoolcache/Python/3.13.11/x64
2026-01-25T08:57:20.9773341Z   LD_LIBRARY_PATH: /opt/hostedtoolcache/Python/3.13.11/x64/lib
2026-01-25T08:57:20.9773641Z ##[endgroup]
2026-01-25T08:57:21.5593614Z --- /home/runner/work/flask_blog/flask_blog/app/auth/__init__.py	2026-01-25 08:57:06.650994+00:00
2026-01-25T08:57:21.5596112Z +++ /home/runner/work/flask_blog/flask_blog/app/auth/__init__.py	2026-01-25 08:57:21.556781+00:00
2026-01-25T08:57:21.5596983Z @@ -1,9 +1,9 @@
2026-01-25T08:57:21.5597612Z  """Blueprint авторизации."""
2026-01-25T08:57:21.5598003Z  
2026-01-25T08:57:21.5598373Z  from flask import Blueprint
2026-01-25T08:57:21.5598781Z  
2026-01-25T08:57:21.5599173Z -bp = Blueprint('auth', __name__, url_prefix='/auth')
2026-01-25T08:57:21.5599769Z +bp = Blueprint("auth", __name__, url_prefix="/auth")
2026-01-25T08:57:21.5600255Z  
2026-01-25T08:57:21.5600836Z  from app.auth.utils import hash_password, verify_password, generate_discriminator
2026-01-25T08:57:21.5601529Z  
2026-01-25T08:57:21.5601881Z  from app.auth import routes  # noqa: E402, F401
2026-01-25T08:57:21.5623970Z would reformat /home/runner/work/flask_blog/flask_blog/app/auth/__init__.py
2026-01-25T08:57:21.5683169Z --- /home/runner/work/flask_blog/flask_blog/app/db/__init__.py	2026-01-25 08:57:06.650994+00:00
2026-01-25T08:57:21.5684280Z +++ /home/runner/work/flask_blog/flask_blog/app/db/__init__.py	2026-01-25 08:57:21.567721+00:00
2026-01-25T08:57:21.5685078Z @@ -1,5 +1,5 @@
2026-01-25T08:57:21.5685634Z  """Модуль работы с базой данных."""
2026-01-25T08:57:21.5686503Z  
2026-01-25T08:57:21.5686920Z  from app.db.db import close_db, get_db, init_app, init_db
2026-01-25T08:57:21.5687462Z  
2026-01-25T08:57:21.5687854Z -__all__ = ['get_db', 'close_db', 'init_db', 'init_app']
2026-01-25T08:57:21.5688430Z +__all__ = ["get_db", "close_db", "init_db", "init_app"]
2026-01-25T08:57:21.5723667Z would reformat /home/runner/work/flask_blog/flask_blog/app/db/__init__.py
2026-01-25T08:57:21.5964600Z --- /home/runner/work/flask_blog/flask_blog/app/__init__.py	2026-01-25 08:57:06.650994+00:00
2026-01-25T08:57:21.5965727Z +++ /home/runner/work/flask_blog/flask_blog/app/__init__.py	2026-01-25 08:57:21.593642+00:00
2026-01-25T08:57:21.5966546Z @@ -18,57 +18,62 @@
2026-01-25T08:57:21.5966897Z      Returns:
2026-01-25T08:57:21.5967592Z          Flask: готовое к запуску приложение.
2026-01-25T08:57:21.5968042Z      """
2026-01-25T08:57:21.5968416Z      # Загружаем переменные из .env файла
2026-01-25T08:57:21.5968828Z      load_dotenv()
2026-01-25T08:57:21.5969122Z -    
2026-01-25T08:57:21.5969393Z +
2026-01-25T08:57:21.5970010Z      # instance_relative_config=True означает, что конфиг и файлы instance
2026-01-25T08:57:21.5970918Z      # лежат вне пакета app/ (удобно для секретов и локальных настроек).
2026-01-25T08:57:21.5971530Z      app = Flask(__name__, instance_relative_config=True)
2026-01-25T08:57:21.5971996Z  
2026-01-25T08:57:21.5972375Z      # Базовые настройки приложения.
2026-01-25T08:57:21.5974645Z      # SECRET_KEY нужен для сессий/подписей (в проде брать только из env или instance/config.py).
2026-01-25T08:57:21.5975394Z      app.config.from_mapping(
2026-01-25T08:57:21.5975970Z -        SECRET_KEY=os.environ.get('SECRET_KEY', 'dev_key_123'),
2026-01-25T08:57:21.5976760Z +        SECRET_KEY=os.environ.get("SECRET_KEY", "dev_key_123"),
2026-01-25T08:57:21.5977300Z      )
2026-01-25T08:57:21.5978221Z  
2026-01-25T08:57:21.5978665Z      # Загружаем конфигурацию:
2026-01-25T08:57:21.5979444Z      # - обычный режим: из config.py и instance/config.py (если файл существует)
2026-01-25T08:57:21.5980205Z      # - тестовый режим: из test_config
2026-01-25T08:57:21.5980688Z      if test_config is None:
2026-01-25T08:57:21.5981167Z -        app.config.from_object('config.Config')
2026-01-25T08:57:21.5981781Z -        app.config.from_pyfile('config.py', silent=True)
2026-01-25T08:57:21.5982383Z +        app.config.from_object("config.Config")
2026-01-25T08:57:21.5983305Z +        app.config.from_pyfile("config.py", silent=True)
2026-01-25T08:57:21.5983853Z      else:
2026-01-25T08:57:21.5984226Z          app.config.from_mapping(test_config)
2026-01-25T08:57:21.5984769Z  
2026-01-25T08:57:21.5985415Z      # Гарантируем существование папки instance/ (там будет БД и локальный конфиг).
2026-01-25T08:57:21.5986125Z      os.makedirs(app.instance_path, exist_ok=True)
2026-01-25T08:57:21.5986605Z  
2026-01-25T08:57:21.5987047Z      # Добавляем кастомные фильтры для шаблонов
2026-01-25T08:57:21.5987512Z -    @app.template_filter('nl2br')
2026-01-25T08:57:21.5987923Z +    @app.template_filter("nl2br")
2026-01-25T08:57:21.5988322Z      def nl2br_filter(text):
2026-01-25T08:57:21.5988916Z would reformat /home/runner/work/flask_blog/flask_blog/app/__init__.py
2026-01-25T08:57:21.5989668Z          """Преобразует переносы строк в HTML теги <br>."""
2026-01-25T08:57:21.5990143Z          if text is None:
2026-01-25T08:57:21.5990500Z -            return ''
2026-01-25T08:57:21.5990831Z +            return ""
2026-01-25T08:57:21.5991189Z          import markupsafe
2026-01-25T08:57:21.5991683Z -        return markupsafe.Markup(text.replace('\n', '<br>\n'))
2026-01-25T08:57:21.5992241Z +
2026-01-25T08:57:21.5992697Z +        return markupsafe.Markup(text.replace("\n", "<br>\n"))
2026-01-25T08:57:21.5993780Z  
2026-01-25T08:57:21.5994222Z      # Добавляем CSRF токен в контекст всех шаблонов
2026-01-25T08:57:21.5994756Z      @app.context_processor
2026-01-25T08:57:21.5995189Z      def inject_csrf_token():
2026-01-25T08:57:21.5995745Z          """Добавляет CSRF токен в контекст всех шаблонов."""
2026-01-25T08:57:21.5996325Z          from app.forms.csrf import generate_csrf_token
2026-01-25T08:57:21.5996902Z -        return {'csrf_token': generate_csrf_token}
2026-01-25T08:57:21.5997382Z +
2026-01-25T08:57:21.5997757Z +        return {"csrf_token": generate_csrf_token}
2026-01-25T08:57:21.5998211Z  
2026-01-25T08:57:21.5998788Z      # Импорты внутри функции предотвращают циклические ссылки при импорте пакетов.
2026-01-25T08:57:21.5999342Z      from app import db
2026-01-25T08:57:21.5999692Z +
2026-01-25T08:57:21.5999973Z      db.init_app(app)
2026-01-25T08:57:21.6000311Z  
2026-01-25T08:57:21.6000689Z      # Blueprint авторизации: /auth/...
2026-01-25T08:57:21.6001184Z      from app.auth.routes import bp as auth_bp
2026-01-25T08:57:21.6001625Z +
2026-01-25T08:57:21.6001924Z      app.register_blueprint(auth_bp)
2026-01-25T08:57:21.6002337Z  
2026-01-25T08:57:21.6002731Z      # Главные страницы: /
2026-01-25T08:57:21.6003345Z      from app.main.routes import bp as main_bp
2026-01-25T08:57:21.6003856Z +
2026-01-25T08:57:21.6004193Z      app.register_blueprint(main_bp)
2026-01-25T08:57:21.6004603Z  
2026-01-25T08:57:21.6004887Z      return app
2026-01-25T08:57:21.6189350Z --- /home/runner/work/flask_blog/flask_blog/app/db/db.py	2026-01-25 08:57:06.650994+00:00
2026-01-25T08:57:21.6190470Z +++ /home/runner/work/flask_blog/flask_blog/app/db/db.py	2026-01-25 08:57:21.617285+00:00
2026-01-25T08:57:21.6191213Z @@ -12,14 +12,14 @@
2026-01-25T08:57:21.6191583Z  import click
2026-01-25T08:57:21.6191951Z  from flask import g, current_app
2026-01-25T08:57:21.6192382Z  
2026-01-25T08:57:21.6193380Z  # Подавляем предупреждение об устаревшем конвертере временных меток Python 3.12+
2026-01-25T08:57:21.6194088Z  warnings.filterwarnings(
2026-01-25T08:57:21.6194492Z -    'ignore',
2026-01-25T08:57:21.6194827Z +    "ignore",
2026-01-25T08:57:21.6195196Z      category=DeprecationWarning,
2026-01-25T08:57:21.6196179Z -    module='sqlite3',
2026-01-25T08:57:21.6196647Z -    message='.*default timestamp converter.*'
2026-01-25T08:57:21.6197182Z +    module="sqlite3",
2026-01-25T08:57:21.6197627Z +    message=".*default timestamp converter.*",
2026-01-25T08:57:21.6198109Z  )
2026-01-25T08:57:21.6198403Z  
2026-01-25T08:57:21.6199005Z  
2026-01-25T08:57:21.6200091Z would reformat /home/runner/work/flask_blog/flask_blog/app/db/db.py
2026-01-25T08:57:21.6200734Z  def get_db():
2026-01-25T08:57:21.6206124Z      """Возвращает соединение с БД для текущего контекста запроса.
2026-01-25T08:57:21.6206937Z @@ -28,15 +28,14 @@
2026-01-25T08:57:21.6207395Z  
2026-01-25T08:57:21.6207838Z      Почему так:
2026-01-25T08:57:21.6208475Z      - g живёт ровно в рамках одного запроса,
2026-01-25T08:57:21.6209383Z      - мы избегаем глобального соединения и проблем с потоками/контекстами.
2026-01-25T08:57:21.6210141Z      """
2026-01-25T08:57:21.6210603Z -    if 'db' not in g:
2026-01-25T08:57:21.6211175Z +    if "db" not in g:
2026-01-25T08:57:21.6211977Z          # Создаём соединение с БД из конфигурации приложения
2026-01-25T08:57:21.6212642Z          g.db = sqlite3.connect(
2026-01-25T08:57:21.6213458Z -            current_app.config['DATABASE'],
2026-01-25T08:57:21.6214135Z -            detect_types=sqlite3.PARSE_DECLTYPES
2026-01-25T08:57:21.6214990Z +            current_app.config["DATABASE"], detect_types=sqlite3.PARSE_DECLTYPES
2026-01-25T08:57:21.6215799Z          )
2026-01-25T08:57:21.6216505Z          # Позволяет обращаться к колонкам по именам, как к словарю
2026-01-25T08:57:21.6217300Z          g.db.row_factory = sqlite3.Row
2026-01-25T08:57:21.6217895Z  
2026-01-25T08:57:21.6218299Z      return g.db
2026-01-25T08:57:21.6218756Z @@ -45,28 +44,28 @@
2026-01-25T08:57:21.6219268Z  def close_db(_=None):
2026-01-25T08:57:21.6220354Z      """Закрывает соединение с БД, если оно было открыто.
2026-01-25T08:57:21.6221034Z  
2026-01-25T08:57:21.6221810Z      Вызывается автоматически при завершении обработки запроса (teardown_appcontext).
2026-01-25T08:57:21.6222645Z      """
2026-01-25T08:57:21.6223323Z -    db = g.pop('db', None)
2026-01-25T08:57:21.6223899Z +    db = g.pop("db", None)
2026-01-25T08:57:21.6224426Z      if db is not None:
2026-01-25T08:57:21.6224926Z          db.close()
2026-01-25T08:57:21.6225452Z  
2026-01-25T08:57:21.6225857Z  
2026-01-25T08:57:21.6226254Z  def init_db():
2026-01-25T08:57:21.6227251Z      """Инициализирует БД: создаёт таблицы из SQL-скрипта schema.sql."""
2026-01-25T08:57:21.6227982Z      db = get_db()
2026-01-25T08:57:21.6228806Z      # current_app.open_resource ищет файл относительно пакета приложения
2026-01-25T08:57:21.6231131Z -    with current_app.open_resource('db/schema.sql') as f:
2026-01-25T08:57:21.6231803Z -        db.executescript(f.read().decode('utf8'))
2026-01-25T08:57:21.6232507Z +    with current_app.open_resource("db/schema.sql") as f:
2026-01-25T08:57:21.6233379Z +        db.executescript(f.read().decode("utf8"))
2026-01-25T08:57:21.6233932Z  
2026-01-25T08:57:21.6234538Z  
2026-01-25T08:57:21.6234884Z -@click.command('init-db')
2026-01-25T08:57:21.6235346Z +@click.command("init-db")
2026-01-25T08:57:21.6235805Z  def init_db_command():
2026-01-25T08:57:21.6236631Z      """CLI-команда: очистить/создать таблицы (запускается как `flask init-db`)."""
2026-01-25T08:57:21.6237287Z      init_db()
2026-01-25T08:57:21.6237829Z -    click.echo('База данных инициализирована.')
2026-01-25T08:57:21.6238497Z +    click.echo("База данных инициализирована.")
2026-01-25T08:57:21.6238953Z  
2026-01-25T08:57:21.6239234Z  
2026-01-25T08:57:21.6239530Z  def init_app(app):
2026-01-25T08:57:21.6240036Z      """Подключает БД к Flask-приложению.
2026-01-25T08:57:21.6240488Z  
2026-01-25T08:57:21.6296410Z --- /home/runner/work/flask_blog/flask_blog/app/forms/__init__.py	2026-01-25 08:57:06.650994+00:00
2026-01-25T08:57:21.6303674Z +++ /home/runner/work/flask_blog/flask_blog/app/forms/__init__.py	2026-01-25 08:57:21.628831+00:00
2026-01-25T08:57:21.6304412Z @@ -1,35 +1,42 @@
2026-01-25T08:57:21.6304780Z  from .base import Form
2026-01-25T08:57:21.6305279Z  from .fields import StringField, PasswordField, TextAreaField
2026-01-25T08:57:21.6307345Z  from .validators import (
2026-01-25T08:57:21.6307665Z -    DataRequired, Length, EqualTo,
2026-01-25T08:57:21.6307940Z +    DataRequired,
2026-01-25T08:57:21.6308143Z +    Length,
2026-01-25T08:57:21.6308331Z +    EqualTo,
2026-01-25T08:57:21.6308815Z      # TODO: Валидаторы-заглушки (требуют реализации)
2026-01-25T08:57:21.6309161Z -    Email, Username, PasswordStrength, UniqueUsername, 
2026-01-25T08:57:21.6309474Z -    Slug, NumberRange, URL
2026-01-25T08:57:21.6309688Z +    Email,
2026-01-25T08:57:21.6309852Z +    Username,
2026-01-25T08:57:21.6310034Z +    PasswordStrength,
2026-01-25T08:57:21.6310261Z +    UniqueUsername,
2026-01-25T08:57:21.6310473Z +    Slug,
2026-01-25T08:57:21.6310930Z +    NumberRange,
2026-01-25T08:57:21.6311108Z +    URL,
2026-01-25T08:57:21.6311406Z      # TODO: Regexp - будет реализован в будущем
2026-01-25T08:57:21.6311677Z  )
2026-01-25T08:57:21.6311848Z  from .post import PostForm
2026-01-25T08:57:21.6312105Z  from .auth import RegistrationForm, LoginForm
2026-01-25T08:57:21.6312385Z  from .comment import CommentForm
2026-01-25T08:57:21.6312602Z  
2026-01-25T08:57:21.6312755Z  __all__ = [
2026-01-25T08:57:21.6313156Z -    'Form',
2026-01-25T08:57:21.6313378Z -    'StringField',
2026-01-25T08:57:21.6313573Z -    'PasswordField',
2026-01-25T08:57:21.6313985Z -    'TextAreaField',
2026-01-25T08:57:21.6314325Z -    'DataRequired',
2026-01-25T08:57:21.6314645Z -    'Length',
2026-01-25T08:57:21.6314948Z -    'EqualTo',
2026-01-25T08:57:21.6315247Z -    'PostForm',
2026-01-25T08:57:21.6315562Z -    'RegistrationForm',
2026-01-25T08:57:21.6315946Z -    'LoginForm',
2026-01-25T08:57:21.6316275Z -    'CommentForm',
2026-01-25T08:57:21.6316645Z +    "Form",
2026-01-25T08:57:21.6316933Z +    "StringField",
2026-01-25T08:57:21.6317270Z +    "PasswordField",
2026-01-25T08:57:21.6317652Z +    "TextAreaField",
2026-01-25T08:57:21.6318008Z +    "DataRequired",
2026-01-25T08:57:21.6318339Z +    "Length",
2026-01-25T08:57:21.6318663Z +    "EqualTo",
2026-01-25T08:57:21.6319123Z +    "PostForm",
2026-01-25T08:57:21.6319608Z +    "RegistrationForm",
2026-01-25T08:57:21.6320251Z +    "LoginForm",
2026-01-25T08:57:21.6320777Z +    "CommentForm",
2026-01-25T08:57:21.6321503Z      # TODO: Валидаторы-заглушки (требуют реализации)
2026-01-25T08:57:21.6322187Z -    'Email',
2026-01-25T08:57:21.6322669Z -    'Username', 
2026-01-25T08:57:21.6323348Z -    'PasswordStrength',
2026-01-25T08:57:21.6323952Z -    'UniqueUsername',
2026-01-25T08:57:21.6324493Z -    'Slug',
2026-01-25T08:57:21.6324896Z -    'NumberRange',
2026-01-25T08:57:21.6325421Z -    'URL'
2026-01-25T08:57:21.6329388Z +    "Email",
2026-01-25T08:57:21.6330026Z +    "Username",
2026-01-25T08:57:21.6330588Z +    "PasswordStrength",
2026-01-25T08:57:21.6347241Z +    "UniqueUsername",
2026-01-25T08:57:21.6347620Z +    "Slug",
2026-01-25T08:57:21.6347926Z +    "NumberRange",
2026-01-25T08:57:21.6348577Z +    "URL",
2026-01-25T08:57:21.6349116Z      # TODO: 'Regexp' - будет добавлен при реализации
2026-01-25T08:57:21.6349591Z  ]
2026-01-25T08:57:21.6350108Z would reformat /home/runner/work/flask_blog/flask_blog/app/forms/__init__.py
2026-01-25T08:57:21.6350909Z would reformat /home/runner/work/flask_blog/flask_blog/app/auth/utils.py
2026-01-25T08:57:21.6351809Z --- /home/runner/work/flask_blog/flask_blog/app/auth/utils.py	2026-01-25 08:57:06.650994+00:00
2026-01-25T08:57:21.6352864Z +++ /home/runner/work/flask_blog/flask_blog/app/auth/utils.py	2026-01-25 08:57:21.628215+00:00
2026-01-25T08:57:21.6354239Z @@ -1,6 +1,7 @@
2026-01-25T08:57:21.6354828Z  """Утилиты для авторизации: хэширование паролей, декораторы."""
2026-01-25T08:57:21.6355334Z +
2026-01-25T08:57:21.6355661Z  import functools
2026-01-25T08:57:21.6356041Z  import secrets
2026-01-25T08:57:21.6356390Z  from typing import Optional
2026-01-25T08:57:21.6356784Z  
2026-01-25T08:57:21.6357146Z  from flask import flash, g, redirect, url_for
2026-01-25T08:57:21.6357652Z @@ -10,86 +11,86 @@
2026-01-25T08:57:21.6358009Z  MAX_DISCRIMINATOR = 9999
2026-01-25T08:57:21.6358358Z  
2026-01-25T08:57:21.6358633Z  
2026-01-25T08:57:21.6359113Z  def hash_password(password: str, salt: bytes = None) -> tuple[str, bytes]:
2026-01-25T08:57:21.6359944Z      """Хэширует пароль с использованием werkzeug.security.
2026-01-25T08:57:21.6360435Z -    
2026-01-25T08:57:21.6360713Z +
2026-01-25T08:57:21.6360980Z      Args:
2026-01-25T08:57:21.6361405Z          password: Пароль для хэширования
2026-01-25T08:57:21.6362134Z          salt: Опциональная соль (16 байт). Если не предоставлена, генерируется случайно.
2026-01-25T08:57:21.6362725Z -    
2026-01-25T08:57:21.6363186Z +
2026-01-25T08:57:21.6363449Z      Returns:
2026-01-25T08:57:21.6363907Z          tuple[str, bytes]: (хэш пароля, соль)
2026-01-25T08:57:21.6364680Z      """
2026-01-25T08:57:21.6364982Z      if salt is None:
2026-01-25T08:57:21.6365438Z          # Генерируем случайную соль
2026-01-25T08:57:21.6365915Z          salt = secrets.token_bytes(16)
2026-01-25T08:57:21.6366400Z -    
2026-01-25T08:57:21.6366670Z +
2026-01-25T08:57:21.6367101Z      # Конвертируем соль в hex для хранения в хэше
2026-01-25T08:57:21.6367636Z      salt_hex = salt.hex()
2026-01-25T08:57:21.6368008Z -    
2026-01-25T08:57:21.6368292Z +
2026-01-25T08:57:21.6368721Z      # Используем PBKDF2 хэширование с нашей солью
2026-01-25T08:57:21.6369185Z      import hashlib
2026-01-25T08:57:21.6369512Z      import hmac
2026-01-25T08:57:21.6369846Z -    
2026-01-25T08:57:21.6370135Z +
2026-01-25T08:57:21.6370491Z      # PBKDF2 хэширование
2026-01-25T08:57:21.6371066Z -    hashed = hashlib.pbkdf2_hmac('sha256', password.encode(), salt, 100000)
2026-01-25T08:57:21.6371917Z +    hashed = hashlib.pbkdf2_hmac("sha256", password.encode(), salt, 100000)
2026-01-25T08:57:21.6372583Z      hashed_hex = hashed.hex()
2026-01-25T08:57:21.6373151Z -    
2026-01-25T08:57:21.6373713Z -    return f'pbkdf2_sha256${salt_hex}${hashed_hex}', salt
2026-01-25T08:57:21.6374211Z +
2026-01-25T08:57:21.6374608Z +    return f"pbkdf2_sha256${salt_hex}${hashed_hex}", salt
2026-01-25T08:57:21.6375111Z  
2026-01-25T08:57:21.6375372Z  
2026-01-25T08:57:21.6375906Z  def verify_password(stored_password: str, provided_password: str, salt: bytes) -> bool:
2026-01-25T08:57:21.6376694Z      """Проверяет пароль.
2026-01-25T08:57:21.6377032Z -    
2026-01-25T08:57:21.6377323Z +
2026-01-25T08:57:21.6377595Z      Args:
2026-01-25T08:57:21.6378035Z          stored_password: Хэш из базы данных
2026-01-25T08:57:21.6378615Z          provided_password: Предоставленный пароль
2026-01-25T08:57:21.6379261Z          salt: Соль, которая использовалась при хэшировании
2026-01-25T08:57:21.6379722Z -    
2026-01-25T08:57:21.6380001Z +
2026-01-25T08:57:21.6380271Z      Returns:
2026-01-25T08:57:21.6380689Z          bool: True если пароль верный
2026-01-25T08:57:21.6381110Z      """
2026-01-25T08:57:21.6381412Z      try:
2026-01-25T08:57:21.6381708Z          import hashlib
2026-01-25T08:57:21.6382379Z          import hmac
2026-01-25T08:57:21.6382722Z -        
2026-01-25T08:57:21.6383273Z +
2026-01-25T08:57:21.6383667Z          # Разбираем сохраненный хэш
2026-01-25T08:57:21.6384173Z -        parts = stored_password.split('$')
2026-01-25T08:57:21.6384727Z -        if len(parts) != 3 or parts[0] != 'pbkdf2_sha256':
2026-01-25T08:57:21.6385304Z +        parts = stored_password.split("$")
2026-01-25T08:57:21.6385853Z +        if len(parts) != 3 or parts[0] != "pbkdf2_sha256":
2026-01-25T08:57:21.6386436Z              return False
2026-01-25T08:57:21.6386816Z -        
2026-01-25T08:57:21.6387134Z +
2026-01-25T08:57:21.6387475Z          stored_salt_hex = parts[1]
2026-01-25T08:57:21.6387905Z          stored_hash_hex = parts[2]
2026-01-25T08:57:21.6388298Z -        
2026-01-25T08:57:21.6388578Z +
2026-01-25T08:57:21.6389083Z          # Проверяем, что соль в хэше совпадает с переданной
2026-01-25T08:57:21.6389608Z          if salt.hex() != stored_salt_hex:
2026-01-25T08:57:21.6390048Z              return False
2026-01-25T08:57:21.6390435Z -        
2026-01-25T08:57:21.6390708Z +
2026-01-25T08:57:21.6391084Z          # Вычисляем хэш с той же солью
2026-01-25T08:57:21.6391778Z -        hashed = hashlib.pbkdf2_hmac('sha256', provided_password.encode(), salt, 100000)
2026-01-25T08:57:21.6392713Z +        hashed = hashlib.pbkdf2_hmac("sha256", provided_password.encode(), salt, 100000)
2026-01-25T08:57:21.6393626Z          computed_hash_hex = hashed.hex()
2026-01-25T08:57:21.6394088Z -        
2026-01-25T08:57:21.6394367Z +
2026-01-25T08:57:21.6394773Z          # Сравниваем хэши
2026-01-25T08:57:21.6395305Z          return hmac.compare_digest(computed_hash_hex, stored_hash_hex)
2026-01-25T08:57:21.6395926Z      except Exception:
2026-01-25T08:57:21.6396320Z          return False
2026-01-25T08:57:21.6396660Z  
2026-01-25T08:57:21.6396920Z  
2026-01-25T08:57:21.6397646Z  def generate_discriminator(db_conn, username: str) -> Optional[int]:
2026-01-25T08:57:21.6398252Z      """
2026-01-25T08:57:21.6398804Z      Генерирует уникальный случайный дискриминатор (тег) для пользователя.
2026-01-25T08:57:21.6399420Z -    
2026-01-25T08:57:21.6399732Z +
2026-01-25T08:57:21.6400243Z      Позволяет существовать нескольким пользователям с одинаковым именем,
2026-01-25T08:57:21.6400954Z      но разными тегами (например, User#0001 и User#0002).
2026-01-25T08:57:21.6401420Z      """
2026-01-25T08:57:21.6401978Z      # Получаем список всех занятых тегов для данного имени пользователя
2026-01-25T08:57:21.6402513Z      rows = db_conn.execute(
2026-01-25T08:57:21.6403262Z -        'SELECT discriminator FROM user WHERE username = ?', (username,)
2026-01-25T08:57:21.6404069Z +        "SELECT discriminator FROM user WHERE username = ?", (username,)
2026-01-25T08:57:21.6404656Z      ).fetchall()
2026-01-25T08:57:21.6404980Z  
2026-01-25T08:57:21.6405424Z -    taken_discriminators = {row['discriminator'] for row in rows}
2026-01-25T08:57:21.6406192Z +    taken_discriminators = {row["discriminator"] for row in rows}
2026-01-25T08:57:21.6406790Z  
2026-01-25T08:57:21.6407389Z      # Создаем множество всех возможных тегов (от 1 до 9999)
2026-01-25T08:57:21.6407980Z      all_possible = set(range(1, MAX_DISCRIMINATOR + 1))
2026-01-25T08:57:21.6408597Z      # Определяем, какие теги еще свободны
2026-01-25T08:57:21.6409150Z      available = list(all_possible - taken_discriminators)
2026-01-25T08:57:21.6409665Z @@ -102,14 +103,15 @@
2026-01-25T08:57:21.6410041Z      return secrets.choice(available)
2026-01-25T08:57:21.6410451Z  
2026-01-25T08:57:21.6410717Z  
2026-01-25T08:57:21.6411013Z  def login_required(view):
2026-01-25T08:57:21.6411640Z      """Декоратор для защиты маршрутов."""
2026-01-25T08:57:21.6412080Z +
2026-01-25T08:57:21.6412416Z      @functools.wraps(view)
2026-01-25T08:57:21.6412830Z      def wrapped_view(*args, **kwargs):
2026-01-25T08:57:21.6413529Z          if g.user is None:
2026-01-25T08:57:21.6414284Z -            flash('Для этого действия необходимо войти в систему.', 'warning')
2026-01-25T08:57:21.6414919Z -            return redirect(url_for('auth.login'))
2026-01-25T08:57:21.6415915Z +            flash("Для этого действия необходимо войти в систему.", "warning")
2026-01-25T08:57:21.6416525Z +            return redirect(url_for("auth.login"))
2026-01-25T08:57:21.6416981Z  
2026-01-25T08:57:21.6417312Z          return view(*args, **kwargs)
2026-01-25T08:57:21.6417721Z  
2026-01-25T08:57:21.6418029Z      return wrapped_view
2026-01-25T08:57:21.6545413Z --- /home/runner/work/flask_blog/flask_blog/app/forms/comment.py	2026-01-25 08:57:06.650994+00:00
2026-01-25T08:57:21.6548286Z +++ /home/runner/work/flask_blog/flask_blog/app/forms/comment.py	2026-01-25 08:57:21.653631+00:00
2026-01-25T08:57:21.6549035Z @@ -1,14 +1,17 @@
2026-01-25T08:57:21.6549715Z  """Формы для работы с комментариями."""
2026-01-25T08:57:21.6550188Z +
2026-01-25T08:57:21.6550654Z  from . import Form, TextAreaField, DataRequired, Length
2026-01-25T08:57:21.6551891Z  
2026-01-25T08:57:21.6552245Z  
2026-01-25T08:57:21.6552554Z  class CommentForm(Form):
2026-01-25T08:57:21.6553435Z      """Форма для добавления комментария к посту."""
2026-01-25T08:57:21.6553960Z -    
2026-01-25T08:57:21.6554297Z +
2026-01-25T08:57:21.6554618Z      content = TextAreaField(
2026-01-25T08:57:21.6555123Z -        'Комментарий',
2026-01-25T08:57:21.6555559Z +        "Комментарий",
2026-01-25T08:57:21.6555945Z          validators=[
2026-01-25T08:57:21.6556585Z -            DataRequired(message='Текст комментария обязателен'),
2026-01-25T08:57:21.6557569Z -            Length(min=3, max=1000, message='Комментарий должен быть от 3 до 1000 символов')
2026-01-25T08:57:21.6558280Z -        ]
2026-01-25T08:57:21.6558891Z +            DataRequired(message="Текст комментария обязателен"),
2026-01-25T08:57:21.6559440Z +            Length(
2026-01-25T08:57:21.6560157Z +                min=3, max=1000, message="Комментарий должен быть от 3 до 1000 символов"
2026-01-25T08:57:21.6560816Z +            ),
2026-01-25T08:57:21.6561165Z +        ],
2026-01-25T08:57:21.6561462Z      )
2026-01-25T08:57:21.6572231Z would reformat /home/runner/work/flask_blog/flask_blog/app/forms/comment.py
2026-01-25T08:57:21.6729126Z --- /home/runner/work/flask_blog/flask_blog/app/forms/auth.py	2026-01-25 08:57:06.650994+00:00
2026-01-25T08:57:21.6732011Z +++ /home/runner/work/flask_blog/flask_blog/app/forms/auth.py	2026-01-25 08:57:21.671568+00:00
2026-01-25T08:57:21.6732776Z @@ -1,53 +1,56 @@
2026-01-25T08:57:21.6733673Z  """Формы для аутентификации пользователей."""
2026-01-25T08:57:21.6734128Z +
2026-01-25T08:57:21.6734623Z  from . import Form, StringField, PasswordField, DataRequired, Length
2026-01-25T08:57:21.6735231Z +
2026-01-25T08:57:21.6735785Z  # TODO: Regexp будет реализован в будущем для валидации формата данных
2026-01-25T08:57:21.6736345Z  
2026-01-25T08:57:21.6736599Z  
2026-01-25T08:57:21.6736908Z  class RegistrationForm(Form):
2026-01-25T08:57:21.6737546Z      """Форма регистрации нового пользователя."""
2026-01-25T08:57:21.6737998Z -    
2026-01-25T08:57:21.6738281Z +
2026-01-25T08:57:21.6738619Z      username = StringField(
2026-01-25T08:57:21.6739661Z -        'Имя пользователя',
2026-01-25T08:57:21.6740166Z +        "Имя пользователя",
2026-01-25T08:57:21.6740640Z          validators=[
2026-01-25T08:57:21.6741241Z -            DataRequired(message='Имя пользователя обязательно'),
2026-01-25T08:57:21.6742205Z -            Length(min=3, max=20, message='Имя пользователя должно быть от 3 до 20 символов'),
2026-01-25T08:57:21.6743350Z +            DataRequired(message="Имя пользователя обязательно"),
2026-01-25T08:57:21.6743884Z +            Length(
2026-01-25T08:57:21.6744277Z +                min=3,
2026-01-25T08:57:21.6744621Z +                max=20,
2026-01-25T08:57:21.6745238Z +                message="Имя пользователя должно быть от 3 до 20 символов",
2026-01-25T08:57:21.6745764Z +            ),
2026-01-25T08:57:21.6746699Z              # TODO: Добавить Regexp(r'^[a-zA-Z0-9_]+$', message='Имя пользователя может содержать только буквы, цифры и подчёркивания')
2026-01-25T08:57:21.6747949Z              # TODO: Добавить Regexp(r'^(?!.*#).*$', message='Имя пользователя не должно содержать символ #')
2026-01-25T08:57:21.6748652Z -        ]
2026-01-25T08:57:21.6748929Z +        ],
2026-01-25T08:57:21.6749214Z      )
2026-01-25T08:57:21.6749490Z -    
2026-01-25T08:57:21.6749777Z +
2026-01-25T08:57:21.6750098Z      password = PasswordField(
2026-01-25T08:57:21.6750583Z -        'Пароль',
2026-01-25T08:57:21.6750952Z +        "Пароль",
2026-01-25T08:57:21.6751281Z          validators=[
2026-01-25T08:57:21.6751797Z -            DataRequired(message='Пароль обязателен'),
2026-01-25T08:57:21.6752607Z -            Length(min=4, max=128, message='Пароль должен быть от 4 до 128 символов')
2026-01-25T08:57:21.6753397Z -        ]
2026-01-25T08:57:21.6753906Z +            DataRequired(message="Пароль обязателен"),
2026-01-25T08:57:21.6754687Z +            Length(min=4, max=128, message="Пароль должен быть от 4 до 128 символов"),
2026-01-25T08:57:21.6755681Z +        ],
2026-01-25T08:57:21.6755981Z      )
2026-01-25T08:57:21.6756262Z  
2026-01-25T08:57:21.6756547Z  
2026-01-25T08:57:21.6756838Z  class LoginForm(Form):
2026-01-25T08:57:21.6757309Z      """Форма входа пользователя."""
2026-01-25T08:57:21.6757712Z -    
2026-01-25T08:57:21.6757996Z +
2026-01-25T08:57:21.6758321Z      username = StringField(
2026-01-25T08:57:21.6758796Z -        'Имя пользователя',
2026-01-25T08:57:21.6759259Z +        "Имя пользователя",
2026-01-25T08:57:21.6759628Z          validators=[
2026-01-25T08:57:21.6760191Z -            DataRequired(message='Имя пользователя обязательно'),
2026-01-25T08:57:21.6760974Z +            DataRequired(message="Имя пользователя обязательно"),
2026-01-25T08:57:21.6761843Z              # TODO: Добавить Regexp(r'^[a-zA-Z0-9_]+#\d{4}$', message='Формат: имя#0001')
2026-01-25T08:57:21.6762506Z -        ]
2026-01-25T08:57:21.6762852Z +        ],
2026-01-25T08:57:21.6763363Z      )
2026-01-25T08:57:21.6763638Z -    
2026-01-25T08:57:21.6763905Z +
2026-01-25T08:57:21.6764217Z      password = PasswordField(
2026-01-25T08:57:21.6764694Z -        'Пароль',
2026-01-25T08:57:21.6765045Z -        validators=[
2026-01-25T08:57:21.6765549Z -            DataRequired(message='Пароль обязателен')
2026-01-25T08:57:21.6766010Z -        ]
2026-01-25T08:57:21.6766534Z +        "Пароль", validators=[DataRequired(message="Пароль обязателен")]
2026-01-25T08:57:21.6767084Z      )
2026-01-25T08:57:21.6767358Z -    
2026-01-25T08:57:21.6767618Z +
2026-01-25T08:57:21.6767970Z      def __init__(self, formdata=None, **kwargs):
2026-01-25T08:57:21.6768532Z          super().__init__(formdata, **kwargs)
2026-01-25T08:57:21.6769251Z          # Если форма отправлена с login_username, используем его как username
2026-01-25T08:57:21.6769920Z -        if formdata and 'login_username' in formdata:
2026-01-25T08:57:21.6770515Z -            self.username.data = formdata['login_username']
2026-01-25T08:57:21.6771131Z +        if formdata and "login_username" in formdata:
2026-01-25T08:57:21.6771707Z +            self.username.data = formdata["login_username"]
2026-01-25T08:57:21.6772788Z          # Если форма отправлена с login_password, используем его как password
2026-01-25T08:57:21.6773606Z -        if formdata and 'login_password' in formdata:
2026-01-25T08:57:21.6774199Z -            self.password.data = formdata['login_password']
2026-01-25T08:57:21.6774810Z +        if formdata and "login_password" in formdata:
2026-01-25T08:57:21.6775439Z +            self.password.data = formdata["login_password"]
2026-01-25T08:57:21.6797341Z would reformat /home/runner/work/flask_blog/flask_blog/app/forms/auth.py
2026-01-25T08:57:21.6936488Z --- /home/runner/work/flask_blog/flask_blog/app/forms/csrf.py	2026-01-25 08:57:06.650994+00:00
2026-01-25T08:57:21.6937695Z +++ /home/runner/work/flask_blog/flask_blog/app/forms/csrf.py	2026-01-25 08:57:21.692519+00:00
2026-01-25T08:57:21.6938507Z @@ -15,22 +15,22 @@
2026-01-25T08:57:21.6939551Z  
2026-01-25T08:57:21.6939843Z      Returns:
2026-01-25T08:57:21.6942640Z          str: подписанный CSRF-токен (hex).
2026-01-25T08:57:21.6943377Z      """
2026-01-25T08:57:21.6943768Z      from flask import has_request_context
2026-01-25T08:57:21.6944273Z -    
2026-01-25T08:57:21.6944567Z +
2026-01-25T08:57:21.6945112Z      # Для тестов вне контекста запроса используем простую строку
2026-01-25T08:57:21.6945692Z      if not has_request_context():
2026-01-25T08:57:21.6946186Z -        return 'test_csrf_token_for_testing'
2026-01-25T08:57:21.6946640Z -    
2026-01-25T08:57:21.6947007Z -    if '_csrf_token' not in session:
2026-01-25T08:57:21.6947498Z +        return "test_csrf_token_for_testing"
2026-01-25T08:57:21.6947967Z +
2026-01-25T08:57:21.6948303Z +    if "_csrf_token" not in session:
2026-01-25T08:57:21.6949014Z          # Случайное значение на сессию
2026-01-25T08:57:21.6949543Z -        session['_csrf_token'] = os.urandom(32).hex()
2026-01-25T08:57:21.6950215Z +        session["_csrf_token"] = os.urandom(32).hex()
2026-01-25T08:57:21.6950748Z  
2026-01-25T08:57:21.6951308Z      # Создаем подпись токена, чтобы его нельзя было подделать вне сервера
2026-01-25T08:57:21.6951986Z -    key = current_app.config['SECRET_KEY'].encode()
2026-01-25T08:57:21.6952562Z -    token = session['_csrf_token'].encode()
2026-01-25T08:57:21.6953373Z +    key = current_app.config["SECRET_KEY"].encode()
2026-01-25T08:57:21.6953931Z +    token = session["_csrf_token"].encode()
2026-01-25T08:57:21.6954506Z      return hmac.new(key, token, hashlib.sha256).hexdigest()
2026-01-25T08:57:21.6955156Z  
2026-01-25T08:57:21.6955488Z  
2026-01-25T08:57:21.6955801Z  def validate_csrf_token(token):
2026-01-25T08:57:21.6956475Z      """Проверяет CSRF-токен на совпадение с ожидаемым.
2026-01-25T08:57:21.6956990Z @@ -40,16 +40,16 @@
2026-01-25T08:57:21.6957314Z  
2026-01-25T08:57:21.6957604Z      Returns:
2026-01-25T08:57:21.6958039Z          bool: True если токен валиден.
2026-01-25T08:57:21.6958473Z      """
2026-01-25T08:57:21.6958864Z      from flask import has_request_context
2026-01-25T08:57:21.6959304Z -    
2026-01-25T08:57:21.6959589Z +
2026-01-25T08:57:21.6960017Z      # Для тестов вне контекста запроса
2026-01-25T08:57:21.6960848Z      if not has_request_context():
2026-01-25T08:57:21.6961351Z -        return token == 'test_csrf_token_for_testing'
2026-01-25T08:57:21.6961834Z -    
2026-01-25T08:57:21.6962293Z -    if not token or '_csrf_token' not in session:
2026-01-25T08:57:21.6963115Z +        return token == "test_csrf_token_for_testing"
2026-01-25T08:57:21.6963619Z +
2026-01-25T08:57:21.6964019Z +    if not token or "_csrf_token" not in session:
2026-01-25T08:57:21.6964521Z          return False
2026-01-25T08:57:21.6964894Z  
2026-01-25T08:57:21.6965259Z      expected_token = generate_csrf_token()
2026-01-25T08:57:21.6965938Z      # compare_digest защищает от тайминговых атак
2026-01-25T08:57:21.6966544Z      return hmac.compare_digest(expected_token, token)
2026-01-25T08:57:21.6967313Z would reformat /home/runner/work/flask_blog/flask_blog/app/forms/csrf.py
2026-01-25T08:57:21.7303874Z --- /home/runner/work/flask_blog/flask_blog/app/forms/post.py	2026-01-25 08:57:06.651994+00:00
2026-01-25T08:57:21.7306521Z +++ /home/runner/work/flask_blog/flask_blog/app/forms/post.py	2026-01-25 08:57:21.729051+00:00
2026-01-25T08:57:21.7313547Z @@ -1,22 +1,29 @@
2026-01-25T08:57:21.7314985Z  """Формы для работы с постами блога."""
2026-01-25T08:57:21.7315411Z +
2026-01-25T08:57:21.7315819Z  from . import Form, StringField, TextAreaField, DataRequired, Length
2026-01-25T08:57:21.7316315Z  
2026-01-25T08:57:21.7316545Z  
2026-01-25T08:57:21.7316797Z  class PostForm(Form):
2026-01-25T08:57:21.7317221Z      """Форма для создания и редактирования поста."""
2026-01-25T08:57:21.7317613Z -    
2026-01-25T08:57:21.7317858Z +
2026-01-25T08:57:21.7318093Z      title = StringField(
2026-01-25T08:57:21.7318477Z -        'Заголовок',
2026-01-25T08:57:21.7318842Z +        "Заголовок",
2026-01-25T08:57:21.7319156Z          validators=[
2026-01-25T08:57:21.7320258Z -            DataRequired(message='Заголовок обязателен'),
2026-01-25T08:57:21.7321014Z -            Length(min=1, max=200, message='Заголовок должен быть от 1 до 200 символов')
2026-01-25T08:57:21.7321612Z -        ]
2026-01-25T08:57:21.7322057Z +            DataRequired(message="Заголовок обязателен"),
2026-01-25T08:57:21.7322535Z +            Length(
2026-01-25T08:57:21.7323315Z +                min=1, max=200, message="Заголовок должен быть от 1 до 200 символов"
2026-01-25T08:57:21.7323866Z +            ),
2026-01-25T08:57:21.7324175Z +        ],
2026-01-25T08:57:21.7324460Z      )
2026-01-25T08:57:21.7324737Z -    
2026-01-25T08:57:21.7325013Z +
2026-01-25T08:57:21.7325307Z      content = TextAreaField(
2026-01-25T08:57:21.7325774Z -        'Содержание',
2026-01-25T08:57:21.7326154Z +        "Содержание",
2026-01-25T08:57:21.7326487Z          validators=[
2026-01-25T08:57:21.7327002Z -            DataRequired(message='Содержание обязательно'),
2026-01-25T08:57:21.7327855Z -            Length(min=10, max=5000, message='Содержание должно быть от 10 до 5000 символов')
2026-01-25T08:57:21.7328529Z -        ]
2026-01-25T08:57:21.7329021Z +            DataRequired(message="Содержание обязательно"),
2026-01-25T08:57:21.7329538Z +            Length(
2026-01-25T08:57:21.7329849Z +                min=10,
2026-01-25T08:57:21.7330197Z +                max=5000,
2026-01-25T08:57:21.7330763Z +                message="Содержание должно быть от 10 до 5000 символов",
2026-01-25T08:57:21.7331281Z +            ),
2026-01-25T08:57:21.7331585Z +        ],
2026-01-25T08:57:21.7331866Z      )
2026-01-25T08:57:21.7332365Z would reformat /home/runner/work/flask_blog/flask_blog/app/forms/post.py
2026-01-25T08:57:21.7353492Z --- /home/runner/work/flask_blog/flask_blog/app/forms/base.py	2026-01-25 08:57:06.650994+00:00
2026-01-25T08:57:21.7366372Z would reformat /home/runner/work/flask_blog/flask_blog/app/forms/base.py
2026-01-25T08:57:21.7367308Z +++ /home/runner/work/flask_blog/flask_blog/app/forms/base.py	2026-01-25 08:57:21.733372+00:00
2026-01-25T08:57:21.7368114Z @@ -35,11 +35,11 @@
2026-01-25T08:57:21.7368537Z                  setattr(self, name, instance_field)
2026-01-25T08:57:21.7369485Z                  self._fields[name] = instance_field
2026-01-25T08:57:21.7369882Z  
2026-01-25T08:57:21.7370534Z          # Автоматическое получение данных из запроса Flask, если form_data не передали явно.
2026-01-25T08:57:21.7371155Z          if form_data is None and has_request_context():
2026-01-25T08:57:21.7371710Z -            if request.method in ('POST', 'PUT', 'PATCH'):
2026-01-25T08:57:21.7372276Z +            if request.method in ("POST", "PUT", "PATCH"):
2026-01-25T08:57:21.7372800Z                  form_data = request.form
2026-01-25T08:57:21.7373544Z  
2026-01-25T08:57:21.7373913Z          # Заполнение полей данными
2026-01-25T08:57:21.7374329Z          if form_data is not None:
2026-01-25T08:57:21.7374755Z              self.process(form_data)
2026-01-25T08:57:21.7375167Z @@ -47,47 +47,47 @@
2026-01-25T08:57:21.7375540Z      def process(self, form_data):
2026-01-25T08:57:21.7376168Z          """Заполняет поля формы данными из form_data (dict/MultiDict)."""
2026-01-25T08:57:21.7376872Z          # Заполняем данные для каждого зарегистрированного поля
2026-01-25T08:57:21.7377423Z          for name, field in self._fields.items():
2026-01-25T08:57:21.7378111Z              # Работаем как с MultiDict (Flask), так и с обычным dict
2026-01-25T08:57:21.7378673Z -            if hasattr(form_data, 'get'):
2026-01-25T08:57:21.7379146Z +            if hasattr(form_data, "get"):
2026-01-25T08:57:21.7379637Z                  field.data = form_data.get(name)
2026-01-25T08:57:21.7380091Z  
2026-01-25T08:57:21.7380494Z          # Извлекаем CSRF токен для валидации
2026-01-25T08:57:21.7381120Z -        self._csrf_token_data = getattr(form_data, 'get', lambda k: None)('csrf_token')
2026-01-25T08:57:21.7381979Z +        self._csrf_token_data = getattr(form_data, "get", lambda k: None)("csrf_token")
2026-01-25T08:57:21.7382583Z  
2026-01-25T08:57:21.7383489Z      def validate(self):
2026-01-25T08:57:21.7384091Z          """Валидирует форму: CSRF + валидаторы каждого поля.
2026-01-25T08:57:21.7384571Z  
2026-01-25T08:57:21.7384898Z          Returns:
2026-01-25T08:57:21.7385497Z              bool: True если форма валидна, иначе False (ошибки в self.errors).
2026-01-25T08:57:21.7386036Z          """
2026-01-25T08:57:21.7386384Z          from flask import current_app
2026-01-25T08:57:21.7386802Z -        
2026-01-25T08:57:21.7387104Z +
2026-01-25T08:57:21.7387411Z          self._csrf_error = None
2026-01-25T08:57:21.7387805Z          is_valid = True
2026-01-25T08:57:21.7388153Z  
2026-01-25T08:57:21.7388621Z          # В TESTING режиме отключаем CSRF для конкретных тестов
2026-01-25T08:57:21.7389136Z          if current_app.testing:
2026-01-25T08:57:21.7389793Z              # Если WTF_CSRF_ENABLED выключен, пропускаем CSRF проверку
2026-01-25T08:57:21.7390488Z -            if not current_app.config.get('WTF_CSRF_ENABLED', True):
2026-01-25T08:57:21.7391175Z +            if not current_app.config.get("WTF_CSRF_ENABLED", True):
2026-01-25T08:57:21.7391932Z                  return True  # CSRF отключен, считаем валидацию успешной
2026-01-25T08:57:21.7392463Z -            
2026-01-25T08:57:21.7392735Z +
2026-01-25T08:57:21.7393372Z              # Специальный тестовый токен всегда принимается
2026-01-25T08:57:21.7393979Z -            if self._csrf_token_data == 'test_csrf_token_for_testing':
2026-01-25T08:57:21.7394619Z +            if self._csrf_token_data == "test_csrf_token_for_testing":
2026-01-25T08:57:21.7395335Z                  return True  # Тестовый токен для обычных тестов
2026-01-25T08:57:21.7395798Z -            
2026-01-25T08:57:21.7396098Z +
2026-01-25T08:57:21.7396564Z              # Для тестов безопасности принимаем только валидные токены
2026-01-25T08:57:21.7397247Z              # Проверяем, что это не очевидно тестовый токен безопасности
2026-01-25T08:57:21.7397885Z -            if self._csrf_token_data not in ['wrong_token', 'invalid_token', '']:
2026-01-25T08:57:21.7398715Z +            if self._csrf_token_data not in ["wrong_token", "invalid_token", ""]:
2026-01-25T08:57:21.7399498Z                  # Для всех остальных токенов в тестах, включая правильные,
2026-01-25T08:57:21.7400454Z                  # используем нормальную валидацию CSRF
2026-01-25T08:57:21.7401059Z                  pass  # Продолжаем к обычной валидации ниже
2026-01-25T08:57:21.7401477Z              else:
2026-01-25T08:57:21.7401786Z                  # Явно неверные токены должны провалить валидацию
2026-01-25T08:57:21.7402185Z                  pass  # Продолжаем к обычной валидации, которая провалится
2026-01-25T08:57:21.7402479Z -        
2026-01-25T08:57:21.7402638Z +
2026-01-25T08:57:21.7403153Z          # В обычном режиме или в тестах с CSRF, проверяем токен
2026-01-25T08:57:21.7403752Z          if not validate_csrf_token(self._csrf_token_data):
2026-01-25T08:57:21.7404565Z              self._csrf_error = "Неверный или отсутствующий CSRF-токен."
2026-01-25T08:57:21.7405437Z              is_valid = False
2026-01-25T08:57:21.7405845Z  
2026-01-25T08:57:21.7406141Z @@ -109,11 +109,11 @@
2026-01-25T08:57:21.7406503Z          Returns:
2026-01-25T08:57:21.7407049Z              dict[str, list[str]]: ошибки по полям.
2026-01-25T08:57:21.7407494Z          """
2026-01-25T08:57:21.7407791Z          all_errors = {}
2026-01-25T08:57:21.7408153Z          if self._csrf_error:
2026-01-25T08:57:21.7408614Z -            all_errors['csrf'] = [self._csrf_error]
2026-01-25T08:57:21.7409147Z +            all_errors["csrf"] = [self._csrf_error]
2026-01-25T08:57:21.7409586Z  
2026-01-25T08:57:21.7409916Z          for name, field in self._fields.items():
2026-01-25T08:57:21.7411890Z              if field.errors:
2026-01-25T08:57:21.7412421Z                  all_errors[name] = field.errors
2026-01-25T08:57:21.7413166Z          return all_errors
2026-01-25T08:57:21.7413826Z would reformat /home/runner/work/flask_blog/flask_blog/app/forms/fields.py
2026-01-25T08:57:21.7414794Z --- /home/runner/work/flask_blog/flask_blog/app/forms/fields.py	2026-01-25 08:57:06.651994+00:00
2026-01-25T08:57:21.7415818Z +++ /home/runner/work/flask_blog/flask_blog/app/forms/fields.py	2026-01-25 08:57:21.737391+00:00
2026-01-25T08:57:21.7416508Z @@ -63,16 +63,19 @@
2026-01-25T08:57:21.7416833Z          return is_valid
2026-01-25T08:57:21.7417177Z  
2026-01-25T08:57:21.7417437Z  
2026-01-25T08:57:21.7417703Z  class StringField(Field):
2026-01-25T08:57:21.7418376Z      """Текстовое поле (пока без специфики, тип нужен для читабельности/расширения)."""
2026-01-25T08:57:21.7418885Z +
2026-01-25T08:57:21.7419142Z      pass
2026-01-25T08:57:21.7419429Z  
2026-01-25T08:57:21.7419693Z  
2026-01-25T08:57:21.7420003Z  class PasswordField(Field):
2026-01-25T08:57:21.7420689Z      """Поле пароля (тип нужен для семантики; отображение контролируется шаблоном)."""
2026-01-25T08:57:21.7421241Z +
2026-01-25T08:57:21.7421519Z      pass
2026-01-25T08:57:21.7421804Z  
2026-01-25T08:57:21.7422056Z  
2026-01-25T08:57:21.7422373Z  class TextAreaField(Field):
2026-01-25T08:57:21.7423150Z      """Многострочное текстовое поле."""
2026-01-25T08:57:21.7423591Z +
2026-01-25T08:57:21.7423872Z      pass
2026-01-25T08:57:21.7484275Z --- /home/runner/work/flask_blog/flask_blog/app/main/__init__.py	2026-01-25 08:57:06.651994+00:00
2026-01-25T08:57:21.7489672Z +++ /home/runner/work/flask_blog/flask_blog/app/main/__init__.py	2026-01-25 08:57:21.747312+00:00
2026-01-25T08:57:21.7490904Z @@ -1,7 +1,7 @@
2026-01-25T08:57:21.7493940Z  """Blueprint главных маршрутов."""
2026-01-25T08:57:21.7494405Z  
2026-01-25T08:57:21.7494727Z  from flask import Blueprint
2026-01-25T08:57:21.7495105Z  
2026-01-25T08:57:21.7495491Z -bp = Blueprint('main', __name__)
2026-01-25T08:57:21.7495951Z +bp = Blueprint("main", __name__)
2026-01-25T08:57:21.7496333Z  
2026-01-25T08:57:21.7496656Z  from app.main import routes  # noqa
2026-01-25T08:57:21.7506097Z would reformat /home/runner/work/flask_blog/flask_blog/app/main/__init__.py
2026-01-25T08:57:21.7582830Z --- /home/runner/work/flask_blog/flask_blog/app/models/__init__.py	2026-01-25 08:57:06.651994+00:00
2026-01-25T08:57:21.7588588Z +++ /home/runner/work/flask_blog/flask_blog/app/models/__init__.py	2026-01-25 08:57:21.757523+00:00
2026-01-25T08:57:21.7592059Z @@ -1,5 +1,6 @@
2026-01-25T08:57:21.7594061Z  """Модели данных приложения."""
2026-01-25T08:57:21.7594886Z +
2026-01-25T08:57:21.7595193Z  from .post import Post
2026-01-25T08:57:21.7595588Z  from .comment import Comment
2026-01-25T08:57:21.7595957Z  
2026-01-25T08:57:21.7596268Z -__all__ = ['Post', 'Comment']
2026-01-25T08:57:21.7596669Z +__all__ = ["Post", "Comment"]
2026-01-25T08:57:21.7601746Z would reformat /home/runner/work/flask_blog/flask_blog/app/models/__init__.py
2026-01-25T08:57:21.8027267Z --- /home/runner/work/flask_blog/flask_blog/app/forms/validators.py	2026-01-25 08:57:06.651994+00:00
2026-01-25T08:57:21.8034042Z +++ /home/runner/work/flask_blog/flask_blog/app/forms/validators.py	2026-01-25 08:57:21.800192+00:00
2026-01-25T08:57:21.8035192Z would reformat /home/runner/work/flask_blog/flask_blog/app/forms/validators.py
2026-01-25T08:57:21.8036572Z @@ -2,19 +2,20 @@
2026-01-25T08:57:21.8037015Z  # ==============================================================================
2026-01-25T08:57:21.8037967Z  # Временные заглушки валидаторов для будущего развития
2026-01-25T08:57:21.8038887Z  # Все валидации кроме CSRF отключены и заменены заглушками
2026-01-25T08:57:21.8039596Z  # ==============================================================================
2026-01-25T08:57:21.8040153Z  
2026-01-25T08:57:21.8040498Z +
2026-01-25T08:57:21.8040804Z  class Validator:
2026-01-25T08:57:21.8041373Z      """Базовый класс валидатора.
2026-01-25T08:57:21.8041771Z -    
2026-01-25T08:57:21.8042442Z +
2026-01-25T08:57:21.8043072Z      TODO: Реализовать полную систему валидации
2026-01-25T08:57:21.8043653Z      - Базовая логика валидации
2026-01-25T08:57:21.8044113Z      - Обработка ошибок
2026-01-25T08:57:21.8044556Z      - Сообщения об ошибках
2026-01-25T08:57:21.8044917Z      """
2026-01-25T08:57:21.8045225Z -    
2026-01-25T08:57:21.8045498Z +
2026-01-25T08:57:21.8045835Z      def __init__(self, message=None):
2026-01-25T08:57:21.8046278Z          self.message = message
2026-01-25T08:57:21.8046686Z  
2026-01-25T08:57:21.8047025Z      def __call__(self, value):
2026-01-25T08:57:21.8047546Z          # TODO: Реализовать логику валидации
2026-01-25T08:57:21.8048131Z @@ -22,93 +23,104 @@
2026-01-25T08:57:21.8065203Z  
2026-01-25T08:57:21.8073474Z  
2026-01-25T08:57:21.8074433Z  # TODO: Заглушки вместо реальных валидаторов
2026-01-25T08:57:21.8075118Z  # Все валидации кроме CSRF отключены для будущего развития
2026-01-25T08:57:21.8075602Z  
2026-01-25T08:57:21.8076067Z +
2026-01-25T08:57:21.8076475Z  class DataRequired(Validator):
2026-01-25T08:57:21.8077019Z      """TODO: Проверка обязательного поля.
2026-01-25T08:57:21.8077447Z -    
2026-01-25T08:57:21.8077920Z +
2026-01-25T08:57:21.8078515Z      ЗАГЛУШКА: Всегда возвращает True для будущего развития
2026-01-25T08:57:21.8078989Z      """
2026-01-25T08:57:21.8079291Z +
2026-01-25T08:57:21.8079631Z      def __call__(self, value):
2026-01-25T08:57:21.8080010Z          return True, None
2026-01-25T08:57:21.8080391Z  
2026-01-25T08:57:21.8081002Z  
2026-01-25T08:57:21.8081290Z  class Length(Validator):
2026-01-25T08:57:21.8081807Z      """TODO: Проверка длины значения.
2026-01-25T08:57:21.8082246Z -    
2026-01-25T08:57:21.8082514Z +
2026-01-25T08:57:21.8083166Z      ЗАГЛУШКА: Всегда возвращает True для будущего развития
2026-01-25T08:57:21.8083652Z      """
2026-01-25T08:57:21.8083953Z +
2026-01-25T08:57:21.8084343Z      def __init__(self, min=-1, max=-1, message=None):
2026-01-25T08:57:21.8085551Z          super().__init__(message)
2026-01-25T08:57:21.8086042Z          self.min = min
2026-01-25T08:57:21.8086401Z          self.max = max
2026-01-25T08:57:21.8086739Z -    
2026-01-25T08:57:21.8087018Z +
2026-01-25T08:57:21.8087334Z      def __call__(self, value):
2026-01-25T08:57:21.8087736Z          return True, None
2026-01-25T08:57:21.8088090Z  
2026-01-25T08:57:21.8088625Z  
2026-01-25T08:57:21.8088915Z  class EqualTo(Validator):
2026-01-25T08:57:21.8089422Z      """TODO: Проверка совпадения полей.
2026-01-25T08:57:21.8089854Z -    
2026-01-25T08:57:21.8090199Z +
2026-01-25T08:57:21.8090658Z      ЗАГЛУШКА: Всегда возвращает True для будущего развития
2026-01-25T08:57:21.8091138Z      """
2026-01-25T08:57:21.8091412Z +
2026-01-25T08:57:21.8091953Z      def __init__(self, field_name, message="Поля должны совпадать"):
2026-01-25T08:57:21.8092556Z          super().__init__(message)
2026-01-25T08:57:21.8093176Z          self.field_name = field_name
2026-01-25T08:57:21.8093581Z -    
2026-01-25T08:57:21.8093866Z +
2026-01-25T08:57:21.8094177Z      def __call__(self, value, form=None):
2026-01-25T08:57:21.8094619Z          return True, None
2026-01-25T08:57:21.8094967Z  
2026-01-25T08:57:21.8095230Z  
2026-01-25T08:57:21.8095637Z  # TODO: Заглушки для будущих валидаторов
2026-01-25T08:57:21.8096072Z  class Email(Validator):
2026-01-25T08:57:21.8096551Z      """TODO: Валидация email адреса."""
2026-01-25T08:57:21.8096996Z +
2026-01-25T08:57:21.8097286Z      def __call__(self, value):
2026-01-25T08:57:21.8097683Z          return True, None
2026-01-25T08:57:21.8098055Z  
2026-01-25T08:57:21.8098315Z  
2026-01-25T08:57:21.8098615Z  class Username(Validator):
2026-01-25T08:57:21.8099127Z      """TODO: Валидация имени пользователя."""
2026-01-25T08:57:21.8099553Z +
2026-01-25T08:57:21.8099892Z      def __call__(self, value):
2026-01-25T08:57:21.8100304Z          return True, None
2026-01-25T08:57:21.8100652Z  
2026-01-25T08:57:21.8100914Z  
2026-01-25T08:57:21.8101263Z  class PasswordStrength(Validator):
2026-01-25T08:57:21.8101820Z      """TODO: Проверка сложности пароля."""
2026-01-25T08:57:21.8102236Z +
2026-01-25T08:57:21.8102535Z      def __call__(self, value):
2026-01-25T08:57:21.8103120Z          return True, None
2026-01-25T08:57:21.8103471Z  
2026-01-25T08:57:21.8103733Z  
2026-01-25T08:57:21.8104062Z  class UniqueUsername(Validator):
2026-01-25T08:57:21.8104712Z      """TODO: Проверка уникальности имени пользователя."""
2026-01-25T08:57:21.8105192Z +
2026-01-25T08:57:21.8105522Z      def __call__(self, value, form=None):
2026-01-25T08:57:21.8106259Z          return True, None
2026-01-25T08:57:21.8106614Z  
2026-01-25T08:57:21.8106883Z  
2026-01-25T08:57:21.8107165Z  class Slug(Validator):
2026-01-25T08:57:21.8107662Z      """TODO: Валидация slug для URL."""
2026-01-25T08:57:21.8108076Z +
2026-01-25T08:57:21.8108359Z      def __call__(self, value):
2026-01-25T08:57:21.8108760Z          return True, None
2026-01-25T08:57:21.8109128Z  
2026-01-25T08:57:21.8109381Z  
2026-01-25T08:57:21.8109685Z  class NumberRange(Validator):
2026-01-25T08:57:21.8110204Z      """TODO: Проверка числового диапазона."""
2026-01-25T08:57:21.8110628Z +
2026-01-25T08:57:21.8110915Z      def __call__(self, value):
2026-01-25T08:57:21.8111307Z          return True, None
2026-01-25T08:57:21.8111657Z  
2026-01-25T08:57:21.8111901Z  
2026-01-25T08:57:21.8112265Z  class URL(Validator):
2026-01-25T08:57:21.8112772Z      """TODO: Валидация URL."""
2026-01-25T08:57:21.8113299Z +
2026-01-25T08:57:21.8113601Z      def __call__(self, value):
2026-01-25T08:57:21.8114006Z          return True, None
2026-01-25T08:57:21.8114368Z  
2026-01-25T08:57:21.8114628Z  
2026-01-25T08:57:21.8115001Z  # TODO: Реализовать в будущем
2026-01-25T08:57:21.8115410Z  # class Regexp(Validator):
2026-01-25T08:57:21.8115909Z  #     """TODO: Проверка регулярным выражением.
2026-01-25T08:57:21.8116351Z -#     
2026-01-25T08:57:21.8116641Z +#
2026-01-25T08:57:21.8117082Z  #     Будущая реализация:
2026-01-25T08:57:21.8117573Z  #     - Самописная регулярная валидация
2026-01-25T08:57:21.8118067Z  #     - Валидация форматов данных
2026-01-25T08:57:21.8118541Z  #     - Кэширование компиляции
2026-01-25T08:57:21.8118903Z  #     """
2026-01-25T08:57:21.8350294Z --- /home/runner/work/flask_blog/flask_blog/app/models/comment.py	2026-01-25 08:57:06.651994+00:00
2026-01-25T08:57:21.8351454Z +++ /home/runner/work/flask_blog/flask_blog/app/models/comment.py	2026-01-25 08:57:21.833409+00:00
2026-01-25T08:57:21.8352674Z @@ -1,84 +1,85 @@
2026-01-25T08:57:21.8353524Z  """Модель комментария к посту блога."""
2026-01-25T08:57:21.8354869Z +
2026-01-25T08:57:21.8355822Z  from datetime import datetime
2026-01-25T08:57:21.8356772Z  from typing import Optional, Dict, Any
2026-01-25T08:57:21.8357657Z  
2026-01-25T08:57:21.8358567Z  
2026-01-25T08:57:21.8359705Z  class Comment:
2026-01-25T08:57:21.8370958Z would reformat /home/runner/work/flask_blog/flask_blog/app/models/comment.py
2026-01-25T08:57:21.8371834Z      """Модель комментария к посту блога.
2026-01-25T08:57:21.8372755Z -    
2026-01-25T08:57:21.8373386Z +
2026-01-25T08:57:21.8374068Z      Содержит только данные и базовую бизнес-логику.
2026-01-25T08:57:21.8374891Z      Вся логика работы с БД вынесена в CommentService.
2026-01-25T08:57:21.8375500Z      """
2026-01-25T08:57:21.8375938Z -    
2026-01-25T08:57:21.8376353Z +
2026-01-25T08:57:21.8376785Z      def __init__(
2026-01-25T08:57:21.8377245Z          self,
2026-01-25T08:57:21.8377817Z          id: Optional[int] = None,
2026-01-25T08:57:21.8378453Z          author_id: Optional[int] = None,
2026-01-25T08:57:21.8379074Z          post_id: Optional[int] = None,
2026-01-25T08:57:21.8379743Z -        content: str = '',
2026-01-25T08:57:21.8380315Z +        content: str = "",
2026-01-25T08:57:21.8380868Z          created: Optional[datetime] = None,
2026-01-25T08:57:21.8381477Z -        author_username: str = '',
2026-01-25T08:57:21.8382092Z -        author_discriminator: int = 0
2026-01-25T08:57:21.8382732Z +        author_username: str = "",
2026-01-25T08:57:21.8383562Z +        author_discriminator: int = 0,
2026-01-25T08:57:21.8384127Z      ):
2026-01-25T08:57:21.8384557Z          self.id = id
2026-01-25T08:57:21.8385076Z          self.author_id = author_id
2026-01-25T08:57:21.8385639Z          self.post_id = post_id
2026-01-25T08:57:21.8386211Z          self.content = content
2026-01-25T08:57:21.8386769Z          self.created = created
2026-01-25T08:57:21.8387500Z          self.author_username = author_username
2026-01-25T08:57:21.8388209Z          self.author_discriminator = author_discriminator
2026-01-25T08:57:21.8388850Z -    
2026-01-25T08:57:21.8389663Z +
2026-01-25T08:57:21.8390076Z      @property
2026-01-25T08:57:21.8390593Z      def author_display_name(self) -> str:
2026-01-25T08:57:21.8391456Z          """Возвращает отображаемое имя автора с дискриминатором."""
2026-01-25T08:57:21.8392342Z          return f"{self.author_username}#{self.author_discriminator:04d}"
2026-01-25T08:57:21.8393280Z -    
2026-01-25T08:57:21.8393735Z +
2026-01-25T08:57:21.8395208Z      def is_author(self, user_id: int) -> bool:
2026-01-25T08:57:21.8396159Z          """Проверяет, является ли пользователь автором комментария.
2026-01-25T08:57:21.8397492Z -        
2026-01-25T08:57:21.8398007Z +
2026-01-25T08:57:21.8398417Z          Args:
2026-01-25T08:57:21.8400155Z              user_id: ID пользователя
2026-01-25T08:57:21.8402156Z -            
2026-01-25T08:57:21.8402492Z +
2026-01-25T08:57:21.8402747Z          Returns:
2026-01-25T08:57:21.8403475Z              bool: True если пользователь автор комментария
2026-01-25T08:57:21.8403949Z          """
2026-01-25T08:57:21.8404317Z          return self.author_id == user_id
2026-01-25T08:57:21.8404772Z -    
2026-01-25T08:57:21.8405058Z +
2026-01-25T08:57:21.8405412Z      def to_dict(self) -> Dict[str, Any]:
2026-01-25T08:57:21.8406084Z          """Преобразует комментарий в словарь для шаблонов.
2026-01-25T08:57:21.8406591Z -        
2026-01-25T08:57:21.8406929Z +
2026-01-25T08:57:21.8407204Z          Returns:
2026-01-25T08:57:21.8407747Z              Dict[str, Any]: словарь с данными комментария
2026-01-25T08:57:21.8408243Z          """
2026-01-25T08:57:21.8408551Z          return {
2026-01-25T08:57:21.8408899Z -            'id': self.id,
2026-01-25T08:57:21.8409322Z -            'author_id': self.author_id,
2026-01-25T08:57:21.8409801Z -            'post_id': self.post_id,
2026-01-25T08:57:21.8410256Z -            'content': self.content,
2026-01-25T08:57:21.8411130Z -            'created': self.created,
2026-01-25T08:57:21.8411641Z -            'author_username': self.author_username,
2026-01-25T08:57:21.8412361Z -            'author_discriminator': self.author_discriminator,
2026-01-25T08:57:21.8413195Z -            'author_display_name': self.author_display_name
2026-01-25T08:57:21.8413756Z +            "id": self.id,
2026-01-25T08:57:21.8414165Z +            "author_id": self.author_id,
2026-01-25T08:57:21.8414645Z +            "post_id": self.post_id,
2026-01-25T08:57:21.8415101Z +            "content": self.content,
2026-01-25T08:57:21.8415562Z +            "created": self.created,
2026-01-25T08:57:21.8416062Z +            "author_username": self.author_username,
2026-01-25T08:57:21.8416662Z +            "author_discriminator": self.author_discriminator,
2026-01-25T08:57:21.8417301Z +            "author_display_name": self.author_display_name,
2026-01-25T08:57:21.8417809Z          }
2026-01-25T08:57:21.8418110Z -    
2026-01-25T08:57:21.8418407Z +
2026-01-25T08:57:21.8418683Z      @classmethod
2026-01-25T08:57:21.8419127Z -    def from_dict(cls, data: Dict[str, Any]) -> 'Comment':
2026-01-25T08:57:21.8419779Z +    def from_dict(cls, data: Dict[str, Any]) -> "Comment":
2026-01-25T08:57:21.8420496Z          """Создаёт экземпляр Comment из словаря.
2026-01-25T08:57:21.8420964Z -        
2026-01-25T08:57:21.8421273Z +
2026-01-25T08:57:21.8421548Z          Args:
2026-01-25T08:57:21.8422027Z              data: Словарь с данными комментария
2026-01-25T08:57:21.8422483Z -            
2026-01-25T08:57:21.8422793Z +
2026-01-25T08:57:21.8423295Z          Returns:
2026-01-25T08:57:21.8423809Z              Comment: созданный экземпляр
2026-01-25T08:57:21.8424250Z          """
2026-01-25T08:57:21.8424573Z          return cls(**data)
2026-01-25T08:57:21.8424962Z -    
2026-01-25T08:57:21.8425250Z +
2026-01-25T08:57:21.8425557Z      def __repr__(self) -> str:
2026-01-25T08:57:21.8426133Z          """Строковое представление для отладки."""
2026-01-25T08:57:21.8426923Z          return f"<Comment(id={self.id}, post_id={self.post_id}, author_id={self.author_id})>"
2026-01-25T08:57:21.8427665Z -    
2026-01-25T08:57:21.8428050Z +
2026-01-25T08:57:21.8428734Z      def __eq__(self, other) -> bool:
2026-01-25T08:57:21.8429318Z          """Сравнение комментариев по ID."""
2026-01-25T08:57:21.8429841Z          if not isinstance(other, Comment):
2026-01-25T08:57:21.8430373Z              return False
2026-01-25T08:57:21.8430777Z          return self.id == other.id
2026-01-25T08:57:21.8494294Z would reformat /home/runner/work/flask_blog/flask_blog/app/services/__init__.py
2026-01-25T08:57:21.8495489Z --- /home/runner/work/flask_blog/flask_blog/app/services/__init__.py	2026-01-25 08:57:06.651994+00:00
2026-01-25T08:57:21.8496880Z +++ /home/runner/work/flask_blog/flask_blog/app/services/__init__.py	2026-01-25 08:57:21.846959+00:00
2026-01-25T08:57:21.8497720Z @@ -1,5 +1,6 @@
2026-01-25T08:57:21.8498336Z  """Сервисный слой приложения."""
2026-01-25T08:57:21.8498939Z +
2026-01-25T08:57:21.8515069Z  from .post_service import PostService
2026-01-25T08:57:21.8515706Z  from .comment_service import CommentService
2026-01-25T08:57:21.8516210Z  
2026-01-25T08:57:21.8516596Z -__all__ = ['PostService', 'CommentService']
2026-01-25T08:57:21.8517141Z +__all__ = ["PostService", "CommentService"]
2026-01-25T08:57:21.8544049Z would reformat /home/runner/work/flask_blog/flask_blog/app/auth/routes.py
2026-01-25T08:57:21.8545108Z --- /home/runner/work/flask_blog/flask_blog/app/auth/routes.py	2026-01-25 08:57:06.650994+00:00
2026-01-25T08:57:21.8547093Z +++ /home/runner/work/flask_blog/flask_blog/app/auth/routes.py	2026-01-25 08:57:21.844579+00:00
2026-01-25T08:57:21.8548175Z @@ -15,263 +15,276 @@
2026-01-25T08:57:21.8548732Z  """
2026-01-25T08:57:21.8549223Z  
2026-01-25T08:57:21.8549755Z  import sqlite3
2026-01-25T08:57:21.8550339Z  from typing import Optional, Tuple
2026-01-25T08:57:21.8550981Z  
2026-01-25T08:57:21.8551895Z -from flask import flash, g, redirect, render_template, request, session, url_for, current_app, make_response
2026-01-25T08:57:21.8553697Z +from flask import (
2026-01-25T08:57:21.8554266Z +    flash,
2026-01-25T08:57:21.8554766Z +    g,
2026-01-25T08:57:21.8555278Z +    redirect,
2026-01-25T08:57:21.8555862Z +    render_template,
2026-01-25T08:57:21.8556445Z +    request,
2026-01-25T08:57:21.8556969Z +    session,
2026-01-25T08:57:21.8557469Z +    url_for,
2026-01-25T08:57:21.8558029Z +    current_app,
2026-01-25T08:57:21.8558557Z +    make_response,
2026-01-25T08:57:21.8559141Z +)
2026-01-25T08:57:21.8559623Z  
2026-01-25T08:57:21.8560138Z  from app.auth import bp
2026-01-25T08:57:21.8561084Z  from app.auth.utils import generate_discriminator, hash_password, verify_password
2026-01-25T08:57:21.8562110Z  from app.db import get_db
2026-01-25T08:57:21.8562807Z  from app.forms import RegistrationForm, LoginForm
2026-01-25T08:57:21.8563811Z  
2026-01-25T08:57:21.8564696Z  # Константы для управления cookie
2026-01-25T08:57:21.8565391Z  COOKIE_DAYS = 30
2026-01-25T08:57:21.8565955Z  COOKIE_OPTIONS = {
2026-01-25T08:57:21.8566489Z -    'max_age': COOKIE_DAYS * 24 * 60 * 60,
2026-01-25T08:57:21.8567142Z -    'httponly': True,
2026-01-25T08:57:21.8567670Z -    'secure': True,
2026-01-25T08:57:21.8568273Z -    'samesite': 'Strict'
2026-01-25T08:57:21.8568930Z +    "max_age": COOKIE_DAYS * 24 * 60 * 60,
2026-01-25T08:57:21.8569516Z +    "httponly": True,
2026-01-25T08:57:21.8570020Z +    "secure": True,
2026-01-25T08:57:21.8570700Z +    "samesite": "Strict",
2026-01-25T08:57:21.8571286Z  }
2026-01-25T08:57:21.8571756Z  
2026-01-25T08:57:21.8572333Z  # Константы для валидации
2026-01-25T08:57:21.8573364Z -ADMIN_USERNAME = 'admin'
2026-01-25T08:57:21.8574056Z -DISCRIMINATOR_FORMAT = '{:04d}'
2026-01-25T08:57:21.8574648Z +ADMIN_USERNAME = "admin"
2026-01-25T08:57:21.8575235Z +DISCRIMINATOR_FORMAT = "{:04d}"
2026-01-25T08:57:21.8575918Z  
2026-01-25T08:57:21.8576343Z  
2026-01-25T08:57:21.8576891Z  def set_auth_cookie(response, username: str) -> None:
2026-01-25T08:57:21.8578089Z      """Устанавливает HttpOnly cookie с логином пользователя для автозаполнения.
2026-01-25T08:57:21.8581838Z -    
2026-01-25T08:57:21.8582146Z +
2026-01-25T08:57:21.8582412Z      Args:
2026-01-25T08:57:21.8583425Z          response: Flask response объект
2026-01-25T08:57:21.8584115Z          username: Полный логин пользователя (с дискриминатором или admin)
2026-01-25T08:57:21.8584594Z      """
2026-01-25T08:57:21.8585122Z -    response.set_cookie('last_username', username, **COOKIE_OPTIONS)
2026-01-25T08:57:21.8585893Z +    response.set_cookie("last_username", username, **COOKIE_OPTIONS)
2026-01-25T08:57:21.8586443Z  
2026-01-25T08:57:21.8586727Z  
2026-01-25T08:57:21.8587049Z  def create_user_session(user_id: int) -> None:
2026-01-25T08:57:21.8587690Z      """Создаёт безопасную сессию для пользователя.
2026-01-25T08:57:21.8588145Z -    
2026-01-25T08:57:21.8588418Z +
2026-01-25T08:57:21.8589002Z      Очищает предыдущие данные сессии и устанавливает новые.
2026-01-25T08:57:21.8589498Z -    
2026-01-25T08:57:21.8590129Z +
2026-01-25T08:57:21.8590466Z      Args:
2026-01-25T08:57:21.8590915Z          user_id: ID пользователя из базы данных
2026-01-25T08:57:21.8591360Z      """
2026-01-25T08:57:21.8591694Z      session.clear()
2026-01-25T08:57:21.8592051Z -    session['user_id'] = user_id
2026-01-25T08:57:21.8592465Z +    session["user_id"] = user_id
2026-01-25T08:57:21.8593136Z      session.permanent = True
2026-01-25T08:57:21.8593530Z  
2026-01-25T08:57:21.8593784Z  
2026-01-25T08:57:21.8594233Z  def format_full_username(username: str, discriminator: int) -> str:
2026-01-25T08:57:21.8594974Z      """Форматирует полный логин с дискриминатором.
2026-01-25T08:57:21.8595442Z -    
2026-01-25T08:57:21.8595762Z +
2026-01-25T08:57:21.8596038Z      Args:
2026-01-25T08:57:21.8596445Z          username: Базовое имя пользователя
2026-01-25T08:57:21.8597078Z          discriminator: Числовой дискриминатор (0 для admin)
2026-01-25T08:57:21.8597587Z -        
2026-01-25T08:57:21.8597882Z +
2026-01-25T08:57:21.8598174Z      Returns:
2026-01-25T08:57:21.8598773Z          Полный логин в формате username#0000 или просто username для admin
2026-01-25T08:57:21.8599360Z      """
2026-01-25T08:57:21.8600087Z -    return f"{username}#{DISCRIMINATOR_FORMAT.format(discriminator)}" if discriminator > 0 else username
2026-01-25T08:57:21.8600914Z +    return (
2026-01-25T08:57:21.8601356Z +        f"{username}#{DISCRIMINATOR_FORMAT.format(discriminator)}"
2026-01-25T08:57:21.8601928Z +        if discriminator > 0
2026-01-25T08:57:21.8602314Z +        else username
2026-01-25T08:57:21.8602624Z +    )
2026-01-25T08:57:21.8603086Z  
2026-01-25T08:57:21.8603334Z  
2026-01-25T08:57:21.8603700Z  def get_prefilled_usernames() -> Tuple[str, str]:
2026-01-25T08:57:21.8604380Z      """Извлекает логины из cookie для автозаполнения формы.
2026-01-25T08:57:21.8604828Z -    
2026-01-25T08:57:21.8605117Z +
2026-01-25T08:57:21.8605561Z      Возвращает кортеж из двух значений:
2026-01-25T08:57:21.8606107Z      - Полный логин (user#1234) для скрытого поля
2026-01-25T08:57:21.8606730Z      - Базовый логин (user) для видимого поля ввода
2026-01-25T08:57:21.8607168Z -    
2026-01-25T08:57:21.8607441Z +
2026-01-25T08:57:21.8607770Z      Returns:
2026-01-25T08:57:21.8608566Z          Tuple[full_username, base_username]: Полный и базовый логины
2026-01-25T08:57:21.8609124Z      """
2026-01-25T08:57:21.8609620Z -    prefilled_username = request.cookies.get('last_username', '')
2026-01-25T08:57:21.8610547Z -    prefilled_base_username = prefilled_username.split('#')[0] if prefilled_username else ''
2026-01-25T08:57:21.8611471Z +    prefilled_username = request.cookies.get("last_username", "")
2026-01-25T08:57:21.8612072Z +    prefilled_base_username = (
2026-01-25T08:57:21.8612727Z +        prefilled_username.split("#")[0] if prefilled_username else ""
2026-01-25T08:57:21.8613537Z +    )
2026-01-25T08:57:21.8613922Z      return prefilled_username, prefilled_base_username
2026-01-25T08:57:21.8614428Z  
2026-01-25T08:57:21.8614710Z  
2026-01-25T08:57:21.8615239Z  def authenticate_admin(password: str) -> Tuple[Optional[dict], Optional[str]]:
2026-01-25T08:57:21.8616063Z      """Аутентифицирует admin пользователя.
2026-01-25T08:57:21.8616504Z -    
2026-01-25T08:57:21.8616844Z +
2026-01-25T08:57:21.8617176Z      Особенности:
2026-01-25T08:57:21.8617678Z      - Admin может входить без дискриминатора
2026-01-25T08:57:21.8618299Z      - Если admin отсутствует в БД, создаётся автоматически
2026-01-25T08:57:21.8618978Z      - Пароль проверяется через конфигурацию приложения
2026-01-25T08:57:21.8619426Z -    
2026-01-25T08:57:21.8619731Z +
2026-01-25T08:57:21.8619992Z      Args:
2026-01-25T08:57:21.8620412Z          password: Пароль для проверки
2026-01-25T08:57:21.8620824Z -        
2026-01-25T08:57:21.8621093Z +
2026-01-25T08:57:21.8621376Z      Returns:
2026-01-25T08:57:21.8622108Z          Tuple[user_dict, error_message]: Данные пользователя или None, сообщение об ошибке или None
2026-01-25T08:57:21.8622788Z      """
2026-01-25T08:57:21.8623433Z -    if password != current_app.config['ADMIN_PASSWORD']:
2026-01-25T08:57:21.8624356Z -        return None, 'Неверный пароль для admin'
2026-01-25T08:57:21.8624786Z -    
2026-01-25T08:57:21.8625157Z +    if password != current_app.config["ADMIN_PASSWORD"]:
2026-01-25T08:57:21.8625815Z +        return None, "Неверный пароль для admin"
2026-01-25T08:57:21.8626246Z +
2026-01-25T08:57:21.8626525Z      db = get_db()
2026-01-25T08:57:21.8626876Z      admin_user = db.execute(
2026-01-25T08:57:21.8627373Z -        'SELECT * FROM user WHERE username = ?', (ADMIN_USERNAME,)
2026-01-25T08:57:21.8628026Z +        "SELECT * FROM user WHERE username = ?", (ADMIN_USERNAME,)
2026-01-25T08:57:21.8628558Z      ).fetchone()
2026-01-25T08:57:21.8628835Z -    
2026-01-25T08:57:21.8629067Z +
2026-01-25T08:57:21.8629413Z      # Создаём admin пользователя если его нет
2026-01-25T08:57:21.8629847Z      if admin_user is None:
2026-01-25T08:57:21.8630277Z          hashed_pw, salt = hash_password(password)
2026-01-25T08:57:21.8630764Z          cursor = db.execute(
2026-01-25T08:57:21.8631436Z              "INSERT INTO user (username, password, discriminator, salt) VALUES (?, ?, ?, ?)",
2026-01-25T08:57:21.8632140Z              (ADMIN_USERNAME, hashed_pw, 0, salt),
2026-01-25T08:57:21.8632600Z          )
2026-01-25T08:57:21.8633115Z          db.commit()
2026-01-25T08:57:21.8633502Z          admin_user = db.execute(
2026-01-25T08:57:21.8634066Z -            'SELECT * FROM user WHERE username = ?', (ADMIN_USERNAME,)
2026-01-25T08:57:21.8634778Z +            "SELECT * FROM user WHERE username = ?", (ADMIN_USERNAME,)
2026-01-25T08:57:21.8635329Z          ).fetchone()
2026-01-25T08:57:21.8635657Z -    
2026-01-25T08:57:21.8635930Z +
2026-01-25T08:57:21.8636293Z      return admin_user, None
2026-01-25T08:57:21.8636679Z  
2026-01-25T08:57:21.8636962Z  
2026-01-25T08:57:21.8637608Z -def authenticate_user(username_to_check: str, password: str) -> Tuple[Optional[dict], Optional[str]]:
2026-01-25T08:57:21.8638454Z +def authenticate_user(
2026-01-25T08:57:21.8638859Z +    username_to_check: str, password: str
2026-01-25T08:57:21.8639366Z +) -> Tuple[Optional[dict], Optional[str]]:
2026-01-25T08:57:21.8640080Z      """Аутентифицирует обычного пользователя по логину с дискриминатором.
2026-01-25T08:57:21.8640827Z -    
2026-01-25T08:57:21.8641118Z +
2026-01-25T08:57:21.8641671Z      Проверяет формат логина username#0000 и ищет соответствующую запись в БД.
2026-01-25T08:57:21.8642218Z -    
2026-01-25T08:57:21.8642488Z +
2026-01-25T08:57:21.8642760Z      Args:
2026-01-25T08:57:21.8643429Z          username_to_check: Логин в формате username#0000
2026-01-25T08:57:21.8644074Z          password: Пароль для проверки
2026-01-25T08:57:21.8644530Z -        
2026-01-25T08:57:21.8644814Z +
2026-01-25T08:57:21.8645089Z      Returns:
2026-01-25T08:57:21.8645810Z          Tuple[user_dict, error_message]: Данные пользователя или None, сообщение об ошибке или None
2026-01-25T08:57:21.8646488Z      """
2026-01-25T08:57:21.8646815Z      if "#" not in username_to_check:
2026-01-25T08:57:21.8647370Z -        return None, 'Неверный формат логина'
2026-01-25T08:57:21.8647846Z -    
2026-01-25T08:57:21.8648270Z +        return None, "Неверный формат логина"
2026-01-25T08:57:21.8648707Z +
2026-01-25T08:57:21.8649040Z      try:
2026-01-25T08:57:21.8649473Z          username, tag_str = username_to_check.rsplit("#", 1)
2026-01-25T08:57:21.8650005Z          tag = int(tag_str)
2026-01-25T08:57:21.8650433Z      except (ValueError, IndexError):
2026-01-25T08:57:21.8651008Z -        return None, 'Неверный формат логина'
2026-01-25T08:57:21.8651441Z -    
2026-01-25T08:57:21.8651886Z +        return None, "Неверный формат логина"
2026-01-25T08:57:21.8652313Z +
2026-01-25T08:57:21.8652601Z      db = get_db()
2026-01-25T08:57:21.8653145Z      user = db.execute(
2026-01-25T08:57:21.8653641Z -        'SELECT * FROM user WHERE username = ? AND discriminator = ?',
2026-01-25T08:57:21.8654183Z -        (username, tag)
2026-01-25T08:57:21.8654745Z +        "SELECT * FROM user WHERE username = ? AND discriminator = ?", (username, tag)
2026-01-25T08:57:21.8655613Z      ).fetchone()
2026-01-25T08:57:21.8655924Z -    
2026-01-25T08:57:21.8656194Z +
2026-01-25T08:57:21.8656473Z      if user is None:
2026-01-25T08:57:21.8656975Z -        return None, 'Неверный логин или пароль'
2026-01-25T08:57:21.8657424Z -    
2026-01-25T08:57:21.8657908Z -    if not verify_password(user['password'], password, user['salt']):
2026-01-25T08:57:21.8658631Z -        return None, 'Неверный логин или пароль'
2026-01-25T08:57:21.8659105Z -    
2026-01-25T08:57:21.8659521Z +        return None, "Неверный логин или пароль"
2026-01-25T08:57:21.8659959Z +
2026-01-25T08:57:21.8660408Z +    if not verify_password(user["password"], password, user["salt"]):
2026-01-25T08:57:21.8661140Z +        return None, "Неверный логин или пароль"
2026-01-25T08:57:21.8661583Z +
2026-01-25T08:57:21.8661966Z      return user, None
2026-01-25T08:57:21.8662340Z  
2026-01-25T08:57:21.8662650Z  
2026-01-25T08:57:21.8663226Z -@bp.route('/register', methods=('GET', 'POST'))
2026-01-25T08:57:21.8663801Z +@bp.route("/register", methods=("GET", "POST"))
2026-01-25T08:57:21.8664342Z  def register():
2026-01-25T08:57:21.8664958Z      """Регистрация нового пользователя с автоматической генерацией дискриминатора.
2026-01-25T08:57:21.8665549Z -    
2026-01-25T08:57:21.8665830Z +
2026-01-25T08:57:21.8666185Z      Процесс регистрации:
2026-01-25T08:57:21.8666664Z      1. Валидация формы (username, пароль)
2026-01-25T08:57:21.8667203Z      2. Проверка зарезервированных имён
2026-01-25T08:57:21.8667744Z      3. Генерация уникального дискриминатора
2026-01-25T08:57:21.8668298Z      4. Создание записи в БД с хэшированным паролем
2026-01-25T08:57:21.8668911Z      5. Автоматический вход и перенаправление
2026-01-25T08:57:21.8669385Z -    
2026-01-25T08:57:21.8669676Z +
2026-01-25T08:57:21.8669939Z      Returns:
2026-01-25T08:57:21.8670452Z          HTML страница регистрации или перенаправление на главную
2026-01-25T08:57:21.8670945Z      """
2026-01-25T08:57:21.8671278Z      form = RegistrationForm(request.form)
2026-01-25T08:57:21.8671763Z -    
2026-01-25T08:57:21.8672145Z -    if request.method == 'POST' and form.validate():
2026-01-25T08:57:21.8672625Z +
2026-01-25T08:57:21.8673190Z +    if request.method == "POST" and form.validate():
2026-01-25T08:57:21.8674139Z          username, password, validation_error = _extract_form_data(form)
2026-01-25T08:57:21.8674741Z -        
2026-01-25T08:57:21.8675086Z +
2026-01-25T08:57:21.8675475Z          if validation_error:
2026-01-25T08:57:21.8675908Z -            flash(validation_error, 'danger')
2026-01-25T08:57:21.8676496Z -            return render_template('auth/register.html', form=form)
2026-01-25T08:57:21.8677027Z -        
2026-01-25T08:57:21.8677366Z +            flash(validation_error, "danger")
2026-01-25T08:57:21.8677965Z +            return render_template("auth/register.html", form=form)
2026-01-25T08:57:21.8678468Z +
2026-01-25T08:57:21.8678932Z          registration_result = _process_registration(username, password)
2026-01-25T08:57:21.8679513Z -        
2026-01-25T08:57:21.8680134Z -        if 'error' in registration_result:
2026-01-25T08:57:21.8680647Z -            flash(registration_result['error'], 'danger')
2026-01-25T08:57:21.8681126Z +
2026-01-25T08:57:21.8681430Z +        if "error" in registration_result:
2026-01-25T08:57:21.8681930Z +            flash(registration_result["error"], "danger")
2026-01-25T08:57:21.8682406Z          else:
2026-01-25T08:57:21.8682884Z              # Успешная регистрация с автоматическим входом
2026-01-25T08:57:21.8683575Z -            return registration_result['response']
2026-01-25T08:57:21.8684037Z -    
2026-01-25T08:57:21.8684396Z +            return registration_result["response"]
2026-01-25T08:57:21.8684849Z +
2026-01-25T08:57:21.8685246Z      # Отображение ошибок валидации формы
2026-01-25T08:57:21.8685697Z -    elif request.method == 'POST':
2026-01-25T08:57:21.8686146Z +    elif request.method == "POST":
2026-01-25T08:57:21.8686585Z          _display_form_errors(form)
2026-01-25T08:57:21.8686973Z -    
2026-01-25T08:57:21.8687409Z -    return render_template('auth/register.html', form=form)
2026-01-25T08:57:21.8687930Z +
2026-01-25T08:57:21.8688320Z +    return render_template("auth/register.html", form=form)
2026-01-25T08:57:21.8688850Z  
2026-01-25T08:57:21.8689119Z  
2026-01-25T08:57:21.8689641Z  def _extract_form_data(form: RegistrationForm) -> Tuple[str, str, Optional[str]]:
2026-01-25T08:57:21.8690495Z      """Извлекает и валидирует данные из формы регистрации.
2026-01-25T08:57:21.8690960Z -    
2026-01-25T08:57:21.8691234Z +
2026-01-25T08:57:21.8691505Z      Args:
2026-01-25T08:57:21.8691900Z          form: Объект формы регистрации
2026-01-25T08:57:21.8692308Z -        
2026-01-25T08:57:21.8692585Z +
2026-01-25T08:57:21.8692851Z      Returns:
2026-01-25T08:57:21.8693679Z          Tuple[username, password, error]: Данные формы и ошибка валидации
2026-01-25T08:57:21.8694252Z      """
2026-01-25T08:57:21.8694598Z      username = form.username.data.strip()
2026-01-25T08:57:21.8695080Z      password = form.password.data
2026-01-25T08:57:21.8695642Z -    
2026-01-25T08:57:21.8695921Z +
2026-01-25T08:57:21.8696307Z      # Проверка зарезервированного имени
2026-01-25T08:57:21.8696766Z      if username.lower() == ADMIN_USERNAME:
2026-01-25T08:57:21.8697806Z -        return username, password, f'Имя {ADMIN_USERNAME} зарезервировано системой'
2026-01-25T08:57:21.8698429Z -    
2026-01-25T08:57:21.8699091Z +        return username, password, f"Имя {ADMIN_USERNAME} зарезервировано системой"
2026-01-25T08:57:21.8699709Z +
2026-01-25T08:57:21.8700016Z      return username, password, None
2026-01-25T08:57:21.8700451Z  
2026-01-25T08:57:21.8700714Z  
2026-01-25T08:57:21.8701155Z  def _process_registration(username: str, password: str) -> dict:
2026-01-25T08:57:21.8701868Z      """Обрабатывает процесс регистрации пользователя.
2026-01-25T08:57:21.8702318Z -    
2026-01-25T08:57:21.8702594Z +
2026-01-25T08:57:21.8702862Z      Args:
2026-01-25T08:57:21.8703435Z          username: Имя пользователя
2026-01-25T08:57:21.8703941Z          password: Пароль
2026-01-25T08:57:21.8704330Z -        
2026-01-25T08:57:21.8704606Z +
2026-01-25T08:57:21.8704872Z      Returns:
2026-01-25T08:57:21.8705341Z          dict: Результат регистрации с error или response
2026-01-25T08:57:21.8705832Z      """
2026-01-25T08:57:21.8706119Z      db = get_db()
2026-01-25T08:57:21.8706420Z -    
2026-01-25T08:57:21.8706687Z +
2026-01-25T08:57:21.8707070Z      # Генерация уникального дискриминатора
2026-01-25T08:57:21.8707626Z      new_discriminator = generate_discriminator(db, username)
2026-01-25T08:57:21.8708140Z -    
2026-01-25T08:57:21.8708413Z +
2026-01-25T08:57:21.8708712Z      if new_discriminator is None:
2026-01-25T08:57:21.8709130Z -        return {
2026-01-25T08:57:21.8709798Z -            'error': f"К сожалению, имя {username} перегружено. Попробуйте другое."
2026-01-25T08:57:21.8710363Z -        }
2026-01-25T08:57:21.8710652Z -    
2026-01-25T08:57:21.8711238Z +        return {"error": f"К сожалению, имя {username} перегружено. Попробуйте другое."}
2026-01-25T08:57:21.8712062Z +
2026-01-25T08:57:21.8712408Z      try:
2026-01-25T08:57:21.8712803Z          # Создание пользователя в БД
2026-01-25T08:57:21.8713579Z          user_id = _create_user_in_db(db, username, password, new_discriminator)
2026-01-25T08:57:21.8714219Z -        
2026-01-25T08:57:21.8714500Z +
2026-01-25T08:57:21.8714869Z          # Автоматический вход
2026-01-25T08:57:21.8715269Z          create_user_session(user_id)
2026-01-25T08:57:21.8715665Z -        
2026-01-25T08:57:21.8715940Z +
2026-01-25T08:57:21.8716355Z          # Создание ответа с cookie для автозаполнения
2026-01-25T08:57:21.8716933Z          response = make_response(redirect(url_for("main.index")))
2026-01-25T08:57:21.8717661Z          full_username = format_full_username(username, new_discriminator)
2026-01-25T08:57:21.8718314Z          set_auth_cookie(response, full_username)
2026-01-25T08:57:21.8718781Z -        
2026-01-25T08:57:21.8719318Z -        flash(f'Добро пожаловать {full_username}!', 'success')
2026-01-25T08:57:21.8719813Z -        
2026-01-25T08:57:21.8720148Z -        return {'response': response}
2026-01-25T08:57:21.8720565Z -        
2026-01-25T08:57:21.8720842Z +
2026-01-25T08:57:21.8721344Z +        flash(f"Добро пожаловать {full_username}!", "success")
2026-01-25T08:57:21.8721836Z +
2026-01-25T08:57:21.8722137Z +        return {"response": response}
2026-01-25T08:57:21.8722545Z +
2026-01-25T08:57:21.8722862Z      except sqlite3.IntegrityError:
2026-01-25T08:57:21.8723461Z -        return {
2026-01-25T08:57:21.8724004Z -            'error': "Ошибка при регистрации. Возможно, имя занято."
2026-01-25T08:57:21.8724497Z -        }
2026-01-25T08:57:21.8725057Z +        return {"error": "Ошибка при регистрации. Возможно, имя занято."}
2026-01-25T08:57:21.8725572Z  
2026-01-25T08:57:21.8725824Z  
2026-01-25T08:57:21.8726336Z  def _create_user_in_db(db, username: str, password: str, discriminator: int) -> int:
2026-01-25T08:57:21.8727132Z      """Создаёт запись пользователя в базе данных.
2026-01-25T08:57:21.8727546Z -    
2026-01-25T08:57:21.8727824Z +
2026-01-25T08:57:21.8728079Z      Args:
2026-01-25T08:57:21.8728425Z          db: Объект подключения к БД
2026-01-25T08:57:21.8728893Z          username: Имя пользователя
2026-01-25T08:57:21.8729615Z          password: Пароль
2026-01-25T08:57:21.8730064Z          discriminator: Дискриминатор
2026-01-25T08:57:21.8730601Z -        
2026-01-25T08:57:21.8730932Z +
2026-01-25T08:57:21.8731191Z      Returns:
2026-01-25T08:57:21.8731565Z          int: ID созданного пользователя
2026-01-25T08:57:21.8731960Z      """
2026-01-25T08:57:21.8732290Z      hashed_pw, salt = hash_password(password)
2026-01-25T08:57:21.8732725Z      cursor = db.execute(
2026-01-25T08:57:21.8733376Z @@ -282,170 +295,180 @@
2026-01-25T08:57:21.8733700Z      return cursor.lastrowid
2026-01-25T08:57:21.8734032Z  
2026-01-25T08:57:21.8734284Z  
2026-01-25T08:57:21.8734691Z  def _display_form_errors(form: RegistrationForm) -> None:
2026-01-25T08:57:21.8735385Z      """Отображает ошибки валидации формы.
2026-01-25T08:57:21.8736114Z -    
2026-01-25T08:57:21.8736432Z +
2026-01-25T08:57:21.8736709Z      Args:
2026-01-25T08:57:21.8737116Z          form: Объект формы с ошибками
2026-01-25T08:57:21.8737673Z      """
2026-01-25T08:57:21.8738112Z      for field_name, field_errors in form.errors.items():
2026-01-25T08:57:21.8738663Z          for error in field_errors:
2026-01-25T08:57:21.8739101Z -            flash(error, 'danger')
2026-01-25T08:57:21.8739502Z -
2026-01-25T08:57:21.8739768Z -
2026-01-25T08:57:21.8740140Z -@bp.route('/login', methods=('GET', 'POST'))
2026-01-25T08:57:21.8740632Z +            flash(error, "danger")
2026-01-25T08:57:21.8741025Z +
2026-01-25T08:57:21.8741293Z +
2026-01-25T08:57:21.8741638Z +@bp.route("/login", methods=("GET", "POST"))
2026-01-25T08:57:21.8742122Z  def login():
2026-01-25T08:57:21.8742650Z      """Вход пользователя с поддержкой дискриминаторов.
2026-01-25T08:57:21.8743382Z -    
2026-01-25T08:57:21.8743666Z +
2026-01-25T08:57:21.8744021Z      Форматы входа:
2026-01-25T08:57:21.8744499Z      - Username#0000: для обычных пользователей
2026-01-25T08:57:21.8745170Z      - admin: для администратора (без дискриминатора)
2026-01-25T08:57:21.8745636Z -    
2026-01-25T08:57:21.8745937Z +
2026-01-25T08:57:21.8746274Z      Особенности:
2026-01-25T08:57:21.8746664Z      - Автозаполнение из cookie
2026-01-25T08:57:21.8747165Z      - Приоритет скрытого поля с полным логином
2026-01-25T08:57:21.8747774Z      - Сохранение последнего успешного логина в cookie
2026-01-25T08:57:21.8748256Z -    
2026-01-25T08:57:21.8748532Z +
2026-01-25T08:57:21.8748805Z      Returns:
2026-01-25T08:57:21.8749306Z          HTML страница входа или перенаправление на главную
2026-01-25T08:57:21.8749784Z      """
2026-01-25T08:57:21.8750322Z      prefilled_username, prefilled_base_username = get_prefilled_usernames()
2026-01-25T08:57:21.8751015Z      form = LoginForm(request.form)
2026-01-25T08:57:21.8751422Z -    
2026-01-25T08:57:21.8751807Z -    if request.method == 'POST' and form.validate():
2026-01-25T08:57:21.8752294Z +
2026-01-25T08:57:21.8752695Z +    if request.method == "POST" and form.validate():
2026-01-25T08:57:21.8753440Z          login_result = _process_login_attempt()
2026-01-25T08:57:21.8753895Z -        
2026-01-25T08:57:21.8754496Z -        if login_result['success']:
2026-01-25T08:57:21.8754962Z -            return login_result['response']
2026-01-25T08:57:21.8755404Z +
2026-01-25T08:57:21.8755712Z +        if login_result["success"]:
2026-01-25T08:57:21.8756186Z +            return login_result["response"]
2026-01-25T08:57:21.8756626Z          else:
2026-01-25T08:57:21.8756990Z -            flash(login_result['error'], 'danger')
2026-01-25T08:57:21.8757444Z -    
2026-01-25T08:57:21.8757792Z +            flash(login_result["error"], "danger")
2026-01-25T08:57:21.8758223Z +
2026-01-25T08:57:21.8758630Z      # Отображение ошибок валидации формы
2026-01-25T08:57:21.8759096Z -    elif request.method == 'POST':
2026-01-25T08:57:21.8759544Z +    elif request.method == "POST":
2026-01-25T08:57:21.8759970Z          _display_form_errors(form)
2026-01-25T08:57:21.8760388Z -    
2026-01-25T08:57:21.8760672Z +
2026-01-25T08:57:21.8760965Z      return render_template(
2026-01-25T08:57:21.8761374Z -        'auth/login.html', 
2026-01-25T08:57:21.8761777Z -        form=form, 
2026-01-25T08:57:21.8762175Z -        prefilled_username=prefilled_username, 
2026-01-25T08:57:21.8762745Z -        prefilled_base_username=prefilled_base_username
2026-01-25T08:57:21.8763506Z +        "auth/login.html",
2026-01-25T08:57:21.8763914Z +        form=form,
2026-01-25T08:57:21.8764293Z +        prefilled_username=prefilled_username,
2026-01-25T08:57:21.8764913Z +        prefilled_base_username=prefilled_base_username,
2026-01-25T08:57:21.8765433Z      )
2026-01-25T08:57:21.8765748Z  
2026-01-25T08:57:21.8766055Z  
2026-01-25T08:57:21.8766380Z  def _process_login_attempt() -> dict:
2026-01-25T08:57:21.8766963Z      """Обрабатывает попытку входа пользователя.
2026-01-25T08:57:21.8767403Z -    
2026-01-25T08:57:21.8767679Z +
2026-01-25T08:57:21.8767949Z      Returns:
2026-01-25T08:57:21.8768708Z          dict: Результат входа с success/response или error
2026-01-25T08:57:21.8769201Z      """
2026-01-25T08:57:21.8769565Z      # Извлечение данных формы
2026-01-25T08:57:21.8770076Z -    raw_username = request.form.get('username', '').strip()
2026-01-25T08:57:21.8770811Z -    full_username_hidden = request.form.get('full_username', '').strip()
2026-01-25T08:57:21.8771496Z -    password = request.form.get('password', '')
2026-01-25T08:57:21.8771974Z -    
2026-01-25T08:57:21.8772377Z +    raw_username = request.form.get("username", "").strip()
2026-01-25T08:57:21.8773261Z +    full_username_hidden = request.form.get("full_username", "").strip()
2026-01-25T08:57:21.8773942Z +    password = request.form.get("password", "")
2026-01-25T08:57:21.8774405Z +
2026-01-25T08:57:21.8774901Z      # Определение логина для проверки (приоритет скрытому полю)
2026-01-25T08:57:21.8775673Z -    username_to_check = _determine_username_for_check(raw_username, full_username_hidden)
2026-01-25T08:57:21.8776390Z -    
2026-01-25T08:57:21.8776770Z +    username_to_check = _determine_username_for_check(
2026-01-25T08:57:21.8777299Z +        raw_username, full_username_hidden
2026-01-25T08:57:21.8777745Z +    )
2026-01-25T08:57:21.8778020Z +
2026-01-25T08:57:21.8778378Z      # Обработка входа admin
2026-01-25T08:57:21.8778866Z      if username_to_check.lower() == ADMIN_USERNAME:
2026-01-25T08:57:21.8779407Z          return _handle_admin_login(password)
2026-01-25T08:57:21.8779844Z -    
2026-01-25T08:57:21.8780116Z +
2026-01-25T08:57:21.8780521Z      # Обработка входа обычного пользователя
2026-01-25T08:57:21.8781067Z      return _handle_user_login(username_to_check, password)
2026-01-25T08:57:21.8781566Z  
2026-01-25T08:57:21.8781828Z  
2026-01-25T08:57:21.8782383Z  def _determine_username_for_check(raw_username: str, full_username_hidden: str) -> str:
2026-01-25T08:57:21.8783468Z      """Определяет какой логин использовать для аутентификации.
2026-01-25T08:57:21.8783955Z -    
2026-01-25T08:57:21.8784254Z +
2026-01-25T08:57:21.8784700Z      Приоритет: скрытое поле с полным логином > видимое поле
2026-01-25T08:57:21.8785171Z -    
2026-01-25T08:57:21.8785444Z +
2026-01-25T08:57:21.8785984Z      Args:
2026-01-25T08:57:21.8786425Z          raw_username: Логин из видимого поля
2026-01-25T08:57:21.8787035Z          full_username_hidden: Логин из скрытого поля
2026-01-25T08:57:21.8787506Z -        
2026-01-25T08:57:21.8787786Z +
2026-01-25T08:57:21.8788056Z      Returns:
2026-01-25T08:57:21.8788455Z          str: Логин для проверки
2026-01-25T08:57:21.8788855Z      """
2026-01-25T08:57:21.8789516Z -    return full_username_hidden if full_username_hidden and '#' in full_username_hidden else raw_username
2026-01-25T08:57:21.8790307Z +    return (
2026-01-25T08:57:21.8790633Z +        full_username_hidden
2026-01-25T08:57:21.8791133Z +        if full_username_hidden and "#" in full_username_hidden
2026-01-25T08:57:21.8791677Z +        else raw_username
2026-01-25T08:57:21.8792023Z +    )
2026-01-25T08:57:21.8792314Z  
2026-01-25T08:57:21.8792588Z  
2026-01-25T08:57:21.8793111Z  def _handle_admin_login(password: str) -> dict:
2026-01-25T08:57:21.8793736Z      """Обрабатывает вход admin пользователя.
2026-01-25T08:57:21.8794172Z -    
2026-01-25T08:57:21.8794442Z +
2026-01-25T08:57:21.8794708Z      Args:
2026-01-25T08:57:21.8795110Z          password: Пароль для проверки
2026-01-25T08:57:21.8795529Z -        
2026-01-25T08:57:21.8795806Z +
2026-01-25T08:57:21.8796078Z      Returns:
2026-01-25T08:57:21.8796478Z          dict: Результат входа
2026-01-25T08:57:21.8796843Z      """
2026-01-25T08:57:21.8797232Z      admin_user, error = authenticate_admin(password)
2026-01-25T08:57:21.8797707Z -    
2026-01-25T08:57:21.8797979Z +
2026-01-25T08:57:21.8798255Z      if admin_user:
2026-01-25T08:57:21.8798676Z -        create_user_session(admin_user['id'])
2026-01-25T08:57:21.8799128Z -        
2026-01-25T08:57:21.8799563Z -        response = make_response(redirect(url_for('main.index')))
2026-01-25T08:57:21.8800166Z +        create_user_session(admin_user["id"])
2026-01-25T08:57:21.8800881Z +
2026-01-25T08:57:21.8801314Z +        response = make_response(redirect(url_for("main.index")))
2026-01-25T08:57:21.8802015Z          set_auth_cookie(response, ADMIN_USERNAME)
2026-01-25T08:57:21.8802686Z -        flash('Добро пожаловать, admin!', 'success')
2026-01-25T08:57:21.8803390Z -        
2026-01-25T08:57:21.8803772Z -        return {'success': True, 'response': response}
2026-01-25T08:57:21.8804249Z -    
2026-01-25T08:57:21.8804580Z -    return {'success': False, 'error': error}
2026-01-25T08:57:21.8805207Z +        flash("Добро пожаловать, admin!", "success")
2026-01-25T08:57:21.8805661Z +
2026-01-25T08:57:21.8806012Z +        return {"success": True, "response": response}
2026-01-25T08:57:21.8806486Z +
2026-01-25T08:57:21.8806818Z +    return {"success": False, "error": error}
2026-01-25T08:57:21.8807256Z  
2026-01-25T08:57:21.8807516Z  
2026-01-25T08:57:21.8807946Z  def _handle_user_login(username: str, password: str) -> dict:
2026-01-25T08:57:21.8808660Z      """Обрабатывает вход обычного пользователя.
2026-01-25T08:57:21.8809100Z -    
2026-01-25T08:57:21.8809398Z +
2026-01-25T08:57:21.8809666Z      Args:
2026-01-25T08:57:21.8810085Z          username: Логин с дискриминатором
2026-01-25T08:57:21.8810594Z          password: Пароль
2026-01-25T08:57:21.8810949Z -        
2026-01-25T08:57:21.8811226Z +
2026-01-25T08:57:21.8811516Z      Returns:
2026-01-25T08:57:21.8811922Z          dict: Результат входа
2026-01-25T08:57:21.8812361Z      """
2026-01-25T08:57:21.8812775Z      user, error = authenticate_user(username, password)
2026-01-25T08:57:21.8813472Z -    
2026-01-25T08:57:21.8813752Z +
2026-01-25T08:57:21.8814036Z      if user:
2026-01-25T08:57:21.8814383Z -        create_user_session(user['id'])
2026-01-25T08:57:21.8814795Z -        
2026-01-25T08:57:21.8815344Z -        full_username = format_full_username(user['username'], user['discriminator'])
2026-01-25T08:57:21.8815624Z -        response = make_response(redirect(url_for('main.index')))
2026-01-25T08:57:21.8815808Z +        create_user_session(user["id"])
2026-01-25T08:57:21.8815954Z +
2026-01-25T08:57:21.8816314Z +        full_username = format_full_username(user["username"], user["discriminator"])
2026-01-25T08:57:21.8816816Z +        response = make_response(redirect(url_for("main.index")))
2026-01-25T08:57:21.8817007Z          set_auth_cookie(response, full_username)
2026-01-25T08:57:21.8817134Z -        
2026-01-25T08:57:21.8817340Z -        return {'success': True, 'response': response}
2026-01-25T08:57:21.8817455Z -    
2026-01-25T08:57:21.8817664Z -    return {'success': False, 'error': error}
2026-01-25T08:57:21.8817787Z +
2026-01-25T08:57:21.8817998Z +        return {"success": True, "response": response}
2026-01-25T08:57:21.8818114Z +
2026-01-25T08:57:21.8818288Z +    return {"success": False, "error": error}
2026-01-25T08:57:21.8818407Z  
2026-01-25T08:57:21.8818519Z  
2026-01-25T08:57:21.8818666Z  @bp.before_app_request
2026-01-25T08:57:21.8818816Z  def load_logged_in_user():
2026-01-25T08:57:21.8819143Z      """Загружает текущего пользователя в контекст запроса.
2026-01-25T08:57:21.8819261Z -    
2026-01-25T08:57:21.8819378Z +
2026-01-25T08:57:21.8819665Z      Выполняется перед каждым запросом к приложению.
2026-01-25T08:57:21.8820057Z      g.user доступен во view-функциях и шаблонах в рамках одного запроса.
2026-01-25T08:57:21.8820223Z -    
2026-01-25T08:57:21.8820333Z +
2026-01-25T08:57:21.8820462Z      Returns:
2026-01-25T08:57:21.8820581Z          None
2026-01-25T08:57:21.8820696Z      """
2026-01-25T08:57:21.8820867Z -    user_id = session.get('user_id')
2026-01-25T08:57:21.8820981Z -    
2026-01-25T08:57:21.8821139Z +    user_id = session.get("user_id")
2026-01-25T08:57:21.8821258Z +
2026-01-25T08:57:21.8821396Z      if user_id is None:
2026-01-25T08:57:21.8821528Z          g.user = None
2026-01-25T08:57:21.8821660Z      else:
2026-01-25T08:57:21.8822043Z          # Используем sqlite3.Row для доступа к полям как к словарю
2026-01-25T08:57:21.8822203Z -        g.user = get_db().execute(
2026-01-25T08:57:21.8822768Z -            'SELECT id, username, discriminator FROM user WHERE id = ?', (user_id,)
2026-01-25T08:57:21.8823085Z -        ).fetchone()
2026-01-25T08:57:21.8823256Z -
2026-01-25T08:57:21.8823374Z -
2026-01-25T08:57:21.8823511Z -@bp.route('/logout')
2026-01-25T08:57:21.8823648Z +        g.user = (
2026-01-25T08:57:21.8823775Z +            get_db()
2026-01-25T08:57:21.8823913Z +            .execute(
2026-01-25T08:57:21.8824256Z +                "SELECT id, username, discriminator FROM user WHERE id = ?", (user_id,)
2026-01-25T08:57:21.8824383Z +            )
2026-01-25T08:57:21.8824513Z +            .fetchone()
2026-01-25T08:57:21.8824641Z +        )
2026-01-25T08:57:21.8824754Z +
2026-01-25T08:57:21.8824875Z +
2026-01-25T08:57:21.8825013Z +@bp.route("/logout")
2026-01-25T08:57:21.8825142Z  def logout():
2026-01-25T08:57:21.8825397Z      """Выход пользователя из системы.
2026-01-25T08:57:21.8825515Z -    
2026-01-25T08:57:21.8825631Z +
2026-01-25T08:57:21.8826007Z      Очищает сессию пользователя и перенаправляет на главную страницу.
2026-01-25T08:57:21.8826130Z -    
2026-01-25T08:57:21.8826244Z +
2026-01-25T08:57:21.8826374Z      Returns:
2026-01-25T08:57:21.8826625Z          Redirect на главную страницу
2026-01-25T08:57:21.8826744Z      """
2026-01-25T08:57:21.8826886Z      session.clear()
2026-01-25T08:57:21.8827124Z -    flash('Вы вышли из системы.', 'info')
2026-01-25T08:57:21.8827307Z -    return redirect(url_for('main.index'))
2026-01-25T08:57:21.8827461Z \ No newline at end of file
2026-01-25T08:57:21.8827693Z +    flash("Вы вышли из системы.", "info")
2026-01-25T08:57:21.8827874Z +    return redirect(url_for("main.index"))
2026-01-25T08:57:21.9149474Z --- /home/runner/work/flask_blog/flask_blog/app/models/post.py	2026-01-25 08:57:06.651994+00:00
2026-01-25T08:57:21.9151291Z +++ /home/runner/work/flask_blog/flask_blog/app/models/post.py	2026-01-25 08:57:21.913130+00:00
2026-01-25T08:57:21.9152646Z @@ -1,87 +1,88 @@
2026-01-25T08:57:21.9154300Z  """Модель поста блога."""
2026-01-25T08:57:21.9155694Z +
2026-01-25T08:57:21.9156985Z  from datetime import datetime
2026-01-25T08:57:21.9158372Z  from typing import Optional, Dict, Any
2026-01-25T08:57:21.9159801Z  
2026-01-25T08:57:21.9160077Z  
2026-01-25T08:57:21.9160217Z  class Post:
2026-01-25T08:57:21.9160453Z      """Модель поста блога.
2026-01-25T08:57:21.9160574Z -    
2026-01-25T08:57:21.9160681Z +
2026-01-25T08:57:21.9160996Z      Содержит только данные и базовую бизнес-логику.
2026-01-25T08:57:21.9161266Z      Вся логика работы с БД вынесена в PostService.
2026-01-25T08:57:21.9161384Z      """
2026-01-25T08:57:21.9161506Z -    
2026-01-25T08:57:21.9161639Z +
2026-01-25T08:57:21.9161812Z      def __init__(
2026-01-25T08:57:21.9161989Z          self,
2026-01-25T08:57:21.9162142Z          id: Optional[int] = None,
2026-01-25T08:57:21.9162339Z          author_id: Optional[int] = None,
2026-01-25T08:57:21.9162505Z -        title: str = '',
2026-01-25T08:57:21.9162653Z -        content: str = '',
2026-01-25T08:57:21.9163316Z +        title: str = "",
2026-01-25T08:57:21.9163470Z +        content: str = "",
2026-01-25T08:57:21.9163640Z          created: Optional[datetime] = None,
2026-01-25T08:57:21.9163803Z -        author_username: str = '',
2026-01-25T08:57:21.9163941Z +        author_username: str = "",
2026-01-25T08:57:21.9164089Z          author_discriminator: int = 0,
2026-01-25T08:57:21.9164230Z -        comment_count: int = 0
2026-01-25T08:57:21.9164357Z +        comment_count: int = 0,
2026-01-25T08:57:21.9164463Z      ):
2026-01-25T08:57:21.9164590Z          self.id = id
2026-01-25T08:57:21.9164746Z          self.author_id = author_id
2026-01-25T08:57:21.9164910Z          self.title = title
2026-01-25T08:57:21.9165057Z          self.content = content
2026-01-25T08:57:21.9165181Z          self.created = created
2026-01-25T08:57:21.9165356Z          self.author_username = author_username
2026-01-25T08:57:21.9165581Z          self.author_discriminator = author_discriminator
2026-01-25T08:57:21.9165763Z          self.comment_count = comment_count
2026-01-25T08:57:21.9165897Z -    
2026-01-25T08:57:21.9165999Z +
2026-01-25T08:57:21.9166119Z      @property
2026-01-25T08:57:21.9166280Z      def author_display_name(self) -> str:
2026-01-25T08:57:21.9166654Z          """Возвращает отображаемое имя автора с дискриминатором."""
2026-01-25T08:57:21.9166952Z          return f"{self.author_username}#{self.author_discriminator:04d}"
2026-01-25T08:57:21.9167060Z -    
2026-01-25T08:57:21.9167166Z +
2026-01-25T08:57:21.9167351Z      def is_author(self, user_id: int) -> bool:
2026-01-25T08:57:21.9167653Z          """Проверяет, является ли пользователь автором поста.
2026-01-25T08:57:21.9167777Z -        
2026-01-25T08:57:21.9167902Z +
2026-01-25T08:57:21.9168018Z          Args:
2026-01-25T08:57:21.9168244Z              user_id: ID пользователя
2026-01-25T08:57:21.9168370Z -            
2026-01-25T08:57:21.9168490Z +
2026-01-25T08:57:21.9168642Z          Returns:
2026-01-25T08:57:21.9169007Z              bool: True если пользователь автор поста
2026-01-25T08:57:21.9169165Z          """
2026-01-25T08:57:21.9169364Z          return self.author_id == user_id
2026-01-25T08:57:21.9169483Z -    
2026-01-25T08:57:21.9169889Z +
2026-01-25T08:57:21.9170086Z      def to_dict(self) -> Dict[str, Any]:
2026-01-25T08:57:21.9170391Z          """Преобразует пост в словарь для шаблонов.
2026-01-25T08:57:21.9170517Z -        
2026-01-25T08:57:21.9170642Z +
2026-01-25T08:57:21.9170771Z          Returns:
2026-01-25T08:57:21.9171063Z              Dict[str, Any]: словарь с данными поста
2026-01-25T08:57:21.9171202Z          """
2026-01-25T08:57:21.9171344Z          return {
2026-01-25T08:57:21.9171504Z -            'id': self.id,
2026-01-25T08:57:21.9171707Z -            'author_id': self.author_id,
2026-01-25T08:57:21.9171857Z -            'title': self.title,
2026-01-25T08:57:21.9172021Z -            'content': self.content,
2026-01-25T08:57:21.9172178Z -            'created': self.created,
2026-01-25T08:57:21.9172419Z -            'author_username': self.author_username,
2026-01-25T08:57:21.9172700Z -            'author_discriminator': self.author_discriminator,
2026-01-25T08:57:21.9173146Z -            'author_display_name': self.author_display_name,
2026-01-25T08:57:21.9173370Z -            'comment_count': self.comment_count
2026-01-25T08:57:21.9173513Z +            "id": self.id,
2026-01-25T08:57:21.9173677Z +            "author_id": self.author_id,
2026-01-25T08:57:21.9173834Z +            "title": self.title,
2026-01-25T08:57:21.9173990Z +            "content": self.content,
2026-01-25T08:57:21.9174144Z +            "created": self.created,
2026-01-25T08:57:21.9174350Z +            "author_username": self.author_username,
2026-01-25T08:57:21.9174609Z +            "author_discriminator": self.author_discriminator,
2026-01-25T08:57:21.9174843Z +            "author_display_name": self.author_display_name,
2026-01-25T08:57:21.9175038Z +            "comment_count": self.comment_count,
2026-01-25T08:57:21.9175160Z          }
2026-01-25T08:57:21.9175527Z -    
2026-01-25T08:57:21.9175647Z +
2026-01-25T08:57:21.9175782Z      @classmethod
2026-01-25T08:57:21.9176027Z -    def from_dict(cls, data: Dict[str, Any]) -> 'Post':
2026-01-25T08:57:21.9176268Z +    def from_dict(cls, data: Dict[str, Any]) -> "Post":
2026-01-25T08:57:21.9176580Z          """Создаёт экземпляр Post из словаря.
2026-01-25T08:57:21.9176719Z -        
2026-01-25T08:57:21.9176836Z +
2026-01-25T08:57:21.9176965Z          Args:
2026-01-25T08:57:21.9177218Z              data: Словарь с данными поста
2026-01-25T08:57:21.9177349Z -            
2026-01-25T08:57:21.9177468Z +
2026-01-25T08:57:21.9177607Z          Returns:
2026-01-25T08:57:21.9177854Z              Post: созданный экземпляр
2026-01-25T08:57:21.9178033Z          """
2026-01-25T08:57:21.9178197Z          return cls(**data)
2026-01-25T08:57:21.9178325Z -    
2026-01-25T08:57:21.9178453Z +
2026-01-25T08:57:21.9178610Z      def __repr__(self) -> str:
2026-01-25T08:57:21.9178892Z          """Строковое представление для отладки."""
2026-01-25T08:57:21.9179327Z          return f"<Post(id={self.id}, title='{self.title}', author_id={self.author_id})>"
2026-01-25T08:57:21.9179456Z -    
2026-01-25T08:57:21.9179580Z +
2026-01-25T08:57:21.9179791Z      def __eq__(self, other) -> bool:
2026-01-25T08:57:21.9180037Z          """Сравнение постов по ID."""
2026-01-25T08:57:21.9180220Z          if not isinstance(other, Post):
2026-01-25T08:57:21.9180366Z              return False
2026-01-25T08:57:21.9180519Z          return self.id == other.id
2026-01-25T08:57:21.9188103Z would reformat /home/runner/work/flask_blog/flask_blog/app/models/post.py
2026-01-25T08:57:21.9398054Z --- /home/runner/work/flask_blog/flask_blog/app/main/routes.py	2026-01-25 08:57:06.651994+00:00
2026-01-25T08:57:21.9403811Z would reformat /home/runner/work/flask_blog/flask_blog/app/main/routes.py
2026-01-25T08:57:21.9404257Z +++ /home/runner/work/flask_blog/flask_blog/app/main/routes.py	2026-01-25 08:57:21.936621+00:00
2026-01-25T08:57:21.9407426Z @@ -1,161 +1,169 @@
2026-01-25T08:57:21.9407879Z  """Главные маршруты приложения."""
2026-01-25T08:57:21.9408339Z -from flask import Blueprint, render_template, request, flash, redirect, url_for, abort, g
2026-01-25T08:57:21.9408887Z +
2026-01-25T08:57:21.9409050Z +from flask import (
2026-01-25T08:57:21.9409185Z +    Blueprint,
2026-01-25T08:57:21.9409319Z +    render_template,
2026-01-25T08:57:21.9409444Z +    request,
2026-01-25T08:57:21.9409573Z +    flash,
2026-01-25T08:57:21.9409692Z +    redirect,
2026-01-25T08:57:21.9409818Z +    url_for,
2026-01-25T08:57:21.9409938Z +    abort,
2026-01-25T08:57:21.9410057Z +    g,
2026-01-25T08:57:21.9410169Z +)
2026-01-25T08:57:21.9410289Z  
2026-01-25T08:57:21.9410478Z  from app.auth.utils import login_required
2026-01-25T08:57:21.9410736Z  from app.services import PostService, CommentService
2026-01-25T08:57:21.9410898Z  from app.models import Post
2026-01-25T08:57:21.9411094Z  from app.forms import PostForm, CommentForm
2026-01-25T08:57:21.9411217Z  
2026-01-25T08:57:21.9411376Z -bp = Blueprint('main', __name__)
2026-01-25T08:57:21.9411539Z +bp = Blueprint("main", __name__)
2026-01-25T08:57:21.9411663Z  
2026-01-25T08:57:21.9411774Z  
2026-01-25T08:57:21.9411898Z -@bp.route('/')
2026-01-25T08:57:21.9412043Z +@bp.route("/")
2026-01-25T08:57:21.9412166Z  def index():
2026-01-25T08:57:21.9412612Z      """Главная страница блога - список всех постов."""
2026-01-25T08:57:21.9412797Z      posts = PostService.get_all()
2026-01-25T08:57:21.9413238Z -    return render_template('main/index.html', posts=posts)
2026-01-25T08:57:21.9413507Z +    return render_template("main/index.html", posts=posts)
2026-01-25T08:57:21.9413653Z  
2026-01-25T08:57:21.9413766Z  
2026-01-25T08:57:21.9413984Z -@bp.route('/post/create', methods=['GET', 'POST'])
2026-01-25T08:57:21.9414191Z +@bp.route("/post/create", methods=["GET", "POST"])
2026-01-25T08:57:21.9414319Z  @login_required
2026-01-25T08:57:21.9414459Z  def create_post():
2026-01-25T08:57:21.9414689Z      """Создание нового поста."""
2026-01-25T08:57:21.9414871Z      form = PostForm(request.form)
2026-01-25T08:57:21.9415300Z -    
2026-01-25T08:57:21.9415536Z -    if request.method == 'POST' and form.validate():
2026-01-25T08:57:21.9415668Z +
2026-01-25T08:57:21.9415907Z +    if request.method == "POST" and form.validate():
2026-01-25T08:57:21.9416071Z          post = PostService.create(
2026-01-25T08:57:21.9416225Z -            author_id=g.user['id'],
2026-01-25T08:57:21.9416364Z -            title=form.title.data,
2026-01-25T08:57:21.9416526Z -            content=form.content.data
2026-01-25T08:57:21.9416879Z +            author_id=g.user["id"], title=form.title.data, content=form.content.data
2026-01-25T08:57:21.9417004Z          )
2026-01-25T08:57:21.9417271Z -        flash('Пост успешно создан!', 'success')
2026-01-25T08:57:21.9417560Z -        return redirect(url_for('main.view_post', post_id=post.id))
2026-01-25T08:57:21.9417674Z -    
2026-01-25T08:57:21.9417933Z +        flash("Пост успешно создан!", "success")
2026-01-25T08:57:21.9418224Z +        return redirect(url_for("main.view_post", post_id=post.id))
2026-01-25T08:57:21.9418355Z +
2026-01-25T08:57:21.9418608Z      # Если форма не валидна, показываем ошибки
2026-01-25T08:57:21.9418769Z -    elif request.method == 'POST':
2026-01-25T08:57:21.9418939Z +    elif request.method == "POST":
2026-01-25T08:57:21.9419184Z          for field_name, field_errors in form.errors.items():
2026-01-25T08:57:21.9419344Z              for error in field_errors:
2026-01-25T08:57:21.9419494Z -                flash(error, 'danger')
2026-01-25T08:57:21.9419628Z -    
2026-01-25T08:57:21.9419900Z -    return render_template('main/create_post.html', form=form)
2026-01-25T08:57:21.9420055Z +                flash(error, "danger")
2026-01-25T08:57:21.9420171Z +
2026-01-25T08:57:21.9420422Z +    return render_template("main/create_post.html", form=form)
2026-01-25T08:57:21.9420557Z  
2026-01-25T08:57:21.9420670Z  
2026-01-25T08:57:21.9420835Z -@bp.route('/post/<int:post_id>')
2026-01-25T08:57:21.9421019Z +@bp.route("/post/<int:post_id>")
2026-01-25T08:57:21.9421225Z  def view_post(post_id):
2026-01-25T08:57:21.9421452Z      """Просмотр отдельного поста."""
2026-01-25T08:57:21.9421633Z      post = PostService.find_by_id(post_id)
2026-01-25T08:57:21.9422020Z      if post is None:
2026-01-25T08:57:21.9422294Z          abort(404, description="Пост не найден")
2026-01-25T08:57:21.9422411Z -    
2026-01-25T08:57:21.9422525Z +
2026-01-25T08:57:21.9422744Z      # Получаем комментарии к посту
2026-01-25T08:57:21.9423167Z      comments = CommentService.get_by_post_id(post_id)
2026-01-25T08:57:21.9423324Z      comment_form = CommentForm()
2026-01-25T08:57:21.9423445Z -    
2026-01-25T08:57:21.9423968Z -    return render_template('main/view_post.html', post=post, comments=comments, comment_form=comment_form)
2026-01-25T08:57:21.9424089Z +
2026-01-25T08:57:21.9424246Z +    return render_template(
2026-01-25T08:57:21.9424611Z +        "main/view_post.html", post=post, comments=comments, comment_form=comment_form
2026-01-25T08:57:21.9424736Z +    )
2026-01-25T08:57:21.9424874Z  
2026-01-25T08:57:21.9424984Z  
2026-01-25T08:57:21.9425249Z -@bp.route('/post/<int:post_id>/edit', methods=['GET', 'POST'])
2026-01-25T08:57:21.9425511Z +@bp.route("/post/<int:post_id>/edit", methods=["GET", "POST"])
2026-01-25T08:57:21.9425660Z  @login_required
2026-01-25T08:57:21.9425812Z  def edit_post(post_id):
2026-01-25T08:57:21.9426101Z      """Редактирование поста (только для автора)."""
2026-01-25T08:57:21.9426282Z      post = PostService.find_by_id(post_id)
2026-01-25T08:57:21.9426427Z      if post is None:
2026-01-25T08:57:21.9426696Z          abort(404, description="Пост не найден")
2026-01-25T08:57:21.9426813Z -    
2026-01-25T08:57:21.9426989Z -    if not post.is_author(g.user['id']):
2026-01-25T08:57:21.9427100Z +
2026-01-25T08:57:21.9427268Z +    if not post.is_author(g.user["id"]):
2026-01-25T08:57:21.9427682Z          abort(403, description="Вы можете редактировать только свои посты")
2026-01-25T08:57:21.9427797Z -    
2026-01-25T08:57:21.9427917Z +
2026-01-25T08:57:21.9428344Z      form = PostForm(request.form)
2026-01-25T08:57:21.9428464Z -    
2026-01-25T08:57:21.9428686Z -    if request.method == 'POST' and form.validate():
2026-01-25T08:57:21.9428822Z +
2026-01-25T08:57:21.9429034Z +    if request.method == "POST" and form.validate():
2026-01-25T08:57:21.9429370Z          PostService.update(post_id, form.title.data, form.content.data)
2026-01-25T08:57:21.9429662Z -        flash('Пост успешно обновлён!', 'success')
2026-01-25T08:57:21.9429951Z -        return redirect(url_for('main.view_post', post_id=post_id))
2026-01-25T08:57:21.9430107Z -    elif request.method == 'GET':
2026-01-25T08:57:21.9430376Z +        flash("Пост успешно обновлён!", "success")
2026-01-25T08:57:21.9430661Z +        return redirect(url_for("main.view_post", post_id=post_id))
2026-01-25T08:57:21.9430813Z +    elif request.method == "GET":
2026-01-25T08:57:21.9431128Z          # Заполняем форму текущими данными поста
2026-01-25T08:57:21.9431299Z          form.title.data = post.title
2026-01-25T08:57:21.9431484Z          form.content.data = post.content
2026-01-25T08:57:21.9431605Z -    
2026-01-25T08:57:21.9431715Z +
2026-01-25T08:57:21.9432013Z      # Если форма не валидна при POST, показываем ошибки
2026-01-25T08:57:21.9432203Z -    elif request.method == 'POST':
2026-01-25T08:57:21.9432352Z +    elif request.method == "POST":
2026-01-25T08:57:21.9432590Z          for field_name, field_errors in form.errors.items():
2026-01-25T08:57:21.9432753Z              for error in field_errors:
2026-01-25T08:57:21.9433090Z -                flash(error, 'danger')
2026-01-25T08:57:21.9433221Z -    
2026-01-25T08:57:21.9433536Z -    return render_template('main/edit_post.html', form=form, post=post)
2026-01-25T08:57:21.9433689Z +                flash(error, "danger")
2026-01-25T08:57:21.9433797Z +
2026-01-25T08:57:21.9434112Z +    return render_template("main/edit_post.html", form=form, post=post)
2026-01-25T08:57:21.9434226Z  
2026-01-25T08:57:21.9434346Z  
2026-01-25T08:57:21.9434581Z -@bp.route('/post/<int:post_id>/delete', methods=['POST'])
2026-01-25T08:57:21.9434830Z +@bp.route("/post/<int:post_id>/delete", methods=["POST"])
2026-01-25T08:57:21.9434970Z  @login_required
2026-01-25T08:57:21.9435333Z  def delete_post(post_id):
2026-01-25T08:57:21.9435610Z      """Удаление поста (только для автора)."""
2026-01-25T08:57:21.9435798Z      post = PostService.find_by_id(post_id)
2026-01-25T08:57:21.9435943Z      if post is None:
2026-01-25T08:57:21.9436229Z          abort(404, description="Пост не найден")
2026-01-25T08:57:21.9436354Z -    
2026-01-25T08:57:21.9436524Z -    if not post.is_author(g.user['id']):
2026-01-25T08:57:21.9436642Z +
2026-01-25T08:57:21.9436801Z +    if not post.is_author(g.user["id"]):
2026-01-25T08:57:21.9437175Z          abort(403, description="Вы можете удалять только свои посты")
2026-01-25T08:57:21.9437316Z -    
2026-01-25T08:57:21.9437429Z +
2026-01-25T08:57:21.9437668Z      # Проверяем CSRF токен
2026-01-25T08:57:21.9437830Z      form = PostForm(request.form)
2026-01-25T08:57:21.9437978Z      if not form.validate():
2026-01-25T08:57:21.9438223Z          for field_name, field_errors in form.errors.items():
2026-01-25T08:57:21.9438379Z              for error in field_errors:
2026-01-25T08:57:21.9438547Z -                flash(error, 'danger')
2026-01-25T08:57:21.9438831Z -        return redirect(url_for('main.view_post', post_id=post_id))
2026-01-25T08:57:21.9438945Z -    
2026-01-25T08:57:21.9439093Z +                flash(error, "danger")
2026-01-25T08:57:21.9439382Z +        return redirect(url_for("main.view_post", post_id=post_id))
2026-01-25T08:57:21.9439497Z +
2026-01-25T08:57:21.9439676Z      PostService.delete(post_id)
2026-01-25T08:57:21.9439957Z -    flash('Пост успешно удалён!', 'success')
2026-01-25T08:57:21.9440131Z -    return redirect(url_for('main.index'))
2026-01-25T08:57:21.9440377Z +    flash("Пост успешно удалён!", "success")
2026-01-25T08:57:21.9440561Z +    return redirect(url_for("main.index"))
2026-01-25T08:57:21.9440676Z  
2026-01-25T08:57:21.9440796Z  
2026-01-25T08:57:21.9441278Z -@bp.route('/post/<int:post_id>/comment', methods=['POST'])
2026-01-25T08:57:21.9441522Z +@bp.route("/post/<int:post_id>/comment", methods=["POST"])
2026-01-25T08:57:21.9441676Z  @login_required
2026-01-25T08:57:21.9441823Z  def add_comment(post_id):
2026-01-25T08:57:21.9442081Z      """Добавление комментария к посту."""
2026-01-25T08:57:21.9442269Z      post = PostService.find_by_id(post_id)
2026-01-25T08:57:21.9442407Z      if post is None:
2026-01-25T08:57:21.9442682Z          abort(404, description="Пост не найден")
2026-01-25T08:57:21.9442816Z -    
2026-01-25T08:57:21.9443118Z +
2026-01-25T08:57:21.9443293Z      form = CommentForm(request.form)
2026-01-25T08:57:21.9443408Z -    
2026-01-25T08:57:21.9443519Z +
2026-01-25T08:57:21.9443666Z      if form.validate():
2026-01-25T08:57:21.9443837Z          comment = CommentService.create(
2026-01-25T08:57:21.9443987Z -            author_id=g.user['id'],
2026-01-25T08:57:21.9444138Z -            post_id=post_id,
2026-01-25T08:57:21.9444303Z -            content=form.content.data
2026-01-25T08:57:21.9444689Z +            author_id=g.user["id"], post_id=post_id, content=form.content.data
2026-01-25T08:57:21.9444922Z          )
2026-01-25T08:57:21.9445314Z -        flash('Комментарий успешно добавлен!', 'success')
2026-01-25T08:57:21.9445696Z +        flash("Комментарий успешно добавлен!", "success")
2026-01-25T08:57:21.9445921Z      else:
2026-01-25T08:57:21.9446413Z          # Показываем ошибки валидации
2026-01-25T08:57:21.9446757Z          for field_name, field_errors in form.errors.items():
2026-01-25T08:57:21.9447030Z              for error in field_errors:
2026-01-25T08:57:21.9447230Z -                flash(error, 'danger')
2026-01-25T08:57:21.9447451Z -    
2026-01-25T08:57:21.9470056Z -    return redirect(url_for('main.view_post', post_id=post_id))
2026-01-25T08:57:21.9470306Z +                flash(error, "danger")
2026-01-25T08:57:21.9470425Z +
2026-01-25T08:57:21.9470733Z +    return redirect(url_for("main.view_post", post_id=post_id))
2026-01-25T08:57:21.9470879Z  
2026-01-25T08:57:21.9470995Z  
2026-01-25T08:57:21.9471290Z -@bp.route('/comment/<int:comment_id>/delete', methods=['POST'])
2026-01-25T08:57:21.9471553Z +@bp.route("/comment/<int:comment_id>/delete", methods=["POST"])
2026-01-25T08:57:21.9472000Z  @login_required
2026-01-25T08:57:21.9472173Z  def delete_comment(comment_id):
2026-01-25T08:57:21.9472526Z      """Удаление комментария (только для автора)."""
2026-01-25T08:57:21.9472764Z      # Проверяем существование комментария
2026-01-25T08:57:21.9473205Z      comment = CommentService.find_by_id(comment_id)
2026-01-25T08:57:21.9473355Z      if comment is None:
2026-01-25T08:57:21.9473697Z          abort(404, description="Комментарий не найден")
2026-01-25T08:57:21.9473820Z -    
2026-01-25T08:57:21.9473934Z +
2026-01-25T08:57:21.9474193Z      # Проверяем CSRF токен через пустую форму
2026-01-25T08:57:21.9474372Z      form = CommentForm(request.form)
2026-01-25T08:57:21.9474525Z      if not form.validate():
2026-01-25T08:57:21.9474781Z          for field_name, field_errors in form.errors.items():
2026-01-25T08:57:21.9475268Z              for error in field_errors:
2026-01-25T08:57:21.9475437Z -                flash(error, 'danger')
2026-01-25T08:57:21.9475800Z -        return redirect(url_for('main.view_post', post_id=comment.post_id))
2026-01-25T08:57:21.9475920Z -    
2026-01-25T08:57:21.9476083Z +                flash(error, "danger")
2026-01-25T08:57:21.9476404Z +        return redirect(url_for("main.view_post", post_id=comment.post_id))
2026-01-25T08:57:21.9476525Z +
2026-01-25T08:57:21.9476843Z      # Удаляем комментарий (проверка прав внутри сервиса)
2026-01-25T08:57:21.9477097Z -    if CommentService.delete(comment_id, g.user['id']):
2026-01-25T08:57:21.9477424Z -        flash('Комментарий успешно удалён!', 'success')
2026-01-25T08:57:21.9477667Z +    if CommentService.delete(comment_id, g.user["id"]):
2026-01-25T08:57:21.9477941Z +        flash("Комментарий успешно удалён!", "success")
2026-01-25T08:57:21.9478069Z      else:
2026-01-25T08:57:21.9478429Z -        flash('Вы можете удалять только свои комментарии', 'danger')
2026-01-25T08:57:21.9478552Z -    
2026-01-25T08:57:21.9478877Z -    return redirect(url_for('main.view_post', post_id=comment.post_id))
2026-01-25T08:57:21.9479249Z +        flash("Вы можете удалять только свои комментарии", "danger")
2026-01-25T08:57:21.9479368Z +
2026-01-25T08:57:21.9479686Z +    return redirect(url_for("main.view_post", post_id=comment.post_id))
2026-01-25T08:57:21.9604456Z would reformat /home/runner/work/flask_blog/flask_blog/app/services/post_service.py
2026-01-25T08:57:21.9605080Z --- /home/runner/work/flask_blog/flask_blog/app/services/post_service.py	2026-01-25 08:57:06.651994+00:00
2026-01-25T08:57:21.9614282Z +++ /home/runner/work/flask_blog/flask_blog/app/services/post_service.py	2026-01-25 08:57:21.955030+00:00
2026-01-25T08:57:21.9614566Z @@ -1,158 +1,159 @@
2026-01-25T08:57:21.9615060Z  """Сервис для работы с постами блога."""
2026-01-25T08:57:21.9615177Z +
2026-01-25T08:57:21.9615363Z  from datetime import datetime
2026-01-25T08:57:21.9615624Z  from typing import Optional, List
2026-01-25T08:57:21.9615771Z  
2026-01-25T08:57:21.9615931Z  from app.db.db import get_db
2026-01-25T08:57:21.9616512Z  from app.models.post import Post
2026-01-25T08:57:21.9616633Z  
2026-01-25T08:57:21.9616760Z  
2026-01-25T08:57:21.9616908Z  class PostService:
2026-01-25T08:57:21.9617176Z      """Сервисный слой для работы с постами.
2026-01-25T08:57:21.9617310Z -    
2026-01-25T08:57:21.9617424Z +
2026-01-25T08:57:21.9617744Z      Вся логика работы с базой данных инкапсулирована здесь.
2026-01-25T08:57:21.9618118Z      Модель Post содержит только данные и базовую бизнес-логику.
2026-01-25T08:57:21.9618241Z      """
2026-01-25T08:57:21.9618354Z -    
2026-01-25T08:57:21.9618476Z +
2026-01-25T08:57:21.9618607Z      @staticmethod
2026-01-25T08:57:21.9618894Z      def create(author_id: int, title: str, content: str) -> Post:
2026-01-25T08:57:21.9619127Z          """Создаёт новый пост.
2026-01-25T08:57:21.9619250Z -        
2026-01-25T08:57:21.9619401Z +
2026-01-25T08:57:21.9619523Z          Args:
2026-01-25T08:57:21.9619743Z              author_id: ID автора
2026-01-25T08:57:21.9619986Z              title: Заголовок поста
2026-01-25T08:57:21.9620236Z              content: Содержание поста
2026-01-25T08:57:21.9620359Z -            
2026-01-25T08:57:21.9620480Z +
2026-01-25T08:57:21.9620601Z          Returns:
2026-01-25T08:57:21.9620973Z              Post: созданный пост с полной информацией
2026-01-25T08:57:21.9621157Z          """
2026-01-25T08:57:21.9621290Z          db = get_db()
2026-01-25T08:57:21.9621452Z          cursor = db.execute(
2026-01-25T08:57:21.9621765Z -            'INSERT INTO post (author_id, title, content) VALUES (?, ?, ?)',
2026-01-25T08:57:21.9621932Z -            (author_id, title, content)
2026-01-25T08:57:21.9622268Z +            "INSERT INTO post (author_id, title, content) VALUES (?, ?, ?)",
2026-01-25T08:57:21.9622426Z +            (author_id, title, content),
2026-01-25T08:57:21.9622545Z          )
2026-01-25T08:57:21.9623247Z          db.commit()
2026-01-25T08:57:21.9623378Z -        
2026-01-25T08:57:21.9623498Z +
2026-01-25T08:57:21.9623996Z          # Получаем созданный пост с информацией об авторе
2026-01-25T08:57:21.9624301Z          return PostService.find_by_id(cursor.lastrowid)
2026-01-25T08:57:21.9624423Z -    
2026-01-25T08:57:21.9624564Z +
2026-01-25T08:57:21.9624719Z      @staticmethod
2026-01-25T08:57:21.9624938Z      def find_by_id(post_id: int) -> Optional[Post]:
2026-01-25T08:57:21.9625219Z          """Находит пост по ID с информацией об авторе.
2026-01-25T08:57:21.9625350Z -        
2026-01-25T08:57:21.9625466Z +
2026-01-25T08:57:21.9625651Z          Args:
2026-01-25T08:57:21.9625868Z              post_id: ID поста
2026-01-25T08:57:21.9625989Z -            
2026-01-25T08:57:21.9626115Z +
2026-01-25T08:57:21.9626242Z          Returns:
2026-01-25T08:57:21.9626477Z              Post или None если не найден
2026-01-25T08:57:21.9626613Z          """
2026-01-25T08:57:21.9626749Z          db = get_db()
2026-01-25T08:57:21.9626914Z          row = db.execute(
2026-01-25T08:57:21.9627210Z -            '''SELECT p.id, p.author_id, p.title, p.content, p.created,
2026-01-25T08:57:21.9627549Z +            """SELECT p.id, p.author_id, p.title, p.content, p.created,
2026-01-25T08:57:21.9627755Z                        u.username, u.discriminator
2026-01-25T08:57:21.9627913Z                 FROM post p
2026-01-25T08:57:21.9628090Z                 JOIN user u ON p.author_id = u.id
2026-01-25T08:57:21.9628261Z -               WHERE p.id = ?''',
2026-01-25T08:57:21.9628412Z -            (post_id,)
2026-01-25T08:57:21.9628600Z +               WHERE p.id = ?""",
2026-01-25T08:57:21.9628760Z +            (post_id,),
2026-01-25T08:57:21.9628929Z          ).fetchone()
2026-01-25T08:57:21.9629067Z -        
2026-01-25T08:57:21.9629193Z +
2026-01-25T08:57:21.9629350Z          if row is None:
2026-01-25T08:57:21.9629481Z              return None
2026-01-25T08:57:21.9629627Z -            
2026-01-25T08:57:21.9629750Z +
2026-01-25T08:57:21.9629923Z          return Post(
2026-01-25T08:57:21.9630060Z -            id=row['id'],
2026-01-25T08:57:21.9630277Z -            author_id=row['author_id'],
2026-01-25T08:57:21.9630707Z -            title=row['title'],
2026-01-25T08:57:21.9630927Z -            content=row['content'],
2026-01-25T08:57:21.9631246Z -            created=row['created'] if row['created'] else None,
2026-01-25T08:57:21.9631448Z -            author_username=row['username'],
2026-01-25T08:57:21.9631664Z -            author_discriminator=row['discriminator'],
2026-01-25T08:57:21.9632242Z -            comment_count=0  # Для单个 поста не считаем комментарии для производительности
2026-01-25T08:57:21.9632427Z +            id=row["id"],
2026-01-25T08:57:21.9632591Z +            author_id=row["author_id"],
2026-01-25T08:57:21.9632716Z +            title=row["title"],
2026-01-25T08:57:21.9632871Z +            content=row["content"],
2026-01-25T08:57:21.9633272Z +            created=row["created"] if row["created"] else None,
2026-01-25T08:57:21.9633478Z +            author_username=row["username"],
2026-01-25T08:57:21.9633654Z +            author_discriminator=row["discriminator"],
2026-01-25T08:57:21.9634048Z +            comment_count=0,  # Для单个 поста не считаем комментарии для производительности
2026-01-25T08:57:21.9634156Z          )
2026-01-25T08:57:21.9634296Z -    
2026-01-25T08:57:21.9634399Z +
2026-01-25T08:57:21.9634508Z      @staticmethod
2026-01-25T08:57:21.9634653Z      def get_all() -> List[Post]:
2026-01-25T08:57:21.9635138Z          """Возвращает список всех постов с информацией об авторах и количеством комментариев.
2026-01-25T08:57:21.9635240Z -        
2026-01-25T08:57:21.9635337Z +
2026-01-25T08:57:21.9635444Z          Returns:
2026-01-25T08:57:21.9635771Z              List[Post]: список постов, отсортированных по дате создания (новые первые)
2026-01-25T08:57:21.9635873Z          """
2026-01-25T08:57:21.9635990Z          db = get_db()
2026-01-25T08:57:21.9636111Z -        rows = db.execute(
2026-01-25T08:57:21.9636676Z -            '''SELECT p.id, p.author_id, p.title, p.content, p.created,
2026-01-25T08:57:21.9636970Z +        rows = db.execute("""SELECT p.id, p.author_id, p.title, p.content, p.created,
2026-01-25T08:57:21.9637138Z                        u.username, u.discriminator,
2026-01-25T08:57:21.9637355Z                        COALESCE(c.comment_count, 0) as comment_count
2026-01-25T08:57:21.9637469Z                 FROM post p
2026-01-25T08:57:21.9637626Z                 JOIN user u ON p.author_id = u.id
2026-01-25T08:57:21.9637742Z                 LEFT JOIN (
2026-01-25T08:57:21.9637922Z                     SELECT post_id, COUNT(*) as comment_count 
2026-01-25T08:57:21.9638043Z                     FROM comment 
2026-01-25T08:57:21.9638171Z                     GROUP BY post_id
2026-01-25T08:57:21.9638296Z                 ) c ON p.id = c.post_id
2026-01-25T08:57:21.9638437Z -               ORDER BY p.created DESC'''
2026-01-25T08:57:21.9638543Z -        ).fetchall()
2026-01-25T08:57:21.9638640Z -        
2026-01-25T08:57:21.9638815Z +               ORDER BY p.created DESC""").fetchall()
2026-01-25T08:57:21.9638909Z +
2026-01-25T08:57:21.9639025Z          posts = []
2026-01-25T08:57:21.9639197Z          for row in rows:
2026-01-25T08:57:21.9639328Z -            posts.append(Post(
2026-01-25T08:57:21.9639439Z -                id=row['id'],
2026-01-25T08:57:21.9639583Z -                author_id=row['author_id'],
2026-01-25T08:57:21.9639707Z -                title=row['title'],
2026-01-25T08:57:21.9639841Z -                content=row['content'],
2026-01-25T08:57:21.9640048Z -                created=row['created'] if row['created'] else None,
2026-01-25T08:57:21.9640199Z -                author_username=row['username'],
2026-01-25T08:57:21.9640403Z -                author_discriminator=row['discriminator'],
2026-01-25T08:57:21.9640551Z -                comment_count=row['comment_count']
2026-01-25T08:57:21.9640654Z -            ))
2026-01-25T08:57:21.9640762Z -        
2026-01-25T08:57:21.9640883Z +            posts.append(
2026-01-25T08:57:21.9641029Z +                Post(
2026-01-25T08:57:21.9641189Z +                    id=row["id"],
2026-01-25T08:57:21.9641325Z +                    author_id=row["author_id"],
2026-01-25T08:57:21.9641630Z +                    title=row["title"],
2026-01-25T08:57:21.9641758Z +                    content=row["content"],
2026-01-25T08:57:21.9641961Z +                    created=row["created"] if row["created"] else None,
2026-01-25T08:57:21.9642122Z +                    author_username=row["username"],
2026-01-25T08:57:21.9642420Z +                    author_discriminator=row["discriminator"],
2026-01-25T08:57:21.9642599Z +                    comment_count=row["comment_count"],
2026-01-25T08:57:21.9642706Z +                )
2026-01-25T08:57:21.9642805Z +            )
2026-01-25T08:57:21.9673189Z +
2026-01-25T08:57:21.9673418Z          return posts
2026-01-25T08:57:21.9673517Z -    
2026-01-25T08:57:21.9673621Z +
2026-01-25T08:57:21.9673726Z      @staticmethod
2026-01-25T08:57:21.9673970Z      def update(post_id: int, title: str, content: str) -> bool:
2026-01-25T08:57:21.9674297Z          """Обновляет заголовок и содержание поста.
2026-01-25T08:57:21.9674427Z -        
2026-01-25T08:57:21.9674536Z +
2026-01-25T08:57:21.9674657Z          Args:
2026-01-25T08:57:21.9674861Z              post_id: ID поста
2026-01-25T08:57:21.9675067Z              title: Новый заголовок
2026-01-25T08:57:21.9675304Z              content: Новое содержание
2026-01-25T08:57:21.9675430Z -            
2026-01-25T08:57:21.9675546Z +
2026-01-25T08:57:21.9675693Z          Returns:
2026-01-25T08:57:21.9675963Z              bool: True если обновление успешно
2026-01-25T08:57:21.9676103Z          """
2026-01-25T08:57:21.9676245Z          db = get_db()
2026-01-25T08:57:21.9676393Z          cursor = db.execute(
2026-01-25T08:57:21.9676659Z -            'UPDATE post SET title = ?, content = ? WHERE id = ?',
2026-01-25T08:57:21.9676821Z -            (title, content, post_id)
2026-01-25T08:57:21.9677069Z +            "UPDATE post SET title = ?, content = ? WHERE id = ?",
2026-01-25T08:57:21.9677582Z +            (title, content, post_id),
2026-01-25T08:57:21.9677706Z          )
2026-01-25T08:57:21.9677854Z          db.commit()
2026-01-25T08:57:21.9677977Z -        
2026-01-25T08:57:21.9678092Z +
2026-01-25T08:57:21.9678254Z          return cursor.rowcount > 0
2026-01-25T08:57:21.9678381Z -    
2026-01-25T08:57:21.9678494Z +
2026-01-25T08:57:21.9678633Z      @staticmethod
2026-01-25T08:57:21.9678806Z      def delete(post_id: int) -> bool:
2026-01-25T08:57:21.9679037Z          """Удаляет пост.
2026-01-25T08:57:21.9679170Z -        
2026-01-25T08:57:21.9679282Z +
2026-01-25T08:57:21.9679405Z          Args:
2026-01-25T08:57:21.9679639Z              post_id: ID поста
2026-01-25T08:57:21.9679765Z -            
2026-01-25T08:57:21.9679881Z +
2026-01-25T08:57:21.9680010Z          Returns:
2026-01-25T08:57:21.9680257Z              bool: True если удаление успешно
2026-01-25T08:57:21.9680387Z          """
2026-01-25T08:57:21.9680533Z          db = get_db()
2026-01-25T08:57:21.9680871Z -        cursor = db.execute('DELETE FROM post WHERE id = ?', (post_id,))
2026-01-25T08:57:21.9681178Z +        cursor = db.execute("DELETE FROM post WHERE id = ?", (post_id,))
2026-01-25T08:57:21.9681344Z          db.commit()
2026-01-25T08:57:21.9681459Z -        
2026-01-25T08:57:21.9681584Z +
2026-01-25T08:57:21.9681746Z          return cursor.rowcount > 0
2026-01-25T08:57:21.9681861Z -    
2026-01-25T08:57:21.9681985Z +
2026-01-25T08:57:21.9682129Z      @staticmethod
2026-01-25T08:57:21.9682294Z      def exists(post_id: int) -> bool:
2026-01-25T08:57:21.9682693Z          """Проверяет существование поста.
2026-01-25T08:57:21.9682816Z -        
2026-01-25T08:57:21.9683166Z +
2026-01-25T08:57:21.9683312Z          Args:
2026-01-25T08:57:21.9683567Z              post_id: ID поста
2026-01-25T08:57:21.9683711Z -            
2026-01-25T08:57:21.9683830Z +
2026-01-25T08:57:21.9683953Z          Returns:
2026-01-25T08:57:21.9684213Z              bool: True если пост существует
2026-01-25T08:57:21.9684351Z          """
2026-01-25T08:57:21.9684509Z          db = get_db()
2026-01-25T08:57:21.9684898Z -        row = db.execute('SELECT 1 FROM post WHERE id = ?', (post_id,)).fetchone()
2026-01-25T08:57:21.9685480Z +        row = db.execute("SELECT 1 FROM post WHERE id = ?", (post_id,)).fetchone()
2026-01-25T08:57:21.9685642Z          return row is not None
2026-01-25T08:57:21.9810356Z --- /home/runner/work/flask_blog/flask_blog/app/services/comment_service.py	2026-01-25 08:57:06.651994+00:00
2026-01-25T08:57:21.9811333Z +++ /home/runner/work/flask_blog/flask_blog/app/services/comment_service.py	2026-01-25 08:57:21.978049+00:00
2026-01-25T08:57:21.9811618Z @@ -1,185 +1,189 @@
2026-01-25T08:57:21.9812161Z  """Сервис для работы с комментариями к постам блога."""
2026-01-25T08:57:21.9812456Z +
2026-01-25T08:57:21.9812838Z  from datetime import datetime
2026-01-25T08:57:21.9813547Z  from typing import Optional, List
2026-01-25T08:57:21.9813809Z  
2026-01-25T08:57:21.9814192Z  from app.db.db import get_db
2026-01-25T08:57:21.9815147Z  from app.models.comment import Comment
2026-01-25T08:57:21.9815447Z  
2026-01-25T08:57:21.9815688Z  
2026-01-25T08:57:21.9815977Z  class CommentService:
2026-01-25T08:57:21.9816417Z      """Сервисный слой для работы с комментариями.
2026-01-25T08:57:21.9816760Z -    
2026-01-25T08:57:21.9817075Z +
2026-01-25T08:57:21.9817515Z      Вся логика работы с базой данных инкапсулирована здесь.
2026-01-25T08:57:21.9818102Z      Модель Comment содержит только данные и базовую бизнес-логику.
2026-01-25T08:57:21.9818450Z      """
2026-01-25T08:57:21.9818832Z -    
2026-01-25T08:57:21.9819058Z +
2026-01-25T08:57:21.9819320Z      @staticmethod
2026-01-25T08:57:21.9819787Z      def create(author_id: int, post_id: int, content: str) -> Comment:
2026-01-25T08:57:21.9820233Z          """Создаёт новый комментарий.
2026-01-25T08:57:21.9820482Z -        
2026-01-25T08:57:21.9820722Z +
2026-01-25T08:57:21.9820952Z          Args:
2026-01-25T08:57:21.9821313Z              author_id: ID автора
2026-01-25T08:57:21.9821752Z              post_id: ID поста
2026-01-25T08:57:21.9822152Z              content: Текст комментария
2026-01-25T08:57:21.9822438Z -            
2026-01-25T08:57:21.9823193Z +
2026-01-25T08:57:21.9823482Z          Returns:
2026-01-25T08:57:21.9824015Z              Comment: созданный комментарий с полной информацией
2026-01-25T08:57:21.9824354Z          """
2026-01-25T08:57:21.9824642Z          db = get_db()
2026-01-25T08:57:21.9824892Z          cursor = db.execute(
2026-01-25T08:57:21.9825420Z -            'INSERT INTO comment (author_id, post_id, content) VALUES (?, ?, ?)',
2026-01-25T08:57:21.9825827Z -            (author_id, post_id, content)
2026-01-25T08:57:21.9826355Z +            "INSERT INTO comment (author_id, post_id, content) VALUES (?, ?, ?)",
2026-01-25T08:57:21.9826674Z +            (author_id, post_id, content),
2026-01-25T08:57:21.9826920Z          )
2026-01-25T08:57:21.9827275Z          db.commit()
2026-01-25T08:57:21.9827603Z -        
2026-01-25T08:57:21.9827845Z +
2026-01-25T08:57:21.9828345Z          # Получаем созданный комментарий с информацией об авторе
2026-01-25T08:57:21.9828924Z          return CommentService.find_by_id(cursor.lastrowid)
2026-01-25T08:57:21.9829500Z -    
2026-01-25T08:57:21.9829727Z +
2026-01-25T08:57:21.9829958Z      @staticmethod
2026-01-25T08:57:21.9830328Z      def find_by_id(comment_id: int) -> Optional[Comment]:
2026-01-25T08:57:21.9830771Z          """Находит комментарий по ID с информацией об авторе.
2026-01-25T08:57:21.9835466Z -        
2026-01-25T08:57:21.9835605Z +
2026-01-25T08:57:21.9835757Z          Args:
2026-01-25T08:57:21.9836056Z              comment_id: ID комментария
2026-01-25T08:57:21.9836177Z -            
2026-01-25T08:57:21.9836290Z +
2026-01-25T08:57:21.9836427Z          Returns:
2026-01-25T08:57:21.9836693Z              Comment или None если не найден
2026-01-25T08:57:21.9836818Z          """
2026-01-25T08:57:21.9836957Z          db = get_db()
2026-01-25T08:57:21.9837102Z          row = db.execute(
2026-01-25T08:57:21.9837447Z -            '''SELECT c.id, c.author_id, c.post_id, c.content, c.created,
2026-01-25T08:57:21.9837727Z +            """SELECT c.id, c.author_id, c.post_id, c.content, c.created,
2026-01-25T08:57:21.9838121Z                        u.username as author_username, u.discriminator as author_discriminator
2026-01-25T08:57:21.9838279Z                 FROM comment c
2026-01-25T08:57:21.9838474Z                 JOIN user u ON c.author_id = u.id
2026-01-25T08:57:21.9838623Z -               WHERE c.id = ?''',
2026-01-25T08:57:21.9838772Z -            (comment_id,)
2026-01-25T08:57:21.9838908Z +               WHERE c.id = ?""",
2026-01-25T08:57:21.9839048Z +            (comment_id,),
2026-01-25T08:57:21.9839181Z          ).fetchone()
2026-01-25T08:57:21.9839295Z -        
2026-01-25T08:57:21.9839412Z +
2026-01-25T08:57:21.9839554Z          if row is None:
2026-01-25T08:57:21.9839691Z              return None
2026-01-25T08:57:21.9839816Z -            
2026-01-25T08:57:21.9839936Z +
2026-01-25T08:57:21.9840378Z          return Comment(
2026-01-25T08:57:21.9840536Z -            id=row['id'],
2026-01-25T08:57:21.9840701Z -            author_id=row['author_id'],
2026-01-25T08:57:21.9840873Z -            post_id=row['post_id'],
2026-01-25T08:57:21.9841030Z -            content=row['content'],
2026-01-25T08:57:21.9841570Z -            created=datetime.fromisoformat(row['created']) if isinstance(row['created'], str) else row['created'],
2026-01-25T08:57:21.9841771Z -            author_username=row['author_username'],
2026-01-25T08:57:21.9842019Z -            author_discriminator=row['author_discriminator']
2026-01-25T08:57:21.9842160Z +            id=row["id"],
2026-01-25T08:57:21.9842326Z +            author_id=row["author_id"],
2026-01-25T08:57:21.9842479Z +            post_id=row["post_id"],
2026-01-25T08:57:21.9842625Z +            content=row["content"],
2026-01-25T08:57:21.9842758Z +            created=(
2026-01-25T08:57:21.9843173Z +                datetime.fromisoformat(row["created"])
2026-01-25T08:57:21.9843375Z +                if isinstance(row["created"], str)
2026-01-25T08:57:21.9843536Z +                else row["created"]
2026-01-25T08:57:21.9843655Z +            ),
2026-01-25T08:57:21.9843890Z +            author_username=row["author_username"],
2026-01-25T08:57:21.9844135Z +            author_discriminator=row["author_discriminator"],
2026-01-25T08:57:21.9844268Z          )
2026-01-25T08:57:21.9844391Z -    
2026-01-25T08:57:21.9844507Z +
2026-01-25T08:57:21.9844636Z      @staticmethod
2026-01-25T08:57:21.9844869Z      def get_by_post_id(post_id: int) -> List[Comment]:
2026-01-25T08:57:21.9845244Z          """Получает все комментарии к посту с информацией об авторах.
2026-01-25T08:57:21.9845373Z -        
2026-01-25T08:57:21.9845496Z +
2026-01-25T08:57:21.9845621Z          Args:
2026-01-25T08:57:21.9845833Z              post_id: ID поста
2026-01-25T08:57:21.9845961Z -            
2026-01-25T08:57:21.9846077Z +
2026-01-25T08:57:21.9846201Z          Returns:
2026-01-25T08:57:21.9846632Z              List[Comment]: список комментариев, отсортированных по времени создания
2026-01-25T08:57:21.9846775Z          """
2026-01-25T08:57:21.9846916Z          db = get_db()
2026-01-25T08:57:21.9847302Z          rows = db.execute(
2026-01-25T08:57:21.9847592Z -            '''SELECT c.id, c.author_id, c.post_id, c.content, c.created,
2026-01-25T08:57:21.9847877Z +            """SELECT c.id, c.author_id, c.post_id, c.content, c.created,
2026-01-25T08:57:21.9848257Z                        u.username as author_username, u.discriminator as author_discriminator
2026-01-25T08:57:21.9848406Z                 FROM comment c
2026-01-25T08:57:21.9848588Z                 JOIN user u ON c.author_id = u.id
2026-01-25T08:57:21.9848740Z                 WHERE c.post_id = ?
2026-01-25T08:57:21.9848900Z -               ORDER BY c.created ASC''',
2026-01-25T08:57:21.9849043Z -            (post_id,)
2026-01-25T08:57:21.9849209Z +               ORDER BY c.created ASC""",
2026-01-25T08:57:21.9849355Z +            (post_id,),
2026-01-25T08:57:21.9849502Z          ).fetchall()
2026-01-25T08:57:21.9849620Z -        
2026-01-25T08:57:21.9849739Z +
2026-01-25T08:57:21.9849871Z          comments = []
2026-01-25T08:57:21.9850016Z          for row in rows:
2026-01-25T08:57:21.9850188Z -            comments.append(Comment(
2026-01-25T08:57:21.9850338Z -                id=row['id'],
2026-01-25T08:57:21.9850503Z -                author_id=row['author_id'],
2026-01-25T08:57:21.9850670Z -                post_id=row['post_id'],
2026-01-25T08:57:21.9850819Z -                content=row['content'],
2026-01-25T08:57:21.9851368Z -                created=datetime.fromisoformat(row['created']) if isinstance(row['created'], str) else row['created'],
2026-01-25T08:57:21.9851576Z -                author_username=row['author_username'],
2026-01-25T08:57:21.9851821Z -                author_discriminator=row['author_discriminator']
2026-01-25T08:57:21.9851953Z -            ))
2026-01-25T08:57:21.9852075Z -        
2026-01-25T08:57:21.9852227Z +            comments.append(
2026-01-25T08:57:21.9852575Z +                Comment(
2026-01-25T08:57:21.9852721Z +                    id=row["id"],
2026-01-25T08:57:21.9853088Z +                    author_id=row["author_id"],
2026-01-25T08:57:21.9853281Z +                    post_id=row["post_id"],
2026-01-25T08:57:21.9853439Z +                    content=row["content"],
2026-01-25T08:57:21.9853583Z +                    created=(
2026-01-25T08:57:21.9853808Z +                        datetime.fromisoformat(row["created"])
2026-01-25T08:57:21.9854005Z +                        if isinstance(row["created"], str)
2026-01-25T08:57:21.9854173Z +                        else row["created"]
2026-01-25T08:57:21.9854317Z +                    ),
2026-01-25T08:57:21.9854532Z +                    author_username=row["author_username"],
2026-01-25T08:57:21.9854794Z +                    author_discriminator=row["author_discriminator"],
2026-01-25T08:57:21.9854916Z +                )
2026-01-25T08:57:21.9855038Z +            )
2026-01-25T08:57:21.9855160Z +
2026-01-25T08:57:21.9855299Z          return comments
2026-01-25T08:57:21.9855423Z -    
2026-01-25T08:57:21.9855564Z +
2026-01-25T08:57:21.9855690Z      @staticmethod
2026-01-25T08:57:21.9855926Z      def delete(comment_id: int, user_id: int) -> bool:
2026-01-25T08:57:21.9856315Z          """Удаляет комментарий (только если пользователь является автором).
2026-01-25T08:57:21.9856442Z -        
2026-01-25T08:57:21.9856564Z +
2026-01-25T08:57:21.9856689Z          Args:
2026-01-25T08:57:21.9856950Z              comment_id: ID комментария
2026-01-25T08:57:21.9857385Z              user_id: ID пользователя, который пытается удалить
2026-01-25T08:57:21.9857508Z -            
2026-01-25T08:57:21.9857632Z +
2026-01-25T08:57:21.9857753Z          Returns:
2026-01-25T08:57:21.9858158Z              bool: True если комментарий удалён, False если нет прав или не найден
2026-01-25T08:57:21.9858291Z          """
2026-01-25T08:57:21.9858425Z          db = get_db()
2026-01-25T08:57:21.9858541Z -        
2026-01-25T08:57:21.9858696Z +
2026-01-25T08:57:21.9859020Z          # Проверяем, что пользователь является автором комментария
2026-01-25T08:57:21.9859166Z          comment = db.execute(
2026-01-25T08:57:21.9859619Z -            'SELECT author_id FROM comment WHERE id = ?',
2026-01-25T08:57:21.9859823Z -            (comment_id,)
2026-01-25T08:57:21.9860144Z +            "SELECT author_id FROM comment WHERE id = ?", (comment_id,)
2026-01-25T08:57:21.9860280Z          ).fetchone()
2026-01-25T08:57:21.9860401Z -        
2026-01-25T08:57:21.9860651Z -        if comment is None or comment['author_id'] != user_id:
2026-01-25T08:57:21.9860768Z +
2026-01-25T08:57:21.9860998Z +        if comment is None or comment["author_id"] != user_id:
2026-01-25T08:57:21.9861139Z              return False
2026-01-25T08:57:21.9861251Z -        
2026-01-25T08:57:21.9861362Z +
2026-01-25T08:57:21.9861593Z          # Удаляем комментарий
2026-01-25T08:57:21.9861735Z -        cursor = db.execute(
2026-01-25T08:57:21.9861915Z -            'DELETE FROM comment WHERE id = ?',
2026-01-25T08:57:21.9862076Z -            (comment_id,)
2026-01-25T08:57:21.9862194Z -        )
2026-01-25T08:57:21.9862524Z +        cursor = db.execute("DELETE FROM comment WHERE id = ?", (comment_id,))
2026-01-25T08:57:21.9862672Z          db.commit()
2026-01-25T08:57:21.9862786Z -        
2026-01-25T08:57:21.9863091Z +
2026-01-25T08:57:21.9863260Z          return cursor.rowcount > 0
2026-01-25T08:57:21.9863378Z -    
2026-01-25T08:57:21.9863500Z +
2026-01-25T08:57:21.9863627Z      @staticmethod
2026-01-25T08:57:21.9863834Z      def get_count_by_post_id(post_id: int) -> int:
2026-01-25T08:57:21.9864142Z          """Получает количество комментариев к посту.
2026-01-25T08:57:21.9864261Z -        
2026-01-25T08:57:21.9864375Z +
2026-01-25T08:57:21.9864504Z          Args:
2026-01-25T08:57:21.9864718Z              post_id: ID поста
2026-01-25T08:57:21.9864847Z -            
2026-01-25T08:57:21.9864961Z +
2026-01-25T08:57:21.9865083Z          Returns:
2026-01-25T08:57:21.9865544Z              int: количество комментариев
2026-01-25T08:57:21.9865672Z          """
2026-01-25T08:57:21.9865807Z          db = get_db()
2026-01-25T08:57:21.9865951Z          row = db.execute(
2026-01-25T08:57:21.9866251Z -            'SELECT COUNT(*) as count FROM comment WHERE post_id = ?',
2026-01-25T08:57:21.9866417Z -            (post_id,)
2026-01-25T08:57:21.9866746Z +            "SELECT COUNT(*) as count FROM comment WHERE post_id = ?", (post_id,)
2026-01-25T08:57:21.9866893Z          ).fetchone()
2026-01-25T08:57:21.9867029Z -        
2026-01-25T08:57:21.9867206Z -        return row['count'] if row else 0
2026-01-25T08:57:21.9867320Z -    
2026-01-25T08:57:21.9867457Z +
2026-01-25T08:57:21.9867639Z +        return row["count"] if row else 0
2026-01-25T08:57:21.9867769Z +
2026-01-25T08:57:21.9867955Z      @staticmethod
2026-01-25T08:57:21.9868257Z      def update(comment_id: int, user_id: int, content: str) -> bool:
2026-01-25T08:57:21.9868701Z          """Обновляет текст комментария (только если пользователь является автором).
2026-01-25T08:57:21.9868867Z -        
2026-01-25T08:57:21.9869002Z +
2026-01-25T08:57:21.9869122Z          Args:
2026-01-25T08:57:21.9869417Z              comment_id: ID комментария
2026-01-25T08:57:21.9869817Z              user_id: ID пользователя, который пытается обновить
2026-01-25T08:57:21.9870093Z              content: Новый текст комментария
2026-01-25T08:57:21.9870228Z -            
2026-01-25T08:57:21.9870357Z +
2026-01-25T08:57:21.9870485Z          Returns:
2026-01-25T08:57:21.9870921Z              bool: True если комментарий обновлён, False если нет прав или не найден
2026-01-25T08:57:21.9871058Z          """
2026-01-25T08:57:21.9871212Z          db = get_db()
2026-01-25T08:57:21.9871329Z -        
2026-01-25T08:57:21.9871457Z +
2026-01-25T08:57:21.9871855Z          # Проверяем, что пользователь является автором комментария
2026-01-25T08:57:21.9872054Z          comment = db.execute(
2026-01-25T08:57:21.9872288Z -            'SELECT author_id FROM comment WHERE id = ?',
2026-01-25T08:57:21.9872467Z -            (comment_id,)
2026-01-25T08:57:21.9872768Z +            "SELECT author_id FROM comment WHERE id = ?", (comment_id,)
2026-01-25T08:57:21.9873463Z          ).fetchone()
2026-01-25T08:57:21.9873598Z -        
2026-01-25T08:57:21.9873872Z -        if comment is None or comment['author_id'] != user_id:
2026-01-25T08:57:21.9874001Z +
2026-01-25T08:57:21.9874236Z +        if comment is None or comment["author_id"] != user_id:
2026-01-25T08:57:21.9874437Z              return False
2026-01-25T08:57:21.9874604Z -        
2026-01-25T08:57:21.9874741Z +
2026-01-25T08:57:21.9874997Z          # Обновляем комментарий
2026-01-25T08:57:21.9875167Z          cursor = db.execute(
2026-01-25T08:57:21.9875413Z -            'UPDATE comment SET content = ? WHERE id = ?',
2026-01-25T08:57:21.9875596Z -            (content, comment_id)
2026-01-25T08:57:21.9875992Z +            "UPDATE comment SET content = ? WHERE id = ?", (content, comment_id)
2026-01-25T08:57:21.9876121Z          )
2026-01-25T08:57:21.9876505Z          db.commit()
2026-01-25T08:57:21.9876625Z -        
2026-01-25T08:57:21.9876744Z +
2026-01-25T08:57:21.9876975Z          return cursor.rowcount > 0
2026-01-25T08:57:21.9910658Z would reformat /home/runner/work/flask_blog/flask_blog/app/services/comment_service.py
2026-01-25T08:57:22.0881533Z would reformat /home/runner/work/flask_blog/flask_blog/tests/base.py
2026-01-25T08:57:22.0882593Z --- /home/runner/work/flask_blog/flask_blog/tests/base.py	2026-01-25 08:57:06.653994+00:00
2026-01-25T08:57:22.0883791Z +++ /home/runner/work/flask_blog/flask_blog/tests/base.py	2026-01-25 08:57:22.084527+00:00
2026-01-25T08:57:22.0884473Z @@ -6,210 +6,228 @@
2026-01-25T08:57:22.0884842Z  from app.auth import hash_password
2026-01-25T08:57:22.0885269Z  
2026-01-25T08:57:22.0885616Z  
2026-01-25T08:57:22.0885912Z  class BaseTestCase:
2026-01-25T08:57:22.0886701Z      """Базовый класс с общими методами для всех тестов."""
2026-01-25T08:57:22.0887266Z -    
2026-01-25T08:57:22.0887564Z +
2026-01-25T08:57:22.0888126Z      def assert_csrf_validation(self, token, expected=True):
2026-01-25T08:57:22.0888829Z          """Унифицированная проверка CSRF валидации.
2026-01-25T08:57:22.0889308Z -        
2026-01-25T08:57:22.0889596Z +
2026-01-25T08:57:22.0889865Z          Args:
2026-01-25T08:57:22.0890320Z              token: CSRF токен для проверки
2026-01-25T08:57:22.0890956Z              expected: Ожидаемый результат (True/False)
2026-01-25T08:57:22.0891415Z          """
2026-01-25T08:57:22.0891752Z          result = validate_csrf_token(token)
2026-01-25T08:57:22.0892522Z -        assert result is expected, f"CSRF validation failed: expected {expected}, got {result}"
2026-01-25T08:57:22.0893530Z -    
2026-01-25T08:57:22.0893829Z +        assert (
2026-01-25T08:57:22.0894178Z +            result is expected
2026-01-25T08:57:22.0894846Z +        ), f"CSRF validation failed: expected {expected}, got {result}"
2026-01-25T08:57:22.0895415Z +
2026-01-25T08:57:22.0895732Z      def assert_csrf_token_generation(self):
2026-01-25T08:57:22.0896354Z          """Проверка генерации CSRF токена."""
2026-01-25T08:57:22.0896828Z          token = generate_csrf_token()
2026-01-25T08:57:22.0897277Z          assert token is not None
2026-01-25T08:57:22.0898169Z          assert len(token) > 0
2026-01-25T08:57:22.0898613Z          assert len(token) == 64  # SHA256 hex
2026-01-25T08:57:22.0899061Z          return token
2026-01-25T08:57:22.0899391Z -    
2026-01-25T08:57:22.0901128Z -    def create_test_user_data(self, username="test_user", discriminator=1234, ***):
2026-01-25T08:57:22.0901858Z +
2026-01-25T08:57:22.0902169Z +    def create_test_user_data(
2026-01-25T08:57:22.0902818Z +        self, username="test_user", discriminator=1234, ***
2026-01-25T08:57:22.0903670Z +    ):
2026-01-25T08:57:22.0904180Z          """Создание данных для тестового пользователя.
2026-01-25T08:57:22.0904646Z -        
2026-01-25T08:57:22.0904936Z +
2026-01-25T08:57:22.0905209Z          Returns:
2026-01-25T08:57:22.0905705Z              dict: Данные пользователя с хэшированным паролем
2026-01-25T08:57:22.0906218Z          """
2026-01-25T08:57:22.0906602Z          hashed_pw, salt = hash_password(password)
2026-01-25T08:57:22.0907085Z          return {
2026-01-25T08:57:22.0907481Z -            'username': username,
2026-01-25T08:57:22.0907963Z -            'discriminator': discriminator,
2026-01-25T08:57:22.0908446Z -            'password': password,
2026-01-25T08:57:22.0908893Z -            'hashed_password': hashed_pw,
2026-01-25T08:57:22.0909344Z -            'salt': salt
2026-01-25T08:57:22.0909751Z +            "username": username,
2026-01-25T08:57:22.0910207Z +            "discriminator": discriminator,
2026-01-25T08:57:22.0910698Z +            "password": password,
2026-01-25T08:57:22.0911135Z +            "hashed_password": hashed_pw,
2026-01-25T08:57:22.0911574Z +            "salt": salt,
2026-01-25T08:57:22.0911936Z          }
2026-01-25T08:57:22.0912226Z -    
2026-01-25T08:57:22.0912500Z +
2026-01-25T08:57:22.0913170Z      def assert_form_validation_error(self, response, error_keywords=None):
2026-01-25T08:57:22.0914494Z          """Проверка наличия ошибок валидации в ответе.
2026-01-25T08:57:22.0914967Z -        
2026-01-25T08:57:22.0915276Z +
2026-01-25T08:57:22.0915559Z          Args:
2026-01-25T08:57:22.0916012Z              response: Response объект
2026-01-25T08:57:22.0916681Z              error_keywords: Список ключевых слов для поиска в ошибке
2026-01-25T08:57:22.0917234Z          """
2026-01-25T08:57:22.0917627Z          assert response.status_code == 200
2026-01-25T08:57:22.0918208Z -        response_text = response.data.decode('utf-8').lower()
2026-01-25T08:57:22.0918766Z -        
2026-01-25T08:57:22.0919180Z +        response_text = response.data.decode("utf-8").lower()
2026-01-25T08:57:22.0919720Z +
2026-01-25T08:57:22.0920108Z          # Стандартные проверки ошибок
2026-01-25T08:57:22.0921006Z -        error_indicators = ['alert-danger', 'ошибка', 'обязательно', 'должно быть', 'формат', 'неверный']
2026-01-25T08:57:22.0921968Z -        assert any(indicator in response_text for indicator in error_indicators), \
2026-01-25T08:57:22.0923123Z -            f"No validation error found in response: {response_text[:200]}"
2026-01-25T08:57:22.0923837Z -        
2026-01-25T08:57:22.0924173Z +        error_indicators = [
2026-01-25T08:57:22.0924580Z +            "alert-danger",
2026-01-25T08:57:22.0925034Z +            "ошибка",
2026-01-25T08:57:22.0925451Z +            "обязательно",
2026-01-25T08:57:22.0925887Z +            "должно быть",
2026-01-25T08:57:22.0926386Z +            "формат",
2026-01-25T08:57:22.0926784Z +            "неверный",
2026-01-25T08:57:22.0927122Z +        ]
2026-01-25T08:57:22.0927412Z +        assert any(
2026-01-25T08:57:22.0927905Z +            indicator in response_text for indicator in error_indicators
2026-01-25T08:57:22.0928646Z +        ), f"No validation error found in response: {response_text[:200]}"
2026-01-25T08:57:22.0929220Z +
2026-01-25T08:57:22.0929703Z          # Дополнительные проверки по ключевым словам
2026-01-25T08:57:22.0930194Z          if error_keywords:
2026-01-25T08:57:22.0930606Z              for keyword in error_keywords:
2026-01-25T08:57:22.0931129Z -                assert keyword.lower() in response_text, \
2026-01-25T08:57:22.0932135Z -                    f"Keyword '{keyword}' not found in error message"
2026-01-25T08:57:22.0932859Z -    
2026-01-25T08:57:22.0963775Z +                assert (
2026-01-25T08:57:22.0964287Z +                    keyword.lower() in response_text
2026-01-25T08:57:22.0964900Z +                ), f"Keyword '{keyword}' not found in error message"
2026-01-25T08:57:22.0965428Z +
2026-01-25T08:57:22.0965874Z      def assert_success_response(self, response, status_codes=None):
2026-01-25T08:57:22.0966753Z          """Проверка успешного ответа.
2026-01-25T08:57:22.0967218Z -        
2026-01-25T08:57:22.0967565Z +
2026-01-25T08:57:22.0967888Z          Args:
2026-01-25T08:57:22.0968305Z              response: Response объект
2026-01-25T08:57:22.0968912Z              status_codes: Разрешенные коды успешного ответа
2026-01-25T08:57:22.0969453Z          """
2026-01-25T08:57:22.0969777Z          if status_codes is None:
2026-01-25T08:57:22.0970443Z              status_codes = [200, 302]  # OK или Redirect
2026-01-25T08:57:22.0970927Z -        
2026-01-25T08:57:22.0971265Z -        assert response.status_code in status_codes, \
2026-01-25T08:57:22.0971970Z -            f"Expected success status {status_codes}, got {response.status_code}"
2026-01-25T08:57:22.0972608Z -    
2026-01-25T08:57:22.0973371Z -    def setup_csrf_in_session(self, client, token_base='test_token_base'):
2026-01-25T08:57:22.0973975Z +
2026-01-25T08:57:22.0974244Z +        assert (
2026-01-25T08:57:22.0974625Z +            response.status_code in status_codes
2026-01-25T08:57:22.0975280Z +        ), f"Expected success status {status_codes}, got {response.status_code}"
2026-01-25T08:57:22.0975880Z +
2026-01-25T08:57:22.0976335Z +    def setup_csrf_in_session(self, client, token_base="test_token_base"):
2026-01-25T08:57:22.0977557Z          """Установка CSRF токена в сессии клиента.
2026-01-25T08:57:22.0978023Z -        
2026-01-25T08:57:22.0978307Z +
2026-01-25T08:57:22.0978596Z          Args:
2026-01-25T08:57:22.0979182Z              client: Test клиент
2026-01-25T08:57:22.0979710Z              token_base: База для генерации токена
2026-01-25T08:57:22.0980144Z -            
2026-01-25T08:57:22.0980434Z +
2026-01-25T08:57:22.0980698Z          Returns:
2026-01-25T08:57:22.0981135Z              str: Сгенерированный токен
2026-01-25T08:57:22.0981562Z          """
2026-01-25T08:57:22.0981922Z          with client.session_transaction() as sess:
2026-01-25T08:57:22.0982485Z -            sess['_csrf_token'] = token_base
2026-01-25T08:57:22.0983334Z +            sess["_csrf_token"] = token_base
2026-01-25T08:57:22.0983819Z          return generate_csrf_token()
2026-01-25T08:57:22.0984273Z  
2026-01-25T08:57:22.0984568Z  
2026-01-25T08:57:22.0984893Z  class DatabaseTestHelper:
2026-01-25T08:57:22.0985536Z      """Хелпер для операций с базой данных в тестах."""
2026-01-25T08:57:22.0986037Z -    
2026-01-25T08:57:22.0986328Z +
2026-01-25T08:57:22.0986604Z      @staticmethod
2026-01-25T08:57:22.0987183Z      def create_user_with_password(db, username, discriminator, password):
2026-01-25T08:57:22.0988019Z          """Создание пользователя с хэшированным паролем.
2026-01-25T08:57:22.0988482Z -        
2026-01-25T08:57:22.0988803Z +
2026-01-25T08:57:22.0989104Z          Args:
2026-01-25T08:57:22.0989573Z              db: Объект базы данных
2026-01-25T08:57:22.0990135Z              username: Имя пользователя
2026-01-25T08:57:22.0990658Z              discriminator: Дискриминатор
2026-01-25T08:57:22.0991214Z              password: Пароль
2026-01-25T08:57:22.0991583Z -            
2026-01-25T08:57:22.0991874Z +
2026-01-25T08:57:22.0992162Z          Returns:
2026-01-25T08:57:22.0992530Z              tuple: (hashed_password, salt)
2026-01-25T08:57:22.1023306Z          """
2026-01-25T08:57:22.1023872Z          hashed_pw, salt = hash_password(password)
2026-01-25T08:57:22.1024440Z          db.execute(
2026-01-25T08:57:22.1025119Z -            'INSERT INTO user (username, discriminator, password, salt) VALUES (?, ?, ?, ?)',
2026-01-25T08:57:22.1026399Z -            (username, discriminator, hashed_pw, salt)
2026-01-25T08:57:22.1027174Z +            "INSERT INTO user (username, discriminator, password, salt) VALUES (?, ?, ?, ?)",
2026-01-25T08:57:22.1027989Z +            (username, discriminator, hashed_pw, salt),
2026-01-25T08:57:22.1028498Z          )
2026-01-25T08:57:22.1028843Z          return hashed_pw, salt
2026-01-25T08:57:22.1029273Z -    
2026-01-25T08:57:22.1029591Z -    @staticmethod
2026-01-25T08:57:22.1030254Z -    def create_user_with_post(db, username, discriminator, password, post_title, post_content):
2026-01-25T08:57:22.1031029Z +
2026-01-25T08:57:22.1031288Z +    @staticmethod
2026-01-25T08:57:22.1031611Z +    def create_user_with_post(
2026-01-25T08:57:22.1032210Z +        db, username, discriminator, password, post_title, post_content
2026-01-25T08:57:22.1032822Z +    ):
2026-01-25T08:57:22.1033653Z          """Создание пользователя с постом для тестов.
2026-01-25T08:57:22.1034147Z -        
2026-01-25T08:57:22.1034606Z +
2026-01-25T08:57:22.1034983Z          Args:
2026-01-25T08:57:22.1035418Z              db: Объект базы данных
2026-01-25T08:57:22.1035978Z              username: Имя пользователя
2026-01-25T08:57:22.1036550Z              discriminator: Дискриминатор
2026-01-25T08:57:22.1037100Z              password: Пароль
2026-01-25T08:57:22.1037641Z              post_title: Заголовок поста
2026-01-25T08:57:22.1038284Z              post_content: Содержание поста
2026-01-25T08:57:22.1038732Z -            
2026-01-25T08:57:22.1039039Z +
2026-01-25T08:57:22.1039328Z          Returns:
2026-01-25T08:57:22.1039712Z              tuple: (user_id, post_id)
2026-01-25T08:57:22.1040159Z          """
2026-01-25T08:57:22.1040590Z          # Создаем пользователя
2026-01-25T08:57:22.1041061Z          hashed_pw, salt = hash_password(password)
2026-01-25T08:57:22.1041884Z          db.execute(
2026-01-25T08:57:22.1042539Z -            'INSERT INTO user (username, discriminator, password, salt) VALUES (?, ?, ?, ?)',
2026-01-25T08:57:22.1043643Z -            (username, discriminator, hashed_pw, salt)
2026-01-25T08:57:22.1044428Z +            "INSERT INTO user (username, discriminator, password, salt) VALUES (?, ?, ?, ?)",
2026-01-25T08:57:22.1045221Z +            (username, discriminator, hashed_pw, salt),
2026-01-25T08:57:22.1045715Z          )
2026-01-25T08:57:22.1046051Z          db.commit()
2026-01-25T08:57:22.1046438Z -        
2026-01-25T08:57:22.1046735Z +
2026-01-25T08:57:22.1047198Z          # Получаем ID пользователя
2026-01-25T08:57:22.1047652Z          user = db.execute(
2026-01-25T08:57:22.1048204Z -            'SELECT id FROM user WHERE username = ? AND discriminator = ?',
2026-01-25T08:57:22.1048850Z -            (username, discriminator)
2026-01-25T08:57:22.1049477Z +            "SELECT id FROM user WHERE username = ? AND discriminator = ?",
2026-01-25T08:57:22.1050137Z +            (username, discriminator),
2026-01-25T08:57:22.1050600Z          ).fetchone()
2026-01-25T08:57:22.1050965Z -        
2026-01-25T08:57:22.1051378Z -        user_id = user['id'] if user else None
2026-01-25T08:57:22.1051845Z -        
2026-01-25T08:57:22.1052163Z +
2026-01-25T08:57:22.1052562Z +        user_id = user["id"] if user else None
2026-01-25T08:57:22.1083528Z +
2026-01-25T08:57:22.1084009Z          if user_id:
2026-01-25T08:57:22.1084653Z              # Создаем пост
2026-01-25T08:57:22.1085147Z              db.execute(
2026-01-25T08:57:22.1085883Z -                'INSERT INTO post (title, content, author_id) VALUES (?, ?, ?)',
2026-01-25T08:57:22.1086684Z -                (post_title, post_content, user_id)
2026-01-25T08:57:22.1087439Z +                "INSERT INTO post (title, content, author_id) VALUES (?, ?, ?)",
2026-01-25T08:57:22.1088349Z +                (post_title, post_content, user_id),
2026-01-25T08:57:22.1088868Z              )
2026-01-25T08:57:22.1089397Z              db.commit()
2026-01-25T08:57:22.1089835Z -            
2026-01-25T08:57:22.1090219Z +
2026-01-25T08:57:22.1090681Z              # Получаем ID поста
2026-01-25T08:57:22.1091668Z              post = db.execute(
2026-01-25T08:57:22.1092303Z -                'SELECT id FROM post WHERE title = ? AND author_id = ?',
2026-01-25T08:57:22.1093389Z -                (post_title, user_id)
2026-01-25T08:57:22.1094163Z +                "SELECT id FROM post WHERE title = ? AND author_id = ?",
2026-01-25T08:57:22.1094819Z +                (post_title, user_id),
2026-01-25T08:57:22.1095422Z              ).fetchone()
2026-01-25T08:57:22.1095885Z -            
2026-01-25T08:57:22.1096349Z -            post_id = post['id'] if post else None
2026-01-25T08:57:22.1096818Z +
2026-01-25T08:57:22.1097211Z +            post_id = post["id"] if post else None
2026-01-25T08:57:22.1097787Z              return user_id, post_id
2026-01-25T08:57:22.1098268Z -        
2026-01-25T08:57:22.1098560Z +
2026-01-25T08:57:22.1098969Z          return user_id, None
2026-01-25T08:57:22.1099399Z -    
2026-01-25T08:57:22.1099694Z +
2026-01-25T08:57:22.1099988Z      @staticmethod
2026-01-25T08:57:22.1100588Z      def cleanup_test_data(db, usernames=None, user_ids=None):
2026-01-25T08:57:22.1101347Z          """Очистка тестовых данных.
2026-01-25T08:57:22.1101799Z -        
2026-01-25T08:57:22.1102100Z +
2026-01-25T08:57:22.1102380Z          Args:
2026-01-25T08:57:22.1102819Z              db: Объект базы данных
2026-01-25T08:57:22.1103900Z              usernames: Список имён пользователей для удаления
2026-01-25T08:57:22.1104722Z              user_ids: Список ID пользователей для удаления
2026-01-25T08:57:22.1105291Z          """
2026-01-25T08:57:22.1105626Z          if usernames:
2026-01-25T08:57:22.1106097Z -            placeholders = ','.join('?' for _ in usernames)
2026-01-25T08:57:22.1106894Z -            db.execute(f'DELETE FROM user WHERE username IN ({placeholders})', usernames)
2026-01-25T08:57:22.1107582Z -        
2026-01-25T08:57:22.1108370Z +            placeholders = ",".join("?" for _ in usernames)
2026-01-25T08:57:22.1108907Z +            db.execute(
2026-01-25T08:57:22.1109491Z +                f"DELETE FROM user WHERE username IN ({placeholders})", usernames
2026-01-25T08:57:22.1110166Z +            )
2026-01-25T08:57:22.1110474Z +
2026-01-25T08:57:22.1110768Z          if user_ids:
2026-01-25T08:57:22.1111219Z -            placeholders = ','.join('?' for _ in user_ids)
2026-01-25T08:57:22.1111938Z -            db.execute(f'DELETE FROM user WHERE id IN ({placeholders})', user_ids)
2026-01-25T08:57:22.1112646Z -        
2026-01-25T08:57:22.1143575Z +            placeholders = ",".join("?" for _ in user_ids)
2026-01-25T08:57:22.1144397Z +            db.execute(f"DELETE FROM user WHERE id IN ({placeholders})", user_ids)
2026-01-25T08:57:22.1145048Z +
2026-01-25T08:57:22.1145354Z          db.commit()
2026-01-25T08:57:22.1145697Z  
2026-01-25T08:57:22.1145962Z  
2026-01-25T08:57:22.1146279Z  class FormTestHelper:
2026-01-25T08:57:22.1146867Z      """Хелпер для тестирования форм."""
2026-01-25T08:57:22.1147294Z -    
2026-01-25T08:57:22.1147586Z +
2026-01-25T08:57:22.1147878Z      @staticmethod
2026-01-25T08:57:22.1148387Z      def create_form_data_with_csrf(client, **kwargs):
2026-01-25T08:57:22.1149064Z          """Создание данных формы с CSRF токеном.
2026-01-25T08:57:22.1149572Z -        
2026-01-25T08:57:22.1149862Z +
2026-01-25T08:57:22.1150177Z          Args:
2026-01-25T08:57:22.1150662Z              client: Test клиент
2026-01-25T08:57:22.1151230Z              **kwargs: Дополнительные поля формы
2026-01-25T08:57:22.1151781Z -            
2026-01-25T08:57:22.1152098Z +
2026-01-25T08:57:22.1152386Z          Returns:
2026-01-25T08:57:22.1152858Z              dict: Данные формы с CSRF токеном
2026-01-25T08:57:22.1153534Z          """
2026-01-25T08:57:22.1154081Z          # В тестах используем фиксированный токен
2026-01-25T08:57:22.1154633Z -        token = 'test_csrf_token_for_testing'
2026-01-25T08:57:22.1155153Z -        form_data = {'csrf_token': token}
2026-01-25T08:57:22.1155682Z +        token = "test_csrf_token_for_testing"
2026-01-25T08:57:22.1156193Z +        form_data = {"csrf_token": token}
2026-01-25T08:57:22.1157100Z          form_data.update(kwargs)
2026-01-25T08:57:22.1157552Z          return form_data
2026-01-25T08:57:22.1157954Z -    
2026-01-25T08:57:22.1158239Z +
2026-01-25T08:57:22.1158535Z      @staticmethod
2026-01-25T08:57:22.1158994Z      def assert_form_fields_exist(form, *field_names):
2026-01-25T08:57:22.1159705Z          """Проверка наличия полей в форме.
2026-01-25T08:57:22.1160196Z -        
2026-01-25T08:57:22.1160529Z +
2026-01-25T08:57:22.1160819Z          Args:
2026-01-25T08:57:22.1161280Z              form: Объект формы
2026-01-25T08:57:22.1161869Z              *field_names: Имена полей для проверки
2026-01-25T08:57:22.1162341Z          """
2026-01-25T08:57:22.1162689Z          for field_name in field_names:
2026-01-25T08:57:22.1163759Z would reformat /home/runner/work/flask_blog/flask_blog/tests/test_comment_counts.py
2026-01-25T08:57:22.1165212Z --- /home/runner/work/flask_blog/flask_blog/tests/test_comment_counts.py	2026-01-25 08:57:06.653994+00:00
2026-01-25T08:57:22.1166409Z +++ /home/runner/work/flask_blog/flask_blog/tests/test_comment_counts.py	2026-01-25 08:57:22.096886+00:00
2026-01-25T08:57:22.1167315Z @@ -1,85 +1,97 @@
2026-01-25T08:57:22.1167945Z  """Тесты для проверки счетчиков комментариев на главной странице."""
2026-01-25T08:57:22.1168495Z +
2026-01-25T08:57:22.1168789Z  import pytest
2026-01-25T08:57:22.1169230Z  from app.services.post_service import PostService
2026-01-25T08:57:22.1169894Z  from app.services.comment_service import CommentService
2026-01-25T08:57:22.1170441Z  
2026-01-25T08:57:22.1170749Z  
2026-01-25T08:57:22.1171069Z  class TestCommentCounts:
2026-01-25T08:57:22.1171612Z      """Тестирование счетчиков комментариев."""
2026-01-25T08:57:22.1172070Z -    
2026-01-25T08:57:22.1172377Z +
2026-01-25T08:57:22.1172840Z      def test_post_service_get_all_includes_comment_count(self, app):
2026-01-25T08:57:22.1204346Z          """Проверяет, что PostService.get_all() возвращает посты с количеством комментариев."""
2026-01-25T08:57:22.1205074Z          with app.app_context():
2026-01-25T08:57:22.1205632Z              posts = PostService.get_all()
2026-01-25T08:57:22.1206076Z -            
2026-01-25T08:57:22.1206385Z +
2026-01-25T08:57:22.1206863Z              # Проверяем, что у всех постов есть поле comment_count
2026-01-25T08:57:22.1207366Z              for post in posts:
2026-01-25T08:57:22.1208129Z -                assert hasattr(post, 'comment_count'), f"У поста {post.id} нет поля comment_count"
2026-01-25T08:57:22.1209344Z -                assert isinstance(post.comment_count, int), f"comment_count должен быть int, а не {type(post.comment_count)}"
2026-01-25T08:57:22.1210585Z -                assert post.comment_count >= 0, f"comment_count не может быть отрицательным: {post.comment_count}"
2026-01-25T08:57:22.1211226Z -    
2026-01-25T08:57:22.1211479Z +                assert hasattr(
2026-01-25T08:57:22.1211853Z +                    post, "comment_count"
2026-01-25T08:57:22.1212368Z +                ), f"У поста {post.id} нет поля comment_count"
2026-01-25T08:57:22.1213180Z +                assert isinstance(
2026-01-25T08:57:22.1213527Z +                    post.comment_count, int
2026-01-25T08:57:22.1214141Z +                ), f"comment_count должен быть int, а не {type(post.comment_count)}"
2026-01-25T08:57:22.1214601Z +                assert (
2026-01-25T08:57:22.1214950Z +                    post.comment_count >= 0
2026-01-25T08:57:22.1215673Z +                ), f"comment_count не может быть отрицательным: {post.comment_count}"
2026-01-25T08:57:22.1216248Z +
2026-01-25T08:57:22.1216686Z      def test_comment_count_matches_database(self, app):
2026-01-25T08:57:22.1217498Z          """Проверяет, что счетчики комментариев соответствуют данным в БД."""
2026-01-25T08:57:22.1218091Z          with app.app_context():
2026-01-25T08:57:22.1218584Z              posts = PostService.get_all()
2026-01-25T08:57:22.1219080Z -            
2026-01-25T08:57:22.1219420Z +
2026-01-25T08:57:22.1219773Z              for post in posts:
2026-01-25T08:57:22.1220442Z                  # Получаем количество комментариев напрямую из БД
2026-01-25T08:57:22.1221154Z                  actual_count = CommentService.get_count_by_post_id(post.id)
2026-01-25T08:57:22.1221741Z -                
2026-01-25T08:57:22.1222065Z +
2026-01-25T08:57:22.1222554Z                  # Сравниваем со значением из PostService
2026-01-25T08:57:22.1223335Z                  assert post.comment_count == actual_count, (
2026-01-25T08:57:22.1224063Z                      f"Несоответствие для поста {post.id}: "
2026-01-25T08:57:22.1224763Z                      f"PostService вернул {post.comment_count}, "
2026-01-25T08:57:22.1225453Z                      f"в БД фактически {actual_count}"
2026-01-25T08:57:22.1225916Z                  )
2026-01-25T08:57:22.1226244Z -    
2026-01-25T08:57:22.1226533Z +
2026-01-25T08:57:22.1226937Z      def test_index_page_renders_comment_counts(self, client):
2026-01-25T08:57:22.1228142Z          """Проверяет, что главная страница корректно отображает счетчики комментариев."""
2026-01-25T08:57:22.1228829Z -        response = client.get('/')
2026-01-25T08:57:22.1229320Z +        response = client.get("/")
2026-01-25T08:57:22.1229850Z          assert response.status_code == 200
2026-01-25T08:57:22.1230343Z -        
2026-01-25T08:57:22.1230631Z +
2026-01-25T08:57:22.1230976Z          html = response.get_data(as_text=True)
2026-01-25T08:57:22.1231442Z -        
2026-01-25T08:57:22.1231755Z +
2026-01-25T08:57:22.1232299Z          # Получаем посты для проверки
2026-01-25T08:57:22.1232815Z          with client.application.app_context():
2026-01-25T08:57:22.1263695Z              posts = PostService.get_all()
2026-01-25T08:57:22.1264171Z -            
2026-01-25T08:57:22.1264494Z +
2026-01-25T08:57:22.1265160Z              # Проверяем, что каждый пост отображает правильное количество комментариев
2026-01-25T08:57:22.1265790Z              for post in posts:
2026-01-25T08:57:22.1266531Z                  # Ищем в HTML количество комментариев для этого поста
2026-01-25T08:57:22.1267078Z                  import re
2026-01-25T08:57:22.1267466Z +
2026-01-25T08:57:22.1268010Z                  # Ищем ссылку на пост и следующий за ней блок с комментариями
2026-01-25T08:57:22.1268867Z                  post_pattern = f'href="/post/{post.id}"[^>]*>.*?fa-comment[^>]*>.*?<span[^>]*>(\d+)</span>'
2026-01-25T08:57:22.1269738Z                  matches = re.findall(post_pattern, html, re.DOTALL)
2026-01-25T08:57:22.1270288Z -                
2026-01-25T08:57:22.1270622Z +
2026-01-25T08:57:22.1270926Z                  if matches:
2026-01-25T08:57:22.1271371Z                      displayed_count = int(matches[0])
2026-01-25T08:57:22.1271972Z                      assert displayed_count == post.comment_count, (
2026-01-25T08:57:22.1272798Z                          f"Для поста {post.id} отображается {displayed_count}, "
2026-01-25T08:57:22.1273786Z                          f"а должно быть {post.comment_count}"
2026-01-25T08:57:22.1274330Z                      )
2026-01-25T08:57:22.1274677Z -    
2026-01-25T08:57:22.1274967Z +
2026-01-25T08:57:22.1275793Z      def test_comment_count_zero_for_posts_without_comments(self, app):
2026-01-25T08:57:22.1276668Z          """Проверяет, что у постов без комментариев счетчик равен 0."""
2026-01-25T08:57:22.1277248Z          with app.app_context():
2026-01-25T08:57:22.1277710Z              posts = PostService.get_all()
2026-01-25T08:57:22.1278168Z -            
2026-01-25T08:57:22.1278476Z +
2026-01-25T08:57:22.1278785Z              for post in posts:
2026-01-25T08:57:22.1279362Z                  actual_count = CommentService.get_count_by_post_id(post.id)
2026-01-25T08:57:22.1280019Z                  if actual_count == 0:
2026-01-25T08:57:22.1280975Z -                    assert post.comment_count == 0, f"У поста {post.id} без комментариев счетчик должен быть 0"
2026-01-25T08:57:22.1281715Z -    
2026-01-25T08:57:22.1282066Z +                    assert (
2026-01-25T08:57:22.1282511Z +                        post.comment_count == 0
2026-01-25T08:57:22.1283507Z +                    ), f"У поста {post.id} без комментариев счетчик должен быть 0"
2026-01-25T08:57:22.1284100Z +
2026-01-25T08:57:22.1284603Z      def test_comment_count_positive_for_posts_with_comments(self, app):
2026-01-25T08:57:22.1285533Z          """Проверяет, что у постов с комментариями счетчик больше 0."""
2026-01-25T08:57:22.1286141Z          with app.app_context():
2026-01-25T08:57:22.1286647Z              posts = PostService.get_all()
2026-01-25T08:57:22.1287093Z -            
2026-01-25T08:57:22.1287417Z +
2026-01-25T08:57:22.1287737Z              for post in posts:
2026-01-25T08:57:22.1288320Z                  actual_count = CommentService.get_count_by_post_id(post.id)
2026-01-25T08:57:22.1288947Z                  if actual_count > 0:
2026-01-25T08:57:22.1289884Z -                    assert post.comment_count > 0, f"У поста {post.id} с комментариями счетчик должен быть > 0"
2026-01-25T08:57:22.1290958Z +                    assert (
2026-01-25T08:57:22.1291397Z +                        post.comment_count > 0
2026-01-25T08:57:22.1292186Z +                    ), f"У поста {post.id} с комментариями счетчик должен быть > 0"
2026-01-25T08:57:22.1292865Z                      assert post.comment_count == actual_count, (
2026-01-25T08:57:22.1324064Z                          f"У поста {post.id} счетчик {post.comment_count}, "
2026-01-25T08:57:22.1324873Z                          f"а в БД {actual_count}"
2026-01-25T08:57:22.1325401Z                      )
2026-01-25T08:57:22.2290556Z --- /home/runner/work/flask_blog/flask_blog/tests/conftest.py	2026-01-25 08:57:06.653994+00:00
2026-01-25T08:57:22.2298143Z would reformat /home/runner/work/flask_blog/flask_blog/tests/conftest.py
2026-01-25T08:57:22.2299120Z +++ /home/runner/work/flask_blog/flask_blog/tests/conftest.py	2026-01-25 08:57:22.224819+00:00
2026-01-25T08:57:22.2301243Z @@ -10,104 +10,110 @@
2026-01-25T08:57:22.2301858Z  from typing import Dict, Any
2026-01-25T08:57:22.2302363Z  
2026-01-25T08:57:22.2303378Z  # Полное подавление предупреждений о временных метках
2026-01-25T08:57:22.2307642Z  if not sys.warnoptions:
2026-01-25T08:57:22.2308086Z      warnings.simplefilter("ignore")
2026-01-25T08:57:22.2308962Z -    warnings.filterwarnings("ignore", category=DeprecationWarning, message=".*default timestamp converter.*")
2026-01-25T08:57:22.2309886Z +    warnings.filterwarnings(
2026-01-25T08:57:22.2310574Z +        "ignore", category=DeprecationWarning, message=".*default timestamp converter.*"
2026-01-25T08:57:22.2311268Z +    )
2026-01-25T08:57:22.2311555Z  
2026-01-25T08:57:22.2311866Z  from app import create_app
2026-01-25T08:57:22.2312280Z  from app.db.db import get_db, init_db
2026-01-25T08:57:22.2312741Z  
2026-01-25T08:57:22.2313237Z  
2026-01-25T08:57:22.2313691Z  def _create_test_app(config: Dict[str, Any]) -> Any:
2026-01-25T08:57:22.2314466Z      """Вспомогательная функция для создания тестового приложения."""
2026-01-25T08:57:22.2315077Z      db_fd, db_path = tempfile.mkstemp()
2026-01-25T08:57:22.2315511Z -    
2026-01-25T08:57:22.2315788Z +
2026-01-25T08:57:22.2316075Z      app_config = {
2026-01-25T08:57:22.2316443Z -        'TESTING': True,
2026-01-25T08:57:22.2316821Z -        'DATABASE': db_path,
2026-01-25T08:57:22.2317302Z -        'SECRET_KEY': 'test-secret-key-for-testing',
2026-01-25T08:57:22.2317869Z -        'ADMIN_PASSWORD': 'test_admin_password',
2026-01-25T08:57:22.2318327Z -        **config
2026-01-25T08:57:22.2318664Z +        "TESTING": True,
2026-01-25T08:57:22.2319054Z +        "DATABASE": db_path,
2026-01-25T08:57:22.2319517Z +        "SECRET_KEY": "test-secret-key-for-testing",
2026-01-25T08:57:22.2320071Z +        "ADMIN_PASSWORD": "test_admin_password",
2026-01-25T08:57:22.2320535Z +        **config,
2026-01-25T08:57:22.2320845Z      }
2026-01-25T08:57:22.2321114Z -    
2026-01-25T08:57:22.2321384Z +
2026-01-25T08:57:22.2321680Z      app = create_app(app_config)
2026-01-25T08:57:22.2322411Z -    
2026-01-25T08:57:22.2322740Z +
2026-01-25T08:57:22.2323584Z      with app.app_context():
2026-01-25T08:57:22.2324312Z          init_db()
2026-01-25T08:57:22.2324823Z          _create_test_data()
2026-01-25T08:57:22.2325392Z -    
2026-01-25T08:57:22.2344940Z +
2026-01-25T08:57:22.2345460Z      return app, db_fd, db_path
2026-01-25T08:57:22.2346005Z  
2026-01-25T08:57:22.2346349Z  
2026-01-25T08:57:22.2346685Z  def _create_test_data():
2026-01-25T08:57:22.2347455Z      """Создает тестовые данные в базе."""
2026-01-25T08:57:22.2348024Z      db = get_db()
2026-01-25T08:57:22.2348476Z      from app.auth import hash_password
2026-01-25T08:57:22.2349073Z -    
2026-01-25T08:57:22.2349558Z +
2026-01-25T08:57:22.2350006Z      # Создаем тестового пользователя
2026-01-25T08:57:22.2350672Z -    hashed_pw, salt = hash_password('test_pass')
2026-01-25T08:57:22.2351299Z +    hashed_pw, salt = hash_password("test_pass")
2026-01-25T08:57:22.2351856Z      db.execute(
2026-01-25T08:57:22.2352508Z -        'INSERT INTO user (username, discriminator, password, salt) VALUES (?, ?, ?, ?)',
2026-01-25T08:57:22.2353592Z -        ('test_user', 1234, hashed_pw, salt),
2026-01-25T08:57:22.2354465Z +        "INSERT INTO user (username, discriminator, password, salt) VALUES (?, ?, ?, ?)",
2026-01-25T08:57:22.2355402Z +        ("test_user", 1234, hashed_pw, salt),
2026-01-25T08:57:22.2355915Z      )
2026-01-25T08:57:22.2356279Z      db.commit()
2026-01-25T08:57:22.2356629Z -    
2026-01-25T08:57:22.2356922Z +
2026-01-25T08:57:22.2357360Z      # Создаем тестовые посты
2026-01-25T08:57:22.2358029Z      user_id = 1  # ID первого созданного пользователя
2026-01-25T08:57:22.2358573Z      test_posts = [
2026-01-25T08:57:22.2359230Z -        ('Тестовый пост 1', 'Содержание первого тестового поста', user_id),
2026-01-25T08:57:22.2360050Z -        ('Тестовый пост 2', 'Содержание второго тестового поста', user_id),
2026-01-25T08:57:22.2360940Z -        ('Пост для просмотра', 'Этот пост используется для тестирования просмотра', user_id),
2026-01-25T08:57:22.2361867Z -        ('Новый пост', 'Содержание нового поста для тестов', user_id),
2026-01-25T08:57:22.2362602Z +        ("Тестовый пост 1", "Содержание первого тестового поста", user_id),
2026-01-25T08:57:22.2364024Z +        ("Тестовый пост 2", "Содержание второго тестового поста", user_id),
2026-01-25T08:57:22.2364565Z +        (
2026-01-25T08:57:22.2364844Z +            "Пост для просмотра",
2026-01-25T08:57:22.2365192Z +            "Этот пост используется для тестирования просмотра",
2026-01-25T08:57:22.2365322Z +            user_id,
2026-01-25T08:57:22.2365452Z +        ),
2026-01-25T08:57:22.2365776Z +        ("Новый пост", "Содержание нового поста для тестов", user_id),
2026-01-25T08:57:22.2365883Z      ]
2026-01-25T08:57:22.2365990Z -    
2026-01-25T08:57:22.2366082Z +
2026-01-25T08:57:22.2366252Z      for title, content, author_id in test_posts:
2026-01-25T08:57:22.2366361Z          db.execute(
2026-01-25T08:57:22.2366749Z              'INSERT INTO post (title, content, author_id, created) VALUES (?, ?, ?, datetime("now"))',
2026-01-25T08:57:22.2366968Z -            (title, content, author_id)
2026-01-25T08:57:22.2367107Z +            (title, content, author_id),
2026-01-25T08:57:22.2367223Z          )
2026-01-25T08:57:22.2367340Z      db.commit()
2026-01-25T08:57:22.2367459Z -    
2026-01-25T08:57:22.2367569Z +
2026-01-25T08:57:22.2367810Z      # Создаем тестовые комментарии для некоторых постов
2026-01-25T08:57:22.2367929Z      test_comments = [
2026-01-25T08:57:22.2368257Z -        (1, user_id, 'Комментарий к первому посту'),  # Комментарий к посту 1
2026-01-25T08:57:22.2368696Z -        (1, user_id, 'Второй комментарий к первому посту'),  # Еще один комментарий к посту 1
2026-01-25T08:57:22.2369079Z -        (2, user_id, 'Комментарий ко второму посту'),  # Комментарий к посту 2
2026-01-25T08:57:22.2369460Z -        (3, user_id, 'Комментарий к третьему посту'),  # Комментарий к посту 3
2026-01-25T08:57:22.2369777Z +        (1, user_id, "Комментарий к первому посту"),  # Комментарий к посту 1
2026-01-25T08:57:22.2370155Z +        (
2026-01-25T08:57:22.2370270Z +            1,
2026-01-25T08:57:22.2370401Z +            user_id,
2026-01-25T08:57:22.2370710Z +            "Второй комментарий к первому посту",
2026-01-25T08:57:22.2371037Z +        ),  # Еще один комментарий к посту 1
2026-01-25T08:57:22.2371473Z +        (2, user_id, "Комментарий ко второму посту"),  # Комментарий к посту 2
2026-01-25T08:57:22.2371983Z +        (3, user_id, "Комментарий к третьему посту"),  # Комментарий к посту 3
2026-01-25T08:57:22.2372116Z      ]
2026-01-25T08:57:22.2372246Z -    
2026-01-25T08:57:22.2372369Z +
2026-01-25T08:57:22.2372592Z      for post_id, author_id, content in test_comments:
2026-01-25T08:57:22.2372735Z          db.execute(
2026-01-25T08:57:22.2373400Z              'INSERT INTO comment (post_id, author_id, content, created) VALUES (?, ?, ?, datetime("now"))',
2026-01-25T08:57:22.2373579Z -            (post_id, author_id, content)
2026-01-25T08:57:22.2373748Z +            (post_id, author_id, content),
2026-01-25T08:57:22.2373889Z          )
2026-01-25T08:57:22.2374015Z      db.commit()
2026-01-25T08:57:22.2374139Z  
2026-01-25T08:57:22.2374255Z  
2026-01-25T08:57:22.2374413Z  @pytest.fixture
2026-01-25T08:57:22.2374541Z  def app():
2026-01-25T08:57:22.2374914Z      """Создает тестовое приложение без CSRF защиты для unit тестов."""
2026-01-25T08:57:22.2375104Z -    app, db_fd, db_path = _create_test_app({
2026-01-25T08:57:22.2375259Z -        'WTF_CSRF_ENABLED': False
2026-01-25T08:57:22.2375379Z -    })
2026-01-25T08:57:22.2375505Z -    
2026-01-25T08:57:22.2375786Z +    app, db_fd, db_path = _create_test_app({"WTF_CSRF_ENABLED": False})
2026-01-25T08:57:22.2375901Z +
2026-01-25T08:57:22.2376032Z      yield app
2026-01-25T08:57:22.2376151Z -    
2026-01-25T08:57:22.2376264Z +
2026-01-25T08:57:22.2376405Z      os.close(db_fd)
2026-01-25T08:57:22.2376544Z      os.unlink(db_path)
2026-01-25T08:57:22.2376659Z  
2026-01-25T08:57:22.2376784Z  
2026-01-25T08:57:22.2376958Z  @pytest.fixture
2026-01-25T08:57:22.2377126Z  def app_with_csrf():
2026-01-25T08:57:22.2377519Z      """Приложение с включенной CSRF защитой для интеграционных тестов."""
2026-01-25T08:57:22.2377708Z -    app, db_fd, db_path = _create_test_app({
2026-01-25T08:57:22.2378087Z -        'WTF_CSRF_ENABLED': True
2026-01-25T08:57:22.2378209Z -    })
2026-01-25T08:57:22.2378331Z -    
2026-01-25T08:57:22.2378627Z +    app, db_fd, db_path = _create_test_app({"WTF_CSRF_ENABLED": True})
2026-01-25T08:57:22.2378745Z +
2026-01-25T08:57:22.2378882Z      yield app
2026-01-25T08:57:22.2379010Z -    
2026-01-25T08:57:22.2379125Z +
2026-01-25T08:57:22.2379263Z      os.close(db_fd)
2026-01-25T08:57:22.2379416Z      os.unlink(db_path)
2026-01-25T08:57:22.2379531Z  
2026-01-25T08:57:22.2379642Z  
2026-01-25T08:57:22.2379781Z  @pytest.fixture
2026-01-25T08:57:22.2379903Z @@ -135,17 +141,16 @@
2026-01-25T08:57:22.2380022Z  
2026-01-25T08:57:22.2380135Z  
2026-01-25T08:57:22.2380265Z  @pytest.fixture
2026-01-25T08:57:22.2380413Z  def security_app():
2026-01-25T08:57:22.2380992Z      """Приложение для тестов безопасности (CSRF включен)."""
2026-01-25T08:57:22.2381191Z -    app, db_fd, db_path = _create_test_app({
2026-01-25T08:57:22.2381388Z -        'WTF_CSRF_ENABLED': True,
2026-01-25T08:57:22.2381553Z -        'SECRET_KEY': 'security-test-key'
2026-01-25T08:57:22.2381677Z -    })
2026-01-25T08:57:22.2381806Z -    
2026-01-25T08:57:22.2381982Z +    app, db_fd, db_path = _create_test_app(
2026-01-25T08:57:22.2382262Z +        {"WTF_CSRF_ENABLED": True, "SECRET_KEY": "security-test-key"}
2026-01-25T08:57:22.2382399Z +    )
2026-01-25T08:57:22.2382511Z +
2026-01-25T08:57:22.2382644Z      yield app
2026-01-25T08:57:22.2382789Z -    
2026-01-25T08:57:22.2383106Z +
2026-01-25T08:57:22.2383273Z      os.close(db_fd)
2026-01-25T08:57:22.2383410Z      os.unlink(db_path)
2026-01-25T08:57:22.2383523Z  
2026-01-25T08:57:22.2383646Z  
2026-01-25T08:57:22.2383808Z  @pytest.fixture
2026-01-25T08:57:22.2383935Z @@ -158,134 +163,149 @@
2026-01-25T08:57:22.2384126Z  def security_auth(security_client):
2026-01-25T08:57:22.2384416Z      """Аутентификация для тестов безопасности."""
2026-01-25T08:57:22.2384589Z      return AuthActions(security_client)
2026-01-25T08:57:22.2384726Z  
2026-01-25T08:57:22.2384863Z  
2026-01-25T08:57:22.2385018Z -
2026-01-25T08:57:22.2385164Z -
2026-01-25T08:57:22.2385276Z -
2026-01-25T08:57:22.2385392Z -
2026-01-25T08:57:22.2385524Z  @pytest.fixture
2026-01-25T08:57:22.2385655Z  def runner(app):
2026-01-25T08:57:22.2385919Z      """CLI runner для тестирования команд."""
2026-01-25T08:57:22.2386085Z      return app.test_cli_runner()
2026-01-25T08:57:22.2386195Z  
2026-01-25T08:57:22.2386314Z  
2026-01-25T08:57:22.2386433Z -
2026-01-25T08:57:22.2386556Z -
2026-01-25T08:57:22.2386695Z  class AuthActions:
2026-01-25T08:57:22.2387048Z      """Вспомогательный класс для действий аутентификации в тестах."""
2026-01-25T08:57:22.2387184Z  
2026-01-25T08:57:22.2387349Z      def __init__(self, client):
2026-01-25T08:57:22.2387496Z          self._client = client
2026-01-25T08:57:22.2387640Z  
2026-01-25T08:57:22.2387869Z      def _get_full_username(self, username: str) -> str:
2026-01-25T08:57:22.2388197Z          """Получить полное имя пользователя с дискриминатором."""
2026-01-25T08:57:22.2388571Z -        if '#' in username:
2026-01-25T08:57:22.2388715Z +        if "#" in username:
2026-01-25T08:57:22.2388856Z              return username
2026-01-25T08:57:22.2388986Z -            
2026-01-25T08:57:22.2389103Z +
2026-01-25T08:57:22.2389354Z          # Ищем пользователя в базе данных
2026-01-25T08:57:22.2389542Z          app = self._client.application
2026-01-25T08:57:22.2389701Z          with app.app_context():
2026-01-25T08:57:22.2389897Z              from app.db.db import get_db
2026-01-25T08:57:22.2390013Z +
2026-01-25T08:57:22.2390144Z              db = get_db()
2026-01-25T08:57:22.2390297Z              cursor = db.execute(
2026-01-25T08:57:22.2390615Z -                'SELECT username, discriminator FROM user WHERE username = ?',
2026-01-25T08:57:22.2390755Z -                (username,)
2026-01-25T08:57:22.2391077Z +                "SELECT username, discriminator FROM user WHERE username = ?",
2026-01-25T08:57:22.2391214Z +                (username,),
2026-01-25T08:57:22.2391347Z              )
2026-01-25T08:57:22.2391510Z              row = cursor.fetchone()
2026-01-25T08:57:22.2391634Z              if row:
2026-01-25T08:57:22.2391805Z                  return f"{row[0]}#{row[1]:04d}"
2026-01-25T08:57:22.2392100Z          return username  # fallback, если не найден
2026-01-25T08:57:22.2392218Z  
2026-01-25T08:57:22.2392776Z -    def login(self, username: str = 'test_user#1234', password: str = 'test_pass', follow_redirects: bool = False):
2026-01-25T08:57:22.2393087Z +    def login(
2026-01-25T08:57:22.2393215Z +        self,
2026-01-25T08:57:22.2393407Z +        username: str = "test_user#1234",
2026-01-25T08:57:22.2393570Z +        password: str = "test_pass",
2026-01-25T08:57:22.2393727Z +        follow_redirects: bool = False,
2026-01-25T08:57:22.2393861Z +    ):
2026-01-25T08:57:22.2394455Z          """Выполнение входа пользователя."""
2026-01-25T08:57:22.2394813Z          # Если username без дискриминатора, пытаемся найти его
2026-01-25T08:57:22.2395070Z          full_username = self._get_full_username(username)
2026-01-25T08:57:22.2395228Z -        
2026-01-25T08:57:22.2395366Z +
2026-01-25T08:57:22.2395605Z          # Получаем CSRF токен если он нужен
2026-01-25T08:57:22.2395904Z -        login_data = {'username': full_username, 'password': password}
2026-01-25T08:57:22.2396033Z -        
2026-01-25T08:57:22.2396357Z +        login_data = {"username": full_username, "password": password}
2026-01-25T08:57:22.2396474Z +
2026-01-25T08:57:22.2396737Z          # Проверяем, включена ли CSRF защита
2026-01-25T08:57:22.2396907Z          app = self._client.application
2026-01-25T08:57:22.2397120Z -        if app.config.get('WTF_CSRF_ENABLED', False):
2026-01-25T08:57:22.2397320Z +        if app.config.get("WTF_CSRF_ENABLED", False):
2026-01-25T08:57:22.2397651Z              # Получаем страницу входа чтобы получить CSRF токен
2026-01-25T08:57:22.2397898Z -            login_page = self._client.get('/auth/login')
2026-01-25T08:57:22.2398094Z +            login_page = self._client.get("/auth/login")
2026-01-25T08:57:22.2398337Z              page_content = login_page.get_data(as_text=True)
2026-01-25T08:57:22.2398589Z              # Ищем CSRF токен в странице
2026-01-25T08:57:22.2399020Z -            csrf_match = re.search(r'name="csrf_token"[^>]*value="([^"]+)"', page_content, re.DOTALL)
2026-01-25T08:57:22.2399187Z +            csrf_match = re.search(
2026-01-25T08:57:22.2399476Z +                r'name="csrf_token"[^>]*value="([^"]+)"', page_content, re.DOTALL
2026-01-25T08:57:22.2399597Z +            )
2026-01-25T08:57:22.2399747Z              if csrf_match:
2026-01-25T08:57:22.2399996Z -                login_data['csrf_token'] = csrf_match.group(1).strip()
2026-01-25T08:57:22.2400118Z -        
2026-01-25T08:57:22.2400368Z +                login_data["csrf_token"] = csrf_match.group(1).strip()
2026-01-25T08:57:22.2400571Z +
2026-01-25T08:57:22.2400774Z          return self._client.post(
2026-01-25T08:57:22.2400910Z -            '/auth/login',
2026-01-25T08:57:22.2401250Z -            data=login_data,
2026-01-25T08:57:22.2401439Z -            follow_redirects=follow_redirects
2026-01-25T08:57:22.2401738Z +            "/auth/login", data=login_data, follow_redirects=follow_redirects
2026-01-25T08:57:22.2401856Z          )
2026-01-25T08:57:22.2401975Z  
2026-01-25T08:57:22.2402121Z      def logout(self):
2026-01-25T08:57:22.2402408Z          """Выполнение выхода пользователя."""
2026-01-25T08:57:22.2402628Z -        return self._client.get('/auth/logout')
2026-01-25T08:57:22.2402747Z -
2026-01-25T08:57:22.2403458Z -    def register(self, username: str = 'new_user', password: str = 'new_pass123', follow_redirects: bool = False):
2026-01-25T08:57:22.2403656Z +        return self._client.get("/auth/logout")
2026-01-25T08:57:22.2403789Z +
2026-01-25T08:57:22.2403938Z +    def register(
2026-01-25T08:57:22.2404090Z +        self,
2026-01-25T08:57:22.2404239Z +        username: str = "new_user",
2026-01-25T08:57:22.2404423Z +        password: str = "new_pass123",
2026-01-25T08:57:22.2404624Z +        follow_redirects: bool = False,
2026-01-25T08:57:22.2404744Z +    ):
2026-01-25T08:57:22.2405050Z          """Регистрация нового пользователя."""
2026-01-25T08:57:22.2405487Z -        register_data = {'username': username, 'password': password, 'password2': password}
2026-01-25T08:57:22.2405612Z -        
2026-01-25T08:57:22.2405746Z +        register_data = {
2026-01-25T08:57:22.2405889Z +            "username": username,
2026-01-25T08:57:22.2406037Z +            "password": password,
2026-01-25T08:57:22.2406184Z +            "password2": password,
2026-01-25T08:57:22.2406300Z +        }
2026-01-25T08:57:22.2406423Z +
2026-01-25T08:57:22.2406694Z          # Проверяем, включена ли CSRF защита
2026-01-25T08:57:22.2406882Z          app = self._client.application
2026-01-25T08:57:22.2407100Z -        if app.config.get('WTF_CSRF_ENABLED', False):
2026-01-25T08:57:22.2407543Z +        if app.config.get("WTF_CSRF_ENABLED", False):
2026-01-25T08:57:22.2407935Z              # Получаем страницу регистрации чтобы получить CSRF токен
2026-01-25T08:57:22.2408224Z -            register_page = self._client.get('/auth/register')
2026-01-25T08:57:22.2408462Z +            register_page = self._client.get("/auth/register")
2026-01-25T08:57:22.2408723Z              # Ищем CSRF токен в странице
2026-01-25T08:57:22.2409251Z -            csrf_match = re.search(r'name="csrf_token"[^>]*value="([^"]+)"', register_page.get_data(as_text=True), re.DOTALL)
2026-01-25T08:57:22.2409403Z +            csrf_match = re.search(
2026-01-25T08:57:22.2409608Z +                r'name="csrf_token"[^>]*value="([^"]+)"',
2026-01-25T08:57:22.2409796Z +                register_page.get_data(as_text=True),
2026-01-25T08:57:22.2409939Z +                re.DOTALL,
2026-01-25T08:57:22.2410052Z +            )
2026-01-25T08:57:22.2410185Z              if csrf_match:
2026-01-25T08:57:22.2410509Z -                register_data['csrf_token'] = csrf_match.group(1).strip()
2026-01-25T08:57:22.2410629Z -        
2026-01-25T08:57:22.2410920Z +                register_data["csrf_token"] = csrf_match.group(1).strip()
2026-01-25T08:57:22.2411043Z +
2026-01-25T08:57:22.2411205Z          response = self._client.post(
2026-01-25T08:57:22.2411348Z -            '/auth/register',
2026-01-25T08:57:22.2411505Z -            data=register_data,
2026-01-25T08:57:22.2411680Z -            follow_redirects=follow_redirects
2026-01-25T08:57:22.2412020Z +            "/auth/register", data=register_data, follow_redirects=follow_redirects
2026-01-25T08:57:22.2412147Z          )
2026-01-25T08:57:22.2412288Z          return response
2026-01-25T08:57:22.2412408Z  
2026-01-25T08:57:22.2412534Z  
2026-01-25T08:57:22.2412666Z  @pytest.fixture
2026-01-25T08:57:22.2412814Z  def sample_user_data():
2026-01-25T08:57:22.2413233Z      """Данные для тестового пользователя."""
2026-01-25T08:57:22.2413443Z      return {
2026-01-25T08:57:22.2413610Z -        'username': 'sample_user',
2026-01-25T08:57:22.2413777Z -        'password': 'sample_password',
2026-01-25T08:57:22.2414156Z -        'discriminator': 9999
2026-01-25T08:57:22.2414319Z +        "username": "sample_user",
2026-01-25T08:57:22.2414483Z +        "password": "sample_password",
2026-01-25T08:57:22.2414636Z +        "discriminator": 9999,
2026-01-25T08:57:22.2414751Z      }
2026-01-25T08:57:22.2414861Z  
2026-01-25T08:57:22.2414983Z  
2026-01-25T08:57:22.2415115Z  @pytest.fixture
2026-01-25T08:57:22.2415260Z  def sample_post_data():
2026-01-25T08:57:22.2415515Z      """Данные для тестового поста."""
2026-01-25T08:57:22.2415635Z      return {
2026-01-25T08:57:22.2415782Z -        'title': 'Test Post Title',
2026-01-25T08:57:22.2416076Z -        'content': 'This is a test post content for testing purposes.'
2026-01-25T08:57:22.2416221Z +        "title": "Test Post Title",
2026-01-25T08:57:22.2416510Z +        "content": "This is a test post content for testing purposes.",
2026-01-25T08:57:22.2416647Z      }
2026-01-25T08:57:22.2416762Z  
2026-01-25T08:57:22.2416874Z  
2026-01-25T08:57:22.2417003Z  @pytest.fixture
2026-01-25T08:57:22.2417150Z  def mock_csrf_token():
2026-01-25T08:57:22.2417387Z      """Мок CSRF токена для тестов."""
2026-01-25T08:57:22.2417607Z -    return 'test-csrf-token-12345'
2026-01-25T08:57:22.2417771Z +    return "test-csrf-token-12345"
2026-01-25T08:57:22.2418006Z  
2026-01-25T08:57:22.2418159Z  
2026-01-25T08:57:22.2418287Z  @pytest.fixture
2026-01-25T08:57:22.2418451Z  def setup_csrf_token(client):
2026-01-25T08:57:22.2418739Z      """Устанавливает CSRF токен в сессии для тестов."""
2026-01-25T08:57:22.2418852Z +
2026-01-25T08:57:22.2419002Z      def _setup_token():
2026-01-25T08:57:22.2419295Z          # Получаем страницу входа чтобы извлечь CSRF токен
2026-01-25T08:57:22.2419493Z -        login_page = client.get('/auth/login')
2026-01-25T08:57:22.2419668Z +        login_page = client.get("/auth/login")
2026-01-25T08:57:22.2420099Z          page_content = login_page.get_data(as_text=True)
2026-01-25T08:57:22.2420518Z -        csrf_match = re.search(r'name="csrf_token"[^>]*value="([^"]+)"', page_content, re.DOTALL)
2026-01-25T08:57:22.2420686Z +        csrf_match = re.search(
2026-01-25T08:57:22.2420960Z +            r'name="csrf_token"[^>]*value="([^"]+)"', page_content, re.DOTALL
2026-01-25T08:57:22.2421091Z +        )
2026-01-25T08:57:22.2421226Z          if csrf_match:
2026-01-25T08:57:22.2421412Z              return csrf_match.group(1).strip()
2026-01-25T08:57:22.2421630Z -        return 'test_csrf_token_for_testing'  # fallback
2026-01-25T08:57:22.2421836Z +        return "test_csrf_token_for_testing"  # fallback
2026-01-25T08:57:22.2421958Z +
2026-01-25T08:57:22.2422100Z      return _setup_token
2026-01-25T08:57:22.2422212Z  
2026-01-25T08:57:22.2422335Z  
2026-01-25T08:57:22.2422561Z  # Маркеры для разных типов тестов
2026-01-25T08:57:22.2422733Z  pytest.mark.unit = pytest.mark.unit
2026-01-25T08:57:22.2748071Z --- /home/runner/work/flask_blog/flask_blog/tests/test_auth.py	2026-01-25 08:57:06.653994+00:00
2026-01-25T08:57:22.2748655Z +++ /home/runner/work/flask_blog/flask_blog/tests/test_auth.py	2026-01-25 08:57:22.270500+00:00
2026-01-25T08:57:22.2748984Z @@ -7,145 +7,137 @@
2026-01-25T08:57:22.2750255Z  class TestPasswordHashing:
2026-01-25T08:57:22.2751641Z      """Тесты для функций хэширования паролей."""
2026-01-25T08:57:22.2752356Z  
2026-01-25T08:57:22.2761651Z would reformat /home/runner/work/flask_blog/flask_blog/tests/test_auth.py
2026-01-25T08:57:22.2765036Z      def test_hash_password_returns_hex_string(self):
2026-01-25T08:57:22.2765666Z          """Хэш пароля должен быть строкой."""
2026-01-25T08:57:22.2766769Z -        hashed, salt = hash_password('password123')
2026-01-25T08:57:22.2767010Z +        hashed, salt = hash_password("password123")
2026-01-25T08:57:22.2767182Z          assert isinstance(hashed, str)
2026-01-25T08:57:22.2767611Z          # Проверяем, что это строка (werkzeug возвращает строку с префиксом метода)
2026-01-25T08:57:22.2767807Z          assert len(hashed) > 0
2026-01-25T08:57:22.2767925Z  
2026-01-25T08:57:22.2768128Z      def test_hash_password_creates_salt(self):
2026-01-25T08:57:22.2768877Z          """Функция должна создавать соль, если она не передана."""
2026-01-25T08:57:22.2769101Z -        hashed, salt = hash_password('password123')
2026-01-25T08:57:22.2769318Z +        hashed, salt = hash_password("password123")
2026-01-25T08:57:22.2769471Z          assert salt is not None
2026-01-25T08:57:22.2769616Z          assert len(salt) == 16
2026-01-25T08:57:22.2769746Z  
2026-01-25T08:57:22.2769958Z      def test_hash_password_uses_provided_salt(self):
2026-01-25T08:57:22.2770258Z          """Функция должна использовать переданную соль."""
2026-01-25T08:57:22.2770422Z -        custom_salt = b'1234567890123456'
2026-01-25T08:57:22.2770672Z -        hashed1, _ = hash_password('password123', custom_salt)
2026-01-25T08:57:22.2770927Z -        hashed2, _ = hash_password('password123', custom_salt)
2026-01-25T08:57:22.2771307Z +        custom_salt = b"1234567890123456"
2026-01-25T08:57:22.2771549Z +        hashed1, _ = hash_password("password123", custom_salt)
2026-01-25T08:57:22.2771811Z +        hashed2, _ = hash_password("password123", custom_salt)
2026-01-25T08:57:22.2771964Z          assert hashed1 == hashed2
2026-01-25T08:57:22.2772081Z  
2026-01-25T08:57:22.2772324Z      def test_different_passwords_different_hashes(self):
2026-01-25T08:57:22.2772634Z          """Разные пароли должны давать разные хэши."""
2026-01-25T08:57:22.2772850Z -        hashed1, salt = hash_password('password123')
2026-01-25T08:57:22.2773311Z -        hashed2, _ = hash_password('password456', salt)
2026-01-25T08:57:22.2773549Z +        hashed1, salt = hash_password("password123")
2026-01-25T08:57:22.2773783Z +        hashed2, _ = hash_password("password456", salt)
2026-01-25T08:57:22.2773934Z          assert hashed1 != hashed2
2026-01-25T08:57:22.2774047Z  
2026-01-25T08:57:22.2774230Z      def test_verify_password_correct(self):
2026-01-25T08:57:22.2774490Z          """Проверка правильного пароля."""
2026-01-25T08:57:22.2774682Z -        hashed, salt = hash_password('mypassword')
2026-01-25T08:57:22.2775007Z -        assert verify_password(hashed, 'mypassword', salt) is True
2026-01-25T08:57:22.2775287Z +        hashed, salt = hash_password("mypassword")
2026-01-25T08:57:22.2775560Z +        assert verify_password(hashed, "mypassword", salt) is True
2026-01-25T08:57:22.2775675Z  
2026-01-25T08:57:22.2775859Z      def test_verify_password_incorrect(self):
2026-01-25T08:57:22.2776115Z          """Проверка неправильного пароля."""
2026-01-25T08:57:22.2776315Z -        hashed, salt = hash_password('mypassword')
2026-01-25T08:57:22.2776614Z -        assert verify_password(hashed, 'wrong_password', salt) is False
2026-01-25T08:57:22.2776815Z +        hashed, salt = hash_password("mypassword")
2026-01-25T08:57:22.2777106Z +        assert verify_password(hashed, "wrong_password", salt) is False
2026-01-25T08:57:22.2777231Z  
2026-01-25T08:57:22.2777358Z  
2026-01-25T08:57:22.2777535Z  class TestGenerateDiscriminator:
2026-01-25T08:57:22.2777813Z      """Тесты для генерации дискриминатора."""
2026-01-25T08:57:22.2778166Z  
2026-01-25T08:57:22.2778435Z      def test_generate_discriminator_new_user(self, app):
2026-01-25T08:57:22.2778802Z          """Генерация дискриминатора для нового username."""
2026-01-25T08:57:22.2778974Z          with app.app_context():
2026-01-25T08:57:22.2779115Z              db = get_db()
2026-01-25T08:57:22.2779393Z -            discriminator = generate_discriminator(db, 'new_user')
2026-01-25T08:57:22.2779644Z +            discriminator = generate_discriminator(db, "new_user")
2026-01-25T08:57:22.2779823Z              assert discriminator is not None
2026-01-25T08:57:22.2779996Z              assert 1 <= discriminator <= 9999
2026-01-25T08:57:22.2780113Z  
2026-01-25T08:57:22.2780381Z      def test_generate_discriminator_existing_user(self, app):
2026-01-25T08:57:22.2780722Z          """Генерация дискриминатора для существующего username."""
2026-01-25T08:57:22.2780894Z          with app.app_context():
2026-01-25T08:57:22.2781034Z              db = get_db()
2026-01-25T08:57:22.2781366Z              # test_user#1234 уже существует (создан в conftest.py)
2026-01-25T08:57:22.2781769Z              # Проверяем многократно, что никогда не вернётся занятый дискриминатор
2026-01-25T08:57:22.2781919Z              for _ in range(100):
2026-01-25T08:57:22.2782190Z -                discriminator = generate_discriminator(db, 'test_user')
2026-01-25T08:57:22.2782459Z +                discriminator = generate_discriminator(db, "test_user")
2026-01-25T08:57:22.2782639Z                  assert discriminator is not None
2026-01-25T08:57:22.2783231Z                  assert discriminator != 1234  # Не должен совпадать с существующим
2026-01-25T08:57:22.2783422Z                  assert 1 <= discriminator <= 9999
2026-01-25T08:57:22.2783537Z  
2026-01-25T08:57:22.2783660Z  
2026-01-25T08:57:22.2783824Z  class TestRegister:
2026-01-25T08:57:22.2784280Z      """Тесты для регистрации."""
2026-01-25T08:57:22.2784421Z  
2026-01-25T08:57:22.2784609Z      def test_register_page_loads(self, client):
2026-01-25T08:57:22.2784916Z          """Страница регистрации должна загружаться."""
2026-01-25T08:57:22.2785138Z -        response = client.get('/auth/register')
2026-01-25T08:57:22.2785307Z -        assert response.status_code == 200
2026-01-25T08:57:22.2785631Z -        assert 'Регистрация'.encode('utf-8') in response.data
2026-01-25T08:57:22.2785818Z +        response = client.get("/auth/register")
2026-01-25T08:57:22.2785986Z +        assert response.status_code == 200
2026-01-25T08:57:22.2786308Z +        assert "Регистрация".encode("utf-8") in response.data
2026-01-25T08:57:22.2786422Z  
2026-01-25T08:57:22.2786712Z      def test_register_success(self, client, app, setup_csrf_token):
2026-01-25T08:57:22.2786993Z          """Успешная регистрация нового пользователя."""
2026-01-25T08:57:22.2787155Z          csrf_token = setup_csrf_token()
2026-01-25T08:57:22.2787330Z          response = client.post(
2026-01-25T08:57:22.2787481Z -            '/auth/register',
2026-01-25T08:57:22.2787606Z -            data={
2026-01-25T08:57:22.2787789Z -                'username': 'new_user', 
2026-01-25T08:57:22.2787961Z -                'password': 'new_pass',
2026-01-25T08:57:22.2788115Z -                'csrf_token': csrf_token
2026-01-25T08:57:22.2788243Z -            },
2026-01-25T08:57:22.2788393Z -            follow_redirects=True
2026-01-25T08:57:22.2788528Z +            "/auth/register",
2026-01-25T08:57:22.2788655Z +            data={
2026-01-25T08:57:22.2788804Z +                "username": "new_user",
2026-01-25T08:57:22.2788942Z +                "password": "new_pass",
2026-01-25T08:57:22.2789091Z +                "csrf_token": csrf_token,
2026-01-25T08:57:22.2789203Z +            },
2026-01-25T08:57:22.2789342Z +            follow_redirects=True,
2026-01-25T08:57:22.2789465Z          )
2026-01-25T08:57:22.2789634Z          assert response.status_code == 200
2026-01-25T08:57:22.2790099Z          # Проверяем наличие сообщения об успешной регистрации (без учета кодировки)
2026-01-25T08:57:22.2790368Z -        response_text = response.data.decode('utf-8').lower()
2026-01-25T08:57:22.2791235Z -        assert 'успешна' in response_text or 'success' in response_text or 'welcome' in response_text
2026-01-25T08:57:22.2791551Z +        response_text = response.data.decode("utf-8").lower()
2026-01-25T08:57:22.2791691Z +        assert (
2026-01-25T08:57:22.2791969Z +            "успешна" in response_text
2026-01-25T08:57:22.2792159Z +            or "success" in response_text
2026-01-25T08:57:22.2792323Z +            or "welcome" in response_text
2026-01-25T08:57:22.2792455Z +        )
2026-01-25T08:57:22.2792582Z  
2026-01-25T08:57:22.2792879Z          # Проверяем, что пользователь создан в БД
2026-01-25T08:57:22.2793355Z          with app.app_context():
2026-01-25T08:57:22.2793483Z              db = get_db()
2026-01-25T08:57:22.2793609Z              user = db.execute(
2026-01-25T08:57:22.2793902Z -                'SELECT * FROM user WHERE username = ?', ('new_user',)
2026-01-25T08:57:22.2794131Z +                "SELECT * FROM user WHERE username = ?", ("new_user",)
2026-01-25T08:57:22.2794284Z              ).fetchone()
2026-01-25T08:57:22.2794437Z              assert user is not None
2026-01-25T08:57:22.2794553Z  
2026-01-25T08:57:22.2794871Z      def test_register_empty_username(self, client, setup_csrf_token):
2026-01-25T08:57:22.2795185Z          """Регистрация с пустым логином."""
2026-01-25T08:57:22.2795362Z          csrf_token = setup_csrf_token()
2026-01-25T08:57:22.2795537Z          response = client.post(
2026-01-25T08:57:22.2795689Z -            '/auth/register',
2026-01-25T08:57:22.2795829Z -            data={
2026-01-25T08:57:22.2795995Z -                'username': '', 
2026-01-25T08:57:22.2796181Z -                'password': 'password123',
2026-01-25T08:57:22.2796344Z -                'csrf_token': csrf_token
2026-01-25T08:57:22.2796476Z -            }
2026-01-25T08:57:22.2796965Z +            "/auth/register",
2026-01-25T08:57:22.2797331Z +            data={"username": "", "password": "password123", "csrf_token": csrf_token},
2026-01-25T08:57:22.2797492Z          )
2026-01-25T08:57:22.2797943Z          # TODO: С заглушками валидации форма всегда валидна, происходит редирект
2026-01-25T08:57:22.2798353Z          # Когда валидаторы будут реализованы, здесь должно быть 200 и ошибки
2026-01-25T08:57:22.2798875Z          assert response.status_code == 302  # Редирект после успешной регистрации
2026-01-25T08:57:22.2799292Z          # TODO: После реализации валидаторов проверить наличие ошибок валидации
2026-01-25T08:57:22.2799433Z  
2026-01-25T08:57:22.2799745Z      def test_register_empty_password(self, client, setup_csrf_token):
2026-01-25T08:57:22.2800021Z          """Регистрация с пустым паролем."""
2026-01-25T08:57:22.2800218Z          csrf_token = setup_csrf_token()
2026-01-25T08:57:22.2800399Z          response = client.post(
2026-01-25T08:57:22.2800571Z -            '/auth/register',
2026-01-25T08:57:22.2800730Z -            data={
2026-01-25T08:57:22.2800895Z -                'username': 'some_user', 
2026-01-25T08:57:22.2801055Z -                'password': '',
2026-01-25T08:57:22.2801247Z -                'csrf_token': csrf_token
2026-01-25T08:57:22.2801376Z -            }
2026-01-25T08:57:22.2801552Z +            "/auth/register",
2026-01-25T08:57:22.2801890Z +            data={"username": "some_user", "password": "", "csrf_token": csrf_token},
2026-01-25T08:57:22.2802030Z          )
2026-01-25T08:57:22.2802463Z          # TODO: С заглушками валидации форма всегда валидна, происходит редирект
2026-01-25T08:57:22.2802846Z          # Когда валидаторы будут реализованы, здесь должно быть 200 и ошибки
2026-01-25T08:57:22.2803545Z          assert response.status_code == 302  # Редирект после успешной регистрации
2026-01-25T08:57:22.2803985Z          # TODO: После реализации валидаторов проверить наличие ошибок валидation
2026-01-25T08:57:22.2804121Z  
2026-01-25T08:57:22.2804506Z      def test_register_short_password(self, client, setup_csrf_token):
2026-01-25T08:57:22.2804811Z          """Регистрация со слишком коротким паролем."""
2026-01-25T08:57:22.2805243Z          csrf_token = setup_csrf_token()
2026-01-25T08:57:22.2805441Z          response = client.post(
2026-01-25T08:57:22.2805587Z -            '/auth/register',
2026-01-25T08:57:22.2805719Z -            data={
2026-01-25T08:57:22.2805875Z -                'username': 'some_user', 
2026-01-25T08:57:22.2806031Z -                'password': '123',
2026-01-25T08:57:22.2806197Z -                'csrf_token': csrf_token
2026-01-25T08:57:22.2806328Z -            }
2026-01-25T08:57:22.2806467Z +            "/auth/register",
2026-01-25T08:57:22.2806813Z +            data={"username": "some_user", "password": "123", "csrf_token": csrf_token},
2026-01-25T08:57:22.2806933Z          )
2026-01-25T08:57:22.2807338Z          # TODO: С заглушками валидации форма всегда валидна, происходит редирект
2026-01-25T08:57:22.2807940Z          # Когда валидаторы будут реализованы, здесь должно быть 200 и ошибки
2026-01-25T08:57:22.2808383Z          assert response.status_code == 302  # Редирект после успешной регистрации
2026-01-25T08:57:22.2808776Z          # TODO: После реализации валидаторов проверить наличие ошибок валидации
2026-01-25T08:57:22.2808916Z @@ -154,106 +146,114 @@
2026-01-25T08:57:22.2809040Z  class TestLogin:
2026-01-25T08:57:22.2809260Z      """Тесты для входа в систему."""
2026-01-25T08:57:22.2809376Z  
2026-01-25T08:57:22.2809566Z      def test_login_page_loads(self, client):
2026-01-25T08:57:22.2809833Z          """Страница входа должна загружаться."""
2026-01-25T08:57:22.2810005Z -        response = client.get('/auth/login')
2026-01-25T08:57:22.2810176Z -        assert response.status_code == 200
2026-01-25T08:57:22.2810493Z -        assert 'Вход'.encode('utf-8') in response.data
2026-01-25T08:57:22.2810673Z +        response = client.get("/auth/login")
2026-01-25T08:57:22.2810845Z +        assert response.status_code == 200
2026-01-25T08:57:22.2811218Z +        assert "Вход".encode("utf-8") in response.data
2026-01-25T08:57:22.2811346Z  
2026-01-25T08:57:22.2811557Z      def test_login_success(self, client, auth):
2026-01-25T08:57:22.2811805Z          """Успешный вход."""
2026-01-25T08:57:22.2811974Z          response = auth.login()
2026-01-25T08:57:22.2812332Z          assert response.status_code == 302  # Редирект
2026-01-25T08:57:22.2812464Z  
2026-01-25T08:57:22.2812733Z          # Проверяем, что сессия установлена
2026-01-25T08:57:22.2813219Z          with client.session_transaction() as sess:
2026-01-25T08:57:22.2813459Z -            assert 'user_id' in sess
2026-01-25T08:57:22.2813628Z +            assert "user_id" in sess
2026-01-25T08:57:22.2813755Z  
2026-01-25T08:57:22.2814017Z      def test_login_success_redirect(self, client, auth):
2026-01-25T08:57:22.2814401Z          """После входа должен быть редирект на главную."""
2026-01-25T08:57:22.2814634Z          response = auth.login(follow_redirects=False)
2026-01-25T08:57:22.2814846Z          assert response.status_code == 302
2026-01-25T08:57:22.2815083Z -        assert response.headers['Location'] == '/'
2026-01-25T08:57:22.2815283Z +        assert response.headers["Location"] == "/"
2026-01-25T08:57:22.2815661Z  
2026-01-25T08:57:22.2816015Z      def test_login_invalid_format_no_hash(self, client, setup_csrf_token):
2026-01-25T08:57:22.2816339Z          """Вход с неверным форматом (без #)."""
2026-01-25T08:57:22.2816519Z          csrf_token = setup_csrf_token()
2026-01-25T08:57:22.2816696Z          response = client.post(
2026-01-25T08:57:22.2816841Z -            '/auth/login',
2026-01-25T08:57:22.2816978Z -            data={
2026-01-25T08:57:22.2817168Z -                'username': 'test_user1234', 
2026-01-25T08:57:22.2817376Z -                'password': 'test_pass',
2026-01-25T08:57:22.2817558Z -                'csrf_token': csrf_token
2026-01-25T08:57:22.2817684Z -            }
2026-01-25T08:57:22.2817813Z -        )
2026-01-25T08:57:22.2817998Z -        assert response.status_code == 200
2026-01-25T08:57:22.2818280Z -        response_text = response.data.decode('utf-8').lower()
2026-01-25T08:57:22.2818496Z -        assert ('alert-danger' in response_text or 
2026-01-25T08:57:22.2818825Z -                'ошибка' in response_text or 
2026-01-25T08:57:22.2819109Z -                'обязательно' in response_text or
2026-01-25T08:57:22.2819392Z -                'должно быть' in response_text or
2026-01-25T08:57:22.2819639Z -                'формат' in response_text)
2026-01-25T08:57:22.2819797Z +            "/auth/login",
2026-01-25T08:57:22.2819990Z +            data={
2026-01-25T08:57:22.2820189Z +                "username": "test_user1234",
2026-01-25T08:57:22.2820351Z +                "password": "test_pass",
2026-01-25T08:57:22.2820515Z +                "csrf_token": csrf_token,
2026-01-25T08:57:22.2820653Z +            },
2026-01-25T08:57:22.2820783Z +        )
2026-01-25T08:57:22.2820979Z +        assert response.status_code == 200
2026-01-25T08:57:22.2821588Z +        response_text = response.data.decode("utf-8").lower()
2026-01-25T08:57:22.2821745Z +        assert (
2026-01-25T08:57:22.2821924Z +            "alert-danger" in response_text
2026-01-25T08:57:22.2822253Z +            or "ошибка" in response_text
2026-01-25T08:57:22.2822557Z +            or "обязательно" in response_text
2026-01-25T08:57:22.2822810Z +            or "должно быть" in response_text
2026-01-25T08:57:22.2823314Z +            or "формат" in response_text
2026-01-25T08:57:22.2823458Z +        )
2026-01-25T08:57:22.2823579Z  
2026-01-25T08:57:22.2823972Z      def test_login_invalid_format_bad_discriminator(self, client, setup_csrf_token):
2026-01-25T08:57:22.2824301Z          """Вход с неверным дискриминатором (не число)."""
2026-01-25T08:57:22.2824491Z          csrf_token = setup_csrf_token()
2026-01-25T08:57:22.2824661Z          response = client.post(
2026-01-25T08:57:22.2824816Z -            '/auth/login',
2026-01-25T08:57:22.2824947Z -            data={
2026-01-25T08:57:22.2825157Z -                'username': 'test_user#abcd', 
2026-01-25T08:57:22.2825356Z -                'password': 'test_pass',
2026-01-25T08:57:22.2825509Z -                'csrf_token': csrf_token
2026-01-25T08:57:22.2825663Z -            }
2026-01-25T08:57:22.2825782Z -        )
2026-01-25T08:57:22.2825961Z -        assert response.status_code == 200
2026-01-25T08:57:22.2826231Z -        response_text = response.data.decode('utf-8').lower()
2026-01-25T08:57:22.2826457Z -        assert ('alert-danger' in response_text or 
2026-01-25T08:57:22.2826765Z -                'ошибка' in response_text or 
2026-01-25T08:57:22.2827066Z -                'обязательно' in response_text or
2026-01-25T08:57:22.2827359Z -                'должно быть' in response_text or
2026-01-25T08:57:22.2827622Z -                'формат' in response_text)
2026-01-25T08:57:22.2827768Z +            "/auth/login",
2026-01-25T08:57:22.2827900Z +            data={
2026-01-25T08:57:22.2828079Z +                "username": "test_user#abcd",
2026-01-25T08:57:22.2828262Z +                "password": "test_pass",
2026-01-25T08:57:22.2828447Z +                "csrf_token": csrf_token,
2026-01-25T08:57:22.2828574Z +            },
2026-01-25T08:57:22.2828951Z +        )
2026-01-25T08:57:22.2829185Z +        assert response.status_code == 200
2026-01-25T08:57:22.2829451Z +        response_text = response.data.decode("utf-8").lower()
2026-01-25T08:57:22.2829583Z +        assert (
2026-01-25T08:57:22.2829771Z +            "alert-danger" in response_text
2026-01-25T08:57:22.2830043Z +            or "ошибка" in response_text
2026-01-25T08:57:22.2830299Z +            or "обязательно" in response_text
2026-01-25T08:57:22.2830638Z +            or "должно быть" in response_text
2026-01-25T08:57:22.2830875Z +            or "формат" in response_text
2026-01-25T08:57:22.2831000Z +        )
2026-01-25T08:57:22.2831111Z  
2026-01-25T08:57:22.2831394Z      def test_login_wrong_password(self, client, setup_csrf_token):
2026-01-25T08:57:22.2831657Z          """Вход с неверным паролем."""
2026-01-25T08:57:22.2831842Z          csrf_token = setup_csrf_token()
2026-01-25T08:57:22.2832001Z          response = client.post(
2026-01-25T08:57:22.2832149Z -            '/auth/login',
2026-01-25T08:57:22.2832293Z -            data={
2026-01-25T08:57:22.2832470Z -                'username': 'test_user#1234', 
2026-01-25T08:57:22.2832644Z -                'password': 'wrong_pass',
2026-01-25T08:57:22.2832791Z -                'csrf_token': csrf_token
2026-01-25T08:57:22.2834462Z -            }
2026-01-25T08:57:22.2834627Z -        )
2026-01-25T08:57:22.2863575Z -        assert response.status_code == 200
2026-01-25T08:57:22.2863992Z -        response_text = response.data.decode('utf-8').lower()
2026-01-25T08:57:22.2864226Z -        assert ('alert-danger' in response_text or 
2026-01-25T08:57:22.2864633Z -                'ошибка' in response_text or 
2026-01-25T08:57:22.2864932Z -                'обязательно' in response_text or
2026-01-25T08:57:22.2865212Z -                'должно быть' in response_text or
2026-01-25T08:57:22.2865918Z -                'формат' in response_text or
2026-01-25T08:57:22.2866205Z -                'неверный' in response_text)
2026-01-25T08:57:22.2866383Z +            "/auth/login",
2026-01-25T08:57:22.2866519Z +            data={
2026-01-25T08:57:22.2866737Z +                "username": "test_user#1234",
2026-01-25T08:57:22.2866938Z +                "password": "wrong_pass",
2026-01-25T08:57:22.2867119Z +                "csrf_token": csrf_token,
2026-01-25T08:57:22.2867246Z +            },
2026-01-25T08:57:22.2867369Z +        )
2026-01-25T08:57:22.2867556Z +        assert response.status_code == 200
2026-01-25T08:57:22.2867822Z +        response_text = response.data.decode("utf-8").lower()
2026-01-25T08:57:22.2867950Z +        assert (
2026-01-25T08:57:22.2868180Z +            "alert-danger" in response_text
2026-01-25T08:57:22.2868482Z +            or "ошибка" in response_text
2026-01-25T08:57:22.2868744Z +            or "обязательно" in response_text
2026-01-25T08:57:22.2869034Z +            or "должно быть" in response_text
2026-01-25T08:57:22.2869280Z +            or "формат" in response_text
2026-01-25T08:57:22.2869531Z +            or "неверный" in response_text
2026-01-25T08:57:22.2869676Z +        )
2026-01-25T08:57:22.2869805Z  
2026-01-25T08:57:22.2870134Z      def test_login_nonexistent_user(self, client, setup_csrf_token):
2026-01-25T08:57:22.2870431Z          """Вход с несуществующим пользователем."""
2026-01-25T08:57:22.2870647Z          csrf_token = setup_csrf_token()
2026-01-25T08:57:22.2870851Z          response = client.post(
2026-01-25T08:57:22.2871003Z -            '/auth/login',
2026-01-25T08:57:22.2871163Z -            data={
2026-01-25T08:57:22.2871338Z -                'username': 'no_user#0000', 
2026-01-25T08:57:22.2871505Z -                'password': 'any_pass',
2026-01-25T08:57:22.2871673Z -                'csrf_token': csrf_token
2026-01-25T08:57:22.2871833Z -            }
2026-01-25T08:57:22.2871964Z -        )
2026-01-25T08:57:22.2872203Z -        assert response.status_code == 200
2026-01-25T08:57:22.2872495Z -        response_text = response.data.decode('utf-8').lower()
2026-01-25T08:57:22.2872716Z -        assert ('alert-danger' in response_text or 
2026-01-25T08:57:22.2873532Z -                'ошибка' in response_text or 
2026-01-25T08:57:22.2873820Z -                'обязательно' in response_text or
2026-01-25T08:57:22.2874108Z -                'должно быть' in response_text or
2026-01-25T08:57:22.2874365Z -                'формат' in response_text or
2026-01-25T08:57:22.2874615Z -                'неверный' in response_text)
2026-01-25T08:57:22.2874772Z +            "/auth/login",
2026-01-25T08:57:22.2874910Z +            data={
2026-01-25T08:57:22.2875075Z +                "username": "no_user#0000",
2026-01-25T08:57:22.2875237Z +                "password": "any_pass",
2026-01-25T08:57:22.2875387Z +                "csrf_token": csrf_token,
2026-01-25T08:57:22.2875510Z +            },
2026-01-25T08:57:22.2875656Z +        )
2026-01-25T08:57:22.2875911Z +        assert response.status_code == 200
2026-01-25T08:57:22.2876191Z +        response_text = response.data.decode("utf-8").lower()
2026-01-25T08:57:22.2876325Z +        assert (
2026-01-25T08:57:22.2876519Z +            "alert-danger" in response_text
2026-01-25T08:57:22.2876797Z +            or "ошибка" in response_text
2026-01-25T08:57:22.2877054Z +            or "обязательно" in response_text
2026-01-25T08:57:22.2877308Z +            or "должно быть" in response_text
2026-01-25T08:57:22.2877556Z +            or "формат" in response_text
2026-01-25T08:57:22.2877800Z +            or "неверный" in response_text
2026-01-25T08:57:22.2877924Z +        )
2026-01-25T08:57:22.2878053Z  
2026-01-25T08:57:22.2878170Z  
2026-01-25T08:57:22.2878320Z  class TestLogout:
2026-01-25T08:57:22.2878559Z      """Тесты для выхода из системы."""
2026-01-25T08:57:22.2878679Z  
2026-01-25T08:57:22.2878819Z @@ -261,43 +261,45 @@
2026-01-25T08:57:22.2879077Z          """Выход из системы очищает сессию."""
2026-01-25T08:57:22.2879490Z          auth.login()
2026-01-25T08:57:22.2879625Z  
2026-01-25T08:57:22.2879878Z          # Проверяем, что залогинены
2026-01-25T08:57:22.2880089Z          with client.session_transaction() as sess:
2026-01-25T08:57:22.2880282Z -            assert 'user_id' in sess
2026-01-25T08:57:22.2880433Z +            assert "user_id" in sess
2026-01-25T08:57:22.2880560Z  
2026-01-25T08:57:22.2880728Z          response = auth.logout()
2026-01-25T08:57:22.2880909Z          assert response.status_code == 302
2026-01-25T08:57:22.2881056Z  
2026-01-25T08:57:22.2881329Z          # Проверяем, что сессия очищена
2026-01-25T08:57:22.2881548Z          with client.session_transaction() as sess:
2026-01-25T08:57:22.2881720Z -            assert 'user_id' not in sess
2026-01-25T08:57:22.2881896Z +            assert "user_id" not in sess
2026-01-25T08:57:22.2882017Z  
2026-01-25T08:57:22.2882143Z  
2026-01-25T08:57:22.2882314Z  class TestLoginRequired:
2026-01-25T08:57:22.2882614Z      """Тесты для декоратора login_required."""
2026-01-25T08:57:22.2882773Z  
2026-01-25T08:57:22.2883245Z      def test_load_logged_in_user(self, client, auth, app):
2026-01-25T08:57:22.2883576Z          """Загрузка залогиненного пользователя в g."""
2026-01-25T08:57:22.2883750Z          auth.login()
2026-01-25T08:57:22.2883864Z  
2026-01-25T08:57:22.2884009Z          with client:
2026-01-25T08:57:22.2884165Z -            client.get('/')
2026-01-25T08:57:22.2884308Z +            client.get("/")
2026-01-25T08:57:22.2884469Z              from flask import g
2026-01-25T08:57:22.2884586Z +
2026-01-25T08:57:22.2884751Z              assert g.user is not None
2026-01-25T08:57:22.2885081Z -            assert g.user['username'] == 'test_user'
2026-01-25T08:57:22.2885283Z +            assert g.user["username"] == "test_user"
2026-01-25T08:57:22.2885416Z  
2026-01-25T08:57:22.2885702Z      def test_load_logged_in_user_anonymous(self, client, app):
2026-01-25T08:57:22.2886050Z          """Для не залогиненного пользователя g.user = None."""
2026-01-25T08:57:22.2886227Z          with client:
2026-01-25T08:57:22.2886374Z -            client.get('/')
2026-01-25T08:57:22.2886514Z +            client.get("/")
2026-01-25T08:57:22.2886996Z              from flask import g
2026-01-25T08:57:22.2887118Z +
2026-01-25T08:57:22.2887268Z              assert g.user is None
2026-01-25T08:57:22.2887392Z  
2026-01-25T08:57:22.2887636Z      def test_login_required_decorator(self, client):
2026-01-25T08:57:22.2888016Z          """Проверка, что защищенные маршруты требуют логина."""
2026-01-25T08:57:22.2888412Z          # Предположим, у нас есть защищенный маршрут, например, создание поста
2026-01-25T08:57:22.2888769Z          # Если его нет, этот тест можно адаптировать под существующий
2026-01-25T08:57:22.2889133Z -        response = client.get('/post/create', follow_redirects=False)
2026-01-25T08:57:22.2889449Z +        response = client.get("/post/create", follow_redirects=False)
2026-01-25T08:57:22.2889850Z          # Если маршрут защищен login_required, он должен редиректить
2026-01-25T08:57:22.2890299Z          if response.status_code == 302:
2026-01-25T08:57:22.2890565Z -            assert '/auth/login' in response.headers['Location']
2026-01-25T08:57:22.2890993Z +            assert "/auth/login" in response.headers["Location"]
2026-01-25T08:57:22.3889111Z would reformat /home/runner/work/flask_blog/flask_blog/tests/test_discriminator.py
2026-01-25T08:57:22.3894530Z --- /home/runner/work/flask_blog/flask_blog/tests/test_discriminator.py	2026-01-25 08:57:06.654994+00:00
2026-01-25T08:57:22.3897384Z +++ /home/runner/work/flask_blog/flask_blog/tests/test_discriminator.py	2026-01-25 08:57:22.385745+00:00
2026-01-25T08:57:22.3899494Z @@ -10,141 +10,149 @@
2026-01-25T08:57:22.3901561Z      """Тесты логики генерации дискриминаторов."""
2026-01-25T08:57:22.3903523Z  
2026-01-25T08:57:22.3905241Z      def test_random_discriminator_generation(self):
2026-01-25T08:57:22.3907382Z          """Проверка, что разные пользователи получают разные случайные дискриминаторы."""
2026-01-25T08:57:22.3909373Z          db_fd, db_path = tempfile.mkstemp()
2026-01-25T08:57:22.3911068Z -        
2026-01-25T08:57:22.3912739Z -        app = create_app({
2026-01-25T08:57:22.3914773Z -            'TESTING': True,
2026-01-25T08:57:22.3916440Z -            'DATABASE': db_path,
2026-01-25T08:57:22.3918236Z -            'SECRET_KEY': 'test-secret-key-for-testing',
2026-01-25T08:57:22.3919997Z -            'WTF_CSRF_ENABLED': False,
2026-01-25T08:57:22.3921709Z -        })
2026-01-25T08:57:22.3923669Z +
2026-01-25T08:57:22.3936807Z +        app = create_app(
2026-01-25T08:57:22.3937203Z +            {
2026-01-25T08:57:22.3937544Z +                "TESTING": True,
2026-01-25T08:57:22.3937955Z +                "DATABASE": db_path,
2026-01-25T08:57:22.3938483Z +                "SECRET_KEY": "test-secret-key-for-testing",
2026-01-25T08:57:22.3939033Z +                "WTF_CSRF_ENABLED": False,
2026-01-25T08:57:22.3939464Z +            }
2026-01-25T08:57:22.3939764Z +        )
2026-01-25T08:57:22.3940052Z  
2026-01-25T08:57:22.3940372Z          with app.app_context():
2026-01-25T08:57:22.3940838Z              from app.db.db import init_db, get_db
2026-01-25T08:57:22.3941405Z              from app.auth.utils import generate_discriminator
2026-01-25T08:57:22.3942415Z              from app.auth import hash_password
2026-01-25T08:57:22.3942872Z -            
2026-01-25T08:57:22.3943400Z +
2026-01-25T08:57:22.3943702Z              init_db()
2026-01-25T08:57:22.3944063Z              db = get_db()
2026-01-25T08:57:22.3944429Z -            
2026-01-25T08:57:22.3944716Z +
2026-01-25T08:57:22.3945276Z              # Создаем несколько пользователей с одинаковым именем
2026-01-25T08:57:22.3945812Z              discriminators = []
2026-01-25T08:57:22.3946216Z -            
2026-01-25T08:57:22.3946530Z +
2026-01-25T08:57:22.3946819Z              for i in range(5):
2026-01-25T08:57:22.3947302Z -                disc = generate_discriminator(db, 'testuser')
2026-01-25T08:57:22.3947897Z +                disc = generate_discriminator(db, "testuser")
2026-01-25T08:57:22.3948452Z                  assert disc is not None
2026-01-25T08:57:22.3948912Z                  assert 1 <= disc <= 9999
2026-01-25T08:57:22.3949387Z                  discriminators.append(disc)
2026-01-25T08:57:22.3949840Z -                
2026-01-25T08:57:22.3950165Z +
2026-01-25T08:57:22.3950580Z                  # Добавляем пользователя в БД
2026-01-25T08:57:22.3951116Z -                hashed_pw, salt = hash_password(f'pass{i}')
2026-01-25T08:57:22.3951736Z +                hashed_pw, salt = hash_password(f"pass{i}")
2026-01-25T08:57:22.3952260Z                  db.execute(
2026-01-25T08:57:22.3953085Z -                    'INSERT INTO user (username, discriminator, password, salt) VALUES (?, ?, ?, ?)',
2026-01-25T08:57:22.3953883Z -                    ('testuser', disc, hashed_pw, salt)
2026-01-25T08:57:22.3954681Z +                    "INSERT INTO user (username, discriminator, password, salt) VALUES (?, ?, ?, ?)",
2026-01-25T08:57:22.3955463Z +                    ("testuser", disc, hashed_pw, salt),
2026-01-25T08:57:22.3956244Z                  )
2026-01-25T08:57:22.3956593Z                  db.commit()
2026-01-25T08:57:22.3956959Z -            
2026-01-25T08:57:22.3957270Z +
2026-01-25T08:57:22.3957738Z              # Проверяем, что все дискриминаторы разные
2026-01-25T08:57:22.3958372Z              assert len(set(discriminators)) == len(discriminators)
2026-01-25T08:57:22.3959187Z              print(f"Сгенерированные дискриминаторы: {discriminators}")
2026-01-25T08:57:22.3959725Z  
2026-01-25T08:57:22.3960020Z          os.close(db_fd)
2026-01-25T08:57:22.3960444Z          os.unlink(db_path)
2026-01-25T08:57:22.3960800Z  
2026-01-25T08:57:22.3961143Z      def test_discriminator_exhaustion(self):
2026-01-25T08:57:22.3961870Z          """Проверка поведения при исчерпании всех дискриминаторов."""
2026-01-25T08:57:22.3962425Z          db_fd, db_path = tempfile.mkstemp()
2026-01-25T08:57:22.3962874Z -        
2026-01-25T08:57:22.3963415Z -        app = create_app({
2026-01-25T08:57:22.3963831Z -            'TESTING': True,
2026-01-25T08:57:22.3964245Z -            'DATABASE': db_path,
2026-01-25T08:57:22.3964730Z -            'SECRET_KEY': 'test-secret-key-for-testing',
2026-01-25T08:57:22.3965276Z -            'WTF_CSRF_ENABLED': False,
2026-01-25T08:57:22.3965689Z -        })
2026-01-25T08:57:22.3965970Z +
2026-01-25T08:57:22.3966261Z +        app = create_app(
2026-01-25T08:57:22.3966687Z +            {
2026-01-25T08:57:22.3967009Z +                "TESTING": True,
2026-01-25T08:57:22.3967419Z +                "DATABASE": db_path,
2026-01-25T08:57:22.3967934Z +                "SECRET_KEY": "test-secret-key-for-testing",
2026-01-25T08:57:22.3968467Z +                "WTF_CSRF_ENABLED": False,
2026-01-25T08:57:22.3968916Z +            }
2026-01-25T08:57:22.3969221Z +        )
2026-01-25T08:57:22.3969502Z  
2026-01-25T08:57:22.3969808Z          with app.app_context():
2026-01-25T08:57:22.3970251Z              from app.db.db import init_db, get_db
2026-01-25T08:57:22.3970969Z              from app.auth.utils import generate_discriminator, MAX_DISCRIMINATOR
2026-01-25T08:57:22.3971611Z -            
2026-01-25T08:57:22.3971910Z +
2026-01-25T08:57:22.3972195Z              init_db()
2026-01-25T08:57:22.3972859Z              db = get_db()
2026-01-25T08:57:22.3973392Z -            
2026-01-25T08:57:22.3973693Z +
2026-01-25T08:57:22.3974206Z              # Занимаем все дискриминаторы для имени 'testuser'
2026-01-25T08:57:22.3974972Z              for disc in range(1, 6):  # Для теста используем только первые 5
2026-01-25T08:57:22.3975593Z                  from app.auth import hash_password
2026-01-25T08:57:22.3976133Z -                hashed_pw, salt = hash_password('pass')
2026-01-25T08:57:22.3976618Z +
2026-01-25T08:57:22.3976955Z +                hashed_pw, salt = hash_password("pass")
2026-01-25T08:57:22.3977503Z                  db.execute(
2026-01-25T08:57:22.3978233Z -                    'INSERT INTO user (username, discriminator, password, salt) VALUES (?, ?, ?, ?)',
2026-01-25T08:57:22.3979113Z -                    ('testuser', disc, hashed_pw, salt)
2026-01-25T08:57:22.3979854Z +                    "INSERT INTO user (username, discriminator, password, salt) VALUES (?, ?, ?, ?)",
2026-01-25T08:57:22.3980639Z +                    ("testuser", disc, hashed_pw, salt),
2026-01-25T08:57:22.3981121Z                  )
2026-01-25T08:57:22.3981450Z              db.commit()
2026-01-25T08:57:22.3981803Z -            
2026-01-25T08:57:22.3982131Z +
2026-01-25T08:57:22.3982704Z              # Проверяем, что для новых пользователей есть свободные дискриминаторы (6-9999)
2026-01-25T08:57:22.3983562Z -            disc = generate_discriminator(db, 'testuser')
2026-01-25T08:57:22.3984163Z +            disc = generate_discriminator(db, "testuser")
2026-01-25T08:57:22.3984684Z              assert disc is not None
2026-01-25T08:57:22.3985303Z              assert disc >= 6  # Должен быть следующий свободный
2026-01-25T08:57:22.3985850Z -            
2026-01-25T08:57:22.3986151Z +
2026-01-25T08:57:22.3986634Z              # Но для другого имени должны быть свободные дискриминаторы
2026-01-25T08:57:22.3987502Z              from app.auth import hash_password
2026-01-25T08:57:22.3988062Z -            hashed_pw2, salt2 = hash_password('pass2')
2026-01-25T08:57:22.3988672Z -            disc2 = generate_discriminator(db, 'otheruser')
2026-01-25T08:57:22.3989177Z +
2026-01-25T08:57:22.3989547Z +            hashed_pw2, salt2 = hash_password("pass2")
2026-01-25T08:57:22.3990141Z +            disc2 = generate_discriminator(db, "otheruser")
2026-01-25T08:57:22.3990692Z              assert disc2 is not None
2026-01-25T08:57:22.3991136Z              assert 1 <= disc2 <= 9999
2026-01-25T08:57:22.3991535Z  
2026-01-25T08:57:22.3991821Z          os.close(db_fd)
2026-01-25T08:57:22.3992195Z          os.unlink(db_path)
2026-01-25T08:57:22.3992550Z  
2026-01-25T08:57:22.3993147Z      def test_different_usernames_independent_discriminators(self):
2026-01-25T08:57:22.3994106Z          """Проверка, что разные имена пользователей имеют независимые наборы дискриминаторов."""
2026-01-25T08:57:22.3994831Z          db_fd, db_path = tempfile.mkstemp()
2026-01-25T08:57:22.3995254Z -        
2026-01-25T08:57:22.3995569Z -        app = create_app({
2026-01-25T08:57:22.3995972Z -            'TESTING': True,
2026-01-25T08:57:22.3996372Z -            'DATABASE': db_path,
2026-01-25T08:57:22.3996869Z -            'SECRET_KEY': 'test-secret-key-for-testing',
2026-01-25T08:57:22.3997392Z -            'WTF_CSRF_ENABLED': False,
2026-01-25T08:57:22.3997814Z -        })
2026-01-25T08:57:22.3998091Z +
2026-01-25T08:57:22.3998386Z +        app = create_app(
2026-01-25T08:57:22.3998744Z +            {
2026-01-25T08:57:22.3999056Z +                "TESTING": True,
2026-01-25T08:57:22.3999487Z +                "DATABASE": db_path,
2026-01-25T08:57:22.3999996Z +                "SECRET_KEY": "test-secret-key-for-testing",
2026-01-25T08:57:22.4000514Z +                "WTF_CSRF_ENABLED": False,
2026-01-25T08:57:22.4000865Z +            }
2026-01-25T08:57:22.4001117Z +        )
2026-01-25T08:57:22.4001352Z  
2026-01-25T08:57:22.4001635Z          with app.app_context():
2026-01-25T08:57:22.4002018Z              from app.db.db import init_db, get_db
2026-01-25T08:57:22.4002722Z              from app.auth.utils import generate_discriminator
2026-01-25T08:57:22.4003364Z              from app.auth import hash_password
2026-01-25T08:57:22.4003734Z -            
2026-01-25T08:57:22.4003990Z +
2026-01-25T08:57:22.4004232Z              init_db()
2026-01-25T08:57:22.4004517Z              db = get_db()
2026-01-25T08:57:22.4004803Z -            
2026-01-25T08:57:22.4005036Z +
2026-01-25T08:57:22.4005427Z              # Создаем пользователя с именем 'alice'
2026-01-25T08:57:22.4005890Z -            disc1 = generate_discriminator(db, 'alice')
2026-01-25T08:57:22.4006339Z -            hashed_pw1, salt1 = hash_password('pass1')
2026-01-25T08:57:22.4006826Z +            disc1 = generate_discriminator(db, "alice")
2026-01-25T08:57:22.4007290Z +            hashed_pw1, salt1 = hash_password("pass1")
2026-01-25T08:57:22.4007714Z              db.execute(
2026-01-25T08:57:22.4008335Z -                'INSERT INTO user (username, discriminator, password, salt) VALUES (?, ?, ?, ?)',
2026-01-25T08:57:22.4008993Z -                ('alice', disc1, hashed_pw1, salt1)
2026-01-25T08:57:22.4009605Z +                "INSERT INTO user (username, discriminator, password, salt) VALUES (?, ?, ?, ?)",
2026-01-25T08:57:22.4010203Z +                ("alice", disc1, hashed_pw1, salt1),
2026-01-25T08:57:22.4010584Z              )
2026-01-25T08:57:22.4010944Z              db.commit()
2026-01-25T08:57:22.4011233Z -            
2026-01-25T08:57:22.4011496Z +
2026-01-25T08:57:22.4011918Z              # Создаем пользователя с таким же дискриминатором, но другим именем
2026-01-25T08:57:22.4012411Z -            disc2 = generate_discriminator(db, 'bob')
2026-01-25T08:57:22.4012858Z +            disc2 = generate_discriminator(db, "bob")
2026-01-25T08:57:22.4013593Z              # Дискриминатор может быть любым доступным, не обязательно таким же
2026-01-25T08:57:22.4014351Z              assert disc2 is not None
2026-01-25T08:57:22.4014712Z              assert 1 <= disc2 <= 9999
2026-01-25T08:57:22.4015090Z -            
2026-01-25T08:57:22.4015404Z -            hashed_pw2, salt2 = hash_password('pass2')
2026-01-25T08:57:22.4015797Z +
2026-01-25T08:57:22.4016101Z +            hashed_pw2, salt2 = hash_password("pass2")
2026-01-25T08:57:22.4016519Z              db.execute(
2026-01-25T08:57:22.4017065Z -                'INSERT INTO user (username, discriminator, password, salt) VALUES (?, ?, ?, ?)',
2026-01-25T08:57:22.4017695Z -                ('bob', disc2, hashed_pw2, salt2)
2026-01-25T08:57:22.4018299Z +                "INSERT INTO user (username, discriminator, password, salt) VALUES (?, ?, ?, ?)",
2026-01-25T08:57:22.4018940Z +                ("bob", disc2, hashed_pw2, salt2),
2026-01-25T08:57:22.4019338Z              )
2026-01-25T08:57:22.4019606Z              db.commit()
2026-01-25T08:57:22.4019893Z -            
2026-01-25T08:57:22.4020147Z +
2026-01-25T08:57:22.4020517Z              # Проверяем, что оба пользователя созданы
2026-01-25T08:57:22.4020939Z              users = db.execute(
2026-01-25T08:57:22.4021514Z -                'SELECT username, discriminator FROM user WHERE username IN (?, ?)',
2026-01-25T08:57:22.4022101Z -                ('alice', 'bob')
2026-01-25T08:57:22.4022660Z +                "SELECT username, discriminator FROM user WHERE username IN (?, ?)",
2026-01-25T08:57:22.4023424Z +                ("alice", "bob"),
2026-01-25T08:57:22.4023794Z              ).fetchall()
2026-01-25T08:57:22.4024108Z -            
2026-01-25T08:57:22.4024373Z +
2026-01-25T08:57:22.4024642Z              assert len(users) == 2
2026-01-25T08:57:22.4025198Z              # Дискриминаторы могут быть разными, это нормально
2026-01-25T08:57:22.4025741Z -            assert users[0]['username'] != users[1]['username']
2026-01-25T08:57:22.4026308Z +            assert users[0]["username"] != users[1]["username"]
2026-01-25T08:57:22.4026782Z  
2026-01-25T08:57:22.4027046Z          os.close(db_fd)
2026-01-25T08:57:22.4027388Z          os.unlink(db_path)
2026-01-25T08:57:22.4479056Z --- /home/runner/work/flask_blog/flask_blog/tests/test_comments.py	2026-01-25 08:57:06.653994+00:00
2026-01-25T08:57:22.4480807Z +++ /home/runner/work/flask_blog/flask_blog/tests/test_comments.py	2026-01-25 08:57:22.442567+00:00
2026-01-25T08:57:22.4484703Z @@ -1,6 +1,7 @@
2026-01-25T08:57:22.4487444Z would reformat /home/runner/work/flask_blog/flask_blog/tests/test_comments.py
2026-01-25T08:57:22.4488590Z  """Тесты для функционала комментариев."""
2026-01-25T08:57:22.4489042Z +
2026-01-25T08:57:22.4489388Z  import pytest
2026-01-25T08:57:22.4489754Z  from flask import session
2026-01-25T08:57:22.4490124Z  
2026-01-25T08:57:22.4490444Z  from app.models import Comment
2026-01-25T08:57:22.4490903Z  from app.services import CommentService
2026-01-25T08:57:22.4491427Z @@ -12,27 +13,24 @@
2026-01-25T08:57:22.4491858Z      def test_create_comment(self, app, client, auth):
2026-01-25T08:57:22.4492627Z          """Создание комментария должно работать корректно."""
2026-01-25T08:57:22.4493536Z          # Сначала регистрируем, логинимся и создаём пост
2026-01-25T08:57:22.4494030Z          auth.register()
2026-01-25T08:57:22.4494398Z          auth.login()
2026-01-25T08:57:22.4494727Z -        
2026-01-25T08:57:22.4494994Z +
2026-01-25T08:57:22.4495291Z          with app.app_context():
2026-01-25T08:57:22.4495790Z              # Создаём пост для комментария
2026-01-25T08:57:22.4496269Z              from app.services import PostService
2026-01-25T08:57:22.4496757Z -            post = PostService.create(
2026-01-25T08:57:22.4497223Z -                author_id=1,
2026-01-25T08:57:22.4497722Z -                title="Тестовый пост",
2026-01-25T08:57:22.4498261Z -                content="Содержание поста"
2026-01-25T08:57:22.4498688Z -            )
2026-01-25T08:57:22.4499034Z -            
2026-01-25T08:57:22.4499319Z +
2026-01-25T08:57:22.4499621Z +            post = PostService.create(
2026-01-25T08:57:22.4500583Z +                author_id=1, title="Тестовый пост", content="Содержание поста"
2026-01-25T08:57:22.4501120Z +            )
2026-01-25T08:57:22.4501409Z +
2026-01-25T08:57:22.4501803Z              # Создаём комментарий
2026-01-25T08:57:22.4502249Z              comment = CommentService.create(
2026-01-25T08:57:22.4502721Z -                author_id=1,
2026-01-25T08:57:22.4503320Z -                post_id=post.id,
2026-01-25T08:57:22.4503844Z -                content="Это тестовый комментарий"
2026-01-25T08:57:22.4504285Z -            )
2026-01-25T08:57:22.4504581Z -            
2026-01-25T08:57:22.4505165Z +                author_id=1, post_id=post.id, content="Это тестовый комментарий"
2026-01-25T08:57:22.4505731Z +            )
2026-01-25T08:57:22.4506018Z +
2026-01-25T08:57:22.4506321Z              assert comment.id is not None
2026-01-25T08:57:22.4506952Z              assert comment.content == "Это тестовый комментарий"
2026-01-25T08:57:22.4507494Z              assert comment.author_id == 1
2026-01-25T08:57:22.4508005Z              assert comment.post_id == post.id
2026-01-25T08:57:22.4508491Z              assert comment.created is not None
2026-01-25T08:57:22.4509231Z @@ -41,158 +39,135 @@
2026-01-25T08:57:22.4509546Z  
2026-01-25T08:57:22.4509887Z      def test_find_comment_by_id(self, app, auth):
2026-01-25T08:57:22.4510523Z          """Поиск комментария по ID должен работать."""
2026-01-25T08:57:22.4511031Z          auth.register()
2026-01-25T08:57:22.4511420Z          auth.login()
2026-01-25T08:57:22.4511735Z -        
2026-01-25T08:57:22.4512085Z -        with app.app_context():
2026-01-25T08:57:22.4512546Z -            # Создаём пост
2026-01-25T08:57:22.4513152Z -            from app.services import PostService
2026-01-25T08:57:22.4513706Z -            post = PostService.create(
2026-01-25T08:57:22.4514250Z -                author_id=1,
2026-01-25T08:57:22.4514791Z -                title="Тестовый пост",
2026-01-25T08:57:22.4515365Z -                content="Содержание"
2026-01-25T08:57:22.4515831Z -            )
2026-01-25T08:57:22.4516140Z -            
2026-01-25T08:57:22.4516434Z +
2026-01-25T08:57:22.4516749Z +        with app.app_context():
2026-01-25T08:57:22.4517269Z +            # Создаём пост
2026-01-25T08:57:22.4517712Z +            from app.services import PostService
2026-01-25T08:57:22.4518187Z +
2026-01-25T08:57:22.4518519Z +            post = PostService.create(
2026-01-25T08:57:22.4519244Z +                author_id=1, title="Тестовый пост", content="Содержание"
2026-01-25T08:57:22.4519813Z +            )
2026-01-25T08:57:22.4520121Z +
2026-01-25T08:57:22.4520506Z              # Создаём комментарий
2026-01-25T08:57:22.4521017Z              created_comment = CommentService.create(
2026-01-25T08:57:22.4521547Z -                author_id=1,
2026-01-25T08:57:22.4521963Z -                post_id=post.id,
2026-01-25T08:57:22.4522532Z -                content="Тестовый комментарий"
2026-01-25T08:57:22.4523220Z -            )
2026-01-25T08:57:22.4523554Z -            
2026-01-25T08:57:22.4524666Z +                author_id=1, post_id=post.id, content="Тестовый комментарий"
2026-01-25T08:57:22.4525328Z +            )
2026-01-25T08:57:22.4525634Z +
2026-01-25T08:57:22.4526068Z              # Ищем комментарий по ID
2026-01-25T08:57:22.4526683Z              found_comment = CommentService.find_by_id(created_comment.id)
2026-01-25T08:57:22.4527293Z -            
2026-01-25T08:57:22.4527597Z +
2026-01-25T08:57:22.4527929Z              assert found_comment is not None
2026-01-25T08:57:22.4528503Z              assert found_comment.id == created_comment.id
2026-01-25T08:57:22.4529296Z              assert found_comment.content == "Тестовый комментарий"
2026-01-25T08:57:22.4529846Z  
2026-01-25T08:57:22.4530241Z      def test_get_comments_by_post_id(self, app, auth):
2026-01-25T08:57:22.4531033Z          """Получение комментариев к посту должно работать."""
2026-01-25T08:57:22.4531573Z          auth.register()
2026-01-25T08:57:22.4531970Z          auth.login()
2026-01-25T08:57:22.4532356Z -        
2026-01-25T08:57:22.4532683Z -        with app.app_context():
2026-01-25T08:57:22.4533391Z -            # Создаём пост
2026-01-25T08:57:22.4533854Z -            from app.services import PostService
2026-01-25T08:57:22.4534371Z -            post = PostService.create(
2026-01-25T08:57:22.4534789Z -                author_id=1,
2026-01-25T08:57:22.4535263Z -                title="Тестовый пост",
2026-01-25T08:57:22.4535818Z -                content="Содержание"
2026-01-25T08:57:22.4536242Z -            )
2026-01-25T08:57:22.4536536Z -            
2026-01-25T08:57:22.4536841Z +
2026-01-25T08:57:22.4537125Z +        with app.app_context():
2026-01-25T08:57:22.4537597Z +            # Создаём пост
2026-01-25T08:57:22.4538014Z +            from app.services import PostService
2026-01-25T08:57:22.4538462Z +
2026-01-25T08:57:22.4538781Z +            post = PostService.create(
2026-01-25T08:57:22.4539400Z +                author_id=1, title="Тестовый пост", content="Содержание"
2026-01-25T08:57:22.4539968Z +            )
2026-01-25T08:57:22.4540311Z +
2026-01-25T08:57:22.4540743Z              # Создаём несколько комментариев
2026-01-25T08:57:22.4541256Z              comment1 = CommentService.create(
2026-01-25T08:57:22.4542023Z -                author_id=1,
2026-01-25T08:57:22.4542445Z -                post_id=post.id,
2026-01-25T08:57:22.4543298Z -                content="Первый комментарий"
2026-01-25T08:57:22.4544065Z +                author_id=1, post_id=post.id, content="Первый комментарий"
2026-01-25T08:57:22.4544626Z              )
2026-01-25T08:57:22.4544990Z              comment2 = CommentService.create(
2026-01-25T08:57:22.4545466Z -                author_id=1,
2026-01-25T08:57:22.4545916Z -                post_id=post.id,
2026-01-25T08:57:22.4546487Z -                content="Второй комментарий"
2026-01-25T08:57:22.4546927Z -            )
2026-01-25T08:57:22.4547247Z -            
2026-01-25T08:57:22.4547881Z +                author_id=1, post_id=post.id, content="Второй комментарий"
2026-01-25T08:57:22.4548537Z +            )
2026-01-25T08:57:22.4548853Z +
2026-01-25T08:57:22.4549308Z              # Получаем комментарии к посту
2026-01-25T08:57:22.4549864Z              comments = CommentService.get_by_post_id(post.id)
2026-01-25T08:57:22.4550451Z -            
2026-01-25T08:57:22.4550778Z +
2026-01-25T08:57:22.4551089Z              assert len(comments) == 2
2026-01-25T08:57:22.4551928Z              assert comments[0].content in ["Первый комментарий", "Второй комментарий"]
2026-01-25T08:57:22.4553315Z              assert comments[1].content in ["Первый комментарий", "Второй комментарий"]
2026-01-25T08:57:22.4554137Z  
2026-01-25T08:57:22.4656409Z      def test_delete_own_comment(self, app, auth):
2026-01-25T08:57:22.4657350Z          """Удаление своего комментария должно работать."""
2026-01-25T08:57:22.4657835Z          auth.register()
2026-01-25T08:57:22.4658211Z          auth.login()
2026-01-25T08:57:22.4658602Z -        
2026-01-25T08:57:22.4658921Z -        with app.app_context():
2026-01-25T08:57:22.4659984Z -            # Создаём пост
2026-01-25T08:57:22.4660386Z -            from app.services import PostService
2026-01-25T08:57:22.4660892Z -            post = PostService.create(
2026-01-25T08:57:22.4661332Z -                author_id=1,
2026-01-25T08:57:22.4661851Z -                title="Тестовый пост",
2026-01-25T08:57:22.4662428Z -                content="Содержание"
2026-01-25T08:57:22.4662868Z -            )
2026-01-25T08:57:22.4663381Z -            
2026-01-25T08:57:22.4663755Z +
2026-01-25T08:57:22.4664121Z +        with app.app_context():
2026-01-25T08:57:22.4664675Z +            # Создаём пост
2026-01-25T08:57:22.4665159Z +            from app.services import PostService
2026-01-25T08:57:22.4665719Z +
2026-01-25T08:57:22.4666073Z +            post = PostService.create(
2026-01-25T08:57:22.4666846Z +                author_id=1, title="Тестовый пост", content="Содержание"
2026-01-25T08:57:22.4667435Z +            )
2026-01-25T08:57:22.4667761Z +
2026-01-25T08:57:22.4668152Z              # Создаём комментарий
2026-01-25T08:57:22.4668671Z              comment = CommentService.create(
2026-01-25T08:57:22.4669156Z -                author_id=1,
2026-01-25T08:57:22.4669595Z -                post_id=post.id,
2026-01-25T08:57:22.4670204Z -                content="Тестовый комментарий"
2026-01-25T08:57:22.4670661Z -            )
2026-01-25T08:57:22.4670953Z -            
2026-01-25T08:57:22.4671598Z +                author_id=1, post_id=post.id, content="Тестовый комментарий"
2026-01-25T08:57:22.4672191Z +            )
2026-01-25T08:57:22.4672489Z +
2026-01-25T08:57:22.4672868Z              # Удаляем свой комментарий
2026-01-25T08:57:22.4673625Z              result = CommentService.delete(comment.id, 1)
2026-01-25T08:57:22.4674110Z -            
2026-01-25T08:57:22.4674399Z +
2026-01-25T08:57:22.4674727Z              assert result is True
2026-01-25T08:57:22.4675161Z -            
2026-01-25T08:57:22.4675445Z +
2026-01-25T08:57:22.4675878Z              # Проверяем, что комментарий удалён
2026-01-25T08:57:22.4676479Z              deleted_comment = CommentService.find_by_id(comment.id)
2026-01-25T08:57:22.4677069Z              assert deleted_comment is None
2026-01-25T08:57:22.4677498Z  
2026-01-25T08:57:22.4678180Z      def test_delete_foreign_comment(self, app, auth):
2026-01-25T08:57:22.4678904Z          """Удаление чужого комментария не должно работать."""
2026-01-25T08:57:22.4679483Z          # Создаём двух пользователей
2026-01-25T08:57:22.4679940Z          auth.register(username="user1")
2026-01-25T08:57:22.4680408Z          auth.register(username="user2")
2026-01-25T08:57:22.4680861Z -        
2026-01-25T08:57:22.4681149Z +
2026-01-25T08:57:22.4681512Z          with app.app_context():
2026-01-25T08:57:22.4682087Z              # Создаём пост от первого пользователя
2026-01-25T08:57:22.4682674Z              from app.services import PostService
2026-01-25T08:57:22.4683391Z -            post = PostService.create(
2026-01-25T08:57:22.4683809Z -                author_id=1,
2026-01-25T08:57:22.4684353Z -                title="Тестовый пост",
2026-01-25T08:57:22.4684910Z -                content="Содержание"
2026-01-25T08:57:22.4685329Z -            )
2026-01-25T08:57:22.4685644Z -            
2026-01-25T08:57:22.4685985Z +
2026-01-25T08:57:22.4686325Z +            post = PostService.create(
2026-01-25T08:57:22.4687094Z +                author_id=1, title="Тестовый пост", content="Содержание"
2026-01-25T08:57:22.4687655Z +            )
2026-01-25T08:57:22.4687993Z +
2026-01-25T08:57:22.4688530Z              # Создаём комментарий от первого пользователя
2026-01-25T08:57:22.4689116Z              comment = CommentService.create(
2026-01-25T08:57:22.4689608Z -                author_id=1,
2026-01-25T08:57:22.4690039Z -                post_id=post.id,
2026-01-25T08:57:22.4690638Z -                content="Комментарий пользователя 1"
2026-01-25T08:57:22.4691144Z -            )
2026-01-25T08:57:22.4691460Z -            
2026-01-25T08:57:22.4692155Z +                author_id=1, post_id=post.id, content="Комментарий пользователя 1"
2026-01-25T08:57:22.4693447Z +            )
2026-01-25T08:57:22.4693811Z +
2026-01-25T08:57:22.4694350Z              # Пытаемся удалить комментарий от второго пользователя
2026-01-25T08:57:22.4695003Z              result = CommentService.delete(comment.id, 2)
2026-01-25T08:57:22.4695509Z -            
2026-01-25T08:57:22.4695828Z +
2026-01-25T08:57:22.4696146Z              assert result is False
2026-01-25T08:57:22.4696563Z -            
2026-01-25T08:57:22.4696900Z +
2026-01-25T08:57:22.4697371Z              # Проверяем, что комментарий не удалён
2026-01-25T08:57:22.4698002Z              existing_comment = CommentService.find_by_id(comment.id)
2026-01-25T08:57:22.4698634Z              assert existing_comment is not None
2026-01-25T08:57:22.4699101Z  
2026-01-25T08:57:22.4699492Z      def test_get_count_by_post_id(self, app, auth):
2026-01-25T08:57:22.4700204Z          """Подсчёт комментариев к посту должен работать."""
2026-01-25T08:57:22.4700726Z          auth.register()
2026-01-25T08:57:22.4701117Z          auth.login()
2026-01-25T08:57:22.4701502Z -        
2026-01-25T08:57:22.4701878Z -        with app.app_context():
2026-01-25T08:57:22.4702427Z -            # Создаём пост
2026-01-25T08:57:22.4703361Z -            from app.services import PostService
2026-01-25T08:57:22.4703892Z -            post = PostService.create(
2026-01-25T08:57:22.4704370Z -                author_id=1,
2026-01-25T08:57:22.4704951Z -                title="Тестовый пост",
2026-01-25T08:57:22.4705514Z -                content="Содержание"
2026-01-25T08:57:22.4705957Z -            )
2026-01-25T08:57:22.4706295Z -            
2026-01-25T08:57:22.4706611Z +
2026-01-25T08:57:22.4706939Z +        with app.app_context():
2026-01-25T08:57:22.4707458Z +            # Создаём пост
2026-01-25T08:57:22.4707947Z +            from app.services import PostService
2026-01-25T08:57:22.4708418Z +
2026-01-25T08:57:22.4708796Z +            post = PostService.create(
2026-01-25T08:57:22.4709535Z +                author_id=1, title="Тестовый пост", content="Содержание"
2026-01-25T08:57:22.4710122Z +            )
2026-01-25T08:57:22.4710437Z +
2026-01-25T08:57:22.4710947Z              # Проверяем количество комментариев (должно быть 0)
2026-01-25T08:57:22.4711614Z              count = CommentService.get_count_by_post_id(post.id)
2026-01-25T08:57:22.4712214Z              assert count == 0
2026-01-25T08:57:22.4712710Z -            
2026-01-25T08:57:22.4713402Z +
2026-01-25T08:57:22.4713873Z              # Создаём несколько комментариев
2026-01-25T08:57:22.4714504Z -            CommentService.create(
2026-01-25T08:57:22.4715010Z -                author_id=1,
2026-01-25T08:57:22.4715439Z -                post_id=post.id,
2026-01-25T08:57:22.4716039Z -                content="Комментарий 1"
2026-01-25T08:57:22.4716484Z -            )
2026-01-25T08:57:22.4716847Z -            CommentService.create(
2026-01-25T08:57:22.4717292Z -                author_id=1,
2026-01-25T08:57:22.4717703Z -                post_id=post.id,
2026-01-25T08:57:22.4718248Z -                content="Комментарий 2"
2026-01-25T08:57:22.4719046Z -            )
2026-01-25T08:57:22.4719388Z -            
2026-01-25T08:57:22.4720140Z +            CommentService.create(author_id=1, post_id=post.id, content="Комментарий 1")
2026-01-25T08:57:22.4721306Z +            CommentService.create(author_id=1, post_id=post.id, content="Комментарий 2")
2026-01-25T08:57:22.4722052Z +
2026-01-25T08:57:22.4722512Z              # Проверяем количество комментариев
2026-01-25T08:57:22.4723340Z              count = CommentService.get_count_by_post_id(post.id)
2026-01-25T08:57:22.4723926Z              assert count == 2
2026-01-25T08:57:22.4724316Z  
2026-01-25T08:57:22.4724603Z  
2026-01-25T08:57:22.4724932Z @@ -201,153 +176,137 @@
2026-01-25T08:57:22.4725272Z  
2026-01-25T08:57:22.4725670Z      def test_add_comment_as_logged_in_user(self, client, auth):
2026-01-25T08:57:22.4726464Z          """Добавление комментария авторизованным пользователем."""
2026-01-25T08:57:22.4727031Z          auth.register()
2026-01-25T08:57:22.4727434Z          auth.login()
2026-01-25T08:57:22.4727779Z -        
2026-01-25T08:57:22.4728067Z +
2026-01-25T08:57:22.4728441Z          # Создаём пост
2026-01-25T08:57:22.4728899Z          with client.application.app_context():
2026-01-25T08:57:22.4729443Z              from app.services import PostService
2026-01-25T08:57:22.4729958Z -            post = PostService.create(
2026-01-25T08:57:22.4730415Z -                author_id=1,
2026-01-25T08:57:22.4731000Z -                title="Тестовый пост",
2026-01-25T08:57:22.4731643Z -                content="Содержание поста"
2026-01-25T08:57:22.4732127Z -            )
2026-01-25T08:57:22.4732506Z -        
2026-01-25T08:57:22.4732820Z +
2026-01-25T08:57:22.4733482Z +            post = PostService.create(
2026-01-25T08:57:22.4734273Z +                author_id=1, title="Тестовый пост", content="Содержание поста"
2026-01-25T08:57:22.4734416Z +            )
2026-01-25T08:57:22.4734548Z +
2026-01-25T08:57:22.4734780Z          # Добавляем комментарий
2026-01-25T08:57:22.4735068Z          with client.session_transaction() as sess:
2026-01-25T08:57:22.4735265Z -            sess['csrf_token'] = 'test-csrf-token'
2026-01-25T08:57:22.4735389Z -        
2026-01-25T08:57:22.4735856Z +            sess["csrf_token"] = "test-csrf-token"
2026-01-25T08:57:22.4735977Z +
2026-01-25T08:57:22.4736140Z          response = client.post(
2026-01-25T08:57:22.4736319Z -            f'/post/{post.id}/comment',
2026-01-25T08:57:22.4736458Z -            data={
2026-01-25T08:57:22.4736755Z -                'content': 'Новый комментарий',
2026-01-25T08:57:22.4736954Z -                'csrf_token': 'test-csrf-token'
2026-01-25T08:57:22.4737080Z -            },
2026-01-25T08:57:22.4737246Z -            follow_redirects=True
2026-01-25T08:57:22.4737412Z +            f"/post/{post.id}/comment",
2026-01-25T08:57:22.4737893Z +            data={"content": "Новый комментарий", "csrf_token": "test-csrf-token"},
2026-01-25T08:57:22.4738082Z +            follow_redirects=True,
2026-01-25T08:57:22.4738211Z          )
2026-01-25T08:57:22.4738361Z -        
2026-01-25T08:57:22.4738499Z +
2026-01-25T08:57:22.4738691Z          assert response.status_code == 200
2026-01-25T08:57:22.4739005Z          # Проверяем, что комментарий появился в ответе
2026-01-25T08:57:22.4739239Z -        content = response.data.decode('utf-8')
2026-01-25T08:57:22.4739504Z -        assert 'Новый комментарий' in content
2026-01-25T08:57:22.4739700Z +        content = response.data.decode("utf-8")
2026-01-25T08:57:22.4739954Z +        assert "Новый комментарий" in content
2026-01-25T08:57:22.4740086Z  
2026-01-25T08:57:22.4740368Z      def test_add_comment_as_anonymous_user(self, client, auth):
2026-01-25T08:57:22.4740776Z          """Добавление комментария анонимным пользователем должно быть запрещено."""
2026-01-25T08:57:22.4741059Z          # Создаём пост (нужно авторизоваться)
2026-01-25T08:57:22.4741295Z          auth.register()
2026-01-25T08:57:22.4741439Z          auth.login()
2026-01-25T08:57:22.4741579Z -        
2026-01-25T08:57:22.4742030Z +
2026-01-25T08:57:22.4742295Z          with client.application.app_context():
2026-01-25T08:57:22.4742514Z              from app.services import PostService
2026-01-25T08:57:22.4742718Z -            post = PostService.create(
2026-01-25T08:57:22.4742870Z -                author_id=1,
2026-01-25T08:57:22.4743412Z -                title="Тестовый пост",
2026-01-25T08:57:22.4743735Z -                content="Содержание поста"
2026-01-25T08:57:22.4743876Z -            )
2026-01-25T08:57:22.4744018Z -        
2026-01-25T08:57:22.4744133Z +
2026-01-25T08:57:22.4744351Z +            post = PostService.create(
2026-01-25T08:57:22.4744830Z +                author_id=1, title="Тестовый пост", content="Содержание поста"
2026-01-25T08:57:22.4744996Z +            )
2026-01-25T08:57:22.4745130Z +
2026-01-25T08:57:22.4745350Z          # Выходим из системы
2026-01-25T08:57:22.4745492Z          auth.logout()
2026-01-25T08:57:22.4745620Z -        
2026-01-25T08:57:22.4745737Z +
2026-01-25T08:57:22.4745979Z          # Пытаемся добавить комментарий
2026-01-25T08:57:22.4746170Z          response = client.post(
2026-01-25T08:57:22.4746334Z -            f'/post/{post.id}/comment',
2026-01-25T08:57:22.4746672Z -            data={'content': 'Новый комментарий'},
2026-01-25T08:57:22.4746898Z -            follow_redirects=True
2026-01-25T08:57:22.4747145Z +            f"/post/{post.id}/comment",
2026-01-25T08:57:22.4747424Z +            data={"content": "Новый комментарий"},
2026-01-25T08:57:22.4747611Z +            follow_redirects=True,
2026-01-25T08:57:22.4747735Z          )
2026-01-25T08:57:22.4747861Z -        
2026-01-25T08:57:22.4747982Z +
2026-01-25T08:57:22.4748263Z          # Должно перенаправить на страницу логина
2026-01-25T08:57:22.4748455Z          assert response.status_code == 200
2026-01-25T08:57:22.4748652Z -        assert b'login' in response.data.lower()
2026-01-25T08:57:22.4748844Z +        assert b"login" in response.data.lower()
2026-01-25T08:57:22.4748971Z  
2026-01-25T08:57:22.4749188Z      def test_delete_own_comment(self, client, auth):
2026-01-25T08:57:22.4749471Z          """Удаление своего комментария."""
2026-01-25T08:57:22.4749636Z          auth.register()
2026-01-25T08:57:22.4750039Z          auth.login()
2026-01-25T08:57:22.4750176Z -        
2026-01-25T08:57:22.4750304Z +
2026-01-25T08:57:22.4750508Z          with client.application.app_context():
2026-01-25T08:57:22.4750752Z              # Создаём пост
2026-01-25T08:57:22.4750949Z              from app.services import PostService
2026-01-25T08:57:22.4751121Z -            post = PostService.create(
2026-01-25T08:57:22.4751278Z -                author_id=1,
2026-01-25T08:57:22.4751526Z -                title="Тестовый пост",
2026-01-25T08:57:22.4751775Z -                content="Содержание поста"
2026-01-25T08:57:22.4751934Z -            )
2026-01-25T08:57:22.4752058Z -            
2026-01-25T08:57:22.4752178Z +
2026-01-25T08:57:22.4752355Z +            post = PostService.create(
2026-01-25T08:57:22.4752777Z +                author_id=1, title="Тестовый пост", content="Содержание поста"
2026-01-25T08:57:22.4753137Z +            )
2026-01-25T08:57:22.4753262Z +
2026-01-25T08:57:22.4753519Z              # Создаём комментарий
2026-01-25T08:57:22.4753742Z              comment = CommentService.create(
2026-01-25T08:57:22.4753884Z -                author_id=1,
2026-01-25T08:57:22.4754033Z -                post_id=post.id,
2026-01-25T08:57:22.4754303Z -                content="Тестовый комментарий"
2026-01-25T08:57:22.4754429Z -            )
2026-01-25T08:57:22.4754551Z -        
2026-01-25T08:57:22.4755001Z +                author_id=1, post_id=post.id, content="Тестовый комментарий"
2026-01-25T08:57:22.4755134Z +            )
2026-01-25T08:57:22.4755260Z +
2026-01-25T08:57:22.4755502Z          # Удаляем комментарий
2026-01-25T08:57:22.4755718Z          with client.session_transaction() as sess:
2026-01-25T08:57:22.4755919Z -            sess['csrf_token'] = 'test-csrf-token'
2026-01-25T08:57:22.4756044Z -        
2026-01-25T08:57:22.4756228Z +            sess["csrf_token"] = "test-csrf-token"
2026-01-25T08:57:22.4756796Z +
2026-01-25T08:57:22.4756972Z          response = client.post(
2026-01-25T08:57:22.4757158Z -            f'/comment/{comment.id}/delete',
2026-01-25T08:57:22.4757328Z -            data={
2026-01-25T08:57:22.4757509Z -                'csrf_token': 'test-csrf-token'
2026-01-25T08:57:22.4757644Z -            },
2026-01-25T08:57:22.4757804Z -            follow_redirects=True
2026-01-25T08:57:22.4757978Z +            f"/comment/{comment.id}/delete",
2026-01-25T08:57:22.4758182Z +            data={"csrf_token": "test-csrf-token"},
2026-01-25T08:57:22.4758340Z +            follow_redirects=True,
2026-01-25T08:57:22.4758467Z          )
2026-01-25T08:57:22.4758619Z -        
2026-01-25T08:57:22.4758740Z +
2026-01-25T08:57:22.4758983Z          assert response.status_code == 200
2026-01-25T08:57:22.4759365Z          # Проверяем, что комментарий удалён (его нет в ответе)
2026-01-25T08:57:22.4759594Z -        content = response.data.decode('utf-8')
2026-01-25T08:57:22.4759939Z -        assert 'Тестовый комментарий' not in content
2026-01-25T08:57:22.4760138Z +        content = response.data.decode("utf-8")
2026-01-25T08:57:22.4760440Z +        assert "Тестовый комментарий" not in content
2026-01-25T08:57:22.4760593Z  
2026-01-25T08:57:22.4760838Z      def test_view_post_with_comments(self, client, auth):
2026-01-25T08:57:22.4761219Z          """Просмотр поста с комментариями."""
2026-01-25T08:57:22.4761375Z          auth.register()
2026-01-25T08:57:22.4761511Z          auth.login()
2026-01-25T08:57:22.4761647Z -        
2026-01-25T08:57:22.4761764Z +
2026-01-25T08:57:22.4761956Z          with client.application.app_context():
2026-01-25T08:57:22.4762184Z              # Создаём пост
2026-01-25T08:57:22.4762389Z              from app.services import PostService
2026-01-25T08:57:22.4762569Z -            post = PostService.create(
2026-01-25T08:57:22.4762712Z -                author_id=1,
2026-01-25T08:57:22.4763187Z -                title="Тестовый пост",
2026-01-25T08:57:22.4763486Z -                content="Содержание поста"
2026-01-25T08:57:22.4763613Z -            )
2026-01-25T08:57:22.4763754Z -            
2026-01-25T08:57:22.4763878Z +
2026-01-25T08:57:22.4764361Z +            post = PostService.create(
2026-01-25T08:57:22.4764796Z +                author_id=1, title="Тестовый пост", content="Содержание поста"
2026-01-25T08:57:22.4764936Z +            )
2026-01-25T08:57:22.4765053Z +
2026-01-25T08:57:22.4765284Z              # Создаём комментарий
2026-01-25T08:57:22.4765464Z              CommentService.create(
2026-01-25T08:57:22.4765602Z -                author_id=1,
2026-01-25T08:57:22.4765764Z -                post_id=post.id,
2026-01-25T08:57:22.4766060Z -                content="Тестовый комментарий"
2026-01-25T08:57:22.4766181Z -            )
2026-01-25T08:57:22.4766301Z -        
2026-01-25T08:57:22.4766704Z +                author_id=1, post_id=post.id, content="Тестовый комментарий"
2026-01-25T08:57:22.4766845Z +            )
2026-01-25T08:57:22.4767214Z +
2026-01-25T08:57:22.4767442Z          # Просматриваем пост
2026-01-25T08:57:22.4767682Z -        response = client.get(f'/post/{post.id}')
2026-01-25T08:57:22.4767816Z -        
2026-01-25T08:57:22.4768032Z +        response = client.get(f"/post/{post.id}")
2026-01-25T08:57:22.4768164Z +
2026-01-25T08:57:22.4768342Z          assert response.status_code == 200
2026-01-25T08:57:22.4768661Z          # Проверяем наличие поста и секции комментариев
2026-01-25T08:57:22.4768880Z -        content = response.data.decode('utf-8')
2026-01-25T08:57:22.4769195Z -        assert 'Тестовый пост' in content
2026-01-25T08:57:22.4769498Z -        assert 'Тестовый комментарий' in content
2026-01-25T08:57:22.4769706Z +        content = response.data.decode("utf-8")
2026-01-25T08:57:22.4769975Z +        assert "Тестовый пост" in content
2026-01-25T08:57:22.4770247Z +        assert "Тестовый комментарий" in content
2026-01-25T08:57:22.4770544Z          # Проверяем наличие слова "Комментарии" в HTML
2026-01-25T08:57:22.4770792Z -        assert 'Комментарии' in content
2026-01-25T08:57:22.4771105Z +        assert "Комментарии" in content
2026-01-25T08:57:22.4771249Z  
2026-01-25T08:57:22.4771366Z  
2026-01-25T08:57:22.4771565Z  class TestCommentModelMethods:
2026-01-25T08:57:22.4771833Z      """Тесты для методов модели Comment."""
2026-01-25T08:57:22.4771965Z  
2026-01-25T08:57:22.4772140Z      def test_author_display_name(self):
2026-01-25T08:57:22.4772486Z          """Проверка отображаемого имени автора."""
2026-01-25T08:57:22.4772638Z -        comment = Comment(
2026-01-25T08:57:22.4772808Z -            author_username="testuser",
2026-01-25T08:57:22.4773157Z -            author_discriminator=42
2026-01-25T08:57:22.4773292Z -        )
2026-01-25T08:57:22.4773432Z -        
2026-01-25T08:57:22.4773805Z +        comment = Comment(author_username="testuser", author_discriminator=42)
2026-01-25T08:57:22.4773940Z +
2026-01-25T08:57:22.4774209Z          assert comment.author_display_name == "testuser#0042"
2026-01-25T08:57:22.4774359Z  
2026-01-25T08:57:22.4774547Z      def test_is_author(self):
2026-01-25T08:57:22.4774825Z          """Проверка метода is_author."""
2026-01-25T08:57:22.4775013Z          comment = Comment(author_id=123)
2026-01-25T08:57:22.4775402Z -        
2026-01-25T08:57:22.4775520Z +
2026-01-25T08:57:22.4775761Z          assert comment.is_author(123) is True
2026-01-25T08:57:22.4775959Z          assert comment.is_author(456) is False
2026-01-25T08:57:22.4776078Z  
2026-01-25T08:57:22.4776236Z      def test_to_dict(self):
2026-01-25T08:57:22.4776522Z          """Проверка преобразования в словарь."""
2026-01-25T08:57:22.4776670Z @@ -355,33 +314,33 @@
2026-01-25T08:57:22.4776804Z              id=1,
2026-01-25T08:57:22.4776947Z              author_id=123,
2026-01-25T08:57:22.4777088Z              post_id=456,
2026-01-25T08:57:22.4777317Z              content="Тест",
2026-01-25T08:57:22.4777481Z              author_username="user",
2026-01-25T08:57:22.4777681Z -            author_discriminator=1
2026-01-25T08:57:22.4777847Z +            author_discriminator=1,
2026-01-25T08:57:22.4777993Z          )
2026-01-25T08:57:22.4778131Z -        
2026-01-25T08:57:22.4778268Z +
2026-01-25T08:57:22.4778424Z          data = comment.to_dict()
2026-01-25T08:57:22.4778582Z -        
2026-01-25T08:57:22.4778732Z -        assert data['id'] == 1
2026-01-25T08:57:22.4778901Z -        assert data['author_id'] == 123
2026-01-25T08:57:22.4779073Z -        assert data['post_id'] == 456
2026-01-25T08:57:22.4779418Z -        assert data['content'] == "Тест"
2026-01-25T08:57:22.4779662Z -        assert data['author_display_name'] == "user#0001"
2026-01-25T08:57:22.4779797Z +
2026-01-25T08:57:22.4779965Z +        assert data["id"] == 1
2026-01-25T08:57:22.4780126Z +        assert data["author_id"] == 123
2026-01-25T08:57:22.4780312Z +        assert data["post_id"] == 456
2026-01-25T08:57:22.4780578Z +        assert data["content"] == "Тест"
2026-01-25T08:57:22.4780821Z +        assert data["author_display_name"] == "user#0001"
2026-01-25T08:57:22.4780943Z  
2026-01-25T08:57:22.4781340Z      def test_from_dict(self):
2026-01-25T08:57:22.4781634Z          """Проверка создания из словаря."""
2026-01-25T08:57:22.4781770Z          data = {
2026-01-25T08:57:22.4781962Z -            'id': 1,
2026-01-25T08:57:22.4782118Z -            'author_id': 123,
2026-01-25T08:57:22.4782259Z -            'post_id': 456,
2026-01-25T08:57:22.4782498Z -            'content': "Тест",
2026-01-25T08:57:22.4782676Z -            'author_username': "user",
2026-01-25T08:57:22.4782846Z -            'author_discriminator': 1
2026-01-25T08:57:22.4783167Z +            "id": 1,
2026-01-25T08:57:22.4783314Z +            "author_id": 123,
2026-01-25T08:57:22.4783453Z +            "post_id": 456,
2026-01-25T08:57:22.4783699Z +            "content": "Тест",
2026-01-25T08:57:22.4783863Z +            "author_username": "user",
2026-01-25T08:57:22.4784047Z +            "author_discriminator": 1,
2026-01-25T08:57:22.4784215Z          }
2026-01-25T08:57:22.4784338Z -        
2026-01-25T08:57:22.4784478Z +
2026-01-25T08:57:22.4784659Z          comment = Comment.from_dict(data)
2026-01-25T08:57:22.4784782Z -        
2026-01-25T08:57:22.4784904Z +
2026-01-25T08:57:22.4785069Z          assert comment.id == 1
2026-01-25T08:57:22.4785308Z          assert comment.author_id == 123
2026-01-25T08:57:22.4785535Z          assert comment.post_id == 456
2026-01-25T08:57:22.4785837Z          assert comment.content == "Тест"
2026-01-25T08:57:22.4939634Z --- /home/runner/work/flask_blog/flask_blog/tests/test_database.py	2026-01-25 08:57:06.654994+00:00
2026-01-25T08:57:22.4943869Z +++ /home/runner/work/flask_blog/flask_blog/tests/test_database.py	2026-01-25 08:57:22.486749+00:00
2026-01-25T08:57:22.4944015Z @@ -12,25 +12,25 @@
2026-01-25T08:57:22.4944165Z  
2026-01-25T08:57:22.4944352Z      def test_database_initialization(self, app):
2026-01-25T08:57:22.4944826Z          """Инициализация базы данных."""
2026-01-25T08:57:22.4944982Z          with app.app_context():
2026-01-25T08:57:22.4945165Z              from app.db.db import init_db, get_db
2026-01-25T08:57:22.4945331Z -            
2026-01-25T08:57:22.4945437Z +
2026-01-25T08:57:22.4945656Z              # Инициализация БД
2026-01-25T08:57:22.4946263Z              init_db()
2026-01-25T08:57:22.4946474Z -            
2026-01-25T08:57:22.4946600Z +
2026-01-25T08:57:22.4946835Z              # Проверка подключения
2026-01-25T08:57:22.4946966Z              db = get_db()
2026-01-25T08:57:22.4947111Z              assert db is not None
2026-01-25T08:57:22.4947229Z  
2026-01-25T08:57:22.4947409Z      def test_user_table_structure(self, app):
2026-01-25T08:57:22.4947678Z          """Проверка структуры таблицы пользователей."""
2026-01-25T08:57:22.4947842Z          with app.app_context():
2026-01-25T08:57:22.4948012Z              from app.db.db import get_db
2026-01-25T08:57:22.4948136Z -            
2026-01-25T08:57:22.4948264Z -            db = get_db()
2026-01-25T08:57:22.4948381Z -            
2026-01-25T08:57:22.4948499Z +
2026-01-25T08:57:22.4948628Z +            db = get_db()
2026-01-25T08:57:22.4948763Z +
2026-01-25T08:57:22.4949031Z              # Проверка существования таблицы
2026-01-25T08:57:22.4949150Z              try:
2026-01-25T08:57:22.4949297Z                  result = db.execute(
2026-01-25T08:57:22.4949664Z                      "SELECT name FROM sqlite_master WHERE type='table' AND name='user'"
2026-01-25T08:57:22.4949806Z                  ).fetchone()
2026-01-25T08:57:22.4950272Z would reformat /home/runner/work/flask_blog/flask_blog/tests/test_database.py
2026-01-25T08:57:22.4950394Z @@ -40,13 +40,13 @@
2026-01-25T08:57:22.4950502Z  
2026-01-25T08:57:22.4950690Z      def test_post_table_structure(self, app):
2026-01-25T08:57:22.4950945Z          """Проверка структуры таблицы постов."""
2026-01-25T08:57:22.4951100Z          with app.app_context():
2026-01-25T08:57:22.4951254Z              from app.db.db import get_db
2026-01-25T08:57:22.4951366Z -            
2026-01-25T08:57:22.4951498Z -            db = get_db()
2026-01-25T08:57:22.4951607Z -            
2026-01-25T08:57:22.4951990Z +
2026-01-25T08:57:22.4952131Z +            db = get_db()
2026-01-25T08:57:22.4952239Z +
2026-01-25T08:57:22.4952500Z              # Проверка существования таблицы
2026-01-25T08:57:22.4952652Z              try:
2026-01-25T08:57:22.4952877Z                  result = db.execute(
2026-01-25T08:57:22.4953546Z                      "SELECT name FROM sqlite_master WHERE type='table' AND name='post'"
2026-01-25T08:57:22.4953705Z                  ).fetchone()
2026-01-25T08:57:22.4953840Z @@ -56,13 +56,13 @@
2026-01-25T08:57:22.4953976Z  
2026-01-25T08:57:22.4954183Z      def test_comment_table_structure(self, app):
2026-01-25T08:57:22.4954492Z          """Проверка структуры таблицы комментариев."""
2026-01-25T08:57:22.4954657Z          with app.app_context():
2026-01-25T08:57:22.4954826Z              from app.db.db import get_db
2026-01-25T08:57:22.4954940Z -            
2026-01-25T08:57:22.4955084Z -            db = get_db()
2026-01-25T08:57:22.4955201Z -            
2026-01-25T08:57:22.4955316Z +
2026-01-25T08:57:22.4955475Z +            db = get_db()
2026-01-25T08:57:22.4955588Z +
2026-01-25T08:57:22.4955862Z              # Проверка существования таблицы
2026-01-25T08:57:22.4956003Z              try:
2026-01-25T08:57:22.4956161Z                  result = db.execute(
2026-01-25T08:57:22.4956515Z                      "SELECT name FROM sqlite_master WHERE type='table' AND name='comment'"
2026-01-25T08:57:22.4956656Z                  ).fetchone()
2026-01-25T08:57:22.4956788Z @@ -76,191 +76,173 @@
2026-01-25T08:57:22.4956907Z  
2026-01-25T08:57:22.4957105Z      def test_user_crud_operations(self, app):
2026-01-25T08:57:22.4957409Z          """CRUD операции для пользователей."""
2026-01-25T08:57:22.4957623Z          with app.app_context():
2026-01-25T08:57:22.4957793Z              from app.db.db import get_db
2026-01-25T08:57:22.4957921Z -            
2026-01-25T08:57:22.4958057Z -            db = get_db()
2026-01-25T08:57:22.4958176Z -            
2026-01-25T08:57:22.4958294Z +
2026-01-25T08:57:22.4958443Z +            db = get_db()
2026-01-25T08:57:22.4958557Z +
2026-01-25T08:57:22.4958820Z              # CREATE с использованием хелпера
2026-01-25T08:57:22.4959134Z              hashed_pw, salt = DatabaseTestHelper.create_user_with_password(
2026-01-25T08:57:22.4959750Z -                db, 'test_user_crud', 8888, 'test_password'
2026-01-25T08:57:22.4959900Z -            )
2026-01-25T08:57:22.4960052Z -            db.commit()
2026-01-25T08:57:22.4960174Z -            
2026-01-25T08:57:22.4960396Z +                db, "test_user_crud", 8888, "test_password"
2026-01-25T08:57:22.4960525Z +            )
2026-01-25T08:57:22.4960672Z +            db.commit()
2026-01-25T08:57:22.4960790Z +
2026-01-25T08:57:22.4960918Z              # READ
2026-01-25T08:57:22.4961071Z              user = db.execute(
2026-01-25T08:57:22.4961378Z -                'SELECT * FROM user WHERE username = ? AND discriminator = ?',
2026-01-25T08:57:22.4961547Z -                ('test_user_crud', 8888)
2026-01-25T08:57:22.4961857Z +                "SELECT * FROM user WHERE username = ? AND discriminator = ?",
2026-01-25T08:57:22.4962034Z +                ("test_user_crud", 8888),
2026-01-25T08:57:22.4962177Z              ).fetchone()
2026-01-25T08:57:22.4962351Z              assert user is not None
2026-01-25T08:57:22.4962566Z -            assert user['username'] == 'test_user_crud'
2026-01-25T08:57:22.4962775Z -            assert user['discriminator'] == 8888
2026-01-25T08:57:22.4963143Z -            
2026-01-25T08:57:22.4963379Z +            assert user["username"] == "test_user_crud"
2026-01-25T08:57:22.4963575Z +            assert user["discriminator"] == 8888
2026-01-25T08:57:22.4963695Z +
2026-01-25T08:57:22.4963839Z              # UPDATE
2026-01-25T08:57:22.4964040Z              db.execute(
2026-01-25T08:57:22.4964469Z -                'UPDATE user SET username = ? WHERE username = ? AND discriminator = ?',
2026-01-25T08:57:22.4964704Z -                ('updated_user', 'test_user_crud', 8888)
2026-01-25T08:57:22.4964863Z -            )
2026-01-25T08:57:22.4965245Z -            db.commit()
2026-01-25T08:57:22.4965382Z -            
2026-01-25T08:57:22.4965742Z +                "UPDATE user SET username = ? WHERE username = ? AND discriminator = ?",
2026-01-25T08:57:22.4965969Z +                ("updated_user", "test_user_crud", 8888),
2026-01-25T08:57:22.4966108Z +            )
2026-01-25T08:57:22.4966250Z +            db.commit()
2026-01-25T08:57:22.4966373Z +
2026-01-25T08:57:22.4966544Z              updated_user = db.execute(
2026-01-25T08:57:22.4966753Z -                'SELECT * FROM user WHERE username = ?',
2026-01-25T08:57:22.4966910Z -                ('updated_user',)
2026-01-25T08:57:22.4967203Z +                "SELECT * FROM user WHERE username = ?", ("updated_user",)
2026-01-25T08:57:22.4967357Z              ).fetchone()
2026-01-25T08:57:22.4967542Z              assert updated_user is not None
2026-01-25T08:57:22.4967781Z -            assert updated_user['username'] == 'updated_user'
2026-01-25T08:57:22.4967910Z -            
2026-01-25T08:57:22.4968159Z +            assert updated_user["username"] == "updated_user"
2026-01-25T08:57:22.4968283Z +
2026-01-25T08:57:22.4968411Z              # DELETE
2026-01-25T08:57:22.4968847Z -            DatabaseTestHelper.cleanup_test_data(db, usernames=['updated_user'])
2026-01-25T08:57:22.4969023Z -            
2026-01-25T08:57:22.4969410Z +            DatabaseTestHelper.cleanup_test_data(db, usernames=["updated_user"])
2026-01-25T08:57:22.4969537Z +
2026-01-25T08:57:22.4969802Z              # Проверка удаления
2026-01-25T08:57:22.4970005Z              deleted_user = db.execute(
2026-01-25T08:57:22.4970220Z -                'SELECT * FROM user WHERE username = ?',
2026-01-25T08:57:22.4970375Z -                ('updated_user',)
2026-01-25T08:57:22.4970664Z +                "SELECT * FROM user WHERE username = ?", ("updated_user",)
2026-01-25T08:57:22.4970812Z              ).fetchone()
2026-01-25T08:57:22.4970980Z              assert deleted_user is None
2026-01-25T08:57:22.4971111Z  
2026-01-25T08:57:22.4971333Z      def test_post_crud_operations(self, app):
2026-01-25T08:57:22.4971604Z          """CRUD операции для постов."""
2026-01-25T08:57:22.4971791Z          with app.app_context():
2026-01-25T08:57:22.4972277Z              from app.db.db import get_db
2026-01-25T08:57:22.4972411Z -            
2026-01-25T08:57:22.4972549Z -            db = get_db()
2026-01-25T08:57:22.4972689Z -            
2026-01-25T08:57:22.4972817Z +
2026-01-25T08:57:22.4974477Z +            db = get_db()
2026-01-25T08:57:22.4974635Z +
2026-01-25T08:57:22.4976383Z              # Создаем пользователя с постом через хелпер
2026-01-25T08:57:22.4976720Z              user_id, post_id = DatabaseTestHelper.create_user_with_post(
2026-01-25T08:57:22.4976948Z -                db, 'post_test_user', 7777, 'test_password',
2026-01-25T08:57:22.4977131Z -                'Test Post', 'Test content'
2026-01-25T08:57:22.4977265Z -            )
2026-01-25T08:57:22.4977399Z -            
2026-01-25T08:57:22.4977735Z +                db, "post_test_user", 7777, "test_password", "Test Post", "Test content"
2026-01-25T08:57:22.4977888Z +            )
2026-01-25T08:57:22.4978022Z +
2026-01-25T08:57:22.4978184Z              if user_id and post_id:
2026-01-25T08:57:22.4978335Z                  # READ
2026-01-25T08:57:22.4978495Z                  post = db.execute(
2026-01-25T08:57:22.4978701Z -                    'SELECT * FROM post WHERE id = ?',
2026-01-25T08:57:22.4978848Z -                    (post_id,)
2026-01-25T08:57:22.4979086Z +                    "SELECT * FROM post WHERE id = ?", (post_id,)
2026-01-25T08:57:22.4979231Z                  ).fetchone()
2026-01-25T08:57:22.4979417Z                  assert post is not None
2026-01-25T08:57:22.4979614Z -                assert post['title'] == 'Test Post'
2026-01-25T08:57:22.4979815Z -                assert post['content'] == 'Test content'
2026-01-25T08:57:22.4979948Z -                
2026-01-25T08:57:22.4980143Z +                assert post["title"] == "Test Post"
2026-01-25T08:57:22.4980348Z +                assert post["content"] == "Test content"
2026-01-25T08:57:22.4980722Z +
2026-01-25T08:57:22.4980874Z                  # UPDATE
2026-01-25T08:57:22.4981023Z                  db.execute(
2026-01-25T08:57:22.4981330Z -                    'UPDATE post SET title = ?, content = ? WHERE id = ?',
2026-01-25T08:57:22.4981568Z -                    ('Updated Post', 'Updated content', post_id)
2026-01-25T08:57:22.4981709Z -                )
2026-01-25T08:57:22.4981849Z -                db.commit()
2026-01-25T08:57:22.4981975Z -                
2026-01-25T08:57:22.4982254Z +                    "UPDATE post SET title = ?, content = ? WHERE id = ?",
2026-01-25T08:57:22.4982499Z +                    ("Updated Post", "Updated content", post_id),
2026-01-25T08:57:22.4982633Z +                )
2026-01-25T08:57:22.4982783Z +                db.commit()
2026-01-25T08:57:22.4983108Z +
2026-01-25T08:57:22.4983312Z                  updated_post = db.execute(
2026-01-25T08:57:22.4983515Z -                    'SELECT * FROM post WHERE id = ?',
2026-01-25T08:57:22.4983675Z -                    (post_id,)
2026-01-25T08:57:22.4983825Z -                ).fetchone()
2026-01-25T08:57:22.4984061Z -                assert updated_post['title'] == 'Updated Post'
2026-01-25T08:57:22.4984322Z -                assert updated_post['content'] == 'Updated content'
2026-01-25T08:57:22.4984457Z -                
2026-01-25T08:57:22.4984685Z +                    "SELECT * FROM post WHERE id = ?", (post_id,)
2026-01-25T08:57:22.4984827Z +                ).fetchone()
2026-01-25T08:57:22.4985091Z +                assert updated_post["title"] == "Updated Post"
2026-01-25T08:57:22.4985335Z +                assert updated_post["content"] == "Updated content"
2026-01-25T08:57:22.4985469Z +
2026-01-25T08:57:22.4985608Z                  # DELETE
2026-01-25T08:57:22.4985749Z -                db.execute(
2026-01-25T08:57:22.4985953Z -                    'DELETE FROM post WHERE id = ?',
2026-01-25T08:57:22.4986095Z -                    (post_id,)
2026-01-25T08:57:22.4986227Z -                )
2026-01-25T08:57:22.4986380Z -                db.commit()
2026-01-25T08:57:22.4986500Z -                
2026-01-25T08:57:22.4986769Z +                db.execute("DELETE FROM post WHERE id = ?", (post_id,))
2026-01-25T08:57:22.4987189Z +                db.commit()
2026-01-25T08:57:22.4987321Z +
2026-01-25T08:57:22.4987507Z                  deleted_post = db.execute(
2026-01-25T08:57:22.4987706Z -                    'SELECT * FROM post WHERE id = ?',
2026-01-25T08:57:22.4987850Z -                    (post_id,)
2026-01-25T08:57:22.4988088Z +                    "SELECT * FROM post WHERE id = ?", (post_id,)
2026-01-25T08:57:22.4988234Z                  ).fetchone()
2026-01-25T08:57:22.4988413Z                  assert deleted_post is None
2026-01-25T08:57:22.4988548Z -            
2026-01-25T08:57:22.4988666Z +
2026-01-25T08:57:22.4988964Z              # Удаляем тестового пользователя
2026-01-25T08:57:22.4989373Z -            DatabaseTestHelper.cleanup_test_data(db, usernames=['post_test_user'])
2026-01-25T08:57:22.4989775Z +            DatabaseTestHelper.cleanup_test_data(db, usernames=["post_test_user"])
2026-01-25T08:57:22.4989915Z  
2026-01-25T08:57:22.4990132Z      def test_comment_crud_operations(self, app):
2026-01-25T08:57:22.4990419Z          """CRUD операции для комментариев."""
2026-01-25T08:57:22.4990596Z          with app.app_context():
2026-01-25T08:57:22.4990799Z              from app.db.db import get_db
2026-01-25T08:57:22.4990924Z -            
2026-01-25T08:57:22.4991075Z -            db = get_db()
2026-01-25T08:57:22.4991202Z -            
2026-01-25T08:57:22.4991320Z +
2026-01-25T08:57:22.4991465Z +            db = get_db()
2026-01-25T08:57:22.4991582Z +
2026-01-25T08:57:22.4991911Z              # Создаем тестового пользователя и пост
2026-01-25T08:57:22.4992101Z              from app.auth import hash_password
2026-01-25T08:57:22.4992343Z -            hashed_pw, salt = hash_password('test_password')
2026-01-25T08:57:22.4992498Z -            db.execute(
2026-01-25T08:57:22.4993975Z -                'INSERT INTO user (username, discriminator, password, salt) VALUES (?, ?, ?, ?)',
2026-01-25T08:57:22.4995603Z -                ('comment_test_user', 6666, hashed_pw, salt)
2026-01-25T08:57:22.4995809Z -            )
2026-01-25T08:57:22.4995958Z -            db.commit()
2026-01-25T08:57:22.4996084Z -            
2026-01-25T08:57:22.4996211Z +
2026-01-25T08:57:22.4996453Z +            hashed_pw, salt = hash_password("test_password")
2026-01-25T08:57:22.4996600Z +            db.execute(
2026-01-25T08:57:22.4997020Z +                "INSERT INTO user (username, discriminator, password, salt) VALUES (?, ?, ?, ?)",
2026-01-25T08:57:22.4997243Z +                ("comment_test_user", 6666, hashed_pw, salt),
2026-01-25T08:57:22.4997380Z +            )
2026-01-25T08:57:22.4997520Z +            db.commit()
2026-01-25T08:57:22.4997642Z +
2026-01-25T08:57:22.4997800Z              user = db.execute(
2026-01-25T08:57:22.4998114Z -                'SELECT id FROM user WHERE username = ? AND discriminator = ?',
2026-01-25T08:57:22.4998300Z -                ('comment_test_user', 6666)
2026-01-25T08:57:22.4998453Z -            ).fetchone()
2026-01-25T08:57:22.4998575Z -            
2026-01-25T08:57:22.4998891Z +                "SELECT id FROM user WHERE username = ? AND discriminator = ?",
2026-01-25T08:57:22.4999064Z +                ("comment_test_user", 6666),
2026-01-25T08:57:22.4999202Z +            ).fetchone()
2026-01-25T08:57:22.4999330Z +
2026-01-25T08:57:22.4999464Z              if user:
2026-01-25T08:57:22.4999608Z                  db.execute(
2026-01-25T08:57:22.4999934Z -                    'INSERT INTO post (title, content, author_id) VALUES (?, ?, ?)',
2026-01-25T08:57:22.5000246Z -                    ('Comment Test Post', 'Test content for comments', user['id'])
2026-01-25T08:57:22.5000375Z -                )
2026-01-25T08:57:22.5000527Z -                db.commit()
2026-01-25T08:57:22.5000650Z -                
2026-01-25T08:57:22.5000969Z +                    "INSERT INTO post (title, content, author_id) VALUES (?, ?, ?)",
2026-01-25T08:57:22.5001286Z +                    ("Comment Test Post", "Test content for comments", user["id"]),
2026-01-25T08:57:22.5001679Z +                )
2026-01-25T08:57:22.5001847Z +                db.commit()
2026-01-25T08:57:22.5001979Z +
2026-01-25T08:57:22.5002138Z                  post = db.execute(
2026-01-25T08:57:22.5002361Z -                    'SELECT id FROM post WHERE title = ?',
2026-01-25T08:57:22.5002537Z -                    ('Comment Test Post',)
2026-01-25T08:57:22.5002690Z -                ).fetchone()
2026-01-25T08:57:22.5002812Z -                
2026-01-25T08:57:22.5003384Z +                    "SELECT id FROM post WHERE title = ?", ("Comment Test Post",)
2026-01-25T08:57:22.5003561Z +                ).fetchone()
2026-01-25T08:57:22.5003681Z +
2026-01-25T08:57:22.5003828Z                  if post:
2026-01-25T08:57:22.5003974Z                      # CREATE
2026-01-25T08:57:22.5004123Z                      db.execute(
2026-01-25T08:57:22.5004499Z -                        'INSERT INTO comment (content, author_id, post_id) VALUES (?, ?, ?)',
2026-01-25T08:57:22.5004732Z -                        ('Test comment', user['id'], post['id'])
2026-01-25T08:57:22.5005096Z +                        "INSERT INTO comment (content, author_id, post_id) VALUES (?, ?, ?)",
2026-01-25T08:57:22.5005345Z +                        ("Test comment", user["id"], post["id"]),
2026-01-25T08:57:22.5005481Z                      )
2026-01-25T08:57:22.5005623Z                      db.commit()
2026-01-25T08:57:22.5005758Z -                    
2026-01-25T08:57:22.5005879Z +
2026-01-25T08:57:22.5006017Z                      # READ
2026-01-25T08:57:22.5006196Z                      comment = db.execute(
2026-01-25T08:57:22.5006426Z -                        'SELECT * FROM comment WHERE content = ?',
2026-01-25T08:57:22.5006589Z -                        ('Test comment',)
2026-01-25T08:57:22.5006891Z +                        "SELECT * FROM comment WHERE content = ?", ("Test comment",)
2026-01-25T08:57:22.5007275Z                      ).fetchone()
2026-01-25T08:57:22.5007466Z                      assert comment is not None
2026-01-25T08:57:22.5007687Z -                    assert comment['content'] == 'Test comment'
2026-01-25T08:57:22.5007826Z -                    
2026-01-25T08:57:22.5008041Z +                    assert comment["content"] == "Test comment"
2026-01-25T08:57:22.5008163Z +
2026-01-25T08:57:22.5008322Z                      # UPDATE
2026-01-25T08:57:22.5008478Z                      db.execute(
2026-01-25T08:57:22.5008725Z -                        'UPDATE comment SET content = ? WHERE id = ?',
2026-01-25T08:57:22.5008939Z -                        ('Updated comment', comment['id'])
2026-01-25T08:57:22.5009174Z +                        "UPDATE comment SET content = ? WHERE id = ?",
2026-01-25T08:57:22.5009388Z +                        ("Updated comment", comment["id"]),
2026-01-25T08:57:22.5009523Z                      )
2026-01-25T08:57:22.5009682Z                      db.commit()
2026-01-25T08:57:22.5009837Z -                    
2026-01-25T08:57:22.5009958Z +
2026-01-25T08:57:22.5010152Z                      updated_comment = db.execute(
2026-01-25T08:57:22.5010376Z -                        'SELECT * FROM comment WHERE id = ?',
2026-01-25T08:57:22.5010573Z -                        (comment['id'],)
2026-01-25T08:57:22.5010839Z +                        "SELECT * FROM comment WHERE id = ?", (comment["id"],)
2026-01-25T08:57:22.5010989Z                      ).fetchone()
2026-01-25T08:57:22.5011268Z -                    assert updated_comment['content'] == 'Updated comment'
2026-01-25T08:57:22.5011398Z -                    
2026-01-25T08:57:22.5011675Z +                    assert updated_comment["content"] == "Updated comment"
2026-01-25T08:57:22.5011790Z +
2026-01-25T08:57:22.5011927Z                      # DELETE
2026-01-25T08:57:22.5012083Z -                    db.execute(
2026-01-25T08:57:22.5012314Z -                        'DELETE FROM comment WHERE id = ?',
2026-01-25T08:57:22.5012481Z -                        (comment['id'],)
2026-01-25T08:57:22.5012616Z -                    )
2026-01-25T08:57:22.5013121Z +                    db.execute("DELETE FROM comment WHERE id = ?", (comment["id"],))
2026-01-25T08:57:22.5013503Z                      db.commit()
2026-01-25T08:57:22.5013646Z -                    
2026-01-25T08:57:22.5013771Z +
2026-01-25T08:57:22.5013971Z                      deleted_comment = db.execute(
2026-01-25T08:57:22.5014250Z -                        'SELECT * FROM comment WHERE id = ?',
2026-01-25T08:57:22.5014408Z -                        (comment['id'],)
2026-01-25T08:57:22.5014683Z +                        "SELECT * FROM comment WHERE id = ?", (comment["id"],)
2026-01-25T08:57:22.5014831Z                      ).fetchone()
2026-01-25T08:57:22.5015029Z                      assert deleted_comment is None
2026-01-25T08:57:22.5015153Z -                
2026-01-25T08:57:22.5015273Z +
2026-01-25T08:57:22.5015585Z                  # Удаляем тестовый пост
2026-01-25T08:57:22.5015769Z -                db.execute(
2026-01-25T08:57:22.5015967Z -                    'DELETE FROM post WHERE id = ?',
2026-01-25T08:57:22.5016127Z -                    (post['id'],)
2026-01-25T08:57:22.5016271Z -                )
2026-01-25T08:57:22.5016416Z -                db.commit()
2026-01-25T08:57:22.5016551Z -            
2026-01-25T08:57:22.5016854Z +                db.execute("DELETE FROM post WHERE id = ?", (post["id"],))
2026-01-25T08:57:22.5017003Z +                db.commit()
2026-01-25T08:57:22.5017126Z +
2026-01-25T08:57:22.5017401Z              # Удаляем тестового пользователя
2026-01-25T08:57:22.5017553Z              db.execute(
2026-01-25T08:57:22.5017859Z -                'DELETE FROM user WHERE username = ? AND discriminator = ?',
2026-01-25T08:57:22.5018039Z -                ('comment_test_user', 6666)
2026-01-25T08:57:22.5018344Z +                "DELETE FROM user WHERE username = ? AND discriminator = ?",
2026-01-25T08:57:22.5018518Z +                ("comment_test_user", 6666),
2026-01-25T08:57:22.5018885Z              )
2026-01-25T08:57:22.5019039Z              db.commit()
2026-01-25T08:57:22.5019159Z  
2026-01-25T08:57:22.5019284Z  
2026-01-25T08:57:22.5019487Z  class TestDatabaseConstraints:
2026-01-25T08:57:22.5019629Z @@ -269,52 +251,52 @@
2026-01-25T08:57:22.5019887Z      def test_unique_username_discriminator(self, app):
2026-01-25T08:57:22.5020251Z          """Уникальность пары username-discriminator."""
2026-01-25T08:57:22.5020433Z          with app.app_context():
2026-01-25T08:57:22.5020617Z              from app.db.db import get_db
2026-01-25T08:57:22.5020803Z              from app.auth import hash_password
2026-01-25T08:57:22.5020933Z -            
2026-01-25T08:57:22.5021116Z -            db = get_db()
2026-01-25T08:57:22.5021233Z -            
2026-01-25T08:57:22.5021351Z +
2026-01-25T08:57:22.5021496Z +            db = get_db()
2026-01-25T08:57:22.5021615Z +
2026-01-25T08:57:22.5021887Z              # Создаем первого пользователя
2026-01-25T08:57:22.5022133Z -            hashed_pw1, salt1 = hash_password('password1')
2026-01-25T08:57:22.5022295Z -            db.execute(
2026-01-25T08:57:22.5022725Z -                'INSERT INTO user (username, discriminator, password, salt) VALUES (?, ?, ?, ?)',
2026-01-25T08:57:22.5023163Z -                ('unique_test', 1111, hashed_pw1, salt1)
2026-01-25T08:57:22.5023321Z -            )
2026-01-25T08:57:22.5023476Z -            db.commit()
2026-01-25T08:57:22.5023608Z -            
2026-01-25T08:57:22.5023869Z +            hashed_pw1, salt1 = hash_password("password1")
2026-01-25T08:57:22.5024028Z +            db.execute(
2026-01-25T08:57:22.5024444Z +                "INSERT INTO user (username, discriminator, password, salt) VALUES (?, ?, ?, ?)",
2026-01-25T08:57:22.5025189Z +                ("unique_test", 1111, hashed_pw1, salt1),
2026-01-25T08:57:22.5025371Z +            )
2026-01-25T08:57:22.5025681Z +            db.commit()
2026-01-25T08:57:22.5025814Z +
2026-01-25T08:57:22.5026280Z              # Попытка создать второго пользователя с тем же username и discriminator
2026-01-25T08:57:22.5026434Z              try:
2026-01-25T08:57:22.5026700Z -                hashed_pw2, salt2 = hash_password('password2')
2026-01-25T08:57:22.5027116Z -                db.execute(
2026-01-25T08:57:22.5027565Z -                    'INSERT INTO user (username, discriminator, password, salt) VALUES (?, ?, ?, ?)',
2026-01-25T08:57:22.5027789Z -                    ('unique_test', 1111, hashed_pw2, salt2)
2026-01-25T08:57:22.5028026Z +                hashed_pw2, salt2 = hash_password("password2")
2026-01-25T08:57:22.5028176Z +                db.execute(
2026-01-25T08:57:22.5028598Z +                    "INSERT INTO user (username, discriminator, password, salt) VALUES (?, ?, ?, ?)",
2026-01-25T08:57:22.5028807Z +                    ("unique_test", 1111, hashed_pw2, salt2),
2026-01-25T08:57:22.5028950Z                  )
2026-01-25T08:57:22.5029088Z                  db.commit()
2026-01-25T08:57:22.5029362Z                  assert False, "Should have raised an integrity error"
2026-01-25T08:57:22.5029762Z              except Exception:
2026-01-25T08:57:22.5030186Z                  pass  # Ожидаемое поведение - нарушение уникальности
2026-01-25T08:57:22.5030342Z -            
2026-01-25T08:57:22.5030463Z +
2026-01-25T08:57:22.5030727Z              # Удаляем тестового пользователя
2026-01-25T08:57:22.5030875Z              db.execute(
2026-01-25T08:57:22.5031178Z -                'DELETE FROM user WHERE username = ? AND discriminator = ?',
2026-01-25T08:57:22.5031339Z -                ('unique_test', 1111)
2026-01-25T08:57:22.5031639Z +                "DELETE FROM user WHERE username = ? AND discriminator = ?",
2026-01-25T08:57:22.5031790Z +                ("unique_test", 1111),
2026-01-25T08:57:22.5031920Z              )
2026-01-25T08:57:22.5032057Z              db.commit()
2026-01-25T08:57:22.5032177Z  
2026-01-25T08:57:22.5032388Z      def test_foreign_key_constraints(self, app):
2026-01-25T08:57:22.5032644Z          """Проверка внешних ключей."""
2026-01-25T08:57:22.5032833Z          with app.app_context():
2026-01-25T08:57:22.5033348Z              from app.db.db import get_db
2026-01-25T08:57:22.5033482Z -            
2026-01-25T08:57:22.5033651Z -            db = get_db()
2026-01-25T08:57:22.5033786Z -            
2026-01-25T08:57:22.5033920Z +
2026-01-25T08:57:22.5034063Z +            db = get_db()
2026-01-25T08:57:22.5034193Z +
2026-01-25T08:57:22.5034537Z              # Попытка создать пост с несуществующим author_id
2026-01-25T08:57:22.5034679Z              try:
2026-01-25T08:57:22.5034827Z                  db.execute(
2026-01-25T08:57:22.5035151Z -                    'INSERT INTO post (title, content, author_id) VALUES (?, ?, ?)',
2026-01-25T08:57:22.5035386Z -                    ('Orphan Post', 'Orphan content', 99999)
2026-01-25T08:57:22.5035693Z +                    "INSERT INTO post (title, content, author_id) VALUES (?, ?, ?)",
2026-01-25T08:57:22.5035903Z +                    ("Orphan Post", "Orphan content", 99999),
2026-01-25T08:57:22.5036040Z                  )
2026-01-25T08:57:22.5036202Z                  db.commit()
2026-01-25T08:57:22.5036537Z                  assert False, "Should have raised a foreign key constraint error"
2026-01-25T08:57:22.5036947Z              except Exception:
2026-01-25T08:57:22.5037358Z                  pass  # Ожидаемое поведение - нарушение внешнего ключа
2026-01-25T08:57:22.5037518Z @@ -326,64 +308,64 @@
2026-01-25T08:57:22.5037719Z      def test_transaction_rollback(self, app):
2026-01-25T08:57:22.5037979Z          """Откат транзакции при ошибке."""
2026-01-25T08:57:22.5038155Z          with app.app_context():
2026-01-25T08:57:22.5038338Z              from app.db.db import get_db
2026-01-25T08:57:22.5038527Z              from app.auth import hash_password
2026-01-25T08:57:22.5038663Z -            
2026-01-25T08:57:22.5038801Z -            db = get_db()
2026-01-25T08:57:22.5038928Z -            
2026-01-25T08:57:22.5039045Z +
2026-01-25T08:57:22.5039183Z +            db = get_db()
2026-01-25T08:57:22.5039307Z +
2026-01-25T08:57:22.5039601Z              # Начинаем транзакцию
2026-01-25T08:57:22.5039747Z              try:
2026-01-25T08:57:22.5039991Z                  # Создаем пользователя
2026-01-25T08:57:22.5040274Z -                hashed_pw, salt = hash_password('test_password')
2026-01-25T08:57:22.5040422Z -                db.execute(
2026-01-25T08:57:22.5040862Z -                    'INSERT INTO user (username, discriminator, password, salt) VALUES (?, ?, ?, ?)',
2026-01-25T08:57:22.5041128Z -                    ('transaction_test', 5555, hashed_pw, salt)
2026-01-25T08:57:22.5041266Z -                )
2026-01-25T08:57:22.5041390Z -                
2026-01-25T08:57:22.5041634Z +                hashed_pw, salt = hash_password("test_password")
2026-01-25T08:57:22.5041780Z +                db.execute(
2026-01-25T08:57:22.5042210Z +                    "INSERT INTO user (username, discriminator, password, salt) VALUES (?, ?, ?, ?)",
2026-01-25T08:57:22.5042428Z +                    ("transaction_test", 5555, hashed_pw, salt),
2026-01-25T08:57:22.5042827Z +                )
2026-01-25T08:57:22.5043233Z +
2026-01-25T08:57:22.5043522Z                  # Вызываем ошибку
2026-01-25T08:57:22.5043717Z -                db.execute('INVALID SQL QUERY')
2026-01-25T08:57:22.5043876Z -                db.commit()
2026-01-25T08:57:22.5043985Z -                
2026-01-25T08:57:22.5044134Z +                db.execute("INVALID SQL QUERY")
2026-01-25T08:57:22.5044246Z +                db.commit()
2026-01-25T08:57:22.5044354Z +
2026-01-25T08:57:22.5044481Z              except Exception:
2026-01-25T08:57:22.5044693Z                  # Откатываем транзакцию
2026-01-25T08:57:22.5044833Z                  db.rollback()
2026-01-25T08:57:22.5044949Z -            
2026-01-25T08:57:22.5045059Z +
2026-01-25T08:57:22.5045326Z              # Проверяем, что пользователь не был создан
2026-01-25T08:57:22.5045466Z              user = db.execute(
2026-01-25T08:57:22.5045769Z -                'SELECT * FROM user WHERE username = ? AND discriminator = ?',
2026-01-25T08:57:22.5045976Z -                ('transaction_test', 5555)
2026-01-25T08:57:22.5046265Z +                "SELECT * FROM user WHERE username = ? AND discriminator = ?",
2026-01-25T08:57:22.5046452Z +                ("transaction_test", 5555),
2026-01-25T08:57:22.5046589Z              ).fetchone()
2026-01-25T08:57:22.5046738Z              assert user is None
2026-01-25T08:57:22.5046864Z  
2026-01-25T08:57:22.5047079Z      def test_transaction_commit(self, app):
2026-01-25T08:57:22.5047318Z          """Фиксация транзакции."""
2026-01-25T08:57:22.5047484Z          with app.app_context():
2026-01-25T08:57:22.5047656Z              from app.db.db import get_db
2026-01-25T08:57:22.5047853Z              from app.auth import hash_password
2026-01-25T08:57:22.5047977Z -            
2026-01-25T08:57:22.5048121Z -            db = get_db()
2026-01-25T08:57:22.5048252Z -            
2026-01-25T08:57:22.5048375Z +
2026-01-25T08:57:22.5048517Z +            db = get_db()
2026-01-25T08:57:22.5048642Z +
2026-01-25T08:57:22.5048948Z              # Создаем пользователя в транзакции
2026-01-25T08:57:22.5049197Z -            hashed_pw, salt = hash_password('test_password')
2026-01-25T08:57:22.5049348Z -            db.execute(
2026-01-25T08:57:22.5050046Z -                'INSERT INTO user (username, discriminator, password, salt) VALUES (?, ?, ?, ?)',
2026-01-25T08:57:22.5050257Z -                ('commit_test', 4444, hashed_pw, salt)
2026-01-25T08:57:22.5050384Z -            )
2026-01-25T08:57:22.5050520Z -            db.commit()
2026-01-25T08:57:22.5050646Z -            
2026-01-25T08:57:22.5050884Z +            hashed_pw, salt = hash_password("test_password")
2026-01-25T08:57:22.5051031Z +            db.execute(
2026-01-25T08:57:22.5051466Z +                "INSERT INTO user (username, discriminator, password, salt) VALUES (?, ?, ?, ?)",
2026-01-25T08:57:22.5051663Z +                ("commit_test", 4444, hashed_pw, salt),
2026-01-25T08:57:22.5051784Z +            )
2026-01-25T08:57:22.5051928Z +            db.commit()
2026-01-25T08:57:22.5052072Z +
2026-01-25T08:57:22.5052354Z              # Проверяем, что пользователь создан
2026-01-25T08:57:22.5052504Z              user = db.execute(
2026-01-25T08:57:22.5052820Z -                'SELECT * FROM user WHERE username = ? AND discriminator = ?',
2026-01-25T08:57:22.5053278Z -                ('commit_test', 4444)
2026-01-25T08:57:22.5053620Z +                "SELECT * FROM user WHERE username = ? AND discriminator = ?",
2026-01-25T08:57:22.5053780Z +                ("commit_test", 4444),
2026-01-25T08:57:22.5053927Z              ).fetchone()
2026-01-25T08:57:22.5054104Z              assert user is not None
2026-01-25T08:57:22.5054230Z -            
2026-01-25T08:57:22.5054357Z +
2026-01-25T08:57:22.5054636Z              # Удаляем тестового пользователя
2026-01-25T08:57:22.5054783Z              db.execute(
2026-01-25T08:57:22.5055139Z -                'DELETE FROM user WHERE username = ? AND discriminator = ?',
2026-01-25T08:57:22.5055294Z -                ('commit_test', 4444)
2026-01-25T08:57:22.5055836Z +                "DELETE FROM user WHERE username = ? AND discriminator = ?",
2026-01-25T08:57:22.5056002Z +                ("commit_test", 4444),
2026-01-25T08:57:22.5056142Z              )
2026-01-25T08:57:22.5056290Z              db.commit()
2026-01-25T08:57:22.5056411Z  
2026-01-25T08:57:22.5056525Z  
2026-01-25T08:57:22.5056762Z  class TestDatabasePerformance:
2026-01-25T08:57:22.5056893Z @@ -392,52 +374,50 @@
2026-01-25T08:57:22.5057094Z      def test_query_performance(self, app):
2026-01-25T08:57:22.5057368Z          """Производительность запросов."""
2026-01-25T08:57:22.5057540Z          with app.app_context():
2026-01-25T08:57:22.5057710Z              from app.db.db import get_db
2026-01-25T08:57:22.5057845Z              import time
2026-01-25T08:57:22.5057975Z -            
2026-01-25T08:57:22.5058114Z -            db = get_db()
2026-01-25T08:57:22.5058236Z -            
2026-01-25T08:57:22.5058365Z +
2026-01-25T08:57:22.5058499Z +            db = get_db()
2026-01-25T08:57:22.5058640Z +
2026-01-25T08:57:22.5058938Z              # Измеряем время простого запроса
2026-01-25T08:57:22.5059109Z              start_time = time.time()
2026-01-25T08:57:22.5059325Z -            result = db.execute('SELECT 1').fetchone()
2026-01-25T08:57:22.5059559Z +            result = db.execute("SELECT 1").fetchone()
2026-01-25T08:57:22.5059715Z              end_time = time.time()
2026-01-25T08:57:22.5059846Z -            
2026-01-25T08:57:22.5059985Z +
2026-01-25T08:57:22.5060144Z              assert result[0] == 1
2026-01-25T08:57:22.5060591Z              assert (end_time - start_time) < 0.1  # Менее 100мс
2026-01-25T08:57:22.5060738Z  
2026-01-25T08:57:22.5060962Z      def test_batch_insert_performance(self, app):
2026-01-25T08:57:22.5061307Z          """Производительность массовой вставки."""
2026-01-25T08:57:22.5061473Z          with app.app_context():
2026-01-25T08:57:22.5061647Z              from app.db.db import get_db
2026-01-25T08:57:22.5061842Z              from app.auth import hash_password
2026-01-25T08:57:22.5062005Z              import time
2026-01-25T08:57:22.5062143Z -            
2026-01-25T08:57:22.5062295Z -            db = get_db()
2026-01-25T08:57:22.5062417Z -            
2026-01-25T08:57:22.5062833Z +
2026-01-25T08:57:22.5063224Z +            db = get_db()
2026-01-25T08:57:22.5063396Z +
2026-01-25T08:57:22.5063841Z              # Массовая вставка пользователей (меньше пользователей для скорости)
2026-01-25T08:57:22.5064018Z              start_time = time.time()
2026-01-25T08:57:22.5064145Z -            
2026-01-25T08:57:22.5064274Z +
2026-01-25T08:57:22.5064425Z              users_to_insert = []
2026-01-25T08:57:22.5064807Z              for i in range(10):  # Уменьшили с 100 до 10
2026-01-25T08:57:22.5065022Z -                username = f'perf_test_{i}'
2026-01-25T08:57:22.5065206Z +                username = f"perf_test_{i}"
2026-01-25T08:57:22.5065403Z                  discriminator = 1000 + i
2026-01-25T08:57:22.5065764Z -                hashed_pw, salt = hash_password(f'password_{i}')
2026-01-25T08:57:22.5066068Z +                hashed_pw, salt = hash_password(f"password_{i}")
2026-01-25T08:57:22.5066428Z                  users_to_insert.append((username, discriminator, hashed_pw, salt))
2026-01-25T08:57:22.5066585Z -            
2026-01-25T08:57:22.5066707Z +
2026-01-25T08:57:22.5066897Z              for user_data in users_to_insert:
2026-01-25T08:57:22.5067068Z                  db.execute(
2026-01-25T08:57:22.5067536Z -                    'INSERT INTO user (username, discriminator, password, salt) VALUES (?, ?, ?, ?)',
2026-01-25T08:57:22.5067704Z -                    user_data
2026-01-25T08:57:22.5067833Z -                )
2026-01-25T08:57:22.5067961Z -            
2026-01-25T08:57:22.5068380Z +                    "INSERT INTO user (username, discriminator, password, salt) VALUES (?, ?, ?, ?)",
2026-01-25T08:57:22.5068533Z +                    user_data,
2026-01-25T08:57:22.5068678Z +                )
2026-01-25T08:57:22.5068801Z +
2026-01-25T08:57:22.5068947Z              db.commit()
2026-01-25T08:57:22.5069371Z              end_time = time.time()
2026-01-25T08:57:22.5069514Z -            
2026-01-25T08:57:22.5069650Z +
2026-01-25T08:57:22.5070024Z              # Должно выполняться менее 5 секунд (увеличили лимит)
2026-01-25T08:57:22.5070248Z              assert (end_time - start_time) < 5.0
2026-01-25T08:57:22.5070399Z -            
2026-01-25T08:57:22.5070517Z +
2026-01-25T08:57:22.5070782Z              # Удаляем тестовых пользователей
2026-01-25T08:57:22.5070966Z -            db.execute(
2026-01-25T08:57:22.5071242Z -                'DELETE FROM user WHERE username LIKE "perf_test_%"'
2026-01-25T08:57:22.5071379Z -            )
2026-01-25T08:57:22.5071566Z -            db.commit()
2026-01-25T08:57:22.5071933Z +            db.execute('DELETE FROM user WHERE username LIKE "perf_test_%"')
2026-01-25T08:57:22.5072136Z +            db.commit()
2026-01-25T08:57:22.5163794Z --- /home/runner/work/flask_blog/flask_blog/tests/test_forms.py	2026-01-25 08:57:06.654994+00:00
2026-01-25T08:57:22.5176257Z would reformat /home/runner/work/flask_blog/flask_blog/tests/test_forms.py
2026-01-25T08:57:22.5176738Z +++ /home/runner/work/flask_blog/flask_blog/tests/test_forms.py	2026-01-25 08:57:22.513814+00:00
2026-01-25T08:57:22.5176933Z @@ -2,155 +2,169 @@
2026-01-25T08:57:22.5177315Z  """Тесты для системы форм."""
2026-01-25T08:57:22.5177447Z  
2026-01-25T08:57:22.5177585Z  import pytest
2026-01-25T08:57:22.5177735Z  from flask import Flask
2026-01-25T08:57:22.5177857Z  
2026-01-25T08:57:22.5178703Z -from app.forms import Form, StringField, PasswordField, DataRequired, Length, Email, Username, PasswordStrength, UniqueUsername, Slug, NumberRange, URL
2026-01-25T08:57:22.5178862Z +from app.forms import (
2026-01-25T08:57:22.5178995Z +    Form,
2026-01-25T08:57:22.5179124Z +    StringField,
2026-01-25T08:57:22.5179260Z +    PasswordField,
2026-01-25T08:57:22.5179387Z +    DataRequired,
2026-01-25T08:57:22.5179502Z +    Length,
2026-01-25T08:57:22.5179625Z +    Email,
2026-01-25T08:57:22.5179744Z +    Username,
2026-01-25T08:57:22.5179926Z +    PasswordStrength,
2026-01-25T08:57:22.5180067Z +    UniqueUsername,
2026-01-25T08:57:22.5180196Z +    Slug,
2026-01-25T08:57:22.5180325Z +    NumberRange,
2026-01-25T08:57:22.5180840Z +    URL,
2026-01-25T08:57:22.5180961Z +)
2026-01-25T08:57:22.5181074Z +
2026-01-25T08:57:22.5181353Z  # TODO: Regexp будет реализован в будущем
2026-01-25T08:57:22.5181673Z  from app.forms.csrf import generate_csrf_token, validate_csrf_token
2026-01-25T08:57:22.5181789Z  
2026-01-25T08:57:22.5181906Z  
2026-01-25T08:57:22.5182043Z  @pytest.fixture
2026-01-25T08:57:22.5182171Z  def app():
2026-01-25T08:57:22.5182354Z      app = Flask(__name__)
2026-01-25T08:57:22.5182565Z -    app.config['SECRET_KEY'] = 'test-key-12345'
2026-01-25T08:57:22.5182738Z -    app.config['TESTING'] = True
2026-01-25T08:57:22.5183165Z -    app.config['WTF_CSRF_ENABLED'] = False
2026-01-25T08:57:22.5183391Z +    app.config["SECRET_KEY"] = "test-key-12345"
2026-01-25T08:57:22.5183586Z +    app.config["TESTING"] = True
2026-01-25T08:57:22.5183789Z +    app.config["WTF_CSRF_ENABLED"] = False
2026-01-25T08:57:22.5183916Z      return app
2026-01-25T08:57:22.5184037Z  
2026-01-25T08:57:22.5184152Z  
2026-01-25T08:57:22.5184305Z  class MockForm(Form):
2026-01-25T08:57:22.5184676Z -    name = StringField('Name', validators=[DataRequired(), Length(min=3, max=10)])
2026-01-25T08:57:22.5185005Z -    password = PasswordField('Password', validators=[DataRequired()])
2026-01-25T08:57:22.5185370Z +    name = StringField("Name", validators=[DataRequired(), Length(min=3, max=10)])
2026-01-25T08:57:22.5185683Z +    password = PasswordField("Password", validators=[DataRequired()])
2026-01-25T08:57:22.5186050Z      # TODO: username с Regexp будет добавлен при реализации
2026-01-25T08:57:22.5186606Z -    username = StringField('Username', validators=[DataRequired()])  # TODO: + Regexp(r'^\w+$', message='Invalid')
2026-01-25T08:57:22.5186770Z +    username = StringField(
2026-01-25T08:57:22.5186960Z +        "Username", validators=[DataRequired()]
2026-01-25T08:57:22.5187549Z +    )  # TODO: + Regexp(r'^\w+$', message='Invalid')
2026-01-25T08:57:22.5187684Z  
2026-01-25T08:57:22.5187813Z  
2026-01-25T08:57:22.5188008Z  def test_form_validation_success(app):
2026-01-25T08:57:22.5188337Z      """Тест успешной валидации формы.
2026-01-25T08:57:22.5188483Z -    
2026-01-25T08:57:22.5188611Z +
2026-01-25T08:57:22.5189084Z      TODO: После реализации валидаторов этот тест должен проверять реальную валидацию.
2026-01-25T08:57:22.5189526Z      Сейчас все валидаторы - заглушки и всегда возвращают True.
2026-01-25T08:57:22.5189648Z      """
2026-01-25T08:57:22.5189883Z -    with app.test_request_context(method='POST'):
2026-01-25T08:57:22.5190092Z -        token = generate_csrf_token()
2026-01-25T08:57:22.5190217Z -        data = {
2026-01-25T08:57:22.5190361Z -            'name': 'Admin',
2026-01-25T08:57:22.5190536Z -            'password': 'secret_password',
2026-01-25T08:57:22.5190686Z -            'username': 'user_123',
2026-01-25T08:57:22.5190836Z -            'csrf_token': token
2026-01-25T08:57:22.5191064Z +    with app.test_request_context(method="POST"):
2026-01-25T08:57:22.5191220Z +        token = generate_csrf_token()
2026-01-25T08:57:22.5191368Z +        data = {
2026-01-25T08:57:22.5191502Z +            "name": "Admin",
2026-01-25T08:57:22.5191664Z +            "password": "secret_password",
2026-01-25T08:57:22.5191817Z +            "username": "user_123",
2026-01-25T08:57:22.5191959Z +            "csrf_token": token,
2026-01-25T08:57:22.5192083Z          }
2026-01-25T08:57:22.5192259Z          form = MockForm(data)
2026-01-25T08:57:22.5192715Z          # TODO: После реализации валидаторов ожидать True только для корректных данных
2026-01-25T08:57:22.5193143Z          assert form.validate() is True
2026-01-25T08:57:22.5193304Z          assert not form.errors
2026-01-25T08:57:22.5193418Z  
2026-01-25T08:57:22.5193564Z  
2026-01-25T08:57:22.5193759Z  def test_form_validation_placeholder(app):
2026-01-25T08:57:22.5194064Z      """Тест валидации формы с корректными данными."""
2026-01-25T08:57:22.5194303Z -    with app.test_request_context(method='POST'):
2026-01-25T08:57:22.5194501Z +    with app.test_request_context(method="POST"):
2026-01-25T08:57:22.5194906Z          token = generate_csrf_token()
2026-01-25T08:57:22.5195199Z          # Используем корректные данные для валидации
2026-01-25T08:57:22.5195324Z          data = {
2026-01-25T08:57:22.5195780Z -            'name': 'ValidName',  # Корректное имя (DataRequired, Length 3-10)
2026-01-25T08:57:22.5196215Z -            'password': 'valid_pass',  # Корректный пароль (DataRequired)
2026-01-25T08:57:22.5196805Z -            'username': 'validuser',  # Корректный username (DataRequired)  # TODO: + Length min=3, Regexp
2026-01-25T08:57:22.5196964Z -            'csrf_token': token
2026-01-25T08:57:22.5197370Z +            "name": "ValidName",  # Корректное имя (DataRequired, Length 3-10)
2026-01-25T08:57:22.5197772Z +            "password": "valid_pass",  # Корректный пароль (DataRequired)
2026-01-25T08:57:22.5198585Z +            "username": "validuser",  # Корректный username (DataRequired)  # TODO: + Length min=3, Regexp
2026-01-25T08:57:22.5198740Z +            "csrf_token": token,
2026-01-25T08:57:22.5198889Z          }
2026-01-25T08:57:22.5199031Z          form = MockForm(data)
2026-01-25T08:57:22.5199193Z          assert form.validate() is True
2026-01-25T08:57:22.5199353Z          assert not form.errors
2026-01-25T08:57:22.5199472Z  
2026-01-25T08:57:22.5199585Z  
2026-01-25T08:57:22.5199767Z  def test_form_data_population(app):
2026-01-25T08:57:22.5200071Z      """Проверка правильности заполнения данных в полях."""
2026-01-25T08:57:22.5200257Z      with app.app_context():
2026-01-25T08:57:22.5200464Z -        data = {'name': '  John  ', 'password': 'pass'}
2026-01-25T08:57:22.5200606Z -        form = MockForm(data)
2026-01-25T08:57:22.5200793Z -        assert form.name.data == '  John  '
2026-01-25T08:57:22.5200993Z -        assert form.password.data == 'pass'
2026-01-25T08:57:22.5201106Z -
2026-01-25T08:57:22.5201245Z -
2026-01-25T08:57:22.5201453Z +        data = {"name": "  John  ", "password": "pass"}
2026-01-25T08:57:22.5201613Z +        form = MockForm(data)
2026-01-25T08:57:22.5201800Z +        assert form.name.data == "  John  "
2026-01-25T08:57:22.5201974Z +        assert form.password.data == "pass"
2026-01-25T08:57:22.5202093Z  
2026-01-25T08:57:22.5202204Z  
2026-01-25T08:57:22.5202362Z  def test_form_field_access(app):
2026-01-25T08:57:22.5202601Z      """Тест доступа к полям формы."""
2026-01-25T08:57:22.5202771Z      with app.test_request_context():
2026-01-25T08:57:22.5203215Z          form = MockForm()
2026-01-25T08:57:22.5203358Z -        
2026-01-25T08:57:22.5203602Z +
2026-01-25T08:57:22.5203878Z          # Проверка существования полей
2026-01-25T08:57:22.5205289Z -        assert hasattr(form, 'name')
2026-01-25T08:57:22.5205506Z -        assert hasattr(form, 'password')
2026-01-25T08:57:22.5205678Z -        assert hasattr(form, 'username')
2026-01-25T08:57:22.5205809Z -        
2026-01-25T08:57:22.5205996Z +        assert hasattr(form, "name")
2026-01-25T08:57:22.5206177Z +        assert hasattr(form, "password")
2026-01-25T08:57:22.5206339Z +        assert hasattr(form, "username")
2026-01-25T08:57:22.5206730Z +
2026-01-25T08:57:22.5206985Z          # Проверка типов полей
2026-01-25T08:57:22.5207191Z          assert isinstance(form.name, StringField)
2026-01-25T08:57:22.5207438Z          assert isinstance(form.password, PasswordField)
2026-01-25T08:57:22.5207663Z          assert isinstance(form.username, StringField)
2026-01-25T08:57:22.5207777Z  
2026-01-25T08:57:22.5207889Z  
2026-01-25T08:57:22.5208061Z  def test_form_error_handling(app):
2026-01-25T08:57:22.5208377Z      """Тест обработки ошибок формы с заглушками валидаторов.
2026-01-25T08:57:22.5208501Z -    
2026-01-25T08:57:22.5208613Z +
2026-01-25T08:57:22.5209050Z      TODO: После реализации валидаторов этот тест должен проверять реальные ошибки.
2026-01-25T08:57:22.5209388Z      Сейчас все валидаторы - заглушки и всегда возвращают True.
2026-01-25T08:57:22.5209539Z      """
2026-01-25T08:57:22.5209711Z      with app.test_request_context():
2026-01-25T08:57:22.5209893Z          token = generate_csrf_token()
2026-01-25T08:57:22.5210038Z -        
2026-01-25T08:57:22.5210144Z +
2026-01-25T08:57:22.5210477Z          # Форма с данными, которые должны были бы вызывать ошибки
2026-01-25T08:57:22.5210600Z          data = {
2026-01-25T08:57:22.5210981Z -            'name': '',  # TODO: DataRequired error (когда будет реализовано)
2026-01-25T08:57:22.5211375Z -            'password': '12',  # TODO: Слишком короткий (меньше 3 символов)
2026-01-25T08:57:22.5211806Z -            'username': 'user!@#',  # TODO: Regexp error (когда будет реализовано)
2026-01-25T08:57:22.5211969Z -            'csrf_token': token
2026-01-25T08:57:22.5212093Z -        }
2026-01-25T08:57:22.5212236Z -        form = MockForm(data)
2026-01-25T08:57:22.5212365Z -        
2026-01-25T08:57:22.5212745Z +            "name": "",  # TODO: DataRequired error (когда будет реализовано)
2026-01-25T08:57:22.5213586Z +            "password": "12",  # TODO: Слишком короткий (меньше 3 символов)
2026-01-25T08:57:22.5214026Z +            "username": "user!@#",  # TODO: Regexp error (когда будет реализовано)
2026-01-25T08:57:22.5214279Z +            "csrf_token": token,
2026-01-25T08:57:22.5214403Z +        }
2026-01-25T08:57:22.5214560Z +        form = MockForm(data)
2026-01-25T08:57:22.5214674Z +
2026-01-25T08:57:22.5215042Z          # Сейчас все валидаторы - заглушки, поэтому форма всегда валидна
2026-01-25T08:57:22.5215216Z          assert form.validate() is True
2026-01-25T08:57:22.5215576Z          assert not form.errors  # Заглушки не генерируют ошибки
2026-01-25T08:57:22.5215703Z  
2026-01-25T08:57:22.5215813Z  
2026-01-25T08:57:22.5215971Z  def test_form_without_csrf(app):
2026-01-25T08:57:22.5216214Z      """Тест формы без CSRF токена."""
2026-01-25T08:57:22.5216400Z      with app.test_request_context():
2026-01-25T08:57:22.5216637Z          # Форма без CSRF токена
2026-01-25T08:57:22.5216792Z          data = {
2026-01-25T08:57:22.5216936Z -            'name': 'ValidName',
2026-01-25T08:57:22.5217118Z -            'password': 'validpassword',
2026-01-25T08:57:22.5217289Z -            'username': 'validuser'
2026-01-25T08:57:22.5217407Z -        }
2026-01-25T08:57:22.5217561Z -        form = MockForm(data)
2026-01-25T08:57:22.5217674Z -        
2026-01-25T08:57:22.5217817Z +            "name": "ValidName",
2026-01-25T08:57:22.5217989Z +            "password": "validpassword",
2026-01-25T08:57:22.5218143Z +            "username": "validuser",
2026-01-25T08:57:22.5218272Z +        }
2026-01-25T08:57:22.5218417Z +        form = MockForm(data)
2026-01-25T08:57:22.5218532Z +
2026-01-25T08:57:22.5218923Z          # В TESTING режиме CSRF отключен, поэтому валидация должна пройти
2026-01-25T08:57:22.5219083Z          assert form.validate() is True
2026-01-25T08:57:22.5219199Z  
2026-01-25T08:57:22.5219319Z  
2026-01-25T08:57:22.5219508Z  def test_form_with_extra_fields(app):
2026-01-25T08:57:22.5219781Z      """Тест формы с дополнительными полями."""
2026-01-25T08:57:22.5219959Z      with app.test_request_context():
2026-01-25T08:57:22.5220120Z          token = generate_csrf_token()
2026-01-25T08:57:22.5220477Z -        
2026-01-25T08:57:22.5220596Z +
2026-01-25T08:57:22.5220863Z          # Форма с дополнительными полями
2026-01-25T08:57:22.5220999Z          data = {
2026-01-25T08:57:22.5221147Z -            'name': 'ValidName',
2026-01-25T08:57:22.5221313Z -            'password': 'validpassword',
2026-01-25T08:57:22.5221481Z -            'username': 'validuser',
2026-01-25T08:57:22.5221621Z -            'csrf_token': token,
2026-01-25T08:57:22.5221959Z -            'extra_field': 'extra_value'  # Дополнительное поле
2026-01-25T08:57:22.5222098Z -        }
2026-01-25T08:57:22.5222253Z -        form = MockForm(data)
2026-01-25T08:57:22.5222375Z -        
2026-01-25T08:57:22.5222519Z +            "name": "ValidName",
2026-01-25T08:57:22.5222686Z +            "password": "validpassword",
2026-01-25T08:57:22.5222867Z +            "username": "validuser",
2026-01-25T08:57:22.5223280Z +            "csrf_token": token,
2026-01-25T08:57:22.5223667Z +            "extra_field": "extra_value",  # Дополнительное поле
2026-01-25T08:57:22.5223817Z +        }
2026-01-25T08:57:22.5223963Z +        form = MockForm(data)
2026-01-25T08:57:22.5224076Z +
2026-01-25T08:57:22.5224428Z          # Форма должна быть валидной (дополнительные поля игнорируются)
2026-01-25T08:57:22.5224598Z          assert form.validate() is True
2026-01-25T08:57:22.5224748Z          assert not form.errors
2026-01-25T08:57:22.5224872Z  
2026-01-25T08:57:22.5224984Z  
2026-01-25T08:57:22.5225154Z  def test_validators_standalone():
2026-01-25T08:57:22.5225458Z      """Тестирование отдельных валидаторов-заглушек.
2026-01-25T08:57:22.5225576Z -    
2026-01-25T08:57:22.5225693Z +
2026-01-25T08:57:22.5226100Z      TODO: После реализации валидаторов этот тест должен проверять реальную валидацию.
2026-01-25T08:57:22.5226459Z      Сейчас все валидаторы - заглушки и всегда возвращают (True, None).
2026-01-25T08:57:22.5226825Z      """
2026-01-25T08:57:22.5227144Z      # DataRequired - заглушка всегда возвращает True
2026-01-25T08:57:22.5227324Z      dr = DataRequired()
2026-01-25T08:57:22.5227458Z @@ -182,18 +196,21 @@
2026-01-25T08:57:22.5227590Z          Username(),
2026-01-25T08:57:22.5227751Z          PasswordStrength(),
2026-01-25T08:57:22.5227895Z          UniqueUsername(),
2026-01-25T08:57:22.5228014Z          Slug(),
2026-01-25T08:57:22.5228155Z          NumberRange(),
2026-01-25T08:57:22.5228273Z -        URL()
2026-01-25T08:57:22.5228394Z +        URL(),
2026-01-25T08:57:22.5228519Z      ]
2026-01-25T08:57:22.5228636Z -    
2026-01-25T08:57:22.5228929Z -    test_values = ['', 'test', None, 123, 'a' * 1000, 'invalid!@#', 'short']
2026-01-25T08:57:22.5229057Z -    
2026-01-25T08:57:22.5229171Z +
2026-01-25T08:57:22.5229452Z +    test_values = ["", "test", None, 123, "a" * 1000, "invalid!@#", "short"]
2026-01-25T08:57:22.5229581Z +
2026-01-25T08:57:22.5229777Z      for validator in validators_to_test:
2026-01-25T08:57:22.5229942Z          for value in test_values:
2026-01-25T08:57:22.5230068Z              try:
2026-01-25T08:57:22.5230258Z                  result = validator(value)
2026-01-25T08:57:22.5230392Z -                
2026-01-25T08:57:22.5230905Z -                assert result == (True, None), f"{validator.__class__.__name__}({value}) = {result}, expected (True, None)"
2026-01-25T08:57:22.5231024Z +
2026-01-25T08:57:22.5231180Z +                assert result == (
2026-01-25T08:57:22.5231308Z +                    True,
2026-01-25T08:57:22.5231429Z +                    None,
2026-01-25T08:57:22.5231799Z +                ), f"{validator.__class__.__name__}({value}) = {result}, expected (True, None)"
2026-01-25T08:57:22.5231955Z              except Exception as e:
2026-01-25T08:57:22.5232422Z                  pytest.fail(f"Ошибка в валидаторе {validator.__class__.__name__}: {e}")
2026-01-25T08:57:22.6222086Z --- /home/runner/work/flask_blog/flask_blog/tests/test_integration.py	2026-01-25 08:57:06.654994+00:00
2026-01-25T08:57:22.6223893Z +++ /home/runner/work/flask_blog/flask_blog/tests/test_integration.py	2026-01-25 08:57:22.618225+00:00
2026-01-25T08:57:22.6225427Z @@ -6,85 +6,94 @@
2026-01-25T08:57:22.6225813Z  
2026-01-25T08:57:22.6231428Z  
2026-01-25T08:57:22.6231803Z  class TestUserWorkflows:
2026-01-25T08:57:22.6233458Z      """Тесты полных пользовательских сценариев."""
2026-01-25T08:57:22.6234600Z  
2026-01-25T08:57:22.6237276Z -    def test_complete_user_registration_and_login(self, client_with_csrf, auth_with_csrf, app_with_csrf):
2026-01-25T08:57:22.6238214Z +    def test_complete_user_registration_and_login(
2026-01-25T08:57:22.6264023Z would reformat /home/runner/work/flask_blog/flask_blog/tests/test_integration.py
2026-01-25T08:57:22.6264908Z +        self, client_with_csrf, auth_with_csrf, app_with_csrf
2026-01-25T08:57:22.6265716Z +    ):
2026-01-25T08:57:22.6266360Z          """Полный цикл: регистрация -> вход -> выход."""
2026-01-25T08:57:22.6267321Z          with app_with_csrf.app_context():
2026-01-25T08:57:22.6267898Z              # 1. Регистрация
2026-01-25T08:57:22.6268359Z              response = client_with_csrf.post(
2026-01-25T08:57:22.6268875Z -                '/auth/register',
2026-01-25T08:57:22.6269489Z -                data={'username': 'integration_user', 'password': 'test_pass123'},
2026-01-25T08:57:22.6270162Z -                follow_redirects=True
2026-01-25T08:57:22.6270621Z +                "/auth/register",
2026-01-25T08:57:22.6271195Z +                data={"username": "integration_user", "password": "test_pass123"},
2026-01-25T08:57:22.6271843Z +                follow_redirects=True,
2026-01-25T08:57:22.6272265Z              )
2026-01-25T08:57:22.6272556Z -            
2026-01-25T08:57:22.6272851Z +
2026-01-25T08:57:22.6273503Z              if response.status_code == 200:
2026-01-25T08:57:22.6288328Z                  # 2. Вход
2026-01-25T08:57:22.6288820Z                  response = client_with_csrf.post(
2026-01-25T08:57:22.6289344Z -                    '/auth/login',
2026-01-25T08:57:22.6289978Z -                    data={'username': 'integration_user#0001', 'password': 'test_pass123'},
2026-01-25T08:57:22.6290683Z -                    follow_redirects=False
2026-01-25T08:57:22.6291229Z +                    "/auth/login",
2026-01-25T08:57:22.6291630Z +                    data={
2026-01-25T08:57:22.6292068Z +                        "username": "integration_user#0001",
2026-01-25T08:57:22.6292606Z +                        "password": "test_pass123",
2026-01-25T08:57:22.6293266Z +                    },
2026-01-25T08:57:22.6293653Z +                    follow_redirects=False,
2026-01-25T08:57:22.6294100Z                  )
2026-01-25T08:57:22.6294435Z -                
2026-01-25T08:57:22.6294748Z +
2026-01-25T08:57:22.6295117Z                  if response.status_code == 302:
2026-01-25T08:57:22.6295711Z                      # 3. Проверка сессии
2026-01-25T08:57:22.6296290Z                      with client_with_csrf.session_transaction() as sess:
2026-01-25T08:57:22.6296892Z -                        assert 'user_id' in sess
2026-01-25T08:57:22.6297337Z -                    
2026-01-25T08:57:22.6298049Z +                        assert "user_id" in sess
2026-01-25T08:57:22.6298487Z +
2026-01-25T08:57:22.6298869Z                      # 4. Выход
2026-01-25T08:57:22.6299476Z -                    response = client_with_csrf.get('/auth/logout', follow_redirects=False)
2026-01-25T08:57:22.6300200Z +                    response = client_with_csrf.get(
2026-01-25T08:57:22.6300795Z +                        "/auth/logout", follow_redirects=False
2026-01-25T08:57:22.6301278Z +                    )
2026-01-25T08:57:22.6301676Z                      assert response.status_code == 302
2026-01-25T08:57:22.6302151Z -                    
2026-01-25T08:57:22.6302480Z +
2026-01-25T08:57:22.6303207Z                      # 5. Проверка очистки сессии
2026-01-25T08:57:22.6303787Z                      with client_with_csrf.session_transaction() as sess:
2026-01-25T08:57:22.6304408Z -                        assert 'user_id' not in sess
2026-01-25T08:57:22.6304852Z -
2026-01-25T08:57:22.6305424Z -    def test_create_post_workflow(self, client_with_csrf, auth_with_csrf, app_with_csrf):
2026-01-25T08:57:22.6306196Z +                        assert "user_id" not in sess
2026-01-25T08:57:22.6306645Z +
2026-01-25T08:57:22.6306941Z +    def test_create_post_workflow(
2026-01-25T08:57:22.6307472Z +        self, client_with_csrf, auth_with_csrf, app_with_csrf
2026-01-25T08:57:22.6308007Z +    ):
2026-01-25T08:57:22.6308430Z          """Сценарий создания поста."""
2026-01-25T08:57:22.6308901Z          with app_with_csrf.app_context():
2026-01-25T08:57:22.6309440Z              # 1. Вход
2026-01-25T08:57:22.6309794Z              auth_with_csrf.login()
2026-01-25T08:57:22.6310282Z -            
2026-01-25T08:57:22.6310582Z +
2026-01-25T08:57:22.6310943Z              # 2. Создание поста
2026-01-25T08:57:22.6311381Z              response = client_with_csrf.post(
2026-01-25T08:57:22.6312131Z -                '/main/create',
2026-01-25T08:57:22.6312577Z +                "/main/create",
2026-01-25T08:57:22.6313144Z                  data={
2026-01-25T08:57:22.6313673Z -                    'title': 'Интеграционный пост',
2026-01-25T08:57:22.6314405Z -                    'content': 'Это тестовый пост для интеграционных тестов.',
2026-01-25T08:57:22.6315108Z +                    "title": "Интеграционный пост",
2026-01-25T08:57:22.6315806Z +                    "content": "Это тестовый пост для интеграционных тестов.",
2026-01-25T08:57:22.6316349Z                  },
2026-01-25T08:57:22.6316700Z -                follow_redirects=True
2026-01-25T08:57:22.6317168Z +                follow_redirects=True,
2026-01-25T08:57:22.6317594Z              )
2026-01-25T08:57:22.6317900Z -            
2026-01-25T08:57:22.6318184Z +
2026-01-25T08:57:22.6318679Z              # 3. Проверка создания (если маршрут существует)
2026-01-25T08:57:22.6319215Z              if response.status_code == 200:
2026-01-25T08:57:22.6319677Z                  try:
2026-01-25T08:57:22.6320075Z                      from app.db.db import get_db
2026-01-25T08:57:22.6320551Z +
2026-01-25T08:57:22.6320870Z                      db = get_db()
2026-01-25T08:57:22.6321304Z                      post = db.execute(
2026-01-25T08:57:22.6321825Z -                        'SELECT * FROM post WHERE title = ?',
2026-01-25T08:57:22.6322473Z -                        ('Интеграционный пост',)
2026-01-25T08:57:22.6323427Z +                        "SELECT * FROM post WHERE title = ?", ("Интеграционный пост",)
2026-01-25T08:57:22.6324044Z                      ).fetchone()
2026-01-25T08:57:22.6324473Z                      assert post is not None
2026-01-25T08:57:22.6324951Z                  except Exception:
2026-01-25T08:57:22.6325429Z                      pass
2026-01-25T08:57:22.6325776Z  
2026-01-25T08:57:22.6326169Z      def test_comment_workflow(self, client, auth, app):
2026-01-25T08:57:22.6326813Z          """Сценарий добавления комментария."""
2026-01-25T08:57:22.6327324Z          with app.app_context():
2026-01-25T08:57:22.6327818Z              # 1. Вход
2026-01-25T08:57:22.6328176Z              auth.login()
2026-01-25T08:57:22.6328867Z -            
2026-01-25T08:57:22.6329182Z +
2026-01-25T08:57:22.6329633Z              # 2. Попытка добавить комментарий к посту
2026-01-25T08:57:22.6330137Z              response = client.post(
2026-01-25T08:57:22.6330593Z -                '/main/post/1/comment',
2026-01-25T08:57:22.6331042Z +                "/main/post/1/comment",
2026-01-25T08:57:22.6331480Z                  data={
2026-01-25T08:57:22.6332032Z -                    'content': 'Это тестовый комментарий.',
2026-01-25T08:57:22.6332658Z +                    "content": "Это тестовый комментарий.",
2026-01-25T08:57:22.6333308Z                  },
2026-01-25T08:57:22.6333690Z -                follow_redirects=True
2026-01-25T08:57:22.6334151Z +                follow_redirects=True,
2026-01-25T08:57:22.6334582Z              )
2026-01-25T08:57:22.6334912Z -            
2026-01-25T08:57:22.6335199Z +
2026-01-25T08:57:22.6335766Z              # Проверка, что запрос обработан (даже если маршрут не существует)
2026-01-25T08:57:22.6336439Z              assert response.status_code in [200, 302, 404, 405]
2026-01-25T08:57:22.6336978Z  
2026-01-25T08:57:22.6337296Z  
2026-01-25T08:57:22.6337603Z  class TestSecurityFeatures:
2026-01-25T08:57:22.6338037Z @@ -92,146 +101,148 @@
2026-01-25T08:57:22.6338378Z  
2026-01-25T08:57:22.6338732Z      def test_session_security(self, client, auth):
2026-01-25T08:57:22.6339324Z          """Безопасность сессий."""
2026-01-25T08:57:22.6339795Z          # 1. Вход
2026-01-25T08:57:22.6340119Z          auth.login()
2026-01-25T08:57:22.6340462Z -        
2026-01-25T08:57:22.6340738Z +
2026-01-25T08:57:22.6341158Z          # 2. Проверка, что сессия установлена
2026-01-25T08:57:22.6341730Z          with client.session_transaction() as sess:
2026-01-25T08:57:22.6342268Z -            assert 'user_id' in sess
2026-01-25T08:57:22.6342744Z -            original_user_id = sess['user_id']
2026-01-25T08:57:22.6343755Z -        
2026-01-25T08:57:22.6344074Z +            assert "user_id" in sess
2026-01-25T08:57:22.6344552Z +            original_user_id = sess["user_id"]
2026-01-25T08:57:22.6345007Z +
2026-01-25T08:57:22.6345374Z          # 3. Выход
2026-01-25T08:57:22.6345737Z          auth.logout()
2026-01-25T08:57:22.6346146Z -        
2026-01-25T08:57:22.6346448Z +
2026-01-25T08:57:22.6346863Z          # 4. Проверка, что сессия очищена
2026-01-25T08:57:22.6347395Z          with client.session_transaction() as sess:
2026-01-25T08:57:22.6348086Z -            assert 'user_id' not in sess or sess.get('user_id') != original_user_id
2026-01-25T08:57:22.6348749Z -
2026-01-25T08:57:22.6349257Z +            assert "user_id" not in sess or sess.get("user_id") != original_user_id
2026-01-25T08:57:22.6349977Z  
2026-01-25T08:57:22.6350312Z  
2026-01-25T08:57:22.6350604Z  class TestErrorHandling:
2026-01-25T08:57:22.6351116Z      """Тесты обработки ошибок."""
2026-01-25T08:57:22.6351514Z  
2026-01-25T08:57:22.6351887Z      def test_database_error_handling(self, client, app):
2026-01-25T08:57:22.6352545Z          """Обработка ошибок базы данных."""
2026-01-25T08:57:22.6353250Z          with app.app_context():
2026-01-25T08:57:22.6353669Z              try:
2026-01-25T08:57:22.6354045Z                  from app.db.db import get_db
2026-01-25T08:57:22.6354485Z +
2026-01-25T08:57:22.6354760Z                  db = get_db()
2026-01-25T08:57:22.6355132Z -                
2026-01-25T08:57:22.6355475Z +
2026-01-25T08:57:22.6356013Z                  # Попытка выполнить некорректный SQL
2026-01-25T08:57:22.6356454Z                  try:
2026-01-25T08:57:22.6356855Z -                    db.execute('INVALID SQL QUERY')
2026-01-25T08:57:22.6357345Z +                    db.execute("INVALID SQL QUERY")
2026-01-25T08:57:22.6357990Z                      assert False, "Should have raised an exception"
2026-01-25T08:57:22.6358532Z                  except Exception:
2026-01-25T08:57:22.6359200Z                      pass  # Ожидаемое поведение
2026-01-25T08:57:22.6359648Z -                
2026-01-25T08:57:22.6359965Z +
2026-01-25T08:57:22.6360313Z              except Exception:
2026-01-25T08:57:22.6361184Z                  pass  # БД может быть не настроена
2026-01-25T08:57:22.6361632Z  
2026-01-25T08:57:22.6361967Z      def test_form_error_handling(self, client):
2026-01-25T08:57:22.6362541Z          """Обработка ошибок форм."""
2026-01-25T08:57:22.6363376Z          # Попытка отправить форму с некорректными данными
2026-01-25T08:57:22.6363943Z          response = client.post(
2026-01-25T08:57:22.6364370Z -            '/auth/register',
2026-01-25T08:57:22.6364758Z +            "/auth/register",
2026-01-25T08:57:22.6365131Z              data={
2026-01-25T08:57:22.6365587Z -                'username': '',  # Пустой логин
2026-01-25T08:57:22.6366211Z -                'password': '123'  # Слишком короткий пароль
2026-01-25T08:57:22.6366695Z -            }
2026-01-25T08:57:22.6367151Z +                "username": "",  # Пустой логин
2026-01-25T08:57:22.6367795Z +                "password": "123",  # Слишком короткий пароль
2026-01-25T08:57:22.6368280Z +            },
2026-01-25T08:57:22.6368624Z          )
2026-01-25T08:57:22.6368904Z -        
2026-01-25T08:57:22.6369177Z +
2026-01-25T08:57:22.6369743Z          # TODO: С заглушками валидации форма всегда валидна, происходит редирект
2026-01-25T08:57:22.6370535Z          # Когда валидаторы будут реализованы, здесь должно быть 200 или 400
2026-01-25T08:57:22.6371451Z          assert response.status_code in [200, 400, 302]  # Включаем 302 для заглушек
2026-01-25T08:57:22.6372167Z  
2026-01-25T08:57:22.6372552Z      def test_authentication_error_handling(self, client):
2026-01-25T08:57:22.6373387Z          """Обработка ошибок аутентификации."""
2026-01-25T08:57:22.6373969Z          # Попытка входа с неверными данными
2026-01-25T08:57:22.6374434Z          response = client.post(
2026-01-25T08:57:22.6374852Z -            '/auth/login',
2026-01-25T08:57:22.6375476Z -            data={
2026-01-25T08:57:22.6375777Z -                'username': 'nonexistent#0000',
2026-01-25T08:57:22.6376194Z -                'password': 'wrong_password'
2026-01-25T08:57:22.6376598Z -            }
2026-01-25T08:57:22.6376857Z +            "/auth/login",
2026-01-25T08:57:22.6377337Z +            data={"username": "nonexistent#0000", "password": "wrong_password"},
2026-01-25T08:57:22.6377853Z          )
2026-01-25T08:57:22.6378089Z -        
2026-01-25T08:57:22.6378330Z +
2026-01-25T08:57:22.6378652Z          # Должна быть ошибка аутентификации
2026-01-25T08:57:22.6379087Z          assert response.status_code in [200, 400]
2026-01-25T08:57:22.6379666Z          # Проверяем наличие сообщения об ошибке
2026-01-25T08:57:22.6380473Z -        assert b'error' in response.data.lower() or b'nevernyi' in response.data.lower() or b'login' in response.data.lower()
2026-01-25T08:57:22.6381251Z +        assert (
2026-01-25T08:57:22.6381562Z +            b"error" in response.data.lower()
2026-01-25T08:57:22.6382025Z +            or b"nevernyi" in response.data.lower()
2026-01-25T08:57:22.6382516Z +            or b"login" in response.data.lower()
2026-01-25T08:57:22.6383093Z +        )
2026-01-25T08:57:22.6383338Z  
2026-01-25T08:57:22.6383560Z  
2026-01-25T08:57:22.6383845Z  class TestPerformance:
2026-01-25T08:57:22.6384245Z      """Базовые тесты производительности."""
2026-01-25T08:57:22.6384619Z  
2026-01-25T08:57:22.6384921Z      def test_page_load_times(self, client):
2026-01-25T08:57:22.6385443Z          """Проверка времени загрузки страниц."""
2026-01-25T08:57:22.6385804Z          import time
2026-01-25T08:57:22.6386076Z -        
2026-01-25T08:57:22.6386308Z +
2026-01-25T08:57:22.6386626Z          # Измеряем время загрузки главной страницы
2026-01-25T08:57:22.6387023Z          start_time = time.time()
2026-01-25T08:57:22.6387487Z -        response = client.get('/')
2026-01-25T08:57:22.6387869Z +        response = client.get("/")
2026-01-25T08:57:22.6388217Z          end_time = time.time()
2026-01-25T08:57:22.6388551Z -        
2026-01-25T08:57:22.6388788Z +
2026-01-25T08:57:22.6389050Z          assert response.status_code == 200
2026-01-25T08:57:22.6389580Z          # Страница должна загружаться менее 1 секунды
2026-01-25T08:57:22.6390307Z          assert (end_time - start_time) < 1.0
2026-01-25T08:57:22.6390668Z  
2026-01-25T08:57:22.6390972Z      def test_database_query_performance(self, app):
2026-01-25T08:57:22.6391544Z          """Проверка производительности запросов к БД."""
2026-01-25T08:57:22.6392064Z          with app.app_context():
2026-01-25T08:57:22.6392405Z              try:
2026-01-25T08:57:22.6392749Z                  from app.db.db import get_db
2026-01-25T08:57:22.6393335Z                  import time
2026-01-25T08:57:22.6393644Z -                
2026-01-25T08:57:22.6394005Z +
2026-01-25T08:57:22.6394261Z                  db = get_db()
2026-01-25T08:57:22.6394583Z -                
2026-01-25T08:57:22.6394873Z +
2026-01-25T08:57:22.6395374Z                  # Измеряем время простого запроса
2026-01-25T08:57:22.6396071Z                  start_time = time.time()
2026-01-25T08:57:22.6396545Z -                result = db.execute('SELECT 1').fetchone()
2026-01-25T08:57:22.6397040Z +                result = db.execute("SELECT 1").fetchone()
2026-01-25T08:57:22.6397477Z                  end_time = time.time()
2026-01-25T08:57:22.6397949Z -                
2026-01-25T08:57:22.6398372Z +
2026-01-25T08:57:22.6398682Z                  assert result[0] == 1
2026-01-25T08:57:22.6399281Z                  # Запрос должен выполняться менее 0.1 секунды
2026-01-25T08:57:22.6399788Z                  assert (end_time - start_time) < 0.1
2026-01-25T08:57:22.6400221Z -                
2026-01-25T08:57:22.6400487Z +
2026-01-25T08:57:22.6400767Z              except Exception:
2026-01-25T08:57:22.6401274Z                  pass  # БД может быть не настроена
2026-01-25T08:57:22.6401700Z  
2026-01-25T08:57:22.6401958Z  
2026-01-25T08:57:22.6402249Z  class TestEnvironmentVariables:
2026-01-25T08:57:22.6402747Z      """Тесты переменных окружения."""
2026-01-25T08:57:22.6403298Z  
2026-01-25T08:57:22.6403657Z      def test_secret_key_configuration(self):
2026-01-25T08:57:22.6404188Z          """Проверка конфигурации секретного ключа."""
2026-01-25T08:57:22.6404617Z          from config import Config
2026-01-25T08:57:22.6404975Z -        
2026-01-25T08:57:22.6405196Z +
2026-01-25T08:57:22.6405532Z          # SECRET_KEY должен быть настроен
2026-01-25T08:57:22.6405933Z          assert Config.SECRET_KEY is not None
2026-01-25T08:57:22.6406336Z          assert len(Config.SECRET_KEY) > 0
2026-01-25T08:57:22.6406669Z -        
2026-01-25T08:57:22.6406888Z +
2026-01-25T08:57:22.6407247Z          # В продакшене не должен использоваться ключ по умолчанию
2026-01-25T08:57:22.6407720Z -        if Config.SECRET_KEY == 'you-will-never-guess':
2026-01-25T08:57:22.6408176Z +        if Config.SECRET_KEY == "you-will-never-guess":
2026-01-25T08:57:22.6408559Z              import os
2026-01-25T08:57:22.6408827Z +
2026-01-25T08:57:22.6409318Z              # Это должно быть только в разработке
2026-01-25T08:57:22.6409994Z -            assert os.environ.get('FLASK_ENV') == 'development'
2026-01-25T08:57:22.6411147Z +            assert os.environ.get("FLASK_ENV") == "development"
2026-01-25T08:57:22.6411696Z  
2026-01-25T08:57:22.6412051Z      def test_database_path_configuration(self):
2026-01-25T08:57:22.6412775Z          """Проверка конфигурации пути к БД."""
2026-01-25T08:57:22.6413494Z          from config import Config
2026-01-25T08:57:22.6413902Z -        
2026-01-25T08:57:22.6414176Z +
2026-01-25T08:57:22.6414503Z          assert Config.DATABASE is not None
2026-01-25T08:57:22.6415046Z          assert len(Config.DATABASE) > 0
2026-01-25T08:57:22.6415523Z -        
2026-01-25T08:57:22.6415896Z +
2026-01-25T08:57:22.6416389Z          # Путь должен содержать имя файла БД
2026-01-25T08:57:22.6416903Z -        assert 'flask_blog.sqlite' in Config.DATABASE
2026-01-25T08:57:22.6417545Z +        assert "flask_blog.sqlite" in Config.DATABASE
2026-01-25T08:57:22.6418048Z  
2026-01-25T08:57:22.6418461Z      def test_admin_password_configuration(self):
2026-01-25T08:57:22.6419178Z          """Проверка конфигурации пароля администратора."""
2026-01-25T08:57:22.6419744Z          from config import Config
2026-01-25T08:57:22.6420183Z -        
2026-01-25T08:57:22.6420463Z +
2026-01-25T08:57:22.6421116Z          # ADMIN_PASSWORD может быть None (из переменной окружения)
2026-01-25T08:57:22.6421757Z          # или строка
2026-01-25T08:57:22.6422415Z          assert Config.ADMIN_PASSWORD is None or isinstance(Config.ADMIN_PASSWORD, str)
2026-01-25T08:57:22.6423373Z  
2026-01-25T08:57:22.6423648Z  
2026-01-25T08:57:22.6424001Z @@ -239,37 +250,34 @@
2026-01-25T08:57:22.6424484Z      """Тесты фабрики приложений."""
2026-01-25T08:57:22.6424941Z  
2026-01-25T08:57:22.6425303Z      def test_app_creation(self):
2026-01-25T08:57:22.6425803Z          """Создание приложения."""
2026-01-25T08:57:22.6426371Z          from app import create_app
2026-01-25T08:57:22.6427209Z -        
2026-01-25T08:57:22.6427491Z +
2026-01-25T08:57:22.6427789Z          app = create_app()
2026-01-25T08:57:22.6428230Z          assert app is not None
2026-01-25T08:57:22.6428750Z -        assert app.name == 'app'
2026-01-25T08:57:22.6429186Z +        assert app.name == "app"
2026-01-25T08:57:22.6429599Z  
2026-01-25T08:57:22.6429956Z      def test_app_creation_with_config(self):
2026-01-25T08:57:22.6430619Z          """Создание приложения с кастомной конфигурацией."""
2026-01-25T08:57:22.6431133Z          from app import create_app
2026-01-25T08:57:22.6431584Z -        
2026-01-25T08:57:22.6431883Z -        test_config = {
2026-01-25T08:57:22.6432255Z -            'TESTING': True,
2026-01-25T08:57:22.6432714Z -            'SECRET_KEY': 'test-secret-key'
2026-01-25T08:57:22.6433496Z -        }
2026-01-25T08:57:22.6433829Z -        
2026-01-25T08:57:22.6434101Z +
2026-01-25T08:57:22.6434510Z +        test_config = {"TESTING": True, "SECRET_KEY": "test-secret-key"}
2026-01-25T08:57:22.6435203Z +
2026-01-25T08:57:22.6435622Z          app = create_app(test_config)
2026-01-25T08:57:22.6436129Z -        assert app.config['TESTING'] is True
2026-01-25T08:57:22.6436821Z -        assert app.config['SECRET_KEY'] == 'test-secret-key'
2026-01-25T08:57:22.6437414Z +        assert app.config["TESTING"] is True
2026-01-25T08:57:22.6437964Z +        assert app.config["SECRET_KEY"] == "test-secret-key"
2026-01-25T08:57:22.6438507Z  
2026-01-25T08:57:22.6438919Z      def test_blueprints_registration(self):
2026-01-25T08:57:22.6439527Z          """Регистрация blueprint'ов."""
2026-01-25T08:57:22.6439975Z          from app import create_app
2026-01-25T08:57:22.6440389Z -        
2026-01-25T08:57:22.6440667Z +
2026-01-25T08:57:22.6440947Z          app = create_app()
2026-01-25T08:57:22.6441483Z -        
2026-01-25T08:57:22.6441762Z +
2026-01-25T08:57:22.6442187Z          # Проверяем, что blueprint'ы зарегистрированы
2026-01-25T08:57:22.6442865Z          blueprints = [bp.name for bp in app.blueprints.values()]
2026-01-25T08:57:22.6443730Z -        
2026-01-25T08:57:22.6444001Z +
2026-01-25T08:57:22.6444476Z          # Основные blueprint'ы должны быть зарегистрированы
2026-01-25T08:57:22.6445033Z -        expected_blueprints = ['auth', 'main']
2026-01-25T08:57:22.6445828Z +        expected_blueprints = ["auth", "main"]
2026-01-25T08:57:22.6446460Z          for bp_name in expected_blueprints:
2026-01-25T08:57:22.6447008Z              if bp_name in blueprints:
2026-01-25T08:57:22.6447451Z                  assert True
2026-01-25T08:57:22.6492194Z would reformat /home/runner/work/flask_blog/flask_blog/tests/test_main.py
2026-01-25T08:57:22.6493596Z --- /home/runner/work/flask_blog/flask_blog/tests/test_main.py	2026-01-25 08:57:06.654994+00:00
2026-01-25T08:57:22.6494652Z +++ /home/runner/work/flask_blog/flask_blog/tests/test_main.py	2026-01-25 08:57:22.643724+00:00
2026-01-25T08:57:22.6495375Z @@ -8,192 +8,189 @@
2026-01-25T08:57:22.6495730Z  class TestMainRoutes:
2026-01-25T08:57:22.6496421Z      """Тесты основных страниц приложения."""
2026-01-25T08:57:22.6496962Z  
2026-01-25T08:57:22.6497301Z      def test_index_page_loads(self, client):
2026-01-25T08:57:22.6497936Z          """Главная страница должна загружаться."""
2026-01-25T08:57:22.6498461Z -        response = client.get('/')
2026-01-25T08:57:22.6498937Z +        response = client.get("/")
2026-01-25T08:57:22.6499437Z          assert response.status_code == 200
2026-01-25T08:57:22.6500141Z -        assert 'Flask Blog'.encode('utf-8') in response.data
2026-01-25T08:57:22.6500806Z +        assert "Flask Blog".encode("utf-8") in response.data
2026-01-25T08:57:22.6501307Z  
2026-01-25T08:57:22.6501727Z      def test_index_page_context(self, client, app):
2026-01-25T08:57:22.6502387Z          """Проверка контекста главной страницы."""
2026-01-25T08:57:22.6502863Z          with app.app_context():
2026-01-25T08:57:22.6503575Z -            response = client.get('/')
2026-01-25T08:57:22.6504076Z +            response = client.get("/")
2026-01-25T08:57:22.6504613Z              assert response.status_code == 200
2026-01-25T08:57:22.6505721Z -            
2026-01-25T08:57:22.6506049Z +
2026-01-25T08:57:22.6506475Z      def test_index_with_authenticated_user(self, client, auth):
2026-01-25T08:57:22.6507347Z          """Главная страница для аутентифицированного пользователя."""
2026-01-25T08:57:22.6507888Z          auth.login()
2026-01-25T08:57:22.6508262Z -        response = client.get('/')
2026-01-25T08:57:22.6508749Z +        response = client.get("/")
2026-01-25T08:57:22.6509214Z          assert response.status_code == 200
2026-01-25T08:57:22.6509655Z -        
2026-01-25T08:57:22.6509971Z +
2026-01-25T08:57:22.6510284Z      def test_about_page(self, client):
2026-01-25T08:57:22.6510808Z          """Страница о проекте."""
2026-01-25T08:57:22.6511235Z -        response = client.get('/about')
2026-01-25T08:57:22.6511702Z +        response = client.get("/about")
2026-01-25T08:57:22.6512226Z          # Если страница существует
2026-01-25T08:57:22.6512671Z          if response.status_code == 200:
2026-01-25T08:57:22.6513536Z -            assert 'О проекте'.encode('utf-8') in response.data
2026-01-25T08:57:22.6514266Z +            assert "О проекте".encode("utf-8") in response.data
2026-01-25T08:57:22.6514870Z  
2026-01-25T08:57:22.6515135Z  
2026-01-25T08:57:22.6515443Z  class TestPostManagement:
2026-01-25T08:57:22.6515929Z      """Тесты управления постами."""
2026-01-25T08:57:22.6516327Z  
2026-01-25T08:57:22.6516707Z      def test_create_post_requires_login(self, client):
2026-01-25T08:57:22.6517381Z          """Создание поста требует аутентификации."""
2026-01-25T08:57:22.6517996Z -        response = client.get('/post/create', follow_redirects=False)
2026-01-25T08:57:22.6518729Z +        response = client.get("/post/create", follow_redirects=False)
2026-01-25T08:57:22.6519366Z          assert response.status_code == 302
2026-01-25T08:57:22.6519914Z -        assert '/auth/login' in response.headers['Location']
2026-01-25T08:57:22.6520544Z +        assert "/auth/login" in response.headers["Location"]
2026-01-25T08:57:22.6521099Z  
2026-01-25T08:57:22.6521530Z      def test_create_post_authenticated(self, client, auth, app):
2026-01-25T08:57:22.6522271Z          """Создание поста аутентифицированным пользователем."""
2026-01-25T08:57:22.6523370Z          auth.login()
2026-01-25T08:57:22.6523809Z -        response = client.get('/post/create')
2026-01-25T08:57:22.6524306Z +        response = client.get("/post/create")
2026-01-25T08:57:22.6524803Z          assert response.status_code == 200
2026-01-25T08:57:22.6525481Z -        assert 'Создать'.encode('utf-8') in response.data
2026-01-25T08:57:22.6526205Z +        assert "Создать".encode("utf-8") in response.data
2026-01-25T08:57:22.6526709Z  
2026-01-25T08:57:22.6527119Z      def test_post_creation_success(self, client, auth, app):
2026-01-25T08:57:22.6527838Z          """Успешное создание поста."""
2026-01-25T08:57:22.6528296Z          auth.login()
2026-01-25T08:57:22.6528654Z -        
2026-01-25T08:57:22.6528937Z +
2026-01-25T08:57:22.6529231Z          with app.app_context():
2026-01-25T08:57:22.6530047Z              # Пробуем создать пост
2026-01-25T08:57:22.6530502Z              response = client.post(
2026-01-25T08:57:22.6530946Z -                '/post/create',
2026-01-25T08:57:22.6531354Z +                "/post/create",
2026-01-25T08:57:22.6531735Z                  data={
2026-01-25T08:57:22.6532325Z -                    'title': 'Тестовый пост',
2026-01-25T08:57:22.6533181Z -                    'content': 'Это содержимое тестового поста',
2026-01-25T08:57:22.6533837Z +                    "title": "Тестовый пост",
2026-01-25T08:57:22.6534460Z +                    "content": "Это содержимое тестового поста",
2026-01-25T08:57:22.6534930Z                  },
2026-01-25T08:57:22.6535294Z -                follow_redirects=True
2026-01-25T08:57:22.6535762Z +                follow_redirects=True,
2026-01-25T08:57:22.6536168Z              )
2026-01-25T08:57:22.6536477Z -            
2026-01-25T08:57:22.6536802Z +
2026-01-25T08:57:22.6537221Z              # Если маршрут существует и работает
2026-01-25T08:57:22.6537759Z              if response.status_code == 200:
2026-01-25T08:57:22.6538392Z                  # Проверяем, что пост создан (если есть БД)
2026-01-25T08:57:22.6538870Z                  try:
2026-01-25T08:57:22.6539264Z                      from app.db.db import get_db
2026-01-25T08:57:22.6539706Z +
2026-01-25T08:57:22.6540000Z                      db = get_db()
2026-01-25T08:57:22.6540425Z                      post = db.execute(
2026-01-25T08:57:22.6540921Z -                        'SELECT * FROM post WHERE title = ?',
2026-01-25T08:57:22.6541533Z -                        ('Тестовый пост',)
2026-01-25T08:57:22.6542241Z +                        "SELECT * FROM post WHERE title = ?", ("Тестовый пост",)
2026-01-25T08:57:22.6542816Z                      ).fetchone()
2026-01-25T08:57:22.6543583Z                      assert post is not None
2026-01-25T08:57:22.6544039Z                  except Exception:
2026-01-25T08:57:22.6544661Z                      pass  # БД может быть не настроена в тестах
2026-01-25T08:57:22.6545185Z  
2026-01-25T08:57:22.6545519Z      def test_view_post(self, client, app):
2026-01-25T08:57:22.6546077Z          """Просмотр отдельного поста."""
2026-01-25T08:57:22.6546828Z          with app.app_context():
2026-01-25T08:57:22.6547487Z              # Пробуем просмотреть пост с ID 1 (создается в conftest.py)
2026-01-25T08:57:22.6548094Z -            response = client.get('/post/1')
2026-01-25T08:57:22.6548605Z +            response = client.get("/post/1")
2026-01-25T08:57:22.6549175Z              # Должен вернуть 200 (пост есть)
2026-01-25T08:57:22.6549753Z              assert response.status_code == 200
2026-01-25T08:57:22.6550387Z              # Проверяем, что в ответе есть содержимое поста
2026-01-25T08:57:22.6551059Z -            assert b'Test Post' in response.data or b'post' in response.data
2026-01-25T08:57:22.6551827Z +            assert b"Test Post" in response.data or b"post" in response.data
2026-01-25T08:57:22.6552390Z  
2026-01-25T08:57:22.6552792Z      def test_edit_post_requires_login(self, client):
2026-01-25T08:57:22.6553680Z          """Редактирование поста требует аутентификации."""
2026-01-25T08:57:22.6554347Z -        response = client.get('/post/1/edit', follow_redirects=False)
2026-01-25T08:57:22.6555067Z +        response = client.get("/post/1/edit", follow_redirects=False)
2026-01-25T08:57:22.6555672Z          assert response.status_code == 302
2026-01-25T08:57:22.6556231Z -        assert '/auth/login' in response.headers['Location']
2026-01-25T08:57:22.6556872Z +        assert "/auth/login" in response.headers["Location"]
2026-01-25T08:57:22.6557378Z  
2026-01-25T08:57:22.6557796Z      def test_delete_post_requires_login(self, client):
2026-01-25T08:57:22.6558461Z          """Удаление поста требует аутентификации."""
2026-01-25T08:57:22.6559089Z -        response = client.post('/post/1/delete', follow_redirects=False)
2026-01-25T08:57:22.6559873Z +        response = client.post("/post/1/delete", follow_redirects=False)
2026-01-25T08:57:22.6560781Z          assert response.status_code == 302
2026-01-25T08:57:22.6561357Z -        assert '/auth/login' in response.headers['Location']
2026-01-25T08:57:22.6562031Z +        assert "/auth/login" in response.headers["Location"]
2026-01-25T08:57:22.6562600Z  
2026-01-25T08:57:22.6562850Z  
2026-01-25T08:57:22.6563342Z  class TestErrorHandlers:
2026-01-25T08:57:22.6563848Z      """Тесты обработчиков ошибок."""
2026-01-25T08:57:22.6564257Z  
2026-01-25T08:57:22.6564570Z      def test_404_error(self, client):
2026-01-25T08:57:22.6565194Z          """Страница 404 должна возвращать правильный статус."""
2026-01-25T08:57:22.6565757Z -        response = client.get('/nonexistent-page')
2026-01-25T08:57:22.6566324Z +        response = client.get("/nonexistent-page")
2026-01-25T08:57:22.6566856Z          assert response.status_code == 404
2026-01-25T08:57:22.6567298Z  
2026-01-25T08:57:22.6567635Z      def test_404_error_content(self, client):
2026-01-25T08:57:22.6568315Z          """Страница 404 должна содержать сообщение об ошибке."""
2026-01-25T08:57:22.6568983Z -        response = client.get('/nonexistent-page')
2026-01-25T08:57:22.6569179Z +        response = client.get("/nonexistent-page")
2026-01-25T08:57:22.6569369Z          if response.status_code == 404:
2026-01-25T08:57:22.6569662Z              # Проверяем наличие сообщения об ошибке
2026-01-25T08:57:22.6570006Z -            assert b'404' in response.data or b'ne naidena' in response.data.lower()
2026-01-25T08:57:22.6570353Z +            assert b"404" in response.data or b"ne naidena" in response.data.lower()
2026-01-25T08:57:22.6570479Z  
2026-01-25T08:57:22.6570684Z      def test_500_error_handling(self, client, app):
2026-01-25T08:57:22.6570912Z          """Обработка ошибки 500."""
2026-01-25T08:57:22.6571247Z          # Этот тест требует специальной настройки для вызова 500 ошибки
2026-01-25T08:57:22.6571534Z          # Пока просто проверяем, что приложение не падает
2026-01-25T08:57:22.6571701Z          with app.app_context():
2026-01-25T08:57:22.6571895Z -            response = client.get('/')
2026-01-25T08:57:22.6572047Z +            response = client.get("/")
2026-01-25T08:57:22.6572284Z              assert response.status_code in [200, 302, 404, 500]
2026-01-25T08:57:22.6572641Z -
2026-01-25T08:57:22.6572757Z -
2026-01-25T08:57:22.6572877Z  
2026-01-25T08:57:22.6573170Z  
2026-01-25T08:57:22.6573342Z  class TestDatabaseOperations:
2026-01-25T08:57:22.6573604Z      """Тесты операций с базой данных."""
2026-01-25T08:57:22.6573718Z  
2026-01-25T08:57:22.6573939Z      def test_database_initialization(self, app):
2026-01-25T08:57:22.6574187Z          """Инициализация базы данных."""
2026-01-25T08:57:22.6574352Z          with app.app_context():
2026-01-25T08:57:22.6574550Z              from app.db.db import init_db, get_db
2026-01-25T08:57:22.6574669Z -            
2026-01-25T08:57:22.6574782Z +
2026-01-25T08:57:22.6575070Z              # Инициализация должна работать без ошибок
2026-01-25T08:57:22.6575203Z              init_db()
2026-01-25T08:57:22.6575346Z -            
2026-01-25T08:57:22.6575463Z +
2026-01-25T08:57:22.6575717Z              # Подключение к БД должно работать
2026-01-25T08:57:22.6575868Z              db = get_db()
2026-01-25T08:57:22.6576042Z              assert db is not None
2026-01-25T08:57:22.6576159Z  
2026-01-25T08:57:22.6576353Z      def test_database_connection(self, app):
2026-01-25T08:57:22.6576579Z          """Подключение к базе данных."""
2026-01-25T08:57:22.6576728Z          with app.app_context():
2026-01-25T08:57:22.6576899Z              from app.db.db import get_db
2026-01-25T08:57:22.6577018Z -            
2026-01-25T08:57:22.6577130Z +
2026-01-25T08:57:22.6577274Z              db = get_db()
2026-01-25T08:57:22.6577432Z              assert db is not None
2026-01-25T08:57:22.6577547Z -            
2026-01-25T08:57:22.6577668Z +
2026-01-25T08:57:22.6577928Z              # Простая проверка выполнения запроса
2026-01-25T08:57:22.6578061Z              try:
2026-01-25T08:57:22.6578271Z -                result = db.execute('SELECT 1').fetchone()
2026-01-25T08:57:22.6578762Z +                result = db.execute("SELECT 1").fetchone()
2026-01-25T08:57:22.6578931Z                  assert result[0] == 1
2026-01-25T08:57:22.6579097Z              except Exception:
2026-01-25T08:57:22.6579411Z                  pass  # Таблиц может не существовать
2026-01-25T08:57:22.6579543Z -
2026-01-25T08:57:22.6579660Z  
2026-01-25T08:57:22.6579773Z  
2026-01-25T08:57:22.6579937Z  class TestConfiguration:
2026-01-25T08:57:22.6580167Z      """Тесты конфигурации приложения."""
2026-01-25T08:57:22.6580292Z  
2026-01-25T08:57:22.6580455Z      def test_development_config(self):
2026-01-25T08:57:22.6580687Z          """Конфигурация для разработки."""
2026-01-25T08:57:22.6580882Z          from config import DevelopmentConfig
2026-01-25T08:57:22.6581002Z -        
2026-01-25T08:57:22.6581119Z +
2026-01-25T08:57:22.6581320Z          assert DevelopmentConfig.DEBUG is True
2026-01-25T08:57:22.6581550Z -        assert hasattr(DevelopmentConfig, 'SECRET_KEY')
2026-01-25T08:57:22.6581823Z -        assert hasattr(DevelopmentConfig, 'DATABASE')
2026-01-25T08:57:22.6582073Z +        assert hasattr(DevelopmentConfig, "SECRET_KEY")
2026-01-25T08:57:22.6582310Z +        assert hasattr(DevelopmentConfig, "DATABASE")
2026-01-25T08:57:22.6582431Z  
2026-01-25T08:57:22.6582596Z      def test_production_config(self):
2026-01-25T08:57:22.6582835Z          """Конфигурация для продакшена."""
2026-01-25T08:57:22.6583228Z          from config import ProductionConfig
2026-01-25T08:57:22.6583364Z -        
2026-01-25T08:57:22.6583491Z +
2026-01-25T08:57:22.6583695Z          assert ProductionConfig.DEBUG is False
2026-01-25T08:57:22.6583919Z -        assert hasattr(ProductionConfig, 'SECRET_KEY')
2026-01-25T08:57:22.6584128Z -        assert hasattr(ProductionConfig, 'DATABASE')
2026-01-25T08:57:22.6584342Z +        assert hasattr(ProductionConfig, "SECRET_KEY")
2026-01-25T08:57:22.6584545Z +        assert hasattr(ProductionConfig, "DATABASE")
2026-01-25T08:57:22.6584683Z  
2026-01-25T08:57:22.6584839Z      def test_testing_config(self):
2026-01-25T08:57:22.6585098Z          """Конфигурация для тестирования."""
2026-01-25T08:57:22.6585272Z          from config import TestingConfig
2026-01-25T08:57:22.6585608Z -        
2026-01-25T08:57:22.6585724Z +
2026-01-25T08:57:22.6585917Z          assert TestingConfig.TESTING is True
2026-01-25T08:57:22.6586126Z -        assert TestingConfig.DATABASE == ':memory:'
2026-01-25T08:57:22.6586323Z +        assert TestingConfig.DATABASE == ":memory:"
2026-01-25T08:57:22.6586449Z  
2026-01-25T08:57:22.6586606Z      def test_config_values(self):
2026-01-25T08:57:22.6586870Z          """Проверка значений конфигурации."""
2026-01-25T08:57:22.6587032Z          from config import Config
2026-01-25T08:57:22.6587242Z -        
2026-01-25T08:57:22.6587423Z -        assert hasattr(Config, 'SECRET_KEY')
2026-01-25T08:57:22.6587585Z -        assert hasattr(Config, 'BASE_DIR')
2026-01-25T08:57:22.6587748Z -        assert hasattr(Config, 'DATABASE')
2026-01-25T08:57:22.6588150Z -        assert hasattr(Config, 'ADMIN_PASSWORD')
2026-01-25T08:57:22.6588271Z -        
2026-01-25T08:57:22.6588383Z +
2026-01-25T08:57:22.6588558Z +        assert hasattr(Config, "SECRET_KEY")
2026-01-25T08:57:22.6588733Z +        assert hasattr(Config, "BASE_DIR")
2026-01-25T08:57:22.6588894Z +        assert hasattr(Config, "DATABASE")
2026-01-25T08:57:22.6589087Z +        assert hasattr(Config, "ADMIN_PASSWORD")
2026-01-25T08:57:22.6589200Z +
2026-01-25T08:57:22.6589420Z          # Проверка пути к БД
2026-01-25T08:57:22.6589627Z -        assert 'flask_blog.sqlite' in Config.DATABASE
2026-01-25T08:57:22.6589825Z +        assert "flask_blog.sqlite" in Config.DATABASE
2026-01-25T08:57:22.7428284Z --- /home/runner/work/flask_blog/flask_blog/tests/test_validation_stubs.py	2026-01-25 08:57:06.654994+00:00
2026-01-25T08:57:22.7430457Z +++ /home/runner/work/flask_blog/flask_blog/tests/test_validation_stubs.py	2026-01-25 08:57:22.740389+00:00
2026-01-25T08:57:22.7454865Z would reformat /home/runner/work/flask_blog/flask_blog/tests/test_validation_stubs.py
2026-01-25T08:57:22.7455106Z @@ -3,130 +3,128 @@
2026-01-25T08:57:22.7455233Z  
2026-01-25T08:57:22.7455375Z  import pytest
2026-01-25T08:57:22.7455576Z  from flask import Flask
2026-01-25T08:57:22.7455695Z  
2026-01-25T08:57:22.7456065Z  from app.forms import Form, StringField, DataRequired, Length, EqualTo
2026-01-25T08:57:22.7456540Z +
2026-01-25T08:57:22.7457367Z  # TODO: Regexp будет реализован в будущем
2026-01-25T08:57:22.7457949Z  from app.forms.csrf import generate_csrf_token, validate_csrf_token
2026-01-25T08:57:22.7459410Z  
2026-01-25T08:57:22.7459715Z  
2026-01-25T08:57:22.7461148Z  @pytest.fixture
2026-01-25T08:57:22.7461577Z  def app():
2026-01-25T08:57:22.7461948Z      app = Flask(__name__)
2026-01-25T08:57:22.7463796Z -    app.config['SECRET_KEY'] = 'test-key-12345'
2026-01-25T08:57:22.7464545Z -    app.config['TESTING'] = False  # Включаем CSRF для тестов
2026-01-25T08:57:22.7465077Z +    app.config["SECRET_KEY"] = "test-key-12345"
2026-01-25T08:57:22.7467876Z +    app.config["TESTING"] = False  # Включаем CSRF для тестов
2026-01-25T08:57:22.7468033Z      return app
2026-01-25T08:57:22.7468164Z  
2026-01-25T08:57:22.7468752Z  
2026-01-25T08:57:22.7468910Z  class TestForm(Form):
2026-01-25T08:57:22.7469216Z      """Тестовая форма с валидаторами."""
2026-01-25T08:57:22.7469415Z -    name = StringField('Name', validators=[
2026-01-25T08:57:22.7469628Z -        DataRequired(message='Name required'),
2026-01-25T08:57:22.7469867Z -        Length(min=3, max=10, message='Invalid length'),
2026-01-25T08:57:22.7470407Z -        # TODO: Regexp(r'^[a-zA-Z]+$', message='Only letters') - будет реализован в будущем
2026-01-25T08:57:22.7470554Z -    ])
2026-01-25T08:57:22.7470775Z -    confirm = StringField('Confirm', validators=[
2026-01-25T08:57:22.7470961Z -        EqualTo('name', message='Must match')
2026-01-25T08:57:22.7471096Z -    ])
2026-01-25T08:57:22.7471217Z +
2026-01-25T08:57:22.7471375Z +    name = StringField(
2026-01-25T08:57:22.7471525Z +        "Name",
2026-01-25T08:57:22.7471677Z +        validators=[
2026-01-25T08:57:22.7471912Z +            DataRequired(message="Name required"),
2026-01-25T08:57:22.7472163Z +            Length(min=3, max=10, message="Invalid length"),
2026-01-25T08:57:22.7472709Z +            # TODO: Regexp(r'^[a-zA-Z]+$', message='Only letters') - будет реализован в будущем
2026-01-25T08:57:22.7472853Z +        ],
2026-01-25T08:57:22.7473221Z +    )
2026-01-25T08:57:22.7473634Z +    confirm = StringField("Confirm", validators=[EqualTo("name", message="Must match")])
2026-01-25T08:57:22.7473774Z  
2026-01-25T08:57:22.7473892Z  
2026-01-25T08:57:22.7474094Z  def test_all_validators_are_stubs():
2026-01-25T08:57:22.7474439Z      """Проверяем что все валидаторы - заглушки."""
2026-01-25T08:57:22.7474583Z      validators = [
2026-01-25T08:57:22.7474777Z          DataRequired(),
2026-01-25T08:57:22.7474947Z          Length(min=3, max=10),
2026-01-25T08:57:22.7475298Z          # TODO: Regexp(r'test'),  # будет реализован в будущем
2026-01-25T08:57:22.7475755Z -        EqualTo('field'),
2026-01-25T08:57:22.7475903Z +        EqualTo("field"),
2026-01-25T08:57:22.7476041Z      ]
2026-01-25T08:57:22.7476186Z -    
2026-01-25T08:57:22.7476443Z -    test_values = ['', None, 'test', 'a' * 1000, 'invalid!@#']
2026-01-25T08:57:22.7476586Z -    
2026-01-25T08:57:22.7476711Z +
2026-01-25T08:57:22.7476949Z +    test_values = ["", None, "test", "a" * 1000, "invalid!@#"]
2026-01-25T08:57:22.7477074Z +
2026-01-25T08:57:22.7477240Z      for validator in validators:
2026-01-25T08:57:22.7477397Z          for value in test_values:
2026-01-25T08:57:22.7477621Z -            if validator.__class__.__name__ == 'EqualTo':
2026-01-25T08:57:22.7477837Z +            if validator.__class__.__name__ == "EqualTo":
2026-01-25T08:57:22.7478025Z                  result = validator(value, None)
2026-01-25T08:57:22.7478160Z              else:
2026-01-25T08:57:22.7478322Z                  result = validator(value)
2026-01-25T08:57:22.7478449Z -            
2026-01-25T08:57:22.7478885Z -            assert result == (True, None), f"{validator.__class__.__name__}({value}) = {result}"
2026-01-25T08:57:22.7479016Z +
2026-01-25T08:57:22.7479183Z +            assert result == (
2026-01-25T08:57:22.7479315Z +                True,
2026-01-25T08:57:22.7479469Z +                None,
2026-01-25T08:57:22.7479774Z +            ), f"{validator.__class__.__name__}({value}) = {result}"
2026-01-25T08:57:22.7479949Z  
2026-01-25T08:57:22.7480073Z  
2026-01-25T08:57:22.7480293Z  def test_form_always_valid_with_stubs(app):
2026-01-25T08:57:22.7480686Z      """Форма с заглушками всегда валидна при правильном CSRF."""
2026-01-25T08:57:22.7480980Z -    with app.test_request_context(method='POST'):
2026-01-25T08:57:22.7481198Z +    with app.test_request_context(method="POST"):
2026-01-25T08:57:22.7481367Z          token = generate_csrf_token()
2026-01-25T08:57:22.7481518Z -        
2026-01-25T08:57:22.7481635Z +
2026-01-25T08:57:22.7481934Z          # Даже некорректные данные проходят валидацию
2026-01-25T08:57:22.7482110Z          invalid_data = {
2026-01-25T08:57:22.7482447Z -            'name': '',  # DataRequired error (но заглушка)
2026-01-25T08:57:22.7483293Z -            'confirm': 'different',  # EqualTo error (но заглушка)
2026-01-25T08:57:22.7483467Z -            'csrf_token': token
2026-01-25T08:57:22.7483815Z +            "name": "",  # DataRequired error (но заглушка)
2026-01-25T08:57:22.7484228Z +            "confirm": "different",  # EqualTo error (но заглушка)
2026-01-25T08:57:22.7484398Z +            "csrf_token": token,
2026-01-25T08:57:22.7484523Z          }
2026-01-25T08:57:22.7484653Z -        
2026-01-25T08:57:22.7484776Z +
2026-01-25T08:57:22.7484944Z          form = TestForm(invalid_data)
2026-01-25T08:57:22.7485116Z          assert form.validate() is True
2026-01-25T08:57:22.7485507Z          assert not form.errors  # Заглушки не генерируют ошибки
2026-01-25T08:57:22.7485629Z  
2026-01-25T08:57:22.7485755Z  
2026-01-25T08:57:22.7485971Z  def test_form_still_requires_csrf(app):
2026-01-25T08:57:22.7486296Z      """Форма всё ещё требует валидный CSRF токен."""
2026-01-25T08:57:22.7486532Z -    with app.test_request_context(method='POST'):
2026-01-25T08:57:22.7486763Z +    with app.test_request_context(method="POST"):
2026-01-25T08:57:22.7487009Z          # Форма без CSRF токена
2026-01-25T08:57:22.7487141Z -        data = {
2026-01-25T08:57:22.7487286Z -            'name': 'valid',
2026-01-25T08:57:22.7487433Z -            'confirm': 'valid'
2026-01-25T08:57:22.7487555Z -        }
2026-01-25T08:57:22.7487675Z -        
2026-01-25T08:57:22.7487884Z +        data = {"name": "valid", "confirm": "valid"}
2026-01-25T08:57:22.7488023Z +
2026-01-25T08:57:22.7488190Z          form = TestForm(data)
2026-01-25T08:57:22.7488554Z          assert form.validate() is False  # CSRF ошибка
2026-01-25T08:57:22.7488965Z -        assert 'csrf' in form.errors  # CSRF ошибка в списке ошибок
2026-01-25T08:57:22.7489102Z -
2026-01-25T08:57:22.7489219Z -
2026-01-25T08:57:22.7489616Z +        assert "csrf" in form.errors  # CSRF ошибка в списке ошибок
2026-01-25T08:57:22.7490044Z  
2026-01-25T08:57:22.7490169Z  
2026-01-25T08:57:22.7490410Z  def test_form_with_valid_csrf_and_invalid_data(app):
2026-01-25T08:57:22.7490910Z      """Тест: валидный CSRF + невалидные данные = форма валидна (из-за заглушек)."""
2026-01-25T08:57:22.7491136Z -    with app.test_request_context(method='POST'):
2026-01-25T08:57:22.7491339Z +    with app.test_request_context(method="POST"):
2026-01-25T08:57:22.7491510Z          token = generate_csrf_token()
2026-01-25T08:57:22.7491630Z -        
2026-01-25T08:57:22.7491755Z +
2026-01-25T08:57:22.7492088Z          # Данные которые должны были бы вызвать ошибки валидации
2026-01-25T08:57:22.7492223Z          data = {
2026-01-25T08:57:22.7492411Z -            'name': '',  # DataRequired error
2026-01-25T08:57:22.7492598Z -            'confirm': 'mismatch',  # EqualTo error
2026-01-25T08:57:22.7492752Z -            'csrf_token': token
2026-01-25T08:57:22.7493139Z +            "name": "",  # DataRequired error
2026-01-25T08:57:22.7493372Z +            "confirm": "mismatch",  # EqualTo error
2026-01-25T08:57:22.7493525Z +            "csrf_token": token,
2026-01-25T08:57:22.7493680Z          }
2026-01-25T08:57:22.7493803Z -        
2026-01-25T08:57:22.7493920Z +
2026-01-25T08:57:22.7494081Z          form = TestForm(data)
2026-01-25T08:57:22.7494203Z -        
2026-01-25T08:57:22.7494332Z +
2026-01-25T08:57:22.7494595Z          # С заглушками форма валидна
2026-01-25T08:57:22.7494780Z          assert form.validate() is True
2026-01-25T08:57:22.7494939Z          assert not form.errors
2026-01-25T08:57:22.7495064Z -        
2026-01-25T08:57:22.7495182Z +
2026-01-25T08:57:22.7495443Z          # Но данные поля заполняются
2026-01-25T08:57:22.7495602Z -        assert form.name.data == ''
2026-01-25T08:57:22.7495817Z -        assert form.confirm.data == 'mismatch'
2026-01-25T08:57:22.7495992Z +        assert form.name.data == ""
2026-01-25T08:57:22.7496193Z +        assert form.confirm.data == "mismatch"
2026-01-25T08:57:22.7496345Z  
2026-01-25T08:57:22.7496488Z  
2026-01-25T08:57:22.7496695Z  def test_form_field_still_populates_data(app):
2026-01-25T08:57:22.7496996Z      """Поля формы всё ещё заполняются данными."""
2026-01-25T08:57:22.7497443Z      with app.test_request_context():
2026-01-25T08:57:22.7497580Z -        data = {
2026-01-25T08:57:22.7497739Z -            'name': 'test_name',
2026-01-25T08:57:22.7497888Z -            'confirm': 'test_name'
2026-01-25T08:57:22.7498013Z -        }
2026-01-25T08:57:22.7498139Z -        
2026-01-25T08:57:22.7498368Z +        data = {"name": "test_name", "confirm": "test_name"}
2026-01-25T08:57:22.7498485Z +
2026-01-25T08:57:22.7498644Z          form = TestForm(data)
2026-01-25T08:57:22.7498822Z -        assert form.name.data == 'test_name'
2026-01-25T08:57:22.7499024Z -        assert form.confirm.data == 'test_name'
2026-01-25T08:57:22.7499199Z +        assert form.name.data == "test_name"
2026-01-25T08:57:22.7499403Z +        assert form.confirm.data == "test_name"
2026-01-25T08:57:22.7499550Z  
2026-01-25T08:57:22.7499668Z  
2026-01-25T08:57:22.7499867Z  def test_form_error_structure_unchanged(app):
2026-01-25T08:57:22.7500162Z      """Структура ошибок формы не изменилась."""
2026-01-25T08:57:22.7500390Z -    with app.test_request_context(method='POST'):
2026-01-25T08:57:22.7500591Z +    with app.test_request_context(method="POST"):
2026-01-25T08:57:22.7500810Z          # Форма без CSRF
2026-01-25T08:57:22.7500962Z          form = TestForm({})
2026-01-25T08:57:22.7501093Z -        
2026-01-25T08:57:22.7501209Z +
2026-01-25T08:57:22.7501474Z          # Ошибки должны быть в том же формате
2026-01-25T08:57:22.7501823Z          errors = form.errors
2026-01-25T08:57:22.7502025Z          assert isinstance(errors, dict)
2026-01-25T08:57:22.7502501Z          # TODO: С заглушками CSRF ошибки может не быть если WTF_CSRF_ENABLED=False
2026-01-25T08:57:22.7503273Z          # Когда будет полная реализация, проверить наличие 'csrf' в errors
2026-01-25T08:57:22.7540684Z --- /home/runner/work/flask_blog/flask_blog/tests/test_security.py	2026-01-25 08:57:06.654994+00:00
2026-01-25T08:57:22.7541468Z +++ /home/runner/work/flask_blog/flask_blog/tests/test_security.py	2026-01-25 08:57:22.751760+00:00
2026-01-25T08:57:22.7541676Z @@ -24,60 +24,53 @@
2026-01-25T08:57:22.7541913Z              self.assert_csrf_validation(token, True)
2026-01-25T08:57:22.7542035Z  
2026-01-25T08:57:22.7542263Z      def test_csrf_validation_wrong_tokens(self, app):
2026-01-25T08:57:22.7542708Z          """Валидация неправильных CSRF токенов."""
2026-01-25T08:57:22.7543108Z          with app.test_request_context():
2026-01-25T08:57:22.7543447Z -            wrong_tokens = ['wrong_token', '', None, 'invalid', '123']
2026-01-25T08:57:22.7543716Z +            wrong_tokens = ["wrong_token", "", None, "invalid", "123"]
2026-01-25T08:57:22.7543877Z              for token in wrong_tokens:
2026-01-25T08:57:22.7544102Z                  self.assert_csrf_validation(token, False)
2026-01-25T08:57:22.7544222Z  
2026-01-25T08:57:22.7544528Z      def test_csrf_in_registration_form(self, security_client):
2026-01-25T08:57:22.7544814Z          """CSRF защита при регистрации."""
2026-01-25T08:57:22.7545105Z          # Правильный токен должен работать всегда
2026-01-25T08:57:22.7545376Z          form_data = FormTestHelper.create_form_data_with_csrf(
2026-01-25T08:57:22.7545537Z -            security_client,
2026-01-25T08:57:22.7545703Z -            username='csrf_test_user1',
2026-01-25T08:57:22.7545879Z -            password='testpass123'
2026-01-25T08:57:22.7546000Z -        )
2026-01-25T08:57:22.7546330Z -        response = security_client.post('/auth/register', data=form_data)
2026-01-25T08:57:22.7549109Z +            security_client, username="csrf_test_user1", ***
2026-01-25T08:57:22.7549310Z +        )
2026-01-25T08:57:22.7549684Z +        response = security_client.post("/auth/register", data=form_data)
2026-01-25T08:57:22.7549927Z          self.assert_success_response(response)
2026-01-25T08:57:22.7550050Z  
2026-01-25T08:57:22.7550477Z          # Неправильный токен должен блокироваться
2026-01-25T08:57:22.7550634Z          wrong_form_data = {
2026-01-25T08:57:22.7550817Z -            'username': 'csrf_test_user2',
2026-01-25T08:57:22.7551587Z -            'password': 'testpass123',
2026-01-25T08:57:22.7551752Z -            'csrf_token': 'wrong_token'
2026-01-25T08:57:22.7551916Z +            "username": "csrf_test_user2",
2026-01-25T08:57:22.7552091Z +            "password": "testpass123",
2026-01-25T08:57:22.7552252Z +            "csrf_token": "wrong_token",
2026-01-25T08:57:22.7552382Z          }
2026-01-25T08:57:22.7552765Z -        response = security_client.post('/auth/register', data=wrong_form_data)
2026-01-25T08:57:22.7553476Z +        response = security_client.post("/auth/register", data=wrong_form_data)
2026-01-25T08:57:22.7553718Z          self.assert_form_validation_error(response)
2026-01-25T08:57:22.7553840Z  
2026-01-25T08:57:22.7554142Z          # Отсутствие токена должно блокироваться
2026-01-25T08:57:22.7554328Z -        no_token_data = {
2026-01-25T08:57:22.7554498Z -            'username': 'csrf_test_user3',
2026-01-25T08:57:22.7554691Z -            'password': 'testpass123'
2026-01-25T08:57:22.7554826Z -        }
2026-01-25T08:57:22.7555180Z -        response = security_client.post('/auth/register', data=no_token_data)
2026-01-25T08:57:22.7555540Z +        no_token_data = {"username": "csrf_test_user3", "password": "testpass123"}
2026-01-25T08:57:22.7555877Z +        response = security_client.post("/auth/register", data=no_token_data)
2026-01-25T08:57:22.7556100Z          self.assert_form_validation_error(response)
2026-01-25T08:57:22.7556225Z  
2026-01-25T08:57:22.7556459Z      def test_csrf_in_login_form(self, security_client):
2026-01-25T08:57:22.7556724Z          """CSRF защита при входе."""
2026-01-25T08:57:22.7556999Z          # Правильный токен должен работать всегда
2026-01-25T08:57:22.7557268Z          form_data = FormTestHelper.create_form_data_with_csrf(
2026-01-25T08:57:22.7557434Z -            security_client,
2026-01-25T08:57:22.7558188Z would reformat /home/runner/work/flask_blog/flask_blog/tests/test_security.py
2026-01-25T08:57:22.7558362Z -            username='test_user#1234',
2026-01-25T08:57:22.7558559Z -            password='test_pass'
2026-01-25T08:57:22.7558677Z -        )
2026-01-25T08:57:22.7558967Z -        response = security_client.post('/auth/login', data=form_data)
2026-01-25T08:57:22.7566518Z +            security_client, username="test_user#1234", ***
2026-01-25T08:57:22.7566726Z +        )
2026-01-25T08:57:22.7567057Z +        response = security_client.post("/auth/login", data=form_data)
2026-01-25T08:57:22.7567307Z          self.assert_success_response(response)
2026-01-25T08:57:22.7567413Z  
2026-01-25T08:57:22.7567693Z          # Неправильный токен должен блокироваться
2026-01-25T08:57:22.7567830Z          wrong_form_data = {
2026-01-25T08:57:22.7568030Z -            'username': 'test_user#1234',
2026-01-25T08:57:22.7568190Z -            'password': 'test_pass',
2026-01-25T08:57:22.7568347Z -            'csrf_token': 'wrong_token'
2026-01-25T08:57:22.7568507Z +            "username": "test_user#1234",
2026-01-25T08:57:22.7568638Z +            "password": "test_pass",
2026-01-25T08:57:22.7568777Z +            "csrf_token": "wrong_token",
2026-01-25T08:57:22.7568885Z          }
2026-01-25T08:57:22.7569201Z -        response = security_client.post('/auth/login', data=wrong_form_data)
2026-01-25T08:57:22.7569547Z +        response = security_client.post("/auth/login", data=wrong_form_data)
2026-01-25T08:57:22.7569760Z          self.assert_form_validation_error(response)
2026-01-25T08:57:22.7569864Z  
2026-01-25T08:57:22.7570184Z      def test_csrf_in_post_operations(self, security_client, security_auth):
2026-01-25T08:57:22.7570412Z          """CSRF защита в операциях с постами."""
2026-01-25T08:57:22.7570613Z          # Вход с правильным токеном
2026-01-25T08:57:22.7570743Z @@ -85,221 +78,221 @@
2026-01-25T08:57:22.7570931Z          assert login_response.status_code == 302
2026-01-25T08:57:22.7571054Z  
2026-01-25T08:57:22.7571390Z          # Правильный токен должен работать для создания поста
2026-01-25T08:57:22.7571699Z          form_data = FormTestHelper.create_form_data_with_csrf(
2026-01-25T08:57:22.7572199Z              security_client,
2026-01-25T08:57:22.7572360Z -            title='CSRF Test Post',
2026-01-25T08:57:22.7572650Z -            content='This is a test post with enough content length'
2026-01-25T08:57:22.7572783Z -        )
2026-01-25T08:57:22.7583582Z -        response = security_client.post('/post/create', data=form_data)
2026-01-25T08:57:22.7583731Z +            title="CSRF Test Post",
2026-01-25T08:57:22.7583914Z +            content="This is a test post with enough content length",
2026-01-25T08:57:22.7583990Z +        )
2026-01-25T08:57:22.7584174Z +        response = security_client.post("/post/create", data=form_data)
2026-01-25T08:57:22.7584295Z          self.assert_success_response(response)
2026-01-25T08:57:22.7584366Z  
2026-01-25T08:57:22.7584799Z          # Неправильный токен должен блокироваться
2026-01-25T08:57:22.7584892Z          wrong_form_data = {
2026-01-25T08:57:22.7584989Z -            'title': 'CSRF Test Post 2',
2026-01-25T08:57:22.7585116Z -            'content': 'This is another test post',
2026-01-25T08:57:22.7585204Z -            'csrf_token': 'wrong_token'
2026-01-25T08:57:22.7585289Z +            "title": "CSRF Test Post 2",
2026-01-25T08:57:22.7585403Z +            "content": "This is another test post",
2026-01-25T08:57:22.7585485Z +            "csrf_token": "wrong_token",
2026-01-25T08:57:22.7585560Z          }
2026-01-25T08:57:22.7585751Z -        response = security_client.post('/post/create', data=wrong_form_data)
2026-01-25T08:57:22.7585948Z +        response = security_client.post("/post/create", data=wrong_form_data)
2026-01-25T08:57:22.7586077Z          self.assert_form_validation_error(response)
2026-01-25T08:57:22.7586144Z  
2026-01-25T08:57:22.7586209Z  
2026-01-25T08:57:22.7586327Z  class TestPasswordSecurity(BaseTestCase):
2026-01-25T08:57:22.7586474Z      """Тесты безопасности паролей."""
2026-01-25T08:57:22.7586540Z  
2026-01-25T08:57:22.7586660Z      def test_password_hashing_uniqueness(self):
2026-01-25T08:57:22.7586815Z          """Разные пароли должны давать разные хэши."""
2026-01-25T08:57:22.7586922Z          from app.auth import hash_password
2026-01-25T08:57:22.7586994Z -        
2026-01-25T08:57:22.7587093Z -        password1 = 'secure_password_123'
2026-01-25T08:57:22.7587192Z -        password2 = 'different_password'
2026-01-25T08:57:22.7587257Z -        
2026-01-25T08:57:22.7587322Z +
2026-01-25T08:57:22.7587417Z +        password1 = "secure_password_123"
2026-01-25T08:57:22.7587505Z +        password2 = "different_password"
2026-01-25T08:57:22.7587569Z +
2026-01-25T08:57:22.7587691Z          hashed1, salt1 = hash_password(password1)
2026-01-25T08:57:22.7587794Z          hashed2, salt2 = hash_password(password2)
2026-01-25T08:57:22.7587858Z -        
2026-01-25T08:57:22.7587927Z +
2026-01-25T08:57:22.7588024Z          assert hashed1 != hashed2
2026-01-25T08:57:22.7588110Z          assert salt1 != salt2
2026-01-25T08:57:22.7588172Z  
2026-01-25T08:57:22.7588285Z      def test_password_verification_correct(self):
2026-01-25T08:57:22.7588552Z          """Проверка правильного пароля."""
2026-01-25T08:57:22.7588695Z          from app.auth import hash_password, verify_password
2026-01-25T08:57:22.7588779Z -        
2026-01-25T08:57:22.7588878Z -        password = 'secure_password_123'
2026-01-25T08:57:22.7588941Z +
2026-01-25T08:57:22.7589088Z +        password = "secure_password_123"
2026-01-25T08:57:22.7589223Z          hashed, salt = hash_password(password)
2026-01-25T08:57:22.7589287Z -        
2026-01-25T08:57:22.7589355Z +
2026-01-25T08:57:22.7589500Z          assert verify_password(hashed, password, salt) is True
2026-01-25T08:57:22.7589562Z  
2026-01-25T08:57:22.7589701Z      def test_password_verification_incorrect(self):
2026-01-25T08:57:22.7589832Z          """Проверка неправильного пароля."""
2026-01-25T08:57:22.7589996Z          from app.auth import hash_password, verify_password
2026-01-25T08:57:22.7590067Z -        
2026-01-25T08:57:22.7590157Z -        password = 'secure_password_123'
2026-01-25T08:57:22.7590229Z +
2026-01-25T08:57:22.7590323Z +        password = "secure_password_123"
2026-01-25T08:57:22.7590423Z          hashed, salt = hash_password(password)
2026-01-25T08:57:22.7590494Z -        
2026-01-25T08:57:22.7590661Z -        assert verify_password(hashed, 'wrong_password', salt) is False
2026-01-25T08:57:22.7590783Z -        assert verify_password(hashed, '', salt) is False
2026-01-25T08:57:22.7590852Z +
2026-01-25T08:57:22.7591012Z +        assert verify_password(hashed, "wrong_password", salt) is False
2026-01-25T08:57:22.7591129Z +        assert verify_password(hashed, "", salt) is False
2026-01-25T08:57:22.7591258Z          assert verify_password(hashed, None, salt) is False
2026-01-25T08:57:22.7591322Z  
2026-01-25T08:57:22.7591431Z      def test_password_hash_with_same_salt(self):
2026-01-25T08:57:22.7591723Z          """Одинаковые пароли с одинаковой солью дают одинаковые хэши."""
2026-01-25T08:57:22.7591855Z          from app.auth import hash_password
2026-01-25T08:57:22.7591935Z -        
2026-01-25T08:57:22.7592029Z -        password = 'test_password'
2026-01-25T08:57:22.7592125Z -        custom_salt = b'1234567890123456'
2026-01-25T08:57:22.7592207Z -        
2026-01-25T08:57:22.7592270Z +
2026-01-25T08:57:22.7592355Z +        password = "test_password"
2026-01-25T08:57:22.7592445Z +        custom_salt = b"1234567890123456"
2026-01-25T08:57:22.7592509Z +
2026-01-25T08:57:22.7592636Z          hashed1, _ = hash_password(password, custom_salt)
2026-01-25T08:57:22.7592764Z          hashed2, _ = hash_password(password, custom_salt)
2026-01-25T08:57:22.7592830Z -        
2026-01-25T08:57:22.7593233Z +
2026-01-25T08:57:22.7593376Z          assert hashed1 == hashed2
2026-01-25T08:57:22.7593495Z  
2026-01-25T08:57:22.7593657Z      def test_salt_generation(self):
2026-01-25T08:57:22.7593834Z          """Генерация соли должна быть уникальной."""
2026-01-25T08:57:22.7593949Z          from app.auth import hash_password
2026-01-25T08:57:22.7594024Z -        
2026-01-25T08:57:22.7594106Z +
2026-01-25T08:57:22.7594176Z          salts = []
2026-01-25T08:57:22.7594273Z          for _ in range(10):
2026-01-25T08:57:22.7594382Z -            _, salt = hash_password('test_password')
2026-01-25T08:57:22.7594508Z +            _, salt = hash_password("test_password")
2026-01-25T08:57:22.7594599Z              assert salt is not None
2026-01-25T08:57:22.7594684Z              assert len(salt) == 16
2026-01-25T08:57:22.7594775Z              salts.append(salt)
2026-01-25T08:57:22.7594840Z -        
2026-01-25T08:57:22.7594904Z +
2026-01-25T08:57:22.7595039Z          # Все соли должны быть уникальными
2026-01-25T08:57:22.7595134Z          assert len(set(salts)) == len(salts)
2026-01-25T08:57:22.7595198Z  
2026-01-25T08:57:22.7595266Z  
2026-01-25T08:57:22.7595407Z  class TestFormSecurity(BaseTestCase, FormTestHelper):
2026-01-25T08:57:22.7595533Z      """Тесты безопасности форм."""
2026-01-25T08:57:22.7595608Z  
2026-01-25T08:57:22.7595685Z      @pytest.fixture
2026-01-25T08:57:22.7595759Z      def app(self):
2026-01-25T08:57:22.7596016Z          app = Flask(__name__)
2026-01-25T08:57:22.7596135Z -        app.config['SECRET_KEY'] = 'test-key-12345'
2026-01-25T08:57:22.7596233Z -        app.config['TESTING'] = True
2026-01-25T08:57:22.7596349Z -        app.config['WTF_CSRF_ENABLED'] = False
2026-01-25T08:57:22.7596456Z +        app.config["SECRET_KEY"] = "test-key-12345"
2026-01-25T08:57:22.7596549Z +        app.config["TESTING"] = True
2026-01-25T08:57:22.7596645Z +        app.config["WTF_CSRF_ENABLED"] = False
2026-01-25T08:57:22.7596760Z          return app
2026-01-25T08:57:22.7596865Z  
2026-01-25T08:57:22.7596948Z      class TestForm(Form):
2026-01-25T08:57:22.7597084Z          """Тестовая форма с валидаторами."""
2026-01-25T08:57:22.7597196Z -        name = StringField('Name', validators=[
2026-01-25T08:57:22.7597315Z -            DataRequired(message='Name required'),
2026-01-25T08:57:22.7597472Z -            Length(min=3, max=10, message='Invalid length'),
2026-01-25T08:57:22.7597569Z -        ])
2026-01-25T08:57:22.7597695Z -        confirm = StringField('Confirm', validators=[
2026-01-25T08:57:22.7597807Z -            EqualTo('name', message='Must match')
2026-01-25T08:57:22.7597872Z -        ])
2026-01-25T08:57:22.7597952Z +
2026-01-25T08:57:22.7598039Z +        name = StringField(
2026-01-25T08:57:22.7598135Z +            "Name",
2026-01-25T08:57:22.7598212Z +            validators=[
2026-01-25T08:57:22.7598357Z +                DataRequired(message="Name required"),
2026-01-25T08:57:22.7598482Z +                Length(min=3, max=10, message="Invalid length"),
2026-01-25T08:57:22.7598565Z +            ],
2026-01-25T08:57:22.7598638Z +        )
2026-01-25T08:57:22.7598718Z +        confirm = StringField(
2026-01-25T08:57:22.7598890Z +            "Confirm", validators=[EqualTo("name", message="Must match")]
2026-01-25T08:57:22.7599090Z +        )
2026-01-25T08:57:22.7599153Z  
2026-01-25T08:57:22.7599268Z      def test_form_without_csrf_token(self, app):
2026-01-25T08:57:22.7599501Z          """Форма без CSRF токена должна быть невалидной когда CSRF включен."""
2026-01-25T08:57:22.7599602Z          with app.test_request_context():
2026-01-25T08:57:22.7599739Z              # Пропускаем тест если CSRF отключен
2026-01-25T08:57:22.7599886Z -            if not app.config.get('WTF_CSRF_ENABLED', False):
2026-01-25T08:57:22.7600030Z +            if not app.config.get("WTF_CSRF_ENABLED", False):
2026-01-25T08:57:22.7600103Z                  return
2026-01-25T08:57:22.7600170Z -                
2026-01-25T08:57:22.7600238Z +
2026-01-25T08:57:22.7600307Z              data = {
2026-01-25T08:57:22.7600385Z -                'name': 'valid',
2026-01-25T08:57:22.7600470Z -                'confirm': 'valid',
2026-01-25T08:57:22.7600624Z -                'csrf_token': None  # Явно передаем None
2026-01-25T08:57:22.7600712Z +                "name": "valid",
2026-01-25T08:57:22.7600814Z +                "confirm": "valid",
2026-01-25T08:57:22.7600966Z +                "csrf_token": None,  # Явно передаем None
2026-01-25T08:57:22.7601049Z              }
2026-01-25T08:57:22.7601115Z -            
2026-01-25T08:57:22.7601178Z +
2026-01-25T08:57:22.7601271Z              form = self.TestForm(data)
2026-01-25T08:57:22.7601366Z              assert form.validate() is False
2026-01-25T08:57:22.7613402Z -            assert 'csrf' in form.errors
2026-01-25T08:57:22.7613634Z +            assert "csrf" in form.errors
2026-01-25T08:57:22.7613761Z  
2026-01-25T08:57:22.7613958Z      def test_form_with_valid_csrf_token(self, app):
2026-01-25T08:57:22.7614200Z          """Форма с валидным CSRF токеном должна быть валидной."""
2026-01-25T08:57:22.7614368Z          with app.test_request_context():
2026-01-25T08:57:22.7614493Z              token = generate_csrf_token()
2026-01-25T08:57:22.7614585Z -            data = {
2026-01-25T08:57:22.7614669Z -                'name': 'valid',
2026-01-25T08:57:22.7614779Z -                'confirm': 'valid',
2026-01-25T08:57:22.7614870Z -                'csrf_token': token
2026-01-25T08:57:22.7614946Z -            }
2026-01-25T08:57:22.7615234Z -            
2026-01-25T08:57:22.7615424Z +            data = {"name": "valid", "confirm": "valid", "csrf_token": token}
2026-01-25T08:57:22.7615499Z +
2026-01-25T08:57:22.7615602Z              form = self.TestForm(data)
2026-01-25T08:57:22.7615812Z              # С заглушками валидаторов форма всегда валидна при правильном CSRF
2026-01-25T08:57:22.7615917Z              assert form.validate() is True
2026-01-25T08:57:22.7616006Z              assert not form.errors
2026-01-25T08:57:22.7616072Z  
2026-01-25T08:57:22.7616216Z      def test_form_field_structure_unchanged(self, app):
2026-01-25T08:57:22.7616369Z          """Структура полей формы не изменилась."""
2026-01-25T08:57:22.7616474Z          with app.test_request_context():
2026-01-25T08:57:22.7616564Z              form = self.TestForm({})
2026-01-25T08:57:22.7616650Z -            
2026-01-25T08:57:22.7616722Z +
2026-01-25T08:57:22.7616841Z              # Проверяем наличие полей
2026-01-25T08:57:22.7616992Z -            self.assert_form_fields_exist(form, 'name', 'confirm')
2026-01-25T08:57:22.7617083Z -            
2026-01-25T08:57:22.7617218Z +            self.assert_form_fields_exist(form, "name", "confirm")
2026-01-25T08:57:22.7617284Z +
2026-01-25T08:57:22.7617407Z              # Проверяем типы полей
2026-01-25T08:57:22.7617510Z -            assert hasattr(form.name, 'data')
2026-01-25T08:57:22.7617617Z -            assert hasattr(form.confirm, 'data')
2026-01-25T08:57:22.7617711Z +            assert hasattr(form.name, "data")
2026-01-25T08:57:22.7617808Z +            assert hasattr(form.confirm, "data")
2026-01-25T08:57:22.7617878Z  
2026-01-25T08:57:22.7617943Z  
2026-01-25T08:57:22.7618048Z  class TestSessionSecurity(BaseTestCase):
2026-01-25T08:57:22.7618173Z      """Тесты безопасности сессий."""
2026-01-25T08:57:22.7618241Z  
2026-01-25T08:57:22.7618569Z      def test_session_cleared_on_logout(self, client, auth):
2026-01-25T08:57:22.7618717Z          """Выход должен очищать сессию."""
2026-01-25T08:57:22.7618819Z          # Вход
2026-01-25T08:57:22.7618905Z          auth.login()
2026-01-25T08:57:22.7618972Z -        
2026-01-25T08:57:22.7619038Z +
2026-01-25T08:57:22.7619187Z          # Проверяем, что сессия установлена
2026-01-25T08:57:22.7619300Z          with client.session_transaction() as sess:
2026-01-25T08:57:22.7619384Z -            assert 'user_id' in sess
2026-01-25T08:57:22.7619492Z -            original_user_id = sess['user_id']
2026-01-25T08:57:22.7619558Z -        
2026-01-25T08:57:22.7619642Z +            assert "user_id" in sess
2026-01-25T08:57:22.7619783Z +            original_user_id = sess["user_id"]
2026-01-25T08:57:22.7619928Z +
2026-01-25T08:57:22.7620025Z          # Выход
2026-01-25T08:57:22.7620113Z          auth.logout()
2026-01-25T08:57:22.7620179Z -        
2026-01-25T08:57:22.7620262Z +
2026-01-25T08:57:22.7620391Z          # Проверяем, что сессия очищена
2026-01-25T08:57:22.7620498Z          with client.session_transaction() as sess:
2026-01-25T08:57:22.7620689Z -            assert 'user_id' not in sess or sess.get('user_id') != original_user_id
2026-01-25T08:57:22.7620872Z +            assert "user_id" not in sess or sess.get("user_id") != original_user_id
2026-01-25T08:57:22.7620938Z  
2026-01-25T08:57:22.7621120Z      def test_session_persistence_during_requests(self, client, auth):
2026-01-25T08:57:22.7621276Z          """Сессия должна сохраняться между запросами."""
2026-01-25T08:57:22.7621485Z          auth.login()
2026-01-25T08:57:22.7621559Z -        
2026-01-25T08:57:22.7621653Z +
2026-01-25T08:57:22.7621781Z          # Делаем несколько запросов
2026-01-25T08:57:22.7621922Z          for _ in range(3):
2026-01-25T08:57:22.7622053Z -            response = client.get('/')
2026-01-25T08:57:22.7622160Z +            response = client.get("/")
2026-01-25T08:57:22.7622269Z              self.assert_success_response(response)
2026-01-25T08:57:22.7622348Z -            
2026-01-25T08:57:22.7622420Z +
2026-01-25T08:57:22.7622597Z              # Проверяем, что сессия всё ещё активна
2026-01-25T08:57:22.7622812Z              with client.session_transaction() as sess:
2026-01-25T08:57:22.7623197Z -                assert 'user_id' in sess
2026-01-25T08:57:22.7623303Z +                assert "user_id" in sess
2026-01-25T08:57:22.7623380Z  
2026-01-25T08:57:22.7623469Z  
2026-01-25T08:57:22.7623649Z  class TestUsernameDiscriminatorSecurity(BaseTestCase):
2026-01-25T08:57:22.7623842Z      """Тесты безопасности системы дискриминаторов."""
2026-01-25T08:57:22.7623909Z  
2026-01-25T08:57:22.7624082Z      def test_discriminator_uniqueness_for_same_username(self, app):
2026-01-25T08:57:22.7624313Z          """Для одного username должны генерироваться разные дискриминаторы."""
2026-01-25T08:57:22.7624445Z          with app.app_context():
2026-01-25T08:57:22.7624593Z              from app.auth.utils import generate_discriminator
2026-01-25T08:57:22.7624705Z              from app.db.db import get_db
2026-01-25T08:57:22.7624774Z -            
2026-01-25T08:57:22.7624845Z +
2026-01-25T08:57:22.7624924Z              db = get_db()
2026-01-25T08:57:22.7625003Z -            
2026-01-25T08:57:22.7625075Z +
2026-01-25T08:57:22.7625159Z              discriminators = []
2026-01-25T08:57:22.7625239Z              for _ in range(5):
2026-01-25T08:57:22.7625374Z -                disc = generate_discriminator(db, 'testuser')
2026-01-25T08:57:22.7625497Z +                disc = generate_discriminator(db, "testuser")
2026-01-25T08:57:22.7625584Z                  assert disc is not None
2026-01-25T08:57:22.7625680Z                  assert 1 <= disc <= 9999
2026-01-25T08:57:22.7625780Z                  discriminators.append(disc)
2026-01-25T08:57:22.7625859Z -            
2026-01-25T08:57:22.7625924Z +
2026-01-25T08:57:22.7626078Z              # Все дискриминаторы должны быть уникальными
2026-01-25T08:57:22.7626234Z              assert len(set(discriminators)) == len(discriminators)
2026-01-25T08:57:22.7626426Z  
2026-01-25T08:57:22.7626606Z      def test_different_usernames_independent_discriminators(self, app):
2026-01-25T08:57:22.7626860Z          """Разные usernames должны иметь независимые наборы дискриминаторов."""
2026-01-25T08:57:22.7626952Z          with app.app_context():
2026-01-25T08:57:22.7627082Z              from app.auth.utils import generate_discriminator
2026-01-25T08:57:22.7627180Z              from app.db.db import get_db
2026-01-25T08:57:22.7627246Z -            
2026-01-25T08:57:22.7627318Z +
2026-01-25T08:57:22.7627396Z              db = get_db()
2026-01-25T08:57:22.7627463Z -            
2026-01-25T08:57:22.7627533Z +
2026-01-25T08:57:22.7627688Z              # Генерируем дискриминаторы для разных имён
2026-01-25T08:57:22.7627802Z -            disc1 = generate_discriminator(db, 'alice')
2026-01-25T08:57:22.7627921Z -            disc2 = generate_discriminator(db, 'bob')
2026-01-25T08:57:22.7627989Z -            
2026-01-25T08:57:22.7628113Z +            disc1 = generate_discriminator(db, "alice")
2026-01-25T08:57:22.7628223Z +            disc2 = generate_discriminator(db, "bob")
2026-01-25T08:57:22.7628301Z +
2026-01-25T08:57:22.7628403Z              assert disc1 is not None
2026-01-25T08:57:22.7628493Z              assert disc2 is not None
2026-01-25T08:57:22.7628577Z              assert 1 <= disc1 <= 9999
2026-01-25T08:57:22.7628664Z              assert 1 <= disc2 <= 9999
2026-01-25T08:57:22.8700066Z --- /home/runner/work/flask_blog/flask_blog/tests/test_posts.py	2026-01-25 08:57:06.654994+00:00
2026-01-25T08:57:22.8701174Z +++ /home/runner/work/flask_blog/flask_blog/tests/test_posts.py	2026-01-25 08:57:22.866809+00:00
2026-01-25T08:57:22.8701854Z @@ -1,6 +1,7 @@
2026-01-25T08:57:22.8702468Z  """Тесты для функционала постов блога."""
2026-01-25T08:57:22.8703127Z +
2026-01-25T08:57:22.8703398Z  import pytest
2026-01-25T08:57:22.8703773Z  from flask import session
2026-01-25T08:57:22.8704136Z  
2026-01-25T08:57:22.8704438Z  from app.models import Post
2026-01-25T08:57:22.8704870Z  from app.services import PostService
2026-01-25T08:57:22.8705240Z @@ -12,41 +13,39 @@
2026-01-25T08:57:22.8705570Z      def test_create_post(self, app, client, auth):
2026-01-25T08:57:22.8706610Z          """Создание поста должно работать корректно."""
2026-01-25T08:57:22.8707128Z          # Сначала регистрируем и логинимся
2026-01-25T08:57:22.8707540Z          auth.register()
2026-01-25T08:57:22.8707903Z          auth.login()
2026-01-25T08:57:22.8708240Z -        
2026-01-25T08:57:22.8708524Z +
2026-01-25T08:57:22.8708955Z          # Создаём пост через модель
2026-01-25T08:57:22.8709409Z          with app.app_context():
2026-01-25T08:57:22.8709820Z              post = PostService.create(
2026-01-25T08:57:22.8710447Z                  author_id=1,  # ID первого пользователя
2026-01-25T08:57:22.8711106Z                  title="Тестовый пост",
2026-01-25T08:57:22.8711459Z -                content="Это содержание тестового поста."
2026-01-25T08:57:22.8711864Z -            )
2026-01-25T08:57:22.8712529Z -            
2026-01-25T08:57:22.8713266Z +                content="Это содержание тестового поста.",
2026-01-25T08:57:22.8713764Z +            )
2026-01-25T08:57:22.8713977Z +
2026-01-25T08:57:22.8714353Z              assert post.id is not None
2026-01-25T08:57:22.8714962Z              assert post.title == "Тестовый пост"
2026-01-25T08:57:22.8715623Z              assert post.content == "Это содержание тестового поста."
2026-01-25T08:57:22.8716163Z              assert post.author_id == 1
2026-01-25T08:57:22.8716679Z              assert post.created is not None
2026-01-25T08:57:22.8717137Z  
2026-01-25T08:57:22.8717495Z      def test_find_post_by_id(self, app, auth):
2026-01-25T08:57:22.8718132Z          """Поиск поста по ID должен работать."""
2026-01-25T08:57:22.8718600Z          auth.register()
2026-01-25T08:57:22.8718960Z          auth.login()
2026-01-25T08:57:22.8719277Z -        
2026-01-25T08:57:22.8719561Z +
2026-01-25T08:57:22.8719869Z          with app.app_context():
2026-01-25T08:57:22.8720376Z              # Создаём пост
2026-01-25T08:57:22.8720818Z              created_post = PostService.create(
2026-01-25T08:57:22.8721281Z -                author_id=1,
2026-01-25T08:57:22.8721784Z -                title="Тестовый пост",
2026-01-25T08:57:22.8722315Z -                content="Содержание"
2026-01-25T08:57:22.8722714Z -            )
2026-01-25T08:57:22.8723204Z -            
2026-01-25T08:57:22.8723549Z +                author_id=1, title="Тестовый пост", content="Содержание"
2026-01-25T08:57:22.8723869Z +            )
2026-01-25T08:57:22.8724036Z +
2026-01-25T08:57:22.8724291Z              # Ищем пост по ID
2026-01-25T08:57:22.8724782Z              found_post = PostService.find_by_id(created_post.id)
2026-01-25T08:57:22.8725307Z -            
2026-01-25T08:57:22.8725577Z +
2026-01-25T08:57:22.8725886Z              assert found_post is not None
2026-01-25T08:57:22.8726366Z              assert found_post.id == created_post.id
2026-01-25T08:57:22.8727004Z              assert found_post.title == "Тестовый пост"
2026-01-25T08:57:22.8727658Z              assert found_post.content == "Содержание"
2026-01-25T08:57:22.8728201Z              assert found_post.author_username is not None
2026-01-25T08:57:22.8728988Z @@ -60,79 +59,87 @@
2026-01-25T08:57:22.8729311Z  
2026-01-25T08:57:22.8729550Z      def test_get_all_posts(self, app, auth):
2026-01-25T08:57:22.8730034Z          """Получение всех постов должно работать."""
2026-01-25T08:57:22.8730520Z          auth.register()
2026-01-25T08:57:22.8730849Z          auth.login()
2026-01-25T08:57:22.8731183Z -        
2026-01-25T08:57:22.8731463Z +
2026-01-25T08:57:22.8731770Z          with app.app_context():
2026-01-25T08:57:22.8732297Z              # Создаём несколько постов
2026-01-25T08:57:22.8733260Z -            post1 = PostService.create(author_id=1, title="Пост 1", content="Содержание 1")
2026-01-25T08:57:22.8734358Z -            post2 = PostService.create(author_id=1, title="Пост 2", content="Содержание 2")
2026-01-25T08:57:22.8735061Z -            
2026-01-25T08:57:22.8735413Z +            post1 = PostService.create(
2026-01-25T08:57:22.8736125Z +                author_id=1, title="Пост 1", content="Содержание 1"
2026-01-25T08:57:22.8736685Z +            )
2026-01-25T08:57:22.8737041Z +            post2 = PostService.create(
2026-01-25T08:57:22.8737693Z +                author_id=1, title="Пост 2", content="Содержание 2"
2026-01-25T08:57:22.8738207Z +            )
2026-01-25T08:57:22.8738509Z +
2026-01-25T08:57:22.8738869Z              # Получаем все посты
2026-01-25T08:57:22.8739377Z              all_posts = PostService.get_all()
2026-01-25T08:57:22.8739847Z -            
2026-01-25T08:57:22.8740168Z +
2026-01-25T08:57:22.8740482Z              assert len(all_posts) >= 2
2026-01-25T08:57:22.8741149Z              # Посты должны быть отсортированы по дате создания (новые первые)
2026-01-25T08:57:22.8741771Z              assert all_posts[0].created >= all_posts[1].created
2026-01-25T08:57:22.8742261Z  
2026-01-25T08:57:22.8742589Z      def test_update_post(self, app, auth):
2026-01-25T08:57:22.8743684Z          """Обновление поста должно работать."""
2026-01-25T08:57:22.8744164Z          auth.register()
2026-01-25T08:57:22.8744567Z          auth.login()
2026-01-25T08:57:22.8744904Z -        
2026-01-25T08:57:22.8745184Z +
2026-01-25T08:57:22.8745521Z          with app.app_context():
2026-01-25T08:57:22.8746007Z              # Создаём пост
2026-01-25T08:57:22.8746888Z -            post = PostService.create(author_id=1, title="Старый заголовок", content="Старое содержание")
2026-01-25T08:57:22.8747658Z -            
2026-01-25T08:57:22.8748027Z +            post = PostService.create(
2026-01-25T08:57:22.8748794Z +                author_id=1, title="Старый заголовок", content="Старое содержание"
2026-01-25T08:57:22.8749398Z +            )
2026-01-25T08:57:22.8749708Z +
2026-01-25T08:57:22.8750101Z              # Обновляем пост
2026-01-25T08:57:22.8750803Z              PostService.update(post.id, "Новый заголовок", "Новое содержание")
2026-01-25T08:57:22.8751444Z -            
2026-01-25T08:57:22.8751746Z +
2026-01-25T08:57:22.8752158Z              # Проверяем изменения
2026-01-25T08:57:22.8752677Z              updated_post = PostService.find_by_id(post.id)
2026-01-25T08:57:22.8753715Z              assert updated_post.title == "Новый заголовок"
2026-01-25T08:57:22.8754499Z              assert updated_post.content == "Новое содержание"
2026-01-25T08:57:22.8754875Z  
2026-01-25T08:57:22.8755191Z      def test_delete_post(self, app, auth):
2026-01-25T08:57:22.8755705Z          """Удаление поста должно работать."""
2026-01-25T08:57:22.8756094Z          auth.register()
2026-01-25T08:57:22.8756406Z          auth.login()
2026-01-25T08:57:22.8756689Z -        
2026-01-25T08:57:22.8756964Z +
2026-01-25T08:57:22.8757222Z          with app.app_context():
2026-01-25T08:57:22.8757623Z              # Создаём пост
2026-01-25T08:57:22.8758307Z -            post = PostService.create(author_id=1, title="Пост для удаления", content="Содержание")
2026-01-25T08:57:22.8758969Z +            post = PostService.create(
2026-01-25T08:57:22.8759584Z +                author_id=1, title="Пост для удаления", content="Содержание"
2026-01-25T08:57:22.8760094Z +            )
2026-01-25T08:57:22.8760601Z              post_id = post.id
2026-01-25T08:57:22.8760917Z -            
2026-01-25T08:57:22.8761165Z +
2026-01-25T08:57:22.8761467Z              # Удаляем пост
2026-01-25T08:57:22.8761812Z              PostService.delete(post_id)
2026-01-25T08:57:22.8762189Z -            
2026-01-25T08:57:22.8762477Z +
2026-01-25T08:57:22.8762802Z              # Проверяем, что пост удалён
2026-01-25T08:57:22.8763461Z              deleted_post = PostService.find_by_id(post_id)
2026-01-25T08:57:22.8763938Z              assert deleted_post is None
2026-01-25T08:57:22.8764289Z  
2026-01-25T08:57:22.8764557Z      def test_is_author(self, app, auth):
2026-01-25T08:57:22.8765028Z          """Проверка авторства должна работать."""
2026-01-25T08:57:22.8765427Z          auth.register()
2026-01-25T08:57:22.8765812Z          auth.login()
2026-01-25T08:57:22.8766145Z -        
2026-01-25T08:57:22.8766391Z +
2026-01-25T08:57:22.8766652Z          with app.app_context():
2026-01-25T08:57:22.8767145Z              # Создаём пост от пользователя с ID=1
2026-01-25T08:57:22.8767829Z              post = PostService.create(author_id=1, title="Пост", content="Содержание")
2026-01-25T08:57:22.8768423Z -            
2026-01-25T08:57:22.8768698Z +
2026-01-25T08:57:22.8768993Z              # Проверяем авторство
2026-01-25T08:57:22.8769384Z              assert post.is_author(1) is True
2026-01-25T08:57:22.8769828Z              assert post.is_author(2) is False
2026-01-25T08:57:22.8770191Z  
2026-01-25T08:57:22.8770488Z      def test_author_display_name(self, app, auth):
2026-01-25T08:57:22.8771102Z          """Отображаемое имя автора должно форматироваться правильно."""
2026-01-25T08:57:22.8771547Z          auth.register()
2026-01-25T08:57:22.8771854Z          auth.login()
2026-01-25T08:57:22.8772150Z -        
2026-01-25T08:57:22.8772578Z +
2026-01-25T08:57:22.8772831Z          with app.app_context():
2026-01-25T08:57:22.8773442Z              # Создаём пост
2026-01-25T08:57:22.8774113Z              post = PostService.create(author_id=1, title="Пост", content="Содержание")
2026-01-25T08:57:22.8774730Z -            
2026-01-25T08:57:22.8774999Z +
2026-01-25T08:57:22.8775350Z              # Проверяем формат имени автора
2026-01-25T08:57:22.8775804Z              display_name = post.author_display_name
2026-01-25T08:57:22.8776271Z              assert "#" in display_name
2026-01-25T08:57:22.8776865Z              # Пользователь в conftest.py имеет дискриминатор 1234
2026-01-25T08:57:22.8777381Z              assert display_name.endswith("#1234")
2026-01-25T08:57:22.8777833Z @@ -144,267 +151,306 @@
2026-01-25T08:57:22.8778231Z      def test_index_page_shows_posts(self, client, auth):
2026-01-25T08:57:22.8778824Z          """Главная страница должна показывать посты."""
2026-01-25T08:57:22.8779286Z          # Создаём пост
2026-01-25T08:57:22.8779647Z          auth.register()
2026-01-25T08:57:22.8779961Z          auth.login()
2026-01-25T08:57:22.8780251Z -        
2026-01-25T08:57:22.8780516Z +
2026-01-25T08:57:22.8780763Z          # Создаём пост через POST запрос
2026-01-25T08:57:22.8781206Z -        response = client.post('/post/create', data={
2026-01-25T08:57:22.8781540Z -            'title': 'Тестовый пост',
2026-01-25T08:57:22.8781861Z -            'content': 'Содержание тестового поста',
2026-01-25T08:57:22.8782154Z -            'csrf_token': 'test_csrf_token_for_testing'
2026-01-25T08:57:22.8782430Z -        })
2026-01-25T08:57:22.8782704Z -        assert response.status_code == 302  # Redirect after creation
2026-01-25T08:57:22.8783242Z -        
2026-01-25T08:57:22.8783434Z +        response = client.post(
2026-01-25T08:57:22.8783676Z +            "/post/create",
2026-01-25T08:57:22.8783883Z +            data={
2026-01-25T08:57:22.8784119Z +                "title": "Тестовый пост",
2026-01-25T08:57:22.8784446Z +                "content": "Содержание тестового поста",
2026-01-25T08:57:22.8784782Z +                "csrf_token": "test_csrf_token_for_testing",
2026-01-25T08:57:22.8785043Z +            },
2026-01-25T08:57:22.8785252Z +        )
2026-01-25T08:57:22.8785506Z +        assert response.status_code == 302  # Redirect after creation
2026-01-25T08:57:22.8785815Z +
2026-01-25T08:57:22.8786017Z          # Выходим из системы
2026-01-25T08:57:22.8786236Z          auth.logout()
2026-01-25T08:57:22.8786420Z -        
2026-01-25T08:57:22.8786683Z +
2026-01-25T08:57:22.8787061Z          # Проверяем главную страницу
2026-01-25T08:57:22.8787497Z -        response = client.get('/')
2026-01-25T08:57:22.8787937Z +        response = client.get("/")
2026-01-25T08:57:22.8788422Z          assert response.status_code == 200
2026-01-25T08:57:22.8789110Z -        assert 'Тестовый пост' in response.get_data(as_text=True)
2026-01-25T08:57:22.8789660Z would reformat /home/runner/work/flask_blog/flask_blog/tests/test_posts.py
2026-01-25T08:57:22.8790373Z +        assert "Тестовый пост" in response.get_data(as_text=True)
2026-01-25T08:57:22.8791092Z  
2026-01-25T08:57:22.8791460Z      def test_create_post_requires_login(self, client):
2026-01-25T08:57:22.8792127Z          """Создание поста должно требовать авторизации."""
2026-01-25T08:57:22.8792642Z -        response = client.get('/post/create')
2026-01-25T08:57:22.8793395Z +        response = client.get("/post/create")
2026-01-25T08:57:22.8793927Z          assert response.status_code == 302  # Redirect to login
2026-01-25T08:57:22.8794414Z  
2026-01-25T08:57:22.8794729Z      def test_create_post_form(self, client, auth):
2026-01-25T08:57:22.8795288Z          """Форма создания поста должна работать."""
2026-01-25T08:57:22.8795682Z          auth.register()
2026-01-25T08:57:22.8796007Z          auth.login()
2026-01-25T08:57:22.8796329Z -        
2026-01-25T08:57:22.8796653Z -        response = client.get('/post/create')
2026-01-25T08:57:22.8797052Z +
2026-01-25T08:57:22.8797348Z +        response = client.get("/post/create")
2026-01-25T08:57:22.8797838Z          assert response.status_code == 200
2026-01-25T08:57:22.8798453Z -        assert 'Создать новую статью' in response.get_data(as_text=True)
2026-01-25T08:57:22.8799150Z +        assert "Создать новую статью" in response.get_data(as_text=True)
2026-01-25T08:57:22.8799602Z  
2026-01-25T08:57:22.8800007Z      def test_create_post_submission(self, client, auth, setup_csrf_token):
2026-01-25T08:57:22.8800627Z          """Создание поста должно работать."""
2026-01-25T08:57:22.8801028Z          auth.register()
2026-01-25T08:57:22.8801333Z          auth.login()
2026-01-25T08:57:22.8801620Z -        
2026-01-25T08:57:22.8801897Z -        token = setup_csrf_token()
2026-01-25T08:57:22.8802239Z -        
2026-01-25T08:57:22.8802569Z -        response = client.post('/post/create', data={
2026-01-25T08:57:22.8803377Z -            'title': 'Новый пост',
2026-01-25T08:57:22.8803851Z -            'content': 'Содержание нового поста',
2026-01-25T08:57:22.8804304Z -            'csrf_token': 'test_csrf_token_for_testing'
2026-01-25T08:57:22.8804762Z -        })
2026-01-25T08:57:22.8805011Z +
2026-01-25T08:57:22.8805294Z +        token = setup_csrf_token()
2026-01-25T08:57:22.8805878Z +
2026-01-25T08:57:22.8806153Z +        response = client.post(
2026-01-25T08:57:22.8806534Z +            "/post/create",
2026-01-25T08:57:22.8806878Z +            data={
2026-01-25T08:57:22.8807304Z +                "title": "Новый пост",
2026-01-25T08:57:22.8807792Z +                "content": "Содержание нового поста",
2026-01-25T08:57:22.8808286Z +                "csrf_token": "test_csrf_token_for_testing",
2026-01-25T08:57:22.8808729Z +            },
2026-01-25T08:57:22.8808989Z +        )
2026-01-25T08:57:22.8809404Z          assert response.status_code == 302  # Redirect to post view
2026-01-25T08:57:22.8809912Z -        
2026-01-25T08:57:22.8810156Z +
2026-01-25T08:57:22.8810486Z          # Проверяем, что пост создан
2026-01-25T08:57:22.8810890Z -        response = client.get('/')
2026-01-25T08:57:22.8811461Z -        assert 'Новый пост' in response.get_data(as_text=True)
2026-01-25T08:57:22.8811966Z +        response = client.get("/")
2026-01-25T08:57:22.8812504Z +        assert "Новый пост" in response.get_data(as_text=True)
2026-01-25T08:57:22.8813128Z  
2026-01-25T08:57:22.8813492Z      def test_view_post(self, client, auth, setup_csrf_token):
2026-01-25T08:57:22.8814090Z          """Просмотр поста должен работать."""
2026-01-25T08:57:22.8814499Z          auth.register()
2026-01-25T08:57:22.8814810Z          auth.login()
2026-01-25T08:57:22.8815101Z -        
2026-01-25T08:57:22.8815400Z -        token = setup_csrf_token()
2026-01-25T08:57:22.8815757Z -        
2026-01-25T08:57:22.8816104Z -        response = client.post('/post/create', data={
2026-01-25T08:57:22.8816690Z -            'title': 'Пост для просмотра',
2026-01-25T08:57:22.8817223Z -            'content': 'Содержание для просмотра',
2026-01-25T08:57:22.8817708Z -            'csrf_token': 'test_csrf_token_for_testing'
2026-01-25T08:57:22.8818134Z -        })
2026-01-25T08:57:22.8818760Z -        assert response.status_code == 302  # Redirect after creation
2026-01-25T08:57:22.8819265Z -        
2026-01-25T08:57:22.8819529Z +
2026-01-25T08:57:22.8819826Z +        token = setup_csrf_token()
2026-01-25T08:57:22.8820167Z +
2026-01-25T08:57:22.8820440Z +        response = client.post(
2026-01-25T08:57:22.8820820Z +            "/post/create",
2026-01-25T08:57:22.8821156Z +            data={
2026-01-25T08:57:22.8821571Z +                "title": "Пост для просмотра",
2026-01-25T08:57:22.8822096Z +                "content": "Содержание для просмотра",
2026-01-25T08:57:22.8822574Z +                "csrf_token": "test_csrf_token_for_testing",
2026-01-25T08:57:22.8823229Z +            },
2026-01-25T08:57:22.8823514Z +        )
2026-01-25T08:57:22.8823926Z +        assert response.status_code == 302  # Redirect after creation
2026-01-25T08:57:22.8824440Z +
2026-01-25T08:57:22.8824858Z          # Извлекаем ID поста из URL редиректа
2026-01-25T08:57:22.8825496Z -        assert response.status_code == 302, f"Expected redirect, got {response.status_code}"
2026-01-25T08:57:22.8826211Z -        post_id = response.location.split('/')[-1]
2026-01-25T08:57:22.8826654Z -        
2026-01-25T08:57:22.8826913Z +        assert (
2026-01-25T08:57:22.8827224Z +            response.status_code == 302
2026-01-25T08:57:22.8827700Z +        ), f"Expected redirect, got {response.status_code}"
2026-01-25T08:57:22.8828218Z +        post_id = response.location.split("/")[-1]
2026-01-25T08:57:22.8828635Z +
2026-01-25T08:57:22.8828962Z          # Просматриваем пост
2026-01-25T08:57:22.8829363Z -        response = client.get(f'/post/{post_id}')
2026-01-25T08:57:22.8829899Z +        response = client.get(f"/post/{post_id}")
2026-01-25T08:57:22.8830373Z          assert response.status_code == 200
2026-01-25T08:57:22.8831023Z -        assert 'Пост для просмотра' in response.get_data(as_text=True)
2026-01-25T08:57:22.8831783Z -        assert 'Содержание для просмотра' in response.get_data(as_text=True)
2026-01-25T08:57:22.8832548Z +        assert "Пост для просмотра" in response.get_data(as_text=True)
2026-01-25T08:57:22.8833454Z +        assert "Содержание для просмотра" in response.get_data(as_text=True)
2026-01-25T08:57:22.8834155Z  
2026-01-25T08:57:22.8834484Z      def test_view_nonexistent_post(self, client):
2026-01-25T08:57:22.8835106Z          """Просмотр несуществующего поста должен возвращать 404."""
2026-01-25T08:57:22.8835618Z -        response = client.get('/post/999999')
2026-01-25T08:57:22.8836095Z +        response = client.get("/post/999999")
2026-01-25T08:57:22.8836552Z          assert response.status_code == 404
2026-01-25T08:57:22.8836957Z  
2026-01-25T08:57:22.8837408Z      def test_edit_post_requires_login(self, client, auth, setup_csrf_token):
2026-01-25T08:57:22.8838163Z          """Редактирование поста должно требовать авторизации."""
2026-01-25T08:57:22.8838691Z          # Сначала создаём пост
2026-01-25T08:57:22.8839056Z          auth.register()
2026-01-25T08:57:22.8839443Z          auth.login()
2026-01-25T08:57:22.8839745Z -        
2026-01-25T08:57:22.8840044Z -        token = setup_csrf_token()
2026-01-25T08:57:22.8840419Z -        
2026-01-25T08:57:22.8840787Z -        response = client.post('/post/create', data={
2026-01-25T08:57:22.8841323Z -            'title': 'Пост',
2026-01-25T08:57:22.8841767Z -            'content': 'Содержание',
2026-01-25T08:57:22.8842237Z -            'csrf_token': 'test_csrf_token_for_testing'
2026-01-25T08:57:22.8842689Z -        })
2026-01-25T08:57:22.8843306Z -        assert response.status_code == 302  # Redirect after creation
2026-01-25T08:57:22.8843915Z -        post_id = response.location.split('/')[-1]
2026-01-25T08:57:22.8844364Z +
2026-01-25T08:57:22.8844648Z +        token = setup_csrf_token()
2026-01-25T08:57:22.8845019Z +
2026-01-25T08:57:22.8845294Z +        response = client.post(
2026-01-25T08:57:22.8845685Z +            "/post/create",
2026-01-25T08:57:22.8846033Z +            data={
2026-01-25T08:57:22.8846412Z +                "title": "Пост",
2026-01-25T08:57:22.8847099Z +                "content": "Содержание",
2026-01-25T08:57:22.8847578Z +                "csrf_token": "test_csrf_token_for_testing",
2026-01-25T08:57:22.8848036Z +            },
2026-01-25T08:57:22.8848338Z +        )
2026-01-25T08:57:22.8848755Z +        assert response.status_code == 302  # Redirect after creation
2026-01-25T08:57:22.8849365Z +        post_id = response.location.split("/")[-1]
2026-01-25T08:57:22.8849798Z          auth.logout()
2026-01-25T08:57:22.8850092Z -        
2026-01-25T08:57:22.8850340Z +
2026-01-25T08:57:22.8850714Z          # Пытаемся редактировать без авторизации
2026-01-25T08:57:22.8851198Z -        response = client.get(f'/post/{post_id}/edit')
2026-01-25T08:57:22.8851707Z +        response = client.get(f"/post/{post_id}/edit")
2026-01-25T08:57:22.8852259Z          assert response.status_code == 302  # Redirect to login
2026-01-25T08:57:22.8852731Z  
2026-01-25T08:57:22.8853325Z      def test_edit_post_author_only(self, client, auth, setup_csrf_token):
2026-01-25T08:57:22.8853792Z          """Редактировать пост может только автор."""
2026-01-25T08:57:22.8854109Z          # Создаём первого пользователя и пост
2026-01-25T08:57:22.8854456Z -        auth.register(username='user1', password='test_pass')
2026-01-25T08:57:22.8854831Z -        auth.login(username='user1', password='test_pass')
2026-01-25T08:57:22.8855113Z -        
2026-01-25T08:57:22.8855300Z -        token = setup_csrf_token()
2026-01-25T08:57:22.8855520Z -        
2026-01-25T08:57:22.8855726Z -        response = client.post('/post/create', data={
2026-01-25T08:57:22.8856046Z -            'title': 'Пост user1',
2026-01-25T08:57:22.8856329Z -            'content': 'Содержание user1',
2026-01-25T08:57:22.8856606Z -            'csrf_token': 'test_csrf_token_for_testing'
2026-01-25T08:57:22.8857050Z -        })
2026-01-25T08:57:22.8857477Z -        assert response.status_code == 302  # Redirect after creation
2026-01-25T08:57:22.8858123Z -        post_id = response.location.split('/')[-1]
2026-01-25T08:57:22.8858850Z +        auth.register(username="user1", ***)
2026-01-25T08:57:22.8859376Z +        auth.login(username="user1", ***)
2026-01-25T08:57:22.8859995Z +
2026-01-25T08:57:22.8860270Z +        token = setup_csrf_token()
2026-01-25T08:57:22.8860602Z +
2026-01-25T08:57:22.8860877Z +        response = client.post(
2026-01-25T08:57:22.8861322Z +            "/post/create",
2026-01-25T08:57:22.8861592Z +            data={
2026-01-25T08:57:22.8861885Z +                "title": "Пост user1",
2026-01-25T08:57:22.8862188Z +                "content": "Содержание user1",
2026-01-25T08:57:22.8862490Z +                "csrf_token": "test_csrf_token_for_testing",
2026-01-25T08:57:22.8862776Z +            },
2026-01-25T08:57:22.8863196Z +        )
2026-01-25T08:57:22.8863475Z +        assert response.status_code == 302  # Redirect after creation
2026-01-25T08:57:22.8863848Z +        post_id = response.location.split("/")[-1]
2026-01-25T08:57:22.8864132Z          auth.logout()
2026-01-25T08:57:22.8864339Z -        
2026-01-25T08:57:22.8864495Z +
2026-01-25T08:57:22.8864720Z          # Создаём второго пользователя
2026-01-25T08:57:22.8865039Z -        auth.register(username='user2', password='test_pass')
2026-01-25T08:57:22.8865421Z -        auth.login(username='user2', password='test_pass')
2026-01-25T08:57:22.8865703Z -        
2026-01-25T08:57:22.8866014Z +        auth.register(username="user2", ***)
2026-01-25T08:57:22.8866337Z +        auth.login(username="user2", ***)
2026-01-25T08:57:22.8866568Z +
2026-01-25T08:57:22.8866809Z          # Пытаемся редактировать пост первого пользователя
2026-01-25T08:57:22.8867134Z -        response = client.get(f'/post/{post_id}/edit')
2026-01-25T08:57:22.8867445Z +        response = client.get(f"/post/{post_id}/edit")
2026-01-25T08:57:22.8867762Z          assert response.status_code == 403  # Forbidden
2026-01-25T08:57:22.8868027Z  
2026-01-25T08:57:22.8868266Z      def test_edit_post_form(self, client, auth, setup_csrf_token):
2026-01-25T08:57:22.8868873Z          """Форма редактирования поста должна работать для автора."""
2026-01-25T08:57:22.8869171Z          auth.register()
2026-01-25T08:57:22.8869379Z          auth.login()
2026-01-25T08:57:22.8869570Z -        
2026-01-25T08:57:22.8869747Z -        token = setup_csrf_token()
2026-01-25T08:57:22.8869972Z -        
2026-01-25T08:57:22.8870186Z -        response = client.post('/post/create', data={
2026-01-25T08:57:22.8870539Z -            'title': 'Оригинальный заголовок',
2026-01-25T08:57:22.8870859Z -            'content': 'Оригинальное содержание',
2026-01-25T08:57:22.8871168Z -            'csrf_token': 'test_csrf_token_for_testing'
2026-01-25T08:57:22.8871431Z -        })
2026-01-25T08:57:22.8871648Z -        post_id = response.location.split('/')[-1]
2026-01-25T08:57:22.8871917Z -        
2026-01-25T08:57:22.8872075Z +
2026-01-25T08:57:22.8872250Z +        token = setup_csrf_token()
2026-01-25T08:57:22.8872477Z +
2026-01-25T08:57:22.8872643Z +        response = client.post(
2026-01-25T08:57:22.8873084Z +            "/post/create",
2026-01-25T08:57:22.8873316Z +            data={
2026-01-25T08:57:22.8873564Z +                "title": "Оригинальный заголовок",
2026-01-25T08:57:22.8874034Z +                "content": "Оригинальное содержание",
2026-01-25T08:57:22.8874343Z +                "csrf_token": "test_csrf_token_for_testing",
2026-01-25T08:57:22.8874625Z +            },
2026-01-25T08:57:22.8874832Z +        )
2026-01-25T08:57:22.8875044Z +        post_id = response.location.split("/")[-1]
2026-01-25T08:57:22.8875315Z +
2026-01-25T08:57:22.8875517Z          # Получаем форму редактирования
2026-01-25T08:57:22.8875847Z -        response = client.get(f'/post/{post_id}/edit')
2026-01-25T08:57:22.8876169Z +        response = client.get(f"/post/{post_id}/edit")
2026-01-25T08:57:22.8876464Z          assert response.status_code == 200
2026-01-25T08:57:22.8876859Z -        assert 'Оригинальный заголовок' in response.get_data(as_text=True)
2026-01-25T08:57:22.8877368Z -        assert 'Оригинальное содержание' in response.get_data(as_text=True)
2026-01-25T08:57:22.8877836Z +        assert "Оригинальный заголовок" in response.get_data(as_text=True)
2026-01-25T08:57:22.8878285Z +        assert "Оригинальное содержание" in response.get_data(as_text=True)
2026-01-25T08:57:22.8878606Z  
2026-01-25T08:57:22.8878862Z      def test_edit_post_submission(self, client, auth, setup_csrf_token):
2026-01-25T08:57:22.8879276Z          """Отправка формы редактирования должна работать."""
2026-01-25T08:57:22.8879555Z          auth.register()
2026-01-25T08:57:22.8879761Z          auth.login()
2026-01-25T08:57:22.8879940Z -        
2026-01-25T08:57:22.8880118Z -        token = setup_csrf_token()
2026-01-25T08:57:22.8880345Z -        
2026-01-25T08:57:22.8880558Z -        response = client.post('/post/create', data={
2026-01-25T08:57:22.8880902Z -            'title': 'Старый заголовок',
2026-01-25T08:57:22.8881196Z -            'content': 'Старое содержание',
2026-01-25T08:57:22.8881475Z -            'csrf_token': 'test_csrf_token_for_testing'
2026-01-25T08:57:22.8881865Z -        })
2026-01-25T08:57:22.8882074Z -        post_id = response.location.split('/')[-1]
2026-01-25T08:57:22.8882336Z -        
2026-01-25T08:57:22.8882494Z +
2026-01-25T08:57:22.8882662Z +        token = setup_csrf_token()
2026-01-25T08:57:22.8883057Z +
2026-01-25T08:57:22.8883325Z +        response = client.post(
2026-01-25T08:57:22.8883564Z +            "/post/create",
2026-01-25T08:57:22.8883787Z +            data={
2026-01-25T08:57:22.8884034Z +                "title": "Старый заголовок",
2026-01-25T08:57:22.8884339Z +                "content": "Старое содержание",
2026-01-25T08:57:22.8884632Z +                "csrf_token": "test_csrf_token_for_testing",
2026-01-25T08:57:22.8884900Z +            },
2026-01-25T08:57:22.8885071Z +        )
2026-01-25T08:57:22.8885273Z +        post_id = response.location.split("/")[-1]
2026-01-25T08:57:22.8885534Z +
2026-01-25T08:57:22.8885767Z          # Редактируем пост
2026-01-25T08:57:22.8886041Z -        response = client.post(f'/post/{post_id}/edit', data={
2026-01-25T08:57:22.8886421Z -            'title': 'Новый заголовок',
2026-01-25T08:57:22.8886706Z -            'content': 'Новое содержание',
2026-01-25T08:57:22.8886996Z -            'csrf_token': 'test_csrf_token_for_testing'
2026-01-25T08:57:22.8887269Z -        })
2026-01-25T08:57:22.8887448Z +        response = client.post(
2026-01-25T08:57:22.8887684Z +            f"/post/{post_id}/edit",
2026-01-25T08:57:22.8887943Z +            data={
2026-01-25T08:57:22.8888172Z +                "title": "Новый заголовок",
2026-01-25T08:57:22.8888520Z +                "content": "Новое содержание",
2026-01-25T08:57:22.8888849Z +                "csrf_token": "test_csrf_token_for_testing",
2026-01-25T08:57:22.8889122Z +            },
2026-01-25T08:57:22.8889287Z +        )
2026-01-25T08:57:22.8889550Z          assert response.status_code == 302  # Redirect to post view
2026-01-25T08:57:22.8889879Z -        
2026-01-25T08:57:22.8890030Z +
2026-01-25T08:57:22.8890230Z          # Проверяем изменения
2026-01-25T08:57:22.8890511Z -        response = client.get(f'/post/{post_id}')
2026-01-25T08:57:22.8890900Z -        assert 'Новый заголовок' in response.get_data(as_text=True)
2026-01-25T08:57:22.8891462Z -        assert 'Новое содержание' in response.get_data(as_text=True)
2026-01-25T08:57:22.8891797Z +        response = client.get(f"/post/{post_id}")
2026-01-25T08:57:22.8892177Z +        assert "Новый заголовок" in response.get_data(as_text=True)
2026-01-25T08:57:22.8892578Z +        assert "Новое содержание" in response.get_data(as_text=True)
2026-01-25T08:57:22.8892880Z  
2026-01-25T08:57:22.8893371Z      def test_delete_post_requires_login(self, client, auth, setup_csrf_token):
2026-01-25T08:57:22.8893822Z          """Удаление поста должно требовать авторизации."""
2026-01-25T08:57:22.8894127Z          # Сначала создаём пост
2026-01-25T08:57:22.8894351Z          auth.register()
2026-01-25T08:57:22.8894559Z          auth.login()
2026-01-25T08:57:22.8894752Z -        
2026-01-25T08:57:22.8894948Z -        token = setup_csrf_token()
2026-01-25T08:57:22.8895172Z -        
2026-01-25T08:57:22.8895386Z -        response = client.post('/post/create', data={
2026-01-25T08:57:22.8895712Z -            'title': 'Пост',
2026-01-25T08:57:22.8895974Z -            'content': 'Содержание',
2026-01-25T08:57:22.8896254Z -            'csrf_token': 'test_csrf_token_for_testing'
2026-01-25T08:57:22.8896529Z -        })
2026-01-25T08:57:22.8896787Z -        assert response.status_code == 302  # Redirect after creation
2026-01-25T08:57:22.8897151Z -        post_id = response.location.split('/')[-1]
2026-01-25T08:57:22.8897427Z +
2026-01-25T08:57:22.8897599Z +        token = setup_csrf_token()
2026-01-25T08:57:22.8897815Z +
2026-01-25T08:57:22.8897995Z +        response = client.post(
2026-01-25T08:57:22.8898229Z +            "/post/create",
2026-01-25T08:57:22.8898430Z +            data={
2026-01-25T08:57:22.8898657Z +                "title": "Пост",
2026-01-25T08:57:22.8898935Z +                "content": "Содержание",
2026-01-25T08:57:22.8899364Z +                "csrf_token": "test_csrf_token_for_testing",
2026-01-25T08:57:22.8899643Z +            },
2026-01-25T08:57:22.8899813Z +        )
2026-01-25T08:57:22.8900073Z +        assert response.status_code == 302  # Redirect after creation
2026-01-25T08:57:22.8900431Z +        post_id = response.location.split("/")[-1]
2026-01-25T08:57:22.8900513Z          auth.logout()
2026-01-25T08:57:22.8900580Z -        
2026-01-25T08:57:22.8900647Z +
2026-01-25T08:57:22.8900784Z          # Пытаемся удалить без авторизации
2026-01-25T08:57:22.8900913Z -        response = client.post(f'/post/{post_id}/delete')
2026-01-25T08:57:22.8901044Z +        response = client.post(f"/post/{post_id}/delete")
2026-01-25T08:57:22.8901194Z          assert response.status_code == 302  # Redirect to login
2026-01-25T08:57:22.8901261Z  
2026-01-25T08:57:22.8901447Z      def test_delete_post_author_only(self, client, auth, setup_csrf_token):
2026-01-25T08:57:22.8901579Z          """Удалять пост может только автор."""
2026-01-25T08:57:22.8901732Z          # Создаём первого пользователя и пост
2026-01-25T08:57:22.8901885Z -        auth.register(username='user1', password='test_pass')
2026-01-25T08:57:22.8902025Z -        auth.login(username='user1', password='test_pass')
2026-01-25T08:57:22.8902092Z -        
2026-01-25T08:57:22.8902184Z -        token = setup_csrf_token()
2026-01-25T08:57:22.8902250Z -        
2026-01-25T08:57:22.8902375Z -        response = client.post('/post/create', data={
2026-01-25T08:57:22.8902491Z -            'title': 'Пост user1',
2026-01-25T08:57:22.8902617Z -            'content': 'Содержание user1',
2026-01-25T08:57:22.8902744Z -            'csrf_token': 'test_csrf_token_for_testing'
2026-01-25T08:57:22.8902820Z -        })
2026-01-25T08:57:22.8903188Z -        assert response.status_code == 302  # Redirect after creation
2026-01-25T08:57:22.8903319Z -        post_id = response.location.split('/')[-1]
2026-01-25T08:57:22.8903497Z +        auth.register(username="user1", ***)
2026-01-25T08:57:22.8903654Z +        auth.login(username="user1", ***)
2026-01-25T08:57:22.8903724Z +
2026-01-25T08:57:22.8903810Z +        token = setup_csrf_token()
2026-01-25T08:57:22.8904028Z +
2026-01-25T08:57:22.8904120Z +        response = client.post(
2026-01-25T08:57:22.8904202Z +            "/post/create",
2026-01-25T08:57:22.8904270Z +            data={
2026-01-25T08:57:22.8904405Z +                "title": "Пост user1",
2026-01-25T08:57:22.8904542Z +                "content": "Содержание user1",
2026-01-25T08:57:22.8904663Z +                "csrf_token": "test_csrf_token_for_testing",
2026-01-25T08:57:22.8904730Z +            },
2026-01-25T08:57:22.8904804Z +        )
2026-01-25T08:57:22.8904967Z +        assert response.status_code == 302  # Redirect after creation
2026-01-25T08:57:22.8905085Z +        post_id = response.location.split("/")[-1]
2026-01-25T08:57:22.8905167Z          auth.logout()
2026-01-25T08:57:22.8905232Z -        
2026-01-25T08:57:22.8905306Z +
2026-01-25T08:57:22.8905423Z          # Создаём второго пользователя
2026-01-25T08:57:22.8905577Z -        auth.register(username='user2', password='test_pass')
2026-01-25T08:57:22.8905712Z -        auth.login(username='user2', password='test_pass')
2026-01-25T08:57:22.8905788Z -        
2026-01-25T08:57:22.8905950Z +        auth.register(username="user2", ***)
2026-01-25T08:57:22.8906083Z +        auth.login(username="user2", ***)
2026-01-25T08:57:22.8906157Z +
2026-01-25T08:57:22.8906313Z          # Пытаемся удалить пост первого пользователя
2026-01-25T08:57:22.8906457Z -        response = client.post(f'/post/{post_id}/delete')
2026-01-25T08:57:22.8906583Z +        response = client.post(f"/post/{post_id}/delete")
2026-01-25T08:57:22.8906703Z          assert response.status_code == 403  # Forbidden
2026-01-25T08:57:22.8906768Z  
2026-01-25T08:57:22.8906919Z      def test_delete_post(self, client, auth, setup_csrf_token):
2026-01-25T08:57:22.8907179Z          """Удаление поста должно работать."""
2026-01-25T08:57:22.8907288Z          auth.register()
2026-01-25T08:57:22.8907491Z          auth.login()
2026-01-25T08:57:22.8907556Z -        
2026-01-25T08:57:22.8907647Z -        token = setup_csrf_token()
2026-01-25T08:57:22.8907726Z -        
2026-01-25T08:57:22.8907846Z -        response = client.post('/post/create', data={
2026-01-25T08:57:22.8907977Z -            'title': 'Пост для удаления',
2026-01-25T08:57:22.8908114Z -            'content': 'Содержание для удаления',
2026-01-25T08:57:22.8908227Z -            'csrf_token': 'test_csrf_token_for_testing'
2026-01-25T08:57:22.8908299Z -        })
2026-01-25T08:57:22.8908416Z -        post_id = response.location.split('/')[-1]
2026-01-25T08:57:22.8908481Z -        
2026-01-25T08:57:22.8908553Z +
2026-01-25T08:57:22.8908636Z +        token = setup_csrf_token()
2026-01-25T08:57:22.8908701Z +
2026-01-25T08:57:22.8908793Z +        response = client.post(
2026-01-25T08:57:22.8908871Z +            "/post/create",
2026-01-25T08:57:22.8908938Z +            data={
2026-01-25T08:57:22.8909071Z +                "title": "Пост для удаления",
2026-01-25T08:57:22.8909220Z +                "content": "Содержание для удаления",
2026-01-25T08:57:22.8909347Z +                "csrf_token": "test_csrf_token_for_testing",
2026-01-25T08:57:22.8909423Z +            },
2026-01-25T08:57:22.8909489Z +        )
2026-01-25T08:57:22.8909603Z +        post_id = response.location.split("/")[-1]
2026-01-25T08:57:22.8909668Z +
2026-01-25T08:57:22.8909768Z          # Удаляем пост
2026-01-25T08:57:22.8909928Z -        response = client.post(f'/post/{post_id}/delete', data={
2026-01-25T08:57:22.8910039Z -            'csrf_token': 'test_csrf_token_for_testing'
2026-01-25T08:57:22.8910105Z -        })
2026-01-25T08:57:22.8910201Z +        response = client.post(
2026-01-25T08:57:22.8910287Z +            f"/post/{post_id}/delete",
2026-01-25T08:57:22.8910422Z +            data={"csrf_token": "test_csrf_token_for_testing"},
2026-01-25T08:57:22.8910490Z +        )
2026-01-25T08:57:22.8910629Z          assert response.status_code == 302  # Redirect to index
2026-01-25T08:57:22.8910708Z -        
2026-01-25T08:57:22.8910779Z +
2026-01-25T08:57:22.8910918Z          # Проверяем, что пост удалён
2026-01-25T08:57:22.8911031Z -        response = client.get(f'/post/{post_id}')
2026-01-25T08:57:22.8911230Z +        response = client.get(f"/post/{post_id}")
2026-01-25T08:57:22.8911327Z          assert response.status_code == 404
2026-01-25T08:57:22.8911397Z  
2026-01-25T08:57:22.8911557Z      def test_post_form_validation_placeholder(self, client, auth):
2026-01-25T08:57:22.8911711Z          """Тест валидации формы поста с заглушками.
2026-01-25T08:57:22.8911780Z -        
2026-01-25T08:57:22.8911844Z +
2026-01-25T08:57:22.8912039Z          TODO: После реализации валидаторов этот тест должен проверять:
2026-01-25T08:57:22.8912193Z          - Валидацию пустого заголовка (DataRequired)
2026-01-25T08:57:22.8912349Z          - Валидацию короткого содержания (Length min=10)
2026-01-25T08:57:22.8912534Z          - Валидацию максимальной длины заголовка (Length max=200)
2026-01-25T08:57:22.8912690Z          """
2026-01-25T08:57:22.8912771Z          auth.register()
2026-01-25T08:57:22.8912856Z          auth.login()
2026-01-25T08:57:22.8913152Z -        
2026-01-25T08:57:22.8913228Z +
2026-01-25T08:57:22.8913430Z          # Эти данные должны вызывать ошибки валидации после реализации
2026-01-25T08:57:22.8913559Z -        response = client.post('/post/create', data={
2026-01-25T08:57:22.8913753Z -            'title': '',  # TODO: Должно быть ошибкой (DataRequired)
2026-01-25T08:57:22.8913966Z -            'content': '123',  # TODO: Должно быть ошибкой (Length min=10)
2026-01-25T08:57:22.8914082Z -            'csrf_token': 'test_csrf_token_for_testing'
2026-01-25T08:57:22.8914155Z -        })
2026-01-25T08:57:22.8914223Z -        
2026-01-25T08:57:22.8914340Z +        response = client.post(
2026-01-25T08:57:22.8914425Z +            "/post/create",
2026-01-25T08:57:22.8914508Z +            data={
2026-01-25T08:57:22.8914705Z +                "title": "",  # TODO: Должно быть ошибкой (DataRequired)
2026-01-25T08:57:22.8914927Z +                "content": "123",  # TODO: Должно быть ошибкой (Length min=10)
2026-01-25T08:57:22.8915052Z +                "csrf_token": "test_csrf_token_for_testing",
2026-01-25T08:57:22.8915134Z +            },
2026-01-25T08:57:22.8915200Z +        )
2026-01-25T08:57:22.8915291Z +
2026-01-25T08:57:22.8915507Z          # Сейчас все валидаторы - заглушки, поэтому форма проходит валидацию
2026-01-25T08:57:22.8915778Z          # TODO: После реализации валидаторов ожидать status_code 200 (форма показана снова с ошибками)
2026-01-25T08:57:22.8916050Z          assert response.status_code == 302  # Редирект после успешного создания поста
2026-01-25T08:57:22.8916082Z 
2026-01-25T08:57:22.8916193Z Oh no! 💥 💔 💥
2026-01-25T08:57:22.8916354Z 35 files would be reformatted, 1 file would be left unchanged.
2026-01-25T08:57:22.9137339Z ##[error]Process completed with exit code 1.
